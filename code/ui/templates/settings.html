{% extends "base.html" %}

{% block title %}Settings - Communicator-Copilot{% endblock %}

{% block content %}
<div class="settings-container">
    <h1><i class="fas fa-cog"></i> Settings & Preferences</h1>
    
    <div class="settings-grid">
        <!-- AI Mode Settings -->
        <div class="settings-section">
            <h2><i class="fas fa-robot"></i> AI Mode Configuration</h2>
            <div class="setting-item">
                <label for="ai-mode-toggle">AI Mode Status</label>
                <div class="toggle-container">
                    <input type="checkbox" id="ai-mode-toggle" class="toggle-switch">
                    <span class="toggle-label">Currently <span id="ai-status">Disabled</span></span>
                </div>
            </div>
            
            <div class="setting-item">
                <label for="ai-duration">Auto-disable Duration (minutes)</label>
                <select id="ai-duration" class="form-control">
                    <option value="">No auto-disable</option>
                    <option value="30">30 minutes</option>
                    <option value="60">1 hour</option>
                    <option value="120">2 hours</option>
                    <option value="240">4 hours</option>
                    <option value="480">8 hours (max)</option>
                </select>
            </div>
            
            <div class="setting-item">
                <label>
                    <input type="checkbox" id="ai-disclosure" checked disabled>
                    AI Disclosure Required (Always On)
                </label>
                <small>AI will always identify itself during calls</small>
            </div>
        </div>

        <!-- Voice & Audio Settings -->
        <div class="settings-section">
            <h2><i class="fas fa-microphone"></i> Voice & Audio</h2>
            <div class="setting-item">
                <label>
                    <input type="checkbox" id="voice-cloning-enabled">
                    Enable Voice Cloning
                </label>
                <small>Allow AI to use your trained voice model</small>
            </div>
            
            <div class="setting-item">
                <label>
                    <input type="checkbox" id="voice-disclosure" checked>
                    Voice Cloning Disclosure
                </label>
                <small>Disclose when using cloned voice</small>
            </div>
            
            <div class="setting-item">
                <label for="voice-model-select">Active Voice Model</label>
                <select id="voice-model-select" class="form-control">
                    <option value="">No voice model selected</option>
                </select>
                <a href="{{ url_for('voice_training_page') }}" class="btn btn-secondary btn-sm">Train New Model</a>
            </div>
        </div>

        <!-- Call & Recording Settings -->
        <div class="settings-section">
            <h2><i class="fas fa-phone"></i> Call Management</h2>
            <div class="setting-item">
                <label>
                    <input type="checkbox" id="call-recording">
                    Enable Call Recording
                </label>
                <small>Record calls for transcription and analysis</small>
            </div>
            
            <div class="setting-item">
                <label>
                    <input type="checkbox" id="recording-consent" checked>
                    Require Recording Consent
                </label>
                <small>Ask for consent before recording calls</small>
            </div>
            
            <div class="setting-item">
                <label for="call-handling">Default Call Handling</label>
                <select id="call-handling" class="form-control">
                    <option value="screen">Screen unknown calls</option>
                    <option value="answer">Answer all calls</option>
                    <option value="whitelist">Whitelist only</option>
                </select>
            </div>
        </div>

        <!-- Spam Detection Settings -->
        <div class="settings-section">
            <h2><i class="fas fa-shield-alt"></i> Spam Protection</h2>
            <div class="setting-item">
                <label>
                    <input type="checkbox" id="spam-detection" checked>
                    Enable Spam Detection
                </label>
            </div>
            
            <div class="setting-item">
                <label for="spam-sensitivity">Spam Sensitivity</label>
                <select id="spam-sensitivity" class="form-control">
                    <option value="low">Low - Catch obvious spam</option>
                    <option value="medium" selected>Medium - Balanced protection</option>
                    <option value="high">High - Aggressive filtering</option>
                </select>
            </div>
            
            <div class="setting-item">
                <label for="spam-action">Spam Action</label>
                <select id="spam-action" class="form-control">
                    <option value="block">Block completely</option>
                    <option value="screen">Screen with AI</option>
                    <option value="voicemail">Send to voicemail</option>
                </select>
            </div>
        </div>

        <!-- Privacy & Data Settings -->
        <div class="settings-section">
            <h2><i class="fas fa-lock"></i> Privacy & Data</h2>
            <div class="setting-item">
                <label for="feed-retention">Feed Item Retention</label>
                <select id="feed-retention" class="form-control">
                    <option value="3">3 days</option>
                    <option value="7" selected>7 days (default)</option>
                    <option value="14">14 days</option>
                </select>
                <small>How long to keep AI instruction feed items</small>
            </div>
            
            <div class="setting-item">
                <label for="transcript-retention">Transcript Retention</label>
                <select id="transcript-retention" class="form-control">
                    <option value="30">30 days</option>
                    <option value="90" selected>90 days</option>
                    <option value="365">1 year</option>
                    <option value="0">Keep forever</option>
                </select>
            </div>
            
            <div class="setting-item">
                <label>
                    <input type="checkbox" id="analytics-opt-in" checked>
                    Enable Usage Analytics
                </label>
                <small>Help improve the service with anonymous usage data</small>
            </div>
        </div>

        <!-- Notification Settings -->
        <div class="settings-section">
            <h2><i class="fas fa-bell"></i> Notifications</h2>
            <div class="setting-item">
                <label>
                    <input type="checkbox" id="email-notifications" checked>
                    Email Notifications
                </label>
            </div>
            
            <div class="setting-item">
                <label>
                    <input type="checkbox" id="weekly-reports" checked>
                    Weekly Summary Reports
                </label>
            </div>
            
            <div class="setting-item">
                <label>
                    <input type="checkbox" id="spam-alerts">
                    Spam Detection Alerts
                </label>
            </div>
        </div>
    </div>

    <div class="settings-actions">
        <button id="save-settings" class="btn btn-primary">
            <i class="fas fa-save"></i> Save Settings
        </button>
        <button id="reset-settings" class="btn btn-secondary">
            <i class="fas fa-undo"></i> Reset to Defaults
        </button>
        <button id="export-data" class="btn btn-outline">
            <i class="fas fa-download"></i> Export My Data
        </button>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    loadSettings();
    
    document.getElementById('save-settings').addEventListener('click', saveSettings);
    document.getElementById('reset-settings').addEventListener('click', resetSettings);
    document.getElementById('ai-mode-toggle').addEventListener('change', toggleAIMode);
});

async function loadSettings() {
    try {
        const response = await fetch('/api/ai-mode/status');
        const data = await response.json();
        
        document.getElementById('ai-mode-toggle').checked = data.ai_mode_active;
        document.getElementById('ai-status').textContent = data.ai_mode_active ? 'Enabled' : 'Disabled';
        document.getElementById('spam-sensitivity').value = data.spam_sensitivity || 'medium';
        document.getElementById('call-recording').checked = data.recording_enabled;
    } catch (error) {
        console.error('Error loading settings:', error);
    }
}

async function saveSettings() {
    const settings = {
        spam_sensitivity: document.getElementById('spam-sensitivity').value,
        recording_enabled: document.getElementById('call-recording').checked,
        voice_cloning_enabled: document.getElementById('voice-cloning-enabled').checked,
        // Add other settings as needed
    };
    
    try {
        const response = await fetch('/api/settings/update', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(settings)
        });
        
        if (response.ok) {
            showNotification('Settings saved successfully', 'success');
        }
    } catch (error) {
        showNotification('Error saving settings', 'error');
    }
}

async function toggleAIMode() {
    const duration = document.getElementById('ai-duration').value;
    const data = duration ? { duration_minutes: parseInt(duration) } : {};
    
    try {
        const response = await fetch('/api/ai-mode/toggle', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        document.getElementById('ai-status').textContent = result.ai_mode_active ? 'Enabled' : 'Disabled';
    } catch (error) {
        console.error('Error toggling AI mode:', error);
    }
}
</script>
{% endblock %}
