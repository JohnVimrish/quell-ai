var ni=d=>{throw TypeError(d)};var gs=(d,t,e)=>t.has(d)||ni("Cannot "+e);var rt=(d,t,e)=>(gs(d,t,"read from private field"),e?e.call(d):t.get(d)),Ut=(d,t,e)=>t.has(d)?ni("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(d):t.set(d,e),Rt=(d,t,e,s)=>(gs(d,t,"write to private field"),s?s.call(d,e):t.set(d,e),e),zt=(d,t,e)=>(gs(d,t,"access private method"),e);var ri=(d,t,e,s)=>({set _(i){Rt(d,t,i,e)},get _(){return rt(d,t,s)}});import{r as et,j as C,u as mn,N as bn}from"./main-DdieF_OH.js";import{e as yn,F as wn}from"./publicTheme-C4hke2-P.js";var ms={exports:{}},ai;function vn(){return ai||(ai=1,(function(d,t){(function(e,s){d.exports=s()})(self,(()=>(()=>{var e={194:r=>{function a(p){let b=document.createElement(p.tag);return o(b),b.attr(p.attr),b.add(p.children),b}function o(p){if(p)return p.c||(p.c=function(){return arguments.length===1&&typeof arguments[0]=="string"?p.innerHTML=arguments[0]:(p.innerHTML="",arguments.length&&u(p,Array.prototype.slice.call(arguments))),p}),p.attr=b=>c(p,b),p.add=b=>u(p,b),p.rm=b=>p.removeChild(b),p.addClass=b=>(function(g,v){if(g.classList&&g.classList.add)return g.classList.add(v);const y=g.getAttribute("class");y?g.setAttribute("class",`${y} ${v}`):g.setAttribute("class",v)})(p,b),p.rmClass=b=>(function(g,v){if(g.classList&&g.classList.remove)return g.classList.remove(v);const y=g.getAttribute("class");if(!y)return;const S=y.split(" ").filter((A=>A!==v)).join(" ");g.setAttribute("class",S)})(p,b),p}function l(p,b,g,v){const y={tag:null,attr:{},children:[]};return S(b),S(g),S(v),y;function S(A){if(!y.tag){if(!A)return void(y.tag=p);if(typeof A=="string")return void(y.tag=A);y.tag=p}A&&(Array.isArray(A)||f(A)||typeof A=="string"||typeof A=="number"?y.children=y.children.concat(A):y.attr=Object.assign(y.attr,A))}}function h(p,b,g){g.class&&g.classes?g.class+=" "+g.classes:g.classes?g.class=g.classes:g.class||(g.class=""),delete g.classes;let v=(b=b.replace(/#/g,".#")).split(".");(b=v.shift())||(b=p);for(let y=0;y<v.length;y++)v[y][0]=="#"?g.id||(g.id=v[y].substring(1)):g.class+=" "+v[y];return g.class||delete g.class,b}function c(p,b){if(b)for(let g in b)if(g==="class"||g==="classes"){if(b[g]){const v=p.getAttribute("class");let y=b[g].trim().split(/[ \t]+/g).join(" ");v&&(y+=" "+v),p.setAttribute("class",y)}}else if(g==="style"){let v=b[g];if(typeof v=="string")p.style.cssText=v;else for(let y in v)p.style.setProperty(y,v[y])}else g.startsWith("on")?p.addEventListener(g.substring(2).toLowerCase(),b[g]):b[g]===!1?p.removeAttribute(g):b[g]?p.setAttribute(g,b[g]):p.setAttribute(g,"")}function u(p,b){if(b){Array.isArray(b)||(b=[b]);for(let g=0;g<b.length;g++){let v=b[g];v&&(Array.isArray(v)?u(p,v):(f(v)||(v=document.createTextNode(v)),p.appendChild(v)))}}}function f(p){return p&&p.nodeName&&p.nodeType}function m(p,b){let g=l("div",p,b);return g.tag=h("div",g.tag,g.attr),(v,y,S)=>{let A=l("div",v,y,S);return A.tag=h("div",A.tag,A.attr),g.attr.class&&A.attr.class&&(A.attr.class=g.attr.class+" "+A.attr.class),g.attr.style&&A.attr.style&&typeof g.attr.style==typeof A.attr.style&&(typeof g.attr.style=="string"?A.attr.style=g.attr.style+";"+A.attr.style:A.attr.style=Object.assign({},g.attr.style,A.attr.style)),A.attr=Object.assign({},g.attr,A.attr),a(A)}}r.exports={h:function(p,b,g){let v=l("div",p,b,g);return v.tag=h("div",v.tag,v.attr),a(v)},wrap:o,getH:function(p,b){return p instanceof Element?o(p):(b||(b=document),b.contentDocument&&(b=b.contentDocument),o(b.getElementById(p)))},x:m,div:m("div"),svg:function(p,b,g){let v,y=l("svg",p,b,g);if(y.tag=h("svg",y.tag,y.attr),y.tag[0]=="<"){v=document.createElementNS("http://www.w3.org/2000/svg","svg"),v.innerHTML=p;const S=v.getElementsByTagName("svg")[0];S&&(v=S)}else v=document.createElementNS("http://www.w3.org/2000/svg",y.tag),c(v,y.attr),u(v,y.children);return o(v),v}}},187:r=>{var a,o=typeof Reflect=="object"?Reflect:null,l=o&&typeof o.apply=="function"?o.apply:function(w,_,x){return Function.prototype.apply.call(w,_,x)};a=o&&typeof o.ownKeys=="function"?o.ownKeys:Object.getOwnPropertySymbols?function(w){return Object.getOwnPropertyNames(w).concat(Object.getOwnPropertySymbols(w))}:function(w){return Object.getOwnPropertyNames(w)};var h=Number.isNaN||function(w){return w!=w};function c(){c.init.call(this)}r.exports=c,r.exports.once=function(w,_){return new Promise((function(x,E){function k(P){w.removeListener(_,T),E(P)}function T(){typeof w.removeListener=="function"&&w.removeListener("error",k),x([].slice.call(arguments))}A(w,_,T,{once:!0}),_!=="error"&&(function(P,M,I){typeof P.on=="function"&&A(P,"error",M,{once:!0})})(w,k)}))},c.EventEmitter=c,c.prototype._events=void 0,c.prototype._eventsCount=0,c.prototype._maxListeners=void 0;var u=10;function f(w){if(typeof w!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof w)}function m(w){return w._maxListeners===void 0?c.defaultMaxListeners:w._maxListeners}function p(w,_,x,E){var k,T,P,M;if(f(x),(T=w._events)===void 0?(T=w._events=Object.create(null),w._eventsCount=0):(T.newListener!==void 0&&(w.emit("newListener",_,x.listener?x.listener:x),T=w._events),P=T[_]),P===void 0)P=T[_]=x,++w._eventsCount;else if(typeof P=="function"?P=T[_]=E?[x,P]:[P,x]:E?P.unshift(x):P.push(x),(k=m(w))>0&&P.length>k&&!P.warned){P.warned=!0;var I=new Error("Possible EventEmitter memory leak detected. "+P.length+" "+String(_)+" listeners added. Use emitter.setMaxListeners() to increase limit");I.name="MaxListenersExceededWarning",I.emitter=w,I.type=_,I.count=P.length,M=I,console&&console.warn&&console.warn(M)}return w}function b(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function g(w,_,x){var E={fired:!1,wrapFn:void 0,target:w,type:_,listener:x},k=b.bind(E);return k.listener=x,E.wrapFn=k,k}function v(w,_,x){var E=w._events;if(E===void 0)return[];var k=E[_];return k===void 0?[]:typeof k=="function"?x?[k.listener||k]:[k]:x?(function(T){for(var P=new Array(T.length),M=0;M<P.length;++M)P[M]=T[M].listener||T[M];return P})(k):S(k,k.length)}function y(w){var _=this._events;if(_!==void 0){var x=_[w];if(typeof x=="function")return 1;if(x!==void 0)return x.length}return 0}function S(w,_){for(var x=new Array(_),E=0;E<_;++E)x[E]=w[E];return x}function A(w,_,x,E){if(typeof w.on=="function")E.once?w.once(_,x):w.on(_,x);else{if(typeof w.addEventListener!="function")throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof w);w.addEventListener(_,(function k(T){E.once&&w.removeEventListener(_,k),x(T)}))}}Object.defineProperty(c,"defaultMaxListeners",{enumerable:!0,get:function(){return u},set:function(w){if(typeof w!="number"||w<0||h(w))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+w+".");u=w}}),c.init=function(){this._events!==void 0&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},c.prototype.setMaxListeners=function(w){if(typeof w!="number"||w<0||h(w))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+w+".");return this._maxListeners=w,this},c.prototype.getMaxListeners=function(){return m(this)},c.prototype.emit=function(w){for(var _=[],x=1;x<arguments.length;x++)_.push(arguments[x]);var E=w==="error",k=this._events;if(k!==void 0)E=E&&k.error===void 0;else if(!E)return!1;if(E){var T;if(_.length>0&&(T=_[0]),T instanceof Error)throw T;var P=new Error("Unhandled error."+(T?" ("+T.message+")":""));throw P.context=T,P}var M=k[w];if(M===void 0)return!1;if(typeof M=="function")l(M,this,_);else{var I=M.length,R=S(M,I);for(x=0;x<I;++x)l(R[x],this,_)}return!0},c.prototype.addListener=function(w,_){return p(this,w,_,!1)},c.prototype.on=c.prototype.addListener,c.prototype.prependListener=function(w,_){return p(this,w,_,!0)},c.prototype.once=function(w,_){return f(_),this.on(w,g(this,w,_)),this},c.prototype.prependOnceListener=function(w,_){return f(_),this.prependListener(w,g(this,w,_)),this},c.prototype.removeListener=function(w,_){var x,E,k,T,P;if(f(_),(E=this._events)===void 0)return this;if((x=E[w])===void 0)return this;if(x===_||x.listener===_)--this._eventsCount==0?this._events=Object.create(null):(delete E[w],E.removeListener&&this.emit("removeListener",w,x.listener||_));else if(typeof x!="function"){for(k=-1,T=x.length-1;T>=0;T--)if(x[T]===_||x[T].listener===_){P=x[T].listener,k=T;break}if(k<0)return this;k===0?x.shift():(function(M,I){for(;I+1<M.length;I++)M[I]=M[I+1];M.pop()})(x,k),x.length===1&&(E[w]=x[0]),E.removeListener!==void 0&&this.emit("removeListener",w,P||_)}return this},c.prototype.off=c.prototype.removeListener,c.prototype.removeAllListeners=function(w){var _,x,E;if((x=this._events)===void 0)return this;if(x.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):x[w]!==void 0&&(--this._eventsCount==0?this._events=Object.create(null):delete x[w]),this;if(arguments.length===0){var k,T=Object.keys(x);for(E=0;E<T.length;++E)(k=T[E])!=="removeListener"&&this.removeAllListeners(k);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(typeof(_=x[w])=="function")this.removeListener(w,_);else if(_!==void 0)for(E=_.length-1;E>=0;E--)this.removeListener(w,_[E]);return this},c.prototype.listeners=function(w){return v(this,w,!0)},c.prototype.rawListeners=function(w){return v(this,w,!1)},c.listenerCount=function(w,_){return typeof w.listenerCount=="function"?w.listenerCount(_):y.call(w,_)},c.prototype.listenerCount=y,c.prototype.eventNames=function(){return this._eventsCount>0?a(this._events):[]}}},s={};function i(r){var a=s[r];if(a!==void 0)return a.exports;var o=s[r]={exports:{}};return e[r](o,o.exports,i),o.exports}i.d=(r,a)=>{for(var o in a)i.o(a,o)&&!i.o(r,o)&&Object.defineProperty(r,o,{enumerable:!0,get:a[o]})},i.o=(r,a)=>Object.prototype.hasOwnProperty.call(r,a),i.r=r=>{typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(r,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(r,"__esModule",{value:!0})};var n={};return(()=>{i.r(n),i.d(n,{init:()=>v});var r=i(194),a=i(187);class o extends a{}const l=window.devicePixelRatio||1;function h(y,S){const A=new o;A.page_count=y.book.numPages(),(function(w,_){const x={e:(0,r.h)("canvas")};x.ctx=x.e.getContext("2d"),x.e.width=Math.floor(w.sz.boxw*l),x.e.height=Math.floor(w.sz.boxh*l),x.e.style.width=Math.floor(w.sz.boxw)+"px",x.e.style.height=Math.floor(w.sz.boxh)+"px",w.canvas=x,_()})(y,(w=>{if(w)return S(w);(function(_,x){const E=_.sz.boxw*l,k=_.sz.boxh*l;_.book.getPage(1,((T,P)=>{if(T)return x(T);const M=1-_.sz.marginTop/100;let I=k*M;const R=1-_.sz.marginLeft/100;let D=2*P.width*(I/P.height);const O=E*R;D>O&&(D=O,I=P.height*(D/(2*P.width))),_.layout={top:(k-I)/2,left:(E-D)/2,mid:E/2,width:D,height:I},x()}))})(y,(_=>{if(_)return S(_);y.app.c(y.canvas.e),(function(x,E){const k=[c(x,E)],T={};["onmouseenter","onmouseleave","onmousemove","onclick","onmousedown","onmouseup"].map((P=>{T[P]=M=>{k.map((I=>{I[P]&&I[P](M)}))}})),x.app.attr(T)})(y,A),y.zoom=0,y.showNdx=0,(function(x,E){function k(T){p({draw:P=>{T.flipFrac=P.flipFrac,(function(M,I){m(M,I);const R=M.canvas,D=2*M.flipNdx,O=D+1,N=f(M),H=.5-Math.abs(.5-M.flipFrac);function q(Y,z){R.ctx.fillStyle=Y;const J=M.sz.bx_border;R.ctx.fillRect(z.left-J,z.top-J-5,z.width+2*J,z.height+2*J+10)}function ct(Y,z){const J=Y.sz.bx_border;return{left:z.left-J,top:z.top-J,width:z.width+2*J,height:z.height+2*J}}R.ctx.save(),M.book.getPage(D,((Y,z)=>{if(Y)return console.error(Y);M.book.getPage(O,((J,Et)=>{if(J)return console.error(J);(function(ft,Z,wt,Xt){let L,$,it,X,mt,dt,tt,Ct,St;if(M.showNdx<M.flipNdx){L=Object.assign({},N),L.width/=2,L.left=N.mid,$=L.left+(1-wt)*L.width,it=L.width*wt,mt=ct(M,L),R.ctx.save(),X=new Path2D,X.rect($,mt.top-5,it,mt.height+10),R.ctx.clip(X),Z?R.ctx.drawImage(Z.img,L.left,L.top,L.width,L.height):q(M.color.bg,mt),R.ctx.restore(),L=Object.assign({},N),L.left+=(1-wt)*L.width,L.width/=2,it=L.width*wt,dt=L.height,tt=L.top,L.height*=1+.1*H,L.top-=(L.height-dt)/2,R.ctx.save(),X=new Path2D,X.moveTo(L.left,tt),X.lineTo(L.left,tt+dt),Ct={x:L.left+it/2,y:L.top+L.height},St={x:L.left+it,y:tt+dt},X.quadraticCurveTo(Ct.x,Ct.y,St.x,St.y),X.lineTo(St.x,tt),Ct={x:L.left+it,y:L.top},St={x:L.left,y:tt},X.quadraticCurveTo(Ct.x,Ct.y,St.x,St.y),R.ctx.clip(X),R.ctx.drawImage(ft.img,L.left,L.top,L.width,L.height),R.ctx.restore(),R.ctx.save();const ie=L.width/2*Math.max(Math.min(H,.5),0);R.ctx.strokeStyle="rgba(0,0,0,"+.1*H+")",R.ctx.lineWidth=30*H,R.ctx.beginPath(),R.ctx.moveTo(L.left,tt),R.ctx.lineTo(L.left,tt+dt),R.ctx.stroke();let bt=R.ctx.createLinearGradient(L.left+it,tt,L.left+it+ie,tt);bt.addColorStop(0,"rgba(0,0,0,"+.3*H+")"),bt.addColorStop(.8,"rgba(0,0,0,0.0)"),R.ctx.fillStyle=bt,R.ctx.fillRect(L.left+it,tt,it+ie,dt),R.ctx.restore()}else{L=Object.assign({},N),L.width/=2,it=L.width*wt+M.sz.bx_border,mt=ct(M,L),R.ctx.save(),X=new Path2D,X.rect(mt.left,mt.top-5,it,mt.height+10),R.ctx.clip(X),ft?R.ctx.drawImage(ft.img,L.left,L.top,L.width,L.height):q(M.color.bg,L),R.ctx.restore(),L=Object.assign({},N),L.width/=2,$=L.left+wt*L.width,L.left=$-(1-wt)*L.width,it=L.width*wt,dt=L.height,tt=L.top,L.height*=1+.1*H,L.top-=(L.height-dt)/2,R.ctx.save(),X=new Path2D,X.moveTo($,tt),X.lineTo($,tt+dt),Ct={x:$+it/2,y:L.top+L.height},St={x:$+it,y:tt+dt},X.quadraticCurveTo(Ct.x,Ct.y,St.x,St.y),X.lineTo(St.x,tt),Ct={x:$+it,y:L.top},St={x:$,y:tt},X.quadraticCurveTo(Ct.x,Ct.y,St.x,St.y),R.ctx.clip(X),R.ctx.drawImage(Z.img,L.left,L.top,L.width,L.height),R.ctx.restore(),R.ctx.save();const ie=L.width/2*Math.max(Math.min(H,.5),0);R.ctx.strokeStyle="rgba(0,0,0,"+.1*H+")",R.ctx.lineWidth=30*H,R.ctx.beginPath(),R.ctx.moveTo($+it,tt),R.ctx.lineTo($+it,tt+dt),R.ctx.stroke();let bt=R.ctx.createLinearGradient($,tt,$-ie,tt);bt.addColorStop(0,"rgba(0,0,0,"+.3*H+")"),bt.addColorStop(.8,"rgba(0,0,0,0.0)"),R.ctx.fillStyle=bt,R.ctx.fillRect($-ie,tt,ie,dt),R.ctx.restore()}Xt()})(z,Et,M.flipFrac,(()=>R.ctx.restore()))}))}))})(T,E)},duration:1111,from:{flipFrac:0},to:{flipFrac:1},timing:P=>P*P*(3-2*P),ondone:()=>{T.showNdx=T.flipNdx,T.flipNdx=null,m(T,E)}})}E.zoom=T=>{T=Number(T),isNaN(T)&&(T=2*x.zoom+1)>4&&(T=0),T?p({draw:P=>{x.zoom=P.zoom,m(x,E)},duration:500,from:{zoom:x.zoom},to:{zoom:T},timing:P=>P*P*(3-2*P)}):(x.zoom=0,x.pan=null,m(x,E))},E.flip_forward=()=>{x.flipNdx||x.flipNdx===0||x.book.numPages()<=1||2*x.showNdx+1>=x.book.numPages()||(x.flipNdx=x.showNdx+1,k(x))},E.flip_back=()=>{x.flipNdx||x.flipNdx===0||x.book.numPages()<=1||x.showNdx&&(x.flipNdx=x.showNdx-1,k(x))}})(y,A),S(null,A),m(y,A)}))}))}function c(y,S){let A;return{onmouseleave:function(w){A=null},onmousedown:function(w){y.zoom&&(A=u(y,w),y.pan&&(A.x-=y.pan.x,A.y-=y.pan.y))},onmouseup:function(w){A=null},onmousemove:function(w){const _=u(y,w);A&&(function(x,E){const k=(function(T){const P=f(T);return{top:P.top,left:P.left,bottom:P.top+P.height,right:P.left+P.width}})(x);return k.top<=E.y&&k.bottom>=E.y&&k.left<=E.x&&k.right>=E.x})(y,_)?(y.pan={x:_.x-A.x,y:_.y-A.y},m(y,S)):A=null}}}function u(y,S){const A=y.app.getBoundingClientRect();return{x:S.clientX-A.x,y:S.clientY-A.y}}function f(y){let S=y.layout;if(y.zoom>0){if(S=Object.assign({},S),y.zoom){const A=.5*y.zoom;S.left=S.left-S.width*A/2,S.top=S.top-S.height*A/2,S.width=S.width*(1+A),S.height=S.height*(1+A)}y.pan&&(S.left+=y.pan.x,S.top+=y.pan.y,S.mid+=y.pan.x)}return S}function m(y,S){const A=y.canvas,w=2*y.showNdx,_=w+1;function x(E,k){A.ctx.drawImage(E.img,k.left,k.top,k.width,k.height)}A.ctx.save(),A.ctx.fillStyle=y.color.bg,A.ctx.fillRect(0,0,y.sz.boxw*l,y.sz.boxh*l),y.book.getPage(w,((E,k)=>{if(E)return console.error(E);!y.flipNdx&&y.flipNdx!==0&&k&&S.emit("seen",w),y.book.getPage(_,((T,P)=>{if(T)return console.error(T);!y.flipNdx&&y.flipNdx!==0&&P&&S.emit("seen",_),(function(M,I,R){const D=f(y);y.zoom==0&&(function(H){A.ctx.fillStyle=y.color.bx;const q=y.sz.bx_border;A.ctx.fillRect(H.left-q,H.top-q,H.width+2*q,H.height+2*q)})(D);const O=Object.assign({},D),N=Object.assign({},D);O.width/=2,N.width/=2,N.left=D.mid,M&&x(M,O),I&&x(I,N),A.ctx.restore()})(k,P)}))}))}function p({draw:y,duration:S,from:A,to:w,timing:_,ondone:x}){x||(x=()=>1),_||(_=k=>k);const E=Date.now();(function k(){let T=(Date.now()-E)/S;T>1&&(T=1);const P=(function(M){M=_(M);const I=Object.assign({},A);for(let R in A){const D=Number(A[R]),O=Number(w[R]);I[R]=D+(O-D)*M}return I})(T);y(P),T===1?x():requestAnimationFrame(k)})()}class b extends a{}const g=y=>(0,r.h)(`canvas#flipbook__pgnum_${y}.flipbook__page`);function v(y,S,A,w){typeof A=="function"&&(w=A,A={}),A||(A={}),w||(w=()=>1);const _=(0,r.getH)(S);if(!_){const E="flipbook-viewer: Failed to find container for viewer: "+S;return console.error(E),void w(E)}if(A.singlepage)(function(E,k){const T=new b;T.page_count=E.book.numPages(),(function(P,M){const I=g(0);P.app.c(I),setTimeout((()=>{P.page_width=I.getBoundingClientRect().width,P.app.rm(I),M()}))})(E,(P=>{if(P)return k(P);(function(M,I){const R=window.devicePixelRatio||1,D=M.book.pdf;M.pages=[],(function O(N){if(N>=D.numPages)return I();const H=N+1;D.getPage(H).then((q=>{const ct=q.getViewport({scale:1}),Y=M.page_width/ct.width,z=q.getViewport({scale:Y}),J=g(H);J.attr({"data-flipbook-page":H}),J.width=Math.floor(z.width*R),J.height=Math.floor(z.height*R),J.style.width=Math.floor(z.width)+"px",J.style.height=Math.floor(z.height)+"px",M.pages.push(J),M.app.add(J);const Et=R!==1?[R,0,0,R,0,0]:null,ft={canvasContext:J.getContext("2d"),transform:Et,viewport:z};q.render(ft).promise.then((()=>O(N+1))).catch((Z=>I(Z||"Failed rendering page"+H)))})).catch((q=>I(q||"Failed getting page:"+H)))})(0)})(E,(M=>{if(M)return k(M);k(null,T),(function(I,R){const D={},O=new IntersectionObserver((function(N){N.forEach((H=>{if(H.intersectionRatio)try{const q=H.target.dataset.flipbookPage;if(D[q])return;D[q]=!0,R.emit("seen",q)}catch(q){console.error(q)}}))}),{root:null,rootMargin:"0px",threshold:.25});I.pages.forEach((N=>O.observe(N)))})(E,T)}))}))})({app:_,book:y},x);else{const E={color:{bg:A.backgroundColor||"#353535"},sz:{bx_border:A.boxBorder||0,boxw:A.width||800,boxh:A.height||600},app:_,book:y},k=A.margin||1;A.marginTop||A.marginTop===0?E.sz.marginTop=A.marginTop:E.sz.marginTop=k,A.marginLeft||A.marginLeft===0?E.sz.marginLeft=A.marginLeft:E.sz.marginLeft=k,h(E,x)}function x(E,k){return A.popup&&history.pushState({},"","#"),k&&(k.version="1.6.1"),w(E,k)}}})(),n})()))})(ms)),ms.exports}var An=vn();const kt=typeof process=="object"&&process+""=="[object process]"&&!process.versions.nw&&!(process.versions.electron&&process.type&&process.type!=="browser"),Cs=[.001,0,0,.001,0,0],bs=1.35,It={ANY:1,DISPLAY:2,PRINT:4,ANNOTATIONS_FORMS:16,ANNOTATIONS_STORAGE:32,ANNOTATIONS_DISABLE:64,IS_EDITING:128,OPLIST:256},Zt={DISABLE:0,ENABLE:1,ENABLE_FORMS:2,ENABLE_STORAGE:3},De="pdfjs_internal_editor_",V={DISABLE:-1,NONE:0,FREETEXT:3,HIGHLIGHT:9,STAMP:13,INK:15,POPUP:16,SIGNATURE:101,COMMENT:102},K={RESIZE:1,CREATE:2,FREETEXT_SIZE:11,FREETEXT_COLOR:12,FREETEXT_OPACITY:13,INK_COLOR:21,INK_THICKNESS:22,INK_OPACITY:23,HIGHLIGHT_COLOR:31,HIGHLIGHT_THICKNESS:32,HIGHLIGHT_FREE:33,HIGHLIGHT_SHOW_ALL:34,DRAW_STEP:41},xn={PRINT:4,MODIFY_CONTENTS:8,COPY:16,MODIFY_ANNOTATIONS:32,FILL_INTERACTIVE_FORMS:256,COPY_FOR_ACCESSIBILITY:512,ASSEMBLE:1024,PRINT_HIGH_QUALITY:2048},vt={FILL:0,STROKE:1,FILL_STROKE:2,INVISIBLE:3,FILL_STROKE_MASK:3,ADD_TO_PATH_FLAG:4},es={GRAYSCALE_1BPP:1,RGB_24BPP:2,RGBA_32BPP:3},gt={TEXT:1,LINK:2,FREETEXT:3,LINE:4,SQUARE:5,CIRCLE:6,POLYGON:7,POLYLINE:8,HIGHLIGHT:9,UNDERLINE:10,SQUIGGLY:11,STRIKEOUT:12,STAMP:13,CARET:14,INK:15,POPUP:16,FILEATTACHMENT:17,SOUND:18,MOVIE:19,WIDGET:20,SCREEN:21,PRINTERMARK:22,TRAPNET:23,WATERMARK:24,THREED:25,REDACT:26},pe={SOLID:1,DASHED:2,BEVELED:3,INSET:4,UNDERLINE:5},ls={ERRORS:0,WARNINGS:1,INFOS:5},Ie={dependency:1,setLineWidth:2,setLineCap:3,setLineJoin:4,setMiterLimit:5,setDash:6,setRenderingIntent:7,setFlatness:8,setGState:9,save:10,restore:11,transform:12,moveTo:13,lineTo:14,curveTo:15,curveTo2:16,curveTo3:17,closePath:18,rectangle:19,stroke:20,closeStroke:21,fill:22,eoFill:23,fillStroke:24,eoFillStroke:25,closeFillStroke:26,closeEOFillStroke:27,endPath:28,clip:29,eoClip:30,beginText:31,endText:32,setCharSpacing:33,setWordSpacing:34,setHScale:35,setLeading:36,setFont:37,setTextRenderingMode:38,setTextRise:39,moveText:40,setLeadingMoveText:41,setTextMatrix:42,nextLine:43,showText:44,showSpacedText:45,nextLineShowText:46,nextLineSetSpacingShowText:47,setCharWidth:48,setCharWidthAndBounds:49,setStrokeColorSpace:50,setFillColorSpace:51,setStrokeColor:52,setStrokeColorN:53,setFillColor:54,setFillColorN:55,setStrokeGray:56,setFillGray:57,setStrokeRGBColor:58,setFillRGBColor:59,setStrokeCMYKColor:60,setFillCMYKColor:61,shadingFill:62,beginInlineImage:63,beginImageData:64,endInlineImage:65,paintXObject:66,markPoint:67,markPointProps:68,beginMarkedContent:69,beginMarkedContentProps:70,endMarkedContent:71,beginCompat:72,endCompat:73,paintFormXObjectBegin:74,paintFormXObjectEnd:75,beginGroup:76,endGroup:77,beginAnnotation:80,endAnnotation:81,paintImageMaskXObject:83,paintImageMaskXObjectGroup:84,paintImageXObject:85,paintInlineImageXObject:86,paintInlineImageXObjectGroup:87,paintImageXObjectRepeat:88,paintImageMaskXObjectRepeat:89,paintSolidColorImageMask:90,constructPath:91,setStrokeTransparent:92,setFillTransparent:93,rawFillPath:94},Ve={moveTo:0,lineTo:1,curveTo:2,closePath:3},_n={NEED_PASSWORD:1,INCORRECT_PASSWORD:2};let hs=ls.WARNINGS;function Sn(d){Number.isInteger(d)&&(hs=d)}function En(){return hs}function cs(d){hs>=ls.INFOS&&console.info(`Info: ${d}`)}function G(d){hs>=ls.WARNINGS&&console.warn(`Warning: ${d}`)}function nt(d){throw new Error(d)}function Q(d,t){d||nt(t)}function Cn(d){switch(d?.protocol){case"http:":case"https:":case"ftp:":case"mailto:":case"tel:":return!0;default:return!1}}function Ni(d,t=null,e=null){if(!d)return null;if(e&&typeof d=="string"&&(e.addDefaultProtocol&&d.startsWith("www.")&&d.match(/\./g)?.length>=2&&(d=`http://${d}`),e.tryConvertEncoding))try{d=Rn(d)}catch{}const s=t?URL.parse(d,t):URL.parse(d);return Cn(s)?s:null}function Fi(d,t,e=!1){const s=URL.parse(d);return s?(s.hash=t,s.href):e&&Ni(d,"http://example.com")?d.split("#",1)[0]+`${t?`#${t}`:""}`:""}function W(d,t,e,s=!1){return Object.defineProperty(d,t,{value:e,enumerable:!s,configurable:!0,writable:!1}),e}const ce=(function(){function t(e,s){this.message=e,this.name=s}return t.prototype=new Error,t.constructor=t,t})();class oi extends ce{constructor(t,e){super(t,"PasswordException"),this.code=e}}class ys extends ce{constructor(t,e){super(t,"UnknownErrorException"),this.details=e}}class Ts extends ce{constructor(t){super(t,"InvalidPDFException")}}class ns extends ce{constructor(t,e,s){super(t,"ResponseException"),this.status=e,this.missing=s}}class Tn extends ce{constructor(t){super(t,"FormatError")}}class ee extends ce{constructor(t){super(t,"AbortException")}}function Oi(d){(typeof d!="object"||d?.length===void 0)&&nt("Invalid argument for bytesToString");const t=d.length,e=8192;if(t<e)return String.fromCharCode.apply(null,d);const s=[];for(let i=0;i<t;i+=e){const n=Math.min(i+e,t),r=d.subarray(i,n);s.push(String.fromCharCode.apply(null,r))}return s.join("")}function Be(d){typeof d!="string"&&nt("Invalid argument for stringToBytes");const t=d.length,e=new Uint8Array(t);for(let s=0;s<t;++s)e[s]=d.charCodeAt(s)&255;return e}function kn(d){return String.fromCharCode(d>>24&255,d>>16&255,d>>8&255,d&255)}function Pn(){const d=new Uint8Array(4);return d[0]=1,new Uint32Array(d.buffer,0,1)[0]===1}function Mn(){try{return new Function(""),!0}catch{return!1}}class _t{static get isLittleEndian(){return W(this,"isLittleEndian",Pn())}static get isEvalSupported(){return W(this,"isEvalSupported",Mn())}static get isOffscreenCanvasSupported(){return W(this,"isOffscreenCanvasSupported",typeof OffscreenCanvas<"u")}static get isImageDecoderSupported(){return W(this,"isImageDecoderSupported",typeof ImageDecoder<"u")}static get platform(){const{platform:t,userAgent:e}=navigator;return W(this,"platform",{isAndroid:e.includes("Android"),isLinux:t.includes("Linux"),isMac:t.includes("Mac"),isWindows:t.includes("Win"),isFirefox:e.includes("Firefox")})}static get isCSSRoundSupported(){return W(this,"isCSSRoundSupported",globalThis.CSS?.supports?.("width: round(1.5px, 1px)"))}}const ws=Array.from(Array(256).keys(),d=>d.toString(16).padStart(2,"0"));class B{static makeHexColor(t,e,s){return`#${ws[t]}${ws[e]}${ws[s]}`}static domMatrixToTransform(t){return[t.a,t.b,t.c,t.d,t.e,t.f]}static scaleMinMax(t,e){let s;t[0]?(t[0]<0&&(s=e[0],e[0]=e[2],e[2]=s),e[0]*=t[0],e[2]*=t[0],t[3]<0&&(s=e[1],e[1]=e[3],e[3]=s),e[1]*=t[3],e[3]*=t[3]):(s=e[0],e[0]=e[1],e[1]=s,s=e[2],e[2]=e[3],e[3]=s,t[1]<0&&(s=e[1],e[1]=e[3],e[3]=s),e[1]*=t[1],e[3]*=t[1],t[2]<0&&(s=e[0],e[0]=e[2],e[2]=s),e[0]*=t[2],e[2]*=t[2]),e[0]+=t[4],e[1]+=t[5],e[2]+=t[4],e[3]+=t[5]}static transform(t,e){return[t[0]*e[0]+t[2]*e[1],t[1]*e[0]+t[3]*e[1],t[0]*e[2]+t[2]*e[3],t[1]*e[2]+t[3]*e[3],t[0]*e[4]+t[2]*e[5]+t[4],t[1]*e[4]+t[3]*e[5]+t[5]]}static multiplyByDOMMatrix(t,e){return[t[0]*e.a+t[2]*e.b,t[1]*e.a+t[3]*e.b,t[0]*e.c+t[2]*e.d,t[1]*e.c+t[3]*e.d,t[0]*e.e+t[2]*e.f+t[4],t[1]*e.e+t[3]*e.f+t[5]]}static applyTransform(t,e,s=0){const i=t[s],n=t[s+1];t[s]=i*e[0]+n*e[2]+e[4],t[s+1]=i*e[1]+n*e[3]+e[5]}static applyTransformToBezier(t,e,s=0){const i=e[0],n=e[1],r=e[2],a=e[3],o=e[4],l=e[5];for(let h=0;h<6;h+=2){const c=t[s+h],u=t[s+h+1];t[s+h]=c*i+u*r+o,t[s+h+1]=c*n+u*a+l}}static applyInverseTransform(t,e){const s=t[0],i=t[1],n=e[0]*e[3]-e[1]*e[2];t[0]=(s*e[3]-i*e[2]+e[2]*e[5]-e[4]*e[3])/n,t[1]=(-s*e[1]+i*e[0]+e[4]*e[1]-e[5]*e[0])/n}static axialAlignedBoundingBox(t,e,s){const i=e[0],n=e[1],r=e[2],a=e[3],o=e[4],l=e[5],h=t[0],c=t[1],u=t[2],f=t[3];let m=i*h+o,p=m,b=i*u+o,g=b,v=a*c+l,y=v,S=a*f+l,A=S;if(n!==0||r!==0){const w=n*h,_=n*u,x=r*c,E=r*f;m+=x,g+=x,b+=E,p+=E,v+=w,A+=w,S+=_,y+=_}s[0]=Math.min(s[0],m,b,p,g),s[1]=Math.min(s[1],v,S,y,A),s[2]=Math.max(s[2],m,b,p,g),s[3]=Math.max(s[3],v,S,y,A)}static inverseTransform(t){const e=t[0]*t[3]-t[1]*t[2];return[t[3]/e,-t[1]/e,-t[2]/e,t[0]/e,(t[2]*t[5]-t[4]*t[3])/e,(t[4]*t[1]-t[5]*t[0])/e]}static singularValueDecompose2dScale(t,e){const s=t[0],i=t[1],n=t[2],r=t[3],a=s**2+i**2,o=s*n+i*r,l=n**2+r**2,h=(a+l)/2,c=Math.sqrt(h**2-(a*l-o**2));e[0]=Math.sqrt(h+c||1),e[1]=Math.sqrt(h-c||1)}static normalizeRect(t){const e=t.slice(0);return t[0]>t[2]&&(e[0]=t[2],e[2]=t[0]),t[1]>t[3]&&(e[1]=t[3],e[3]=t[1]),e}static intersect(t,e){const s=Math.max(Math.min(t[0],t[2]),Math.min(e[0],e[2])),i=Math.min(Math.max(t[0],t[2]),Math.max(e[0],e[2]));if(s>i)return null;const n=Math.max(Math.min(t[1],t[3]),Math.min(e[1],e[3])),r=Math.min(Math.max(t[1],t[3]),Math.max(e[1],e[3]));return n>r?null:[s,n,i,r]}static pointBoundingBox(t,e,s){s[0]=Math.min(s[0],t),s[1]=Math.min(s[1],e),s[2]=Math.max(s[2],t),s[3]=Math.max(s[3],e)}static rectBoundingBox(t,e,s,i,n){n[0]=Math.min(n[0],t,s),n[1]=Math.min(n[1],e,i),n[2]=Math.max(n[2],t,s),n[3]=Math.max(n[3],e,i)}static#t(t,e,s,i,n,r,a,o,l,h){if(l<=0||l>=1)return;const c=1-l,u=l*l,f=u*l,m=c*(c*(c*t+3*l*e)+3*u*s)+f*i,p=c*(c*(c*n+3*l*r)+3*u*a)+f*o;h[0]=Math.min(h[0],m),h[1]=Math.min(h[1],p),h[2]=Math.max(h[2],m),h[3]=Math.max(h[3],p)}static#e(t,e,s,i,n,r,a,o,l,h,c,u){if(Math.abs(l)<1e-12){Math.abs(h)>=1e-12&&this.#t(t,e,s,i,n,r,a,o,-c/h,u);return}const f=h**2-4*c*l;if(f<0)return;const m=Math.sqrt(f),p=2*l;this.#t(t,e,s,i,n,r,a,o,(-h+m)/p,u),this.#t(t,e,s,i,n,r,a,o,(-h-m)/p,u)}static bezierBoundingBox(t,e,s,i,n,r,a,o,l){l[0]=Math.min(l[0],t,a),l[1]=Math.min(l[1],e,o),l[2]=Math.max(l[2],t,a),l[3]=Math.max(l[3],e,o),this.#e(t,s,n,a,e,i,r,o,3*(-t+3*(s-n)+a),6*(t-2*s+n),3*(s-t),l),this.#e(t,s,n,a,e,i,r,o,3*(-e+3*(i-r)+o),6*(e-2*i+r),3*(i-e),l)}}function Rn(d){return decodeURIComponent(escape(d))}let vs=null,li=null;function Ln(d){return vs||(vs=/([\u00a0\u00b5\u037e\u0eb3\u2000-\u200a\u202f\u2126\ufb00-\ufb04\ufb06\ufb20-\ufb36\ufb38-\ufb3c\ufb3e\ufb40-\ufb41\ufb43-\ufb44\ufb46-\ufba1\ufba4-\ufba9\ufbae-\ufbb1\ufbd3-\ufbdc\ufbde-\ufbe7\ufbea-\ufbf8\ufbfc-\ufbfd\ufc00-\ufc5d\ufc64-\ufcf1\ufcf5-\ufd3d\ufd88\ufdf4\ufdfa-\ufdfb\ufe71\ufe77\ufe79\ufe7b\ufe7d]+)|(\ufb05+)/gu,li=new Map([["ﬅ","ſt"]])),d.replaceAll(vs,(t,e,s)=>e?e.normalize("NFKC"):li.get(s))}function Bi(){if(typeof crypto.randomUUID=="function")return crypto.randomUUID();const d=new Uint8Array(32);return crypto.getRandomValues(d),Oi(d)}const js="pdfjs_internal_id_";function Dn(d,t,e){if(!Array.isArray(e)||e.length<2)return!1;const[s,i,...n]=e;if(!d(s)&&!Number.isInteger(s)||!t(i))return!1;const r=n.length;let a=!0;switch(i.name){case"XYZ":if(r<2||r>3)return!1;break;case"Fit":case"FitB":return r===0;case"FitH":case"FitBH":case"FitV":case"FitBV":if(r>1)return!1;break;case"FitR":if(r!==4)return!1;a=!1;break;default:return!1}for(const o of n)if(!(typeof o=="number"||a&&o===null))return!1;return!0}function Pt(d,t,e){return Math.min(Math.max(d,t),e)}function ji(d){return Uint8Array.prototype.toBase64?d.toBase64():btoa(Oi(d))}function In(d){return Uint8Array.fromBase64?Uint8Array.fromBase64(d):Be(atob(d))}typeof Promise.try!="function"&&(Promise.try=function(d,...t){return new Promise(e=>{e(d(...t))})});typeof Math.sumPrecise!="function"&&(Math.sumPrecise=function(d){return d.reduce((t,e)=>t+e,0)});class Ne{static textContent(t){const e=[],s={items:e,styles:Object.create(null)};function i(n){if(!n)return;let r=null;const a=n.name;if(a==="#text")r=n.value;else if(Ne.shouldBuildText(a))n?.attributes?.textContent?r=n.attributes.textContent:n.value&&(r=n.value);else return;if(r!==null&&e.push({str:r}),!!n.children)for(const o of n.children)i(o)}return i(t),s}static shouldBuildText(t){return!(t==="textarea"||t==="input"||t==="option"||t==="select")}}class Hi{static setupStorage(t,e,s,i,n){const r=i.getValue(e,{value:null});switch(s.name){case"textarea":if(r.value!==null&&(t.textContent=r.value),n==="print")break;t.addEventListener("input",a=>{i.setValue(e,{value:a.target.value})});break;case"input":if(s.attributes.type==="radio"||s.attributes.type==="checkbox"){if(r.value===s.attributes.xfaOn?t.setAttribute("checked",!0):r.value===s.attributes.xfaOff&&t.removeAttribute("checked"),n==="print")break;t.addEventListener("change",a=>{i.setValue(e,{value:a.target.checked?a.target.getAttribute("xfaOn"):a.target.getAttribute("xfaOff")})})}else{if(r.value!==null&&t.setAttribute("value",r.value),n==="print")break;t.addEventListener("input",a=>{i.setValue(e,{value:a.target.value})})}break;case"select":if(r.value!==null){t.setAttribute("value",r.value);for(const a of s.children)a.attributes.value===r.value?a.attributes.selected=!0:a.attributes.hasOwnProperty("selected")&&delete a.attributes.selected}t.addEventListener("input",a=>{const o=a.target.options,l=o.selectedIndex===-1?"":o[o.selectedIndex].value;i.setValue(e,{value:l})});break}}static setAttributes({html:t,element:e,storage:s=null,intent:i,linkService:n}){const{attributes:r}=e,a=t instanceof HTMLAnchorElement;r.type==="radio"&&(r.name=`${r.name}-${i}`);for(const[o,l]of Object.entries(r))if(l!=null)switch(o){case"class":l.length&&t.setAttribute(o,l.join(" "));break;case"dataId":break;case"id":t.setAttribute("data-element-id",l);break;case"style":Object.assign(t.style,l);break;case"textContent":t.textContent=l;break;default:(!a||o!=="href"&&o!=="newWindow")&&t.setAttribute(o,l)}a&&n.addLinkAttributes(t,r.href,r.newWindow),s&&r.dataId&&this.setupStorage(t,r.dataId,e,s)}static render(t){const e=t.annotationStorage,s=t.linkService,i=t.xfaHtml,n=t.intent||"display",r=document.createElement(i.name);i.attributes&&this.setAttributes({html:r,element:i,intent:n,linkService:s});const a=n!=="richText",o=t.div;if(o.append(r),t.viewport){const c=`matrix(${t.viewport.transform.join(",")})`;o.style.transform=c}a&&o.setAttribute("class","xfaLayer xfaFont");const l=[];if(i.children.length===0){if(i.value){const c=document.createTextNode(i.value);r.append(c),a&&Ne.shouldBuildText(i.name)&&l.push(c)}return{textDivs:l}}const h=[[i,-1,r]];for(;h.length>0;){const[c,u,f]=h.at(-1);if(u+1===c.children.length){h.pop();continue}const m=c.children[++h.at(-1)[1]];if(m===null)continue;const{name:p}=m;if(p==="#text"){const g=document.createTextNode(m.value);l.push(g),f.append(g);continue}const b=m?.attributes?.xmlns?document.createElementNS(m.attributes.xmlns,p):document.createElement(p);if(f.append(b),m.attributes&&this.setAttributes({html:b,element:m,storage:e,intent:n,linkService:s}),m.children?.length>0)h.push([m,-1,b]);else if(m.value){const g=document.createTextNode(m.value);a&&Ne.shouldBuildText(p)&&l.push(g),b.append(g)}}for(const c of o.querySelectorAll(".xfaNonInteractive input, .xfaNonInteractive textarea"))c.setAttribute("readOnly",!0);return{textDivs:l}}static update(t){const e=`matrix(${t.viewport.transform.join(",")})`;t.div.style.transform=e,t.div.hidden=!1}}const Yt="http://www.w3.org/2000/svg";class Se{static CSS=96;static PDF=72;static PDF_TO_CSS_UNITS=this.CSS/this.PDF}async function je(d,t="text"){if(Pe(d,document.baseURI)){const e=await fetch(d);if(!e.ok)throw new Error(e.statusText);switch(t){case"arraybuffer":return e.arrayBuffer();case"blob":return e.blob();case"json":return e.json()}return e.text()}return new Promise((e,s)=>{const i=new XMLHttpRequest;i.open("GET",d,!0),i.responseType=t,i.onreadystatechange=()=>{if(i.readyState===XMLHttpRequest.DONE){if(i.status===200||i.status===0){switch(t){case"arraybuffer":case"blob":case"json":e(i.response);return}e(i.responseText);return}s(new Error(i.statusText))}},i.send(null)})}class He{constructor({viewBox:t,userUnit:e,scale:s,rotation:i,offsetX:n=0,offsetY:r=0,dontFlip:a=!1}){this.viewBox=t,this.userUnit=e,this.scale=s,this.rotation=i,this.offsetX=n,this.offsetY=r,s*=e;const o=(t[2]+t[0])/2,l=(t[3]+t[1])/2;let h,c,u,f;switch(i%=360,i<0&&(i+=360),i){case 180:h=-1,c=0,u=0,f=1;break;case 90:h=0,c=1,u=1,f=0;break;case 270:h=0,c=-1,u=-1,f=0;break;case 0:h=1,c=0,u=0,f=-1;break;default:throw new Error("PageViewport: Invalid rotation, must be a multiple of 90 degrees.")}a&&(u=-u,f=-f);let m,p,b,g;h===0?(m=Math.abs(l-t[1])*s+n,p=Math.abs(o-t[0])*s+r,b=(t[3]-t[1])*s,g=(t[2]-t[0])*s):(m=Math.abs(o-t[0])*s+n,p=Math.abs(l-t[1])*s+r,b=(t[2]-t[0])*s,g=(t[3]-t[1])*s),this.transform=[h*s,c*s,u*s,f*s,m-h*s*o-u*s*l,p-c*s*o-f*s*l],this.width=b,this.height=g}get rawDims(){const t=this.viewBox;return W(this,"rawDims",{pageWidth:t[2]-t[0],pageHeight:t[3]-t[1],pageX:t[0],pageY:t[1]})}clone({scale:t=this.scale,rotation:e=this.rotation,offsetX:s=this.offsetX,offsetY:i=this.offsetY,dontFlip:n=!1}={}){return new He({viewBox:this.viewBox.slice(),userUnit:this.userUnit,scale:t,rotation:e,offsetX:s,offsetY:i,dontFlip:n})}convertToViewportPoint(t,e){const s=[t,e];return B.applyTransform(s,this.transform),s}convertToViewportRectangle(t){const e=[t[0],t[1]];B.applyTransform(e,this.transform);const s=[t[2],t[3]];return B.applyTransform(s,this.transform),[e[0],e[1],s[0],s[1]]}convertToPdfPoint(t,e){const s=[t,e];return B.applyInverseTransform(s,this.transform),s}}class Hs extends ce{constructor(t,e=0){super(t,"RenderingCancelledException"),this.extraDelay=e}}function ds(d){const t=d.length;let e=0;for(;e<t&&d[e].trim()==="";)e++;return d.substring(e,e+5).toLowerCase()==="data:"}function Us(d){return typeof d=="string"&&/\.pdf$/i.test(d)}function Nn(d){return[d]=d.split(/[#?]/,1),d.substring(d.lastIndexOf("/")+1)}function Fn(d,t="document.pdf"){if(typeof d!="string")return t;if(ds(d))return G('getPdfFilenameFromUrl: ignore "data:"-URL for performance reasons.'),t;const s=(a=>{try{return new URL(a)}catch{try{return new URL(decodeURIComponent(a))}catch{try{return new URL(a,"https://foo.bar")}catch{try{return new URL(decodeURIComponent(a),"https://foo.bar")}catch{return null}}}}})(d);if(!s)return t;const i=a=>{try{let o=decodeURIComponent(a);return o.includes("/")?(o=o.split("/").at(-1),o.test(/^\.pdf$/i)?o:a):o}catch{return a}},n=/\.pdf$/i,r=s.pathname.split("/").at(-1);if(n.test(r))return i(r);if(s.searchParams.size>0){const a=Array.from(s.searchParams.values()).reverse();for(const l of a)if(n.test(l))return i(l);const o=Array.from(s.searchParams.keys()).reverse();for(const l of o)if(n.test(l))return i(l)}if(s.hash){const o=/[^/?#=]+\.pdf\b(?!.*\.pdf\b)/i.exec(s.hash);if(o)return i(o[0])}return t}class hi{started=Object.create(null);times=[];time(t){t in this.started&&G(`Timer is already running for ${t}`),this.started[t]=Date.now()}timeEnd(t){t in this.started||G(`Timer has not been started for ${t}`),this.times.push({name:t,start:this.started[t],end:Date.now()}),delete this.started[t]}toString(){const t=[];let e=0;for(const{name:s}of this.times)e=Math.max(s.length,e);for(const{name:s,start:i,end:n}of this.times)t.push(`${s.padEnd(e)} ${n-i}ms
`);return t.join("")}}function Pe(d,t){const e=t?URL.parse(d,t):URL.parse(d);return e?.protocol==="http:"||e?.protocol==="https:"}function jt(d){d.preventDefault()}function ht(d){d.preventDefault(),d.stopPropagation()}function On(d){console.log("Deprecated API usage: "+d)}class ks{static#t;static toDateObject(t){if(t instanceof Date)return t;if(!t||typeof t!="string")return null;this.#t||=new RegExp("^D:(\\d{4})(\\d{2})?(\\d{2})?(\\d{2})?(\\d{2})?(\\d{2})?([Z|+|-])?(\\d{2})?'?(\\d{2})?'?");const e=this.#t.exec(t);if(!e)return null;const s=parseInt(e[1],10);let i=parseInt(e[2],10);i=i>=1&&i<=12?i-1:0;let n=parseInt(e[3],10);n=n>=1&&n<=31?n:1;let r=parseInt(e[4],10);r=r>=0&&r<=23?r:0;let a=parseInt(e[5],10);a=a>=0&&a<=59?a:0;let o=parseInt(e[6],10);o=o>=0&&o<=59?o:0;const l=e[7]||"Z";let h=parseInt(e[8],10);h=h>=0&&h<=23?h:0;let c=parseInt(e[9],10)||0;return c=c>=0&&c<=59?c:0,l==="-"?(r+=h,a+=c):l==="+"&&(r-=h,a-=c),new Date(Date.UTC(s,i,n,r,a,o))}}function Bn(d,{scale:t=1,rotation:e=0}){const{width:s,height:i}=d.attributes.style,n=[0,0,parseInt(s),parseInt(i)];return new He({viewBox:n,userUnit:1,scale:t,rotation:e})}function Ue(d){if(d.startsWith("#")){const t=parseInt(d.slice(1),16);return[(t&16711680)>>16,(t&65280)>>8,t&255]}return d.startsWith("rgb(")?d.slice(4,-1).split(",").map(t=>parseInt(t)):d.startsWith("rgba(")?d.slice(5,-1).split(",").map(t=>parseInt(t)).slice(0,3):(G(`Not a valid color format: "${d}"`),[0,0,0])}function jn(d){const t=document.createElement("span");t.style.visibility="hidden",t.style.colorScheme="only light",document.body.append(t);for(const e of d.keys()){t.style.color=e;const s=window.getComputedStyle(t).color;d.set(e,Ue(s))}t.remove()}function ot(d){const{a:t,b:e,c:s,d:i,e:n,f:r}=d.getTransform();return[t,e,s,i,n,r]}function $t(d){const{a:t,b:e,c:s,d:i,e:n,f:r}=d.getTransform().invertSelf();return[t,e,s,i,n,r]}function le(d,t,e=!1,s=!0){if(t instanceof He){const{pageWidth:i,pageHeight:n}=t.rawDims,{style:r}=d,a=_t.isCSSRoundSupported,o=`var(--total-scale-factor) * ${i}px`,l=`var(--total-scale-factor) * ${n}px`,h=a?`round(down, ${o}, var(--scale-round-x))`:`calc(${o})`,c=a?`round(down, ${l}, var(--scale-round-y))`:`calc(${l})`;!e||t.rotation%180===0?(r.width=h,r.height=c):(r.width=c,r.height=h)}s&&d.setAttribute("data-main-rotation",t.rotation)}class qt{constructor(){const{pixelRatio:t}=qt;this.sx=t,this.sy=t}get scaled(){return this.sx!==1||this.sy!==1}get symmetric(){return this.sx===this.sy}limitCanvas(t,e,s,i,n=-1){let r=1/0,a=1/0,o=1/0;s=qt.capPixels(s,n),s>0&&(r=Math.sqrt(s/(t*e))),i!==-1&&(a=i/t,o=i/e);const l=Math.min(r,a,o);return this.sx>l||this.sy>l?(this.sx=l,this.sy=l,!0):!1}static get pixelRatio(){return globalThis.devicePixelRatio||1}static capPixels(t,e){if(e>=0){const s=Math.ceil(window.screen.availWidth*window.screen.availHeight*this.pixelRatio**2*(1+e/100));return t>0?Math.min(t,s):s}return t}}const Ps=["image/apng","image/avif","image/bmp","image/gif","image/jpeg","image/png","image/svg+xml","image/webp","image/x-icon"];class Hn{static get isDarkMode(){return W(this,"isDarkMode",!!window?.matchMedia?.("(prefers-color-scheme: dark)").matches)}}class Un{static get commentForegroundColor(){const t=document.createElement("span");t.classList.add("comment","sidebar");const{style:e}=t;e.width=e.height="0",e.display="none",e.color="var(--comment-fg-color)",document.body.append(t);const{color:s}=window.getComputedStyle(t);return t.remove(),W(this,"commentForegroundColor",Ue(s))}}function zn(d,t,e,s){s=Math.min(Math.max(s??1,0),1);const i=255*(1-s);return d=Math.round(d*s+i),t=Math.round(t*s+i),e=Math.round(e*s+i),[d,t,e]}function ci(d,t){const e=d[0]/255,s=d[1]/255,i=d[2]/255,n=Math.max(e,s,i),r=Math.min(e,s,i),a=(n+r)/2;if(n===r)t[0]=t[1]=0;else{const o=n-r;switch(t[1]=a<.5?o/(n+r):o/(2-n-r),n){case e:t[0]=((s-i)/o+(s<i?6:0))*60;break;case s:t[0]=((i-e)/o+2)*60;break;case i:t[0]=((e-s)/o+4)*60;break}}t[2]=a}function Ms(d,t){const e=d[0],s=d[1],i=d[2],n=(1-Math.abs(2*i-1))*s,r=n*(1-Math.abs(e/60%2-1)),a=i-n/2;switch(Math.floor(e/60)){case 0:t[0]=n+a,t[1]=r+a,t[2]=a;break;case 1:t[0]=r+a,t[1]=n+a,t[2]=a;break;case 2:t[0]=a,t[1]=n+a,t[2]=r+a;break;case 3:t[0]=a,t[1]=r+a,t[2]=n+a;break;case 4:t[0]=r+a,t[1]=a,t[2]=n+a;break;case 5:case 6:t[0]=n+a,t[1]=a,t[2]=r+a;break}}function di(d){return d<=.03928?d/12.92:((d+.055)/1.055)**2.4}function ui(d,t,e){Ms(d,e),e.map(di);const s=.2126*e[0]+.7152*e[1]+.0722*e[2];Ms(t,e),e.map(di);const i=.2126*e[0]+.7152*e[1]+.0722*e[2];return s>i?(s+.05)/(i+.05):(i+.05)/(s+.05)}const fi=new Map;function $n(d,t){const e=d[0]+d[1]*256+d[2]*65536+t[0]*16777216+t[1]*4294967296+t[2]*1099511627776;let s=fi.get(e);if(s)return s;const i=new Float32Array(9),n=i.subarray(0,3),r=i.subarray(3,6);ci(d,r);const a=i.subarray(6,9);ci(t,a);const o=a[2]<.5,l=o?12:4.5;if(r[2]=o?Math.sqrt(r[2]):1-Math.sqrt(1-r[2]),ui(r,a,n)<l){let h,c;o?(h=r[2],c=1):(h=0,c=r[2]);const u=.005;for(;c-h>u;){const f=r[2]=(h+c)/2;o===ui(r,a,n)<l?h=f:c=f}r[2]=o?c:h}return Ms(r,n),s=B.makeHexColor(Math.round(n[0]*255),Math.round(n[1]*255),Math.round(n[2]*255)),fi.set(e,s),s}function Ui({html:d,dir:t,className:e},s){const i=document.createDocumentFragment();if(typeof d=="string"){const n=document.createElement("p");n.dir=t||"auto";const r=d.split(/(?:\r\n?|\n)/);for(let a=0,o=r.length;a<o;++a){const l=r[a];n.append(document.createTextNode(l)),a<o-1&&n.append(document.createElement("br"))}i.append(n)}else Hi.render({xfaHtml:d,div:i,intent:"richText"});i.firstChild.classList.add("richText",e),s.append(i)}class Le{#t=null;#e=null;#i;#s=null;#a=null;#n=null;#r=null;#o=null;static#h=null;constructor(t){this.#i=t,Le.#h||=Object.freeze({freetext:"pdfjs-editor-remove-freetext-button",highlight:"pdfjs-editor-remove-highlight-button",ink:"pdfjs-editor-remove-ink-button",stamp:"pdfjs-editor-remove-stamp-button",signature:"pdfjs-editor-remove-signature-button"})}render(){const t=this.#t=document.createElement("div");t.classList.add("editToolbar","hidden"),t.setAttribute("role","toolbar");const e=this.#i._uiManager._signal;e instanceof AbortSignal&&!e.aborted&&(t.addEventListener("contextmenu",jt,{signal:e}),t.addEventListener("pointerdown",Le.#l,{signal:e}));const s=this.#s=document.createElement("div");s.className="buttons",t.append(s);const i=this.#i.toolbarPosition;if(i){const{style:n}=t,r=this.#i._uiManager.direction==="ltr"?1-i[0]:i[0];n.insetInlineEnd=`${100*r}%`,n.top=`calc(${100*i[1]}% + var(--editor-toolbar-vert-offset))`}return t}get div(){return this.#t}static#l(t){t.stopPropagation()}#u(t){this.#i._focusEventsAllowed=!1,ht(t)}#d(t){this.#i._focusEventsAllowed=!0,ht(t)}#f(t){const e=this.#i._uiManager._signal;return!(e instanceof AbortSignal)||e.aborted?!1:(t.addEventListener("focusin",this.#u.bind(this),{capture:!0,signal:e}),t.addEventListener("focusout",this.#d.bind(this),{capture:!0,signal:e}),t.addEventListener("contextmenu",jt,{signal:e}),!0)}hide(){this.#t.classList.add("hidden"),this.#e?.hideDropdown()}show(){this.#t.classList.remove("hidden"),this.#a?.shown(),this.#n?.shown()}addDeleteButton(){const{editorType:t,_uiManager:e}=this.#i,s=document.createElement("button");s.classList.add("basic","deleteButton"),s.tabIndex=0,s.setAttribute("data-l10n-id",Le.#h[t]),this.#f(s)&&s.addEventListener("click",i=>{e.delete()},{signal:e._signal}),this.#s.append(s)}get#m(){const t=document.createElement("div");return t.className="divider",t}async addAltText(t){const e=await t.render();this.#f(e),this.#s.append(e,this.#m),this.#a=t}addComment(t,e=null){if(this.#n)return;const s=t.renderForToolbar();if(!s)return;this.#f(s);const i=this.#r=this.#m;e?(this.#s.insertBefore(s,e),this.#s.insertBefore(i,e)):this.#s.append(s,i),this.#n=t,t.toolbar=this}addColorPicker(t){if(this.#e)return;this.#e=t;const e=t.renderButton();this.#f(e),this.#s.append(e,this.#m)}async addEditSignatureButton(t){const e=this.#o=await t.renderEditButton(this.#i);this.#f(e),this.#s.append(e,this.#m)}removeButton(t){switch(t){case"comment":this.#n?.removeToolbarCommentButton(),this.#n=null,this.#r?.remove(),this.#r=null;break}}async addButton(t,e){switch(t){case"colorPicker":this.addColorPicker(e);break;case"altText":await this.addAltText(e);break;case"editSignature":await this.addEditSignatureButton(e);break;case"delete":this.addDeleteButton();break;case"comment":this.addComment(e);break}}async addButtonBefore(t,e,s){const i=this.#s.querySelector(s);i&&t==="comment"&&this.addComment(e,i)}updateEditSignatureButton(t){this.#o&&(this.#o.title=t)}remove(){this.#t.remove(),this.#e?.destroy(),this.#e=null}}class Gn{#t=null;#e=null;#i;constructor(t){this.#i=t}#s(){const t=this.#e=document.createElement("div");t.className="editToolbar",t.setAttribute("role","toolbar");const e=this.#i._signal;e instanceof AbortSignal&&!e.aborted&&t.addEventListener("contextmenu",jt,{signal:e});const s=this.#t=document.createElement("div");return s.className="buttons",t.append(s),this.#i.hasCommentManager()&&this.#n("commentButton","pdfjs-comment-floating-button","pdfjs-comment-floating-button-label",()=>{this.#i.commentSelection("floating_button")}),this.#n("highlightButton","pdfjs-highlight-floating-button1","pdfjs-highlight-floating-button-label",()=>{this.#i.highlightSelection("floating_button")}),t}#a(t,e){let s=0,i=0;for(const n of t){const r=n.y+n.height;if(r<s)continue;const a=n.x+(e?n.width:0);if(r>s){i=a,s=r;continue}e?a>i&&(i=a):a<i&&(i=a)}return[e?1-i:i,s]}show(t,e,s){const[i,n]=this.#a(e,s),{style:r}=this.#e||=this.#s();t.append(this.#e),r.insetInlineEnd=`${100*i}%`,r.top=`calc(${100*n}% + var(--editor-toolbar-vert-offset))`}hide(){this.#e.remove()}#n(t,e,s,i){const n=document.createElement("button");n.classList.add("basic",t),n.tabIndex=0,n.setAttribute("data-l10n-id",e);const r=document.createElement("span");n.append(r),r.className="visuallyHidden",r.setAttribute("data-l10n-id",s);const a=this.#i._signal;a instanceof AbortSignal&&!a.aborted&&(n.addEventListener("contextmenu",jt,{signal:a}),n.addEventListener("click",i,{signal:a})),this.#t.append(n)}}function zi(d,t,e){for(const s of e)t.addEventListener(s,d[s].bind(d))}class Vn{#t=0;get id(){return`${De}${this.#t++}`}}class zs{#t=Bi();#e=0;#i=null;static get _isSVGFittingCanvas(){const t='data:image/svg+xml;charset=UTF-8,<svg viewBox="0 0 1 1" width="1" height="1" xmlns="http://www.w3.org/2000/svg"><rect width="1" height="1" style="fill:red;"/></svg>',s=new OffscreenCanvas(1,3).getContext("2d",{willReadFrequently:!0}),i=new Image;i.src=t;const n=i.decode().then(()=>(s.drawImage(i,0,0,1,1,0,0,1,3),new Uint32Array(s.getImageData(0,0,1,1).data.buffer)[0]===0));return W(this,"_isSVGFittingCanvas",n)}async#s(t,e){this.#i||=new Map;let s=this.#i.get(t);if(s===null)return null;if(s?.bitmap)return s.refCounter+=1,s;try{s||={bitmap:null,id:`image_${this.#t}_${this.#e++}`,refCounter:0,isSvg:!1};let i;if(typeof e=="string"?(s.url=e,i=await je(e,"blob")):e instanceof File?i=s.file=e:e instanceof Blob&&(i=e),i.type==="image/svg+xml"){const n=zs._isSVGFittingCanvas,r=new FileReader,a=new Image,o=new Promise((l,h)=>{a.onload=()=>{s.bitmap=a,s.isSvg=!0,l()},r.onload=async()=>{const c=s.svgUrl=r.result;a.src=await n?`${c}#svgView(preserveAspectRatio(none))`:c},a.onerror=r.onerror=h});r.readAsDataURL(i),await o}else s.bitmap=await createImageBitmap(i);s.refCounter=1}catch(i){G(i),s=null}return this.#i.set(t,s),s&&this.#i.set(s.id,s),s}async getFromFile(t){const{lastModified:e,name:s,size:i,type:n}=t;return this.#s(`${e}_${s}_${i}_${n}`,t)}async getFromUrl(t){return this.#s(t,t)}async getFromBlob(t,e){const s=await e;return this.#s(t,s)}async getFromId(t){this.#i||=new Map;const e=this.#i.get(t);if(!e)return null;if(e.bitmap)return e.refCounter+=1,e;if(e.file)return this.getFromFile(e.file);if(e.blobPromise){const{blobPromise:s}=e;return delete e.blobPromise,this.getFromBlob(e.id,s)}return this.getFromUrl(e.url)}getFromCanvas(t,e){this.#i||=new Map;let s=this.#i.get(t);if(s?.bitmap)return s.refCounter+=1,s;const i=new OffscreenCanvas(e.width,e.height);return i.getContext("2d").drawImage(e,0,0),s={bitmap:i.transferToImageBitmap(),id:`image_${this.#t}_${this.#e++}`,refCounter:1,isSvg:!1},this.#i.set(t,s),this.#i.set(s.id,s),s}getSvgUrl(t){const e=this.#i.get(t);return e?.isSvg?e.svgUrl:null}deleteId(t){this.#i||=new Map;const e=this.#i.get(t);if(!e||(e.refCounter-=1,e.refCounter!==0))return;const{bitmap:s}=e;if(!e.url&&!e.file){const i=new OffscreenCanvas(s.width,s.height);i.getContext("bitmaprenderer").transferFromImageBitmap(s),e.blobPromise=i.convertToBlob()}s.close?.(),e.bitmap=null}isValidId(t){return t.startsWith(`image_${this.#t}_`)}}class Wn{#t=[];#e=!1;#i;#s=-1;constructor(t=128){this.#i=t}add({cmd:t,undo:e,post:s,mustExec:i,type:n=NaN,overwriteIfSameType:r=!1,keepUndo:a=!1}){if(i&&t(),this.#e)return;const o={cmd:t,undo:e,post:s,type:n};if(this.#s===-1){this.#t.length>0&&(this.#t.length=0),this.#s=0,this.#t.push(o);return}if(r&&this.#t[this.#s].type===n){a&&(o.undo=this.#t[this.#s].undo),this.#t[this.#s]=o;return}const l=this.#s+1;l===this.#i?this.#t.splice(0,1):(this.#s=l,l<this.#t.length&&this.#t.splice(l)),this.#t.push(o)}undo(){if(this.#s===-1)return;this.#e=!0;const{undo:t,post:e}=this.#t[this.#s];t(),e?.(),this.#e=!1,this.#s-=1}redo(){if(this.#s<this.#t.length-1){this.#s+=1,this.#e=!0;const{cmd:t,post:e}=this.#t[this.#s];t(),e?.(),this.#e=!1}}hasSomethingToUndo(){return this.#s!==-1}hasSomethingToRedo(){return this.#s<this.#t.length-1}cleanType(t){if(this.#s!==-1){for(let e=this.#s;e>=0;e--)if(this.#t[e].type!==t){this.#t.splice(e+1,this.#s-e),this.#s=e;return}this.#t.length=0,this.#s=-1}}destroy(){this.#t=null}}class ze{constructor(t){this.buffer=[],this.callbacks=new Map,this.allKeys=new Set;const{isMac:e}=_t.platform;for(const[s,i,n={}]of t)for(const r of s){const a=r.startsWith("mac+");e&&a?(this.callbacks.set(r.slice(4),{callback:i,options:n}),this.allKeys.add(r.split("+").at(-1))):!e&&!a&&(this.callbacks.set(r,{callback:i,options:n}),this.allKeys.add(r.split("+").at(-1)))}}#t(t){t.altKey&&this.buffer.push("alt"),t.ctrlKey&&this.buffer.push("ctrl"),t.metaKey&&this.buffer.push("meta"),t.shiftKey&&this.buffer.push("shift"),this.buffer.push(t.key);const e=this.buffer.join("+");return this.buffer.length=0,e}exec(t,e){if(!this.allKeys.has(e.key))return;const s=this.callbacks.get(this.#t(e));if(!s)return;const{callback:i,options:{bubbles:n=!1,args:r=[],checker:a=null}}=s;a&&!a(t,e)||(i.bind(t,...r,e)(),n||ht(e))}}class $s{static _colorsMapping=new Map([["CanvasText",[0,0,0]],["Canvas",[255,255,255]]]);get _colors(){const t=new Map([["CanvasText",null],["Canvas",null]]);return jn(t),W(this,"_colors",t)}convert(t){const e=Ue(t);if(!window.matchMedia("(forced-colors: active)").matches)return e;for(const[s,i]of this._colors)if(i.every((n,r)=>n===e[r]))return $s._colorsMapping.get(s);return e}getHexCode(t){const e=this._colors.get(t);return e?B.makeHexColor(...e):t}}class se{#t=new AbortController;#e=null;#i=null;#s=new Map;#a=new Map;#n=null;#r=null;#o=null;#h=new Wn;#l=null;#u=null;#d=null;#f=0;#m=new Set;#p=null;#c=null;#g=new Set;_editorUndoBar=null;#b=!1;#w=!1;#y=!1;#E=null;#_=null;#v=null;#T=null;#x=!1;#S=null;#M=new Vn;#k=!1;#P=!1;#O=!1;#L=null;#I=null;#B=null;#N=null;#G=null;#C=V.NONE;#A=new Set;#D=null;#j=null;#U=null;#q=null;#W=null;#X={isEditing:!1,isEmpty:!0,hasSomethingToUndo:!1,hasSomethingToRedo:!1,hasSelectedEditor:!1,hasSelectedText:!1};#z=[0,0];#F=null;#V=null;#J=null;#Z=null;#H=null;static TRANSLATE_SMALL=1;static TRANSLATE_BIG=10;static get _keyboardManager(){const t=se.prototype,e=r=>r.#V.contains(document.activeElement)&&document.activeElement.tagName!=="BUTTON"&&r.hasSomethingToControl(),s=(r,{target:a})=>{if(a instanceof HTMLInputElement){const{type:o}=a;return o!=="text"&&o!=="number"}return!0},i=this.TRANSLATE_SMALL,n=this.TRANSLATE_BIG;return W(this,"_keyboardManager",new ze([[["ctrl+a","mac+meta+a"],t.selectAll,{checker:s}],[["ctrl+z","mac+meta+z"],t.undo,{checker:s}],[["ctrl+y","ctrl+shift+z","mac+meta+shift+z","ctrl+shift+Z","mac+meta+shift+Z"],t.redo,{checker:s}],[["Backspace","alt+Backspace","ctrl+Backspace","shift+Backspace","mac+Backspace","mac+alt+Backspace","mac+ctrl+Backspace","Delete","ctrl+Delete","shift+Delete","mac+Delete"],t.delete,{checker:s}],[["Enter","mac+Enter"],t.addNewEditorFromKeyboard,{checker:(r,{target:a})=>!(a instanceof HTMLButtonElement)&&r.#V.contains(a)&&!r.isEnterHandled}],[[" ","mac+ "],t.addNewEditorFromKeyboard,{checker:(r,{target:a})=>!(a instanceof HTMLButtonElement)&&r.#V.contains(document.activeElement)}],[["Escape","mac+Escape"],t.unselectAll],[["ArrowLeft","mac+ArrowLeft"],t.translateSelectedEditors,{args:[-i,0],checker:e}],[["ctrl+ArrowLeft","mac+shift+ArrowLeft"],t.translateSelectedEditors,{args:[-n,0],checker:e}],[["ArrowRight","mac+ArrowRight"],t.translateSelectedEditors,{args:[i,0],checker:e}],[["ctrl+ArrowRight","mac+shift+ArrowRight"],t.translateSelectedEditors,{args:[n,0],checker:e}],[["ArrowUp","mac+ArrowUp"],t.translateSelectedEditors,{args:[0,-i],checker:e}],[["ctrl+ArrowUp","mac+shift+ArrowUp"],t.translateSelectedEditors,{args:[0,-n],checker:e}],[["ArrowDown","mac+ArrowDown"],t.translateSelectedEditors,{args:[0,i],checker:e}],[["ctrl+ArrowDown","mac+shift+ArrowDown"],t.translateSelectedEditors,{args:[0,n],checker:e}]]))}constructor(t,e,s,i,n,r,a,o,l,h,c,u,f,m,p,b){const g=this._signal=this.#t.signal;this.#V=t,this.#J=e,this.#Z=s,this.#n=i,this.#l=n,this.#j=r,this.#W=o,this._eventBus=a,a._on("editingaction",this.onEditingAction.bind(this),{signal:g}),a._on("pagechanging",this.onPageChanging.bind(this),{signal:g}),a._on("scalechanging",this.onScaleChanging.bind(this),{signal:g}),a._on("rotationchanging",this.onRotationChanging.bind(this),{signal:g}),a._on("setpreference",this.onSetPreference.bind(this),{signal:g}),a._on("switchannotationeditorparams",v=>this.updateParams(v.type,v.value),{signal:g}),window.addEventListener("pointerdown",()=>{this.#P=!0},{capture:!0,signal:g}),window.addEventListener("pointerup",()=>{this.#P=!1},{capture:!0,signal:g}),this.#lt(),this.#ut(),this.#et(),this.#r=o.annotationStorage,this.#E=o.filterFactory,this.#U=l,this.#T=h||null,this.#b=c,this.#w=u,this.#y=f,this.#G=m||null,this.viewParameters={realScale:Se.PDF_TO_CSS_UNITS,rotation:0},this.isShiftKeyDown=!1,this._editorUndoBar=p||null,this._supportsPinchToZoom=b!==!1,n?.setSidebarUiManager(this)}destroy(){this.#H?.resolve(),this.#H=null,this.#t?.abort(),this.#t=null,this._signal=null;for(const t of this.#a.values())t.destroy();this.#a.clear(),this.#s.clear(),this.#g.clear(),this.#N?.clear(),this.#e=null,this.#A.clear(),this.#h.destroy(),this.#n?.destroy(),this.#l?.destroy(),this.#j?.destroy(),this.#S?.hide(),this.#S=null,this.#B?.destroy(),this.#B=null,this.#i=null,this.#_&&(clearTimeout(this.#_),this.#_=null),this.#F&&(clearTimeout(this.#F),this.#F=null),this._editorUndoBar?.destroy(),this.#W=null}combinedSignal(t){return AbortSignal.any([this._signal,t.signal])}get mlManager(){return this.#G}get useNewAltTextFlow(){return this.#w}get useNewAltTextWhenAddingImage(){return this.#y}get hcmFilter(){return W(this,"hcmFilter",this.#U?this.#E.addHCMFilter(this.#U.foreground,this.#U.background):"none")}get direction(){return W(this,"direction",getComputedStyle(this.#V).direction)}get _highlightColors(){return W(this,"_highlightColors",this.#T?new Map(this.#T.split(",").map(t=>(t=t.split("=").map(e=>e.trim()),t[1]=t[1].toUpperCase(),t))):null)}get highlightColors(){const{_highlightColors:t}=this;if(!t)return W(this,"highlightColors",null);const e=new Map,s=!!this.#U;for(const[i,n]of t){const r=i.endsWith("_HCM");if(s&&r){e.set(i.replace("_HCM",""),n);continue}!s&&!r&&e.set(i,n)}return W(this,"highlightColors",e)}get highlightColorNames(){return W(this,"highlightColorNames",this.highlightColors?new Map(Array.from(this.highlightColors,t=>t.reverse())):null)}getNonHCMColor(t){if(!this._highlightColors)return t;const e=this.highlightColorNames.get(t);return this._highlightColors.get(e)||t}getNonHCMColorName(t){return this.highlightColorNames.get(t)||t}setCurrentDrawingSession(t){t?(this.unselectAll(),this.disableUserSelect(!0)):this.disableUserSelect(!1),this.#d=t}setMainHighlightColorPicker(t){this.#B=t}editAltText(t,e=!1){this.#n?.editAltText(this,t,e)}hasCommentManager(){return!!this.#l}editComment(t,e,s,i){this.#l?.showDialog(this,t,e,s,i)}selectComment(t,e){this.#a.get(t)?.getEditorByUID(e)?.toggleComment(!0,!0)}updateComment(t){this.#l?.updateComment(t.getData())}updatePopupColor(t){this.#l?.updatePopupColor(t)}removeComment(t){this.#l?.removeComments([t.uid])}toggleComment(t,e,s=void 0){this.#l?.toggleCommentPopup(t,e,s)}makeCommentColor(t,e){return t&&this.#l?.makeCommentColor(t,e)||null}getCommentDialogElement(){return this.#l?.dialogElement||null}async waitForEditorsRendered(t){if(this.#a.has(t-1))return;const{resolve:e,promise:s}=Promise.withResolvers(),i=n=>{n.pageNumber===t&&(this._eventBus._off("editorsrendered",i),e())};this._eventBus.on("editorsrendered",i),await s}getSignature(t){this.#j?.getSignature({uiManager:this,editor:t})}get signatureManager(){return this.#j}switchToMode(t,e){this._eventBus.on("annotationeditormodechanged",e,{once:!0,signal:this._signal}),this._eventBus.dispatch("showannotationeditorui",{source:this,mode:t})}setPreference(t,e){this._eventBus.dispatch("setpreference",{source:this,name:t,value:e})}onSetPreference({name:t,value:e}){switch(t){case"enableNewAltTextWhenAddingImage":this.#y=e;break}}onPageChanging({pageNumber:t}){this.#f=t-1}focusMainContainer(){this.#V.focus()}findParent(t,e){for(const s of this.#a.values()){const{x:i,y:n,width:r,height:a}=s.div.getBoundingClientRect();if(t>=i&&t<=i+r&&e>=n&&e<=n+a)return s}return null}disableUserSelect(t=!1){this.#J.classList.toggle("noUserSelect",t)}addShouldRescale(t){this.#g.add(t)}removeShouldRescale(t){this.#g.delete(t)}onScaleChanging({scale:t}){this.commitOrRemove(),this.viewParameters.realScale=t*Se.PDF_TO_CSS_UNITS;for(const e of this.#g)e.onScaleChanging();this.#d?.onScaleChanging()}onRotationChanging({pagesRotation:t}){this.commitOrRemove(),this.viewParameters.rotation=t}#Q({anchorNode:t}){return t.nodeType===Node.TEXT_NODE?t.parentElement:t}#tt(t){const{currentLayer:e}=this;if(e.hasTextLayer(t))return e;for(const s of this.#a.values())if(s.hasTextLayer(t))return s;return null}highlightSelection(t="",e=!1){const s=document.getSelection();if(!s||s.isCollapsed)return;const{anchorNode:i,anchorOffset:n,focusNode:r,focusOffset:a}=s,o=s.toString(),h=this.#Q(s).closest(".textLayer"),c=this.getSelectionBoxes(h);if(!c)return;s.empty();const u=this.#tt(h),f=this.#C===V.NONE,m=()=>{const p=u?.createAndAddNewEditor({x:0,y:0},!1,{methodOfCreation:t,boxes:c,anchorNode:i,anchorOffset:n,focusNode:r,focusOffset:a,text:o});f&&this.showAllEditors("highlight",!0,!0),e&&p?.editComment()};if(f){this.switchToMode(V.HIGHLIGHT,m);return}m()}commentSelection(t=""){this.highlightSelection(t,!0)}#at(){const t=document.getSelection();if(!t||t.isCollapsed)return;const s=this.#Q(t).closest(".textLayer"),i=this.getSelectionBoxes(s);i&&(this.#S||=new Gn(this),this.#S.show(s,i,this.direction==="ltr"))}getAndRemoveDataFromAnnotationStorage(t){if(!this.#r)return null;const e=`${De}${t}`,s=this.#r.getRawValue(e);return s&&this.#r.remove(e),s}addToAnnotationStorage(t){!t.isEmpty()&&this.#r&&!this.#r.has(t.id)&&this.#r.setValue(t.id,t)}a11yAlert(t,e=null){const s=this.#Z;s&&(s.setAttribute("data-l10n-id",t),e?s.setAttribute("data-l10n-args",JSON.stringify(e)):s.removeAttribute("data-l10n-args"))}#ot(){const t=document.getSelection();if(!t||t.isCollapsed){this.#D&&(this.#S?.hide(),this.#D=null,this.#R({hasSelectedText:!1}));return}const{anchorNode:e}=t;if(e===this.#D)return;const i=this.#Q(t).closest(".textLayer");if(!i){this.#D&&(this.#S?.hide(),this.#D=null,this.#R({hasSelectedText:!1}));return}if(this.#S?.hide(),this.#D=e,this.#R({hasSelectedText:!0}),!(this.#C!==V.HIGHLIGHT&&this.#C!==V.NONE)&&(this.#C===V.HIGHLIGHT&&this.showAllEditors("highlight",!0,!0),this.#x=this.isShiftKeyDown,!this.isShiftKeyDown)){const n=this.#C===V.HIGHLIGHT?this.#tt(i):null;if(n?.toggleDrawing(),this.#P){const r=new AbortController,a=this.combinedSignal(r),o=l=>{l.type==="pointerup"&&l.button!==0||(r.abort(),n?.toggleDrawing(!0),l.type==="pointerup"&&this.#Y("main_toolbar"))};window.addEventListener("pointerup",o,{signal:a}),window.addEventListener("blur",o,{signal:a})}else n?.toggleDrawing(!0),this.#Y("main_toolbar")}}#Y(t=""){this.#C===V.HIGHLIGHT?this.highlightSelection(t):this.#b&&this.#at()}#lt(){document.addEventListener("selectionchange",this.#ot.bind(this),{signal:this._signal})}#ht(){if(this.#v)return;this.#v=new AbortController;const t=this.combinedSignal(this.#v);window.addEventListener("focus",this.focus.bind(this),{signal:t}),window.addEventListener("blur",this.blur.bind(this),{signal:t})}#ct(){this.#v?.abort(),this.#v=null}blur(){if(this.isShiftKeyDown=!1,this.#x&&(this.#x=!1,this.#Y("main_toolbar")),!this.hasSelection)return;const{activeElement:t}=document;for(const e of this.#A)if(e.div.contains(t)){this.#I=[e,t],e._focusEventsAllowed=!1;break}}focus(){if(!this.#I)return;const[t,e]=this.#I;this.#I=null,e.addEventListener("focusin",()=>{t._focusEventsAllowed=!0},{once:!0,signal:this._signal}),e.focus()}#et(){if(this.#L)return;this.#L=new AbortController;const t=this.combinedSignal(this.#L);window.addEventListener("keydown",this.keydown.bind(this),{signal:t}),window.addEventListener("keyup",this.keyup.bind(this),{signal:t})}#dt(){this.#L?.abort(),this.#L=null}#st(){if(this.#u)return;this.#u=new AbortController;const t=this.combinedSignal(this.#u);document.addEventListener("copy",this.copy.bind(this),{signal:t}),document.addEventListener("cut",this.cut.bind(this),{signal:t}),document.addEventListener("paste",this.paste.bind(this),{signal:t})}#it(){this.#u?.abort(),this.#u=null}#ut(){const t=this._signal;document.addEventListener("dragover",this.dragOver.bind(this),{signal:t}),document.addEventListener("drop",this.drop.bind(this),{signal:t})}addEditListeners(){this.#et(),this.#st()}removeEditListeners(){this.#dt(),this.#it()}dragOver(t){for(const{type:e}of t.dataTransfer.items)for(const s of this.#c)if(s.isHandlingMimeForPasting(e)){t.dataTransfer.dropEffect="copy",t.preventDefault();return}}drop(t){for(const e of t.dataTransfer.items)for(const s of this.#c)if(s.isHandlingMimeForPasting(e.type)){s.paste(e,this.currentLayer),t.preventDefault();return}}copy(t){if(t.preventDefault(),this.#e?.commitOrRemove(),!this.hasSelection)return;const e=[];for(const s of this.#A){const i=s.serialize(!0);i&&e.push(i)}e.length!==0&&t.clipboardData.setData("application/pdfjs",JSON.stringify(e))}cut(t){this.copy(t),this.delete()}async paste(t){t.preventDefault();const{clipboardData:e}=t;for(const n of e.items)for(const r of this.#c)if(r.isHandlingMimeForPasting(n.type)){r.paste(n,this.currentLayer);return}let s=e.getData("application/pdfjs");if(!s)return;try{s=JSON.parse(s)}catch(n){G(`paste: "${n.message}".`);return}if(!Array.isArray(s))return;this.unselectAll();const i=this.currentLayer;try{const n=[];for(const o of s){const l=await i.deserialize(o);if(!l)return;n.push(l)}const r=()=>{for(const o of n)this.#nt(o);this.#rt(n)},a=()=>{for(const o of n)o.remove()};this.addCommands({cmd:r,undo:a,mustExec:!0})}catch(n){G(`paste: "${n.message}".`)}}keydown(t){!this.isShiftKeyDown&&t.key==="Shift"&&(this.isShiftKeyDown=!0),this.#C!==V.NONE&&!this.isEditorHandlingKeyboard&&se._keyboardManager.exec(this,t)}keyup(t){this.isShiftKeyDown&&t.key==="Shift"&&(this.isShiftKeyDown=!1,this.#x&&(this.#x=!1,this.#Y("main_toolbar")))}onEditingAction({name:t}){switch(t){case"undo":case"redo":case"delete":case"selectAll":this[t]();break;case"highlightSelection":this.highlightSelection("context_menu");break;case"commentSelection":this.commentSelection("context_menu");break}}#R(t){Object.entries(t).some(([s,i])=>this.#X[s]!==i)&&(this._eventBus.dispatch("annotationeditorstateschanged",{source:this,details:Object.assign(this.#X,t)}),this.#C===V.HIGHLIGHT&&t.hasSelectedEditor===!1&&this.#$([[K.HIGHLIGHT_FREE,!0]]))}#$(t){this._eventBus.dispatch("annotationeditorparamschanged",{source:this,details:t})}setEditingState(t){t?(this.#ht(),this.#st(),this.#R({isEditing:this.#C!==V.NONE,isEmpty:this.#K(),hasSomethingToUndo:this.#h.hasSomethingToUndo(),hasSomethingToRedo:this.#h.hasSomethingToRedo(),hasSelectedEditor:!1})):(this.#ct(),this.#it(),this.#R({isEditing:!1}),this.disableUserSelect(!1))}registerEditorTypes(t){if(!this.#c){this.#c=t;for(const e of this.#c)this.#$(e.defaultPropertiesToUpdate)}}getId(){return this.#M.id}get currentLayer(){return this.#a.get(this.#f)}getLayer(t){return this.#a.get(t)}get currentPageIndex(){return this.#f}addLayer(t){this.#a.set(t.pageIndex,t),this.#k?t.enable():t.disable()}removeLayer(t){this.#a.delete(t.pageIndex)}async updateMode(t,e=null,s=!1,i=!1,n=!1){if(this.#C!==t&&!(this.#H&&(await this.#H.promise,!this.#H))){if(this.#H=Promise.withResolvers(),this.#d?.commitOrRemove(),this.#C===V.POPUP&&this.#l?.hideSidebar(),this.#l?.destroyPopup(),this.#C=t,t===V.NONE){this.setEditingState(!1),this.#pt();for(const r of this.#s.values())r.hideStandaloneCommentButton();this._editorUndoBar?.hide(),this.toggleComment(null),this.#H.resolve();return}for(const r of this.#s.values())r.addStandaloneCommentButton();t===V.SIGNATURE&&await this.#j?.loadSignatures(),this.setEditingState(!0),await this.#ft(),this.unselectAll();for(const r of this.#a.values())r.updateMode(t);if(t===V.POPUP){this.#i||=await this.#W.getAnnotationsByType(new Set(this.#c.map(o=>o._editorType)));const r=new Set,a=[];for(const o of this.#s.values()){const{annotationElementId:l,hasComment:h,deleted:c}=o;l&&r.add(l),h&&!c&&a.push(o.getData())}for(const o of this.#i){const{id:l,popupRef:h,contentsObj:c}=o;h&&c?.str&&!r.has(l)&&!this.#m.has(l)&&a.push(o)}this.#l?.showSidebar(a)}if(!e){s&&this.addNewEditorFromKeyboard(),this.#H.resolve();return}for(const r of this.#s.values())r.uid===e?(this.setSelected(r),n?r.editComment():i?r.enterInEditMode():r.focus()):r.unselect();this.#H.resolve()}}addNewEditorFromKeyboard(){this.currentLayer.canCreateNewEmptyEditor()&&this.currentLayer.addNewEditor()}updateToolbar(t){t.mode!==this.#C&&this._eventBus.dispatch("switchannotationeditormode",{source:this,...t})}updateParams(t,e){if(this.#c){switch(t){case K.CREATE:this.currentLayer.addNewEditor(e);return;case K.HIGHLIGHT_SHOW_ALL:this._eventBus.dispatch("reporttelemetry",{source:this,details:{type:"editing",data:{type:"highlight",action:"toggle_visibility"}}}),(this.#q||=new Map).set(t,e),this.showAllEditors("highlight",e);break}if(this.hasSelection)for(const s of this.#A)s.updateParams(t,e);else for(const s of this.#c)s.updateDefaultParams(t,e)}}showAllEditors(t,e,s=!1){for(const n of this.#s.values())n.editorType===t&&n.show(e);(this.#q?.get(K.HIGHLIGHT_SHOW_ALL)??!0)!==e&&this.#$([[K.HIGHLIGHT_SHOW_ALL,e]])}enableWaiting(t=!1){if(this.#O!==t){this.#O=t;for(const e of this.#a.values())t?e.disableClick():e.enableClick(),e.div.classList.toggle("waiting",t)}}async#ft(){if(!this.#k){this.#k=!0;const t=[];for(const e of this.#a.values())t.push(e.enable());await Promise.all(t);for(const e of this.#s.values())e.enable()}}#pt(){if(this.unselectAll(),this.#k){this.#k=!1;for(const t of this.#a.values())t.disable();for(const t of this.#s.values())t.disable()}}*getEditors(t){for(const e of this.#s.values())e.pageIndex===t&&(yield e)}getEditor(t){return this.#s.get(t)}addEditor(t){this.#s.set(t.id,t)}removeEditor(t){t.div.contains(document.activeElement)&&(this.#_&&clearTimeout(this.#_),this.#_=setTimeout(()=>{this.focusMainContainer(),this.#_=null},0)),this.#s.delete(t.id),t.annotationElementId&&this.#N?.delete(t.annotationElementId),this.unselect(t),(!t.annotationElementId||!this.#m.has(t.annotationElementId))&&this.#r?.remove(t.id)}addDeletedAnnotationElement(t){this.#m.add(t.annotationElementId),this.addChangedExistingAnnotation(t),t.deleted=!0}isDeletedAnnotationElement(t){return this.#m.has(t)}removeDeletedAnnotationElement(t){this.#m.delete(t.annotationElementId),this.removeChangedExistingAnnotation(t),t.deleted=!1}#nt(t){const e=this.#a.get(t.pageIndex);e?e.addOrRebuild(t):(this.addEditor(t),this.addToAnnotationStorage(t))}setActiveEditor(t){this.#e!==t&&(this.#e=t,t&&this.#$(t.propertiesToUpdate))}get#gt(){let t=null;for(t of this.#A);return t}updateUI(t){this.#gt===t&&this.#$(t.propertiesToUpdate)}updateUIForDefaultProperties(t){this.#$(t.defaultPropertiesToUpdate)}toggleSelected(t){if(this.#A.has(t)){this.#A.delete(t),t.unselect(),this.#R({hasSelectedEditor:this.hasSelection});return}this.#A.add(t),t.select(),this.#$(t.propertiesToUpdate),this.#R({hasSelectedEditor:!0})}setSelected(t){this.updateToolbar({mode:t.mode,editId:t.id}),this.#d?.commitOrRemove();for(const e of this.#A)e!==t&&e.unselect();this.#A.clear(),this.#A.add(t),t.select(),this.#$(t.propertiesToUpdate),this.#R({hasSelectedEditor:!0})}isSelected(t){return this.#A.has(t)}get firstSelectedEditor(){return this.#A.values().next().value}unselect(t){t.unselect(),this.#A.delete(t),this.#R({hasSelectedEditor:this.hasSelection})}get hasSelection(){return this.#A.size!==0}get isEnterHandled(){return this.#A.size===1&&this.firstSelectedEditor.isEnterHandled}undo(){this.#h.undo(),this.#R({hasSomethingToUndo:this.#h.hasSomethingToUndo(),hasSomethingToRedo:!0,isEmpty:this.#K()}),this._editorUndoBar?.hide()}redo(){this.#h.redo(),this.#R({hasSomethingToUndo:!0,hasSomethingToRedo:this.#h.hasSomethingToRedo(),isEmpty:this.#K()})}addCommands(t){this.#h.add(t),this.#R({hasSomethingToUndo:!0,hasSomethingToRedo:!1,isEmpty:this.#K()})}cleanUndoStack(t){this.#h.cleanType(t)}#K(){if(this.#s.size===0)return!0;if(this.#s.size===1)for(const t of this.#s.values())return t.isEmpty();return!1}delete(){this.commitOrRemove();const t=this.currentLayer?.endDrawingSession(!0);if(!this.hasSelection&&!t)return;const e=t?[t]:[...this.#A],s=()=>{this._editorUndoBar?.show(i,e.length===1?e[0].editorType:e.length);for(const n of e)n.remove()},i=()=>{for(const n of e)this.#nt(n)};this.addCommands({cmd:s,undo:i,mustExec:!0})}commitOrRemove(){this.#e?.commitOrRemove()}hasSomethingToControl(){return this.#e||this.hasSelection}#rt(t){for(const e of this.#A)e.unselect();this.#A.clear();for(const e of t)e.isEmpty()||(this.#A.add(e),e.select());this.#R({hasSelectedEditor:this.hasSelection})}selectAll(){for(const t of this.#A)t.commit();this.#rt(this.#s.values())}unselectAll(){if(!(this.#e&&(this.#e.commitOrRemove(),this.#C!==V.NONE))&&!this.#d?.commitOrRemove()&&this.hasSelection){for(const t of this.#A)t.unselect();this.#A.clear(),this.#R({hasSelectedEditor:!1})}}translateSelectedEditors(t,e,s=!1){if(s||this.commitOrRemove(),!this.hasSelection)return;this.#z[0]+=t,this.#z[1]+=e;const[i,n]=this.#z,r=[...this.#A],a=1e3;this.#F&&clearTimeout(this.#F),this.#F=setTimeout(()=>{this.#F=null,this.#z[0]=this.#z[1]=0,this.addCommands({cmd:()=>{for(const o of r)this.#s.has(o.id)&&(o.translateInPage(i,n),o.translationDone())},undo:()=>{for(const o of r)this.#s.has(o.id)&&(o.translateInPage(-i,-n),o.translationDone())},mustExec:!1})},a);for(const o of r)o.translateInPage(t,e),o.translationDone()}setUpDragSession(){if(this.hasSelection){this.disableUserSelect(!0),this.#p=new Map;for(const t of this.#A)this.#p.set(t,{savedX:t.x,savedY:t.y,savedPageIndex:t.pageIndex,newX:0,newY:0,newPageIndex:-1})}}endDragSession(){if(!this.#p)return!1;this.disableUserSelect(!1);const t=this.#p;this.#p=null;let e=!1;for(const[{x:i,y:n,pageIndex:r},a]of t)a.newX=i,a.newY=n,a.newPageIndex=r,e||=i!==a.savedX||n!==a.savedY||r!==a.savedPageIndex;if(!e)return!1;const s=(i,n,r,a)=>{if(this.#s.has(i.id)){const o=this.#a.get(a);o?i._setParentAndPosition(o,n,r):(i.pageIndex=a,i.x=n,i.y=r)}};return this.addCommands({cmd:()=>{for(const[i,{newX:n,newY:r,newPageIndex:a}]of t)s(i,n,r,a)},undo:()=>{for(const[i,{savedX:n,savedY:r,savedPageIndex:a}]of t)s(i,n,r,a)},mustExec:!0}),!0}dragSelectedEditors(t,e){if(this.#p)for(const s of this.#p.keys())s.drag(t,e)}rebuild(t){if(t.parent===null){const e=this.getLayer(t.pageIndex);e?(e.changeParent(t),e.addOrRebuild(t)):(this.addEditor(t),this.addToAnnotationStorage(t),t.rebuild())}else t.parent.addOrRebuild(t)}get isEditorHandlingKeyboard(){return this.getActive()?.shouldGetKeyboardEvents()||this.#A.size===1&&this.firstSelectedEditor.shouldGetKeyboardEvents()}isActive(t){return this.#e===t}getActive(){return this.#e}getMode(){return this.#C}isEditingMode(){return this.#C!==V.NONE}get imageManager(){return W(this,"imageManager",new zs)}getSelectionBoxes(t){if(!t)return null;const e=document.getSelection();for(let l=0,h=e.rangeCount;l<h;l++)if(!t.contains(e.getRangeAt(l).commonAncestorContainer))return null;const{x:s,y:i,width:n,height:r}=t.getBoundingClientRect();let a;switch(t.getAttribute("data-main-rotation")){case"90":a=(l,h,c,u)=>({x:(h-i)/r,y:1-(l+c-s)/n,width:u/r,height:c/n});break;case"180":a=(l,h,c,u)=>({x:1-(l+c-s)/n,y:1-(h+u-i)/r,width:c/n,height:u/r});break;case"270":a=(l,h,c,u)=>({x:1-(h+u-i)/r,y:(l-s)/n,width:u/r,height:c/n});break;default:a=(l,h,c,u)=>({x:(l-s)/n,y:(h-i)/r,width:c/n,height:u/r});break}const o=[];for(let l=0,h=e.rangeCount;l<h;l++){const c=e.getRangeAt(l);if(!c.collapsed)for(const{x:u,y:f,width:m,height:p}of c.getClientRects())m===0||p===0||o.push(a(u,f,m,p))}return o.length===0?null:o}addChangedExistingAnnotation({annotationElementId:t,id:e}){(this.#o||=new Map).set(t,e)}removeChangedExistingAnnotation({annotationElementId:t}){this.#o?.delete(t)}renderAnnotationElement(t){const e=this.#o?.get(t.data.id);if(!e)return;const s=this.#r.getRawValue(e);s&&(this.#C===V.NONE&&!s.hasBeenModified||s.renderAnnotationElement(t))}setMissingCanvas(t,e,s){const i=this.#N?.get(t);i&&(i.setCanvas(e,s),this.#N.delete(t))}addMissingCanvas(t,e){(this.#N||=new Map).set(t,e)}}class Wt{#t=null;#e=!1;#i=null;#s=null;#a=null;#n=null;#r=!1;#o=null;#h=null;#l=null;#u=null;#d=!1;static#f=null;static _l10n=null;constructor(t){this.#h=t,this.#d=t._uiManager.useNewAltTextFlow,Wt.#f||=Object.freeze({added:"pdfjs-editor-new-alt-text-added-button","added-label":"pdfjs-editor-new-alt-text-added-button-label",missing:"pdfjs-editor-new-alt-text-missing-button","missing-label":"pdfjs-editor-new-alt-text-missing-button-label",review:"pdfjs-editor-new-alt-text-to-review-button","review-label":"pdfjs-editor-new-alt-text-to-review-button-label"})}static initialize(t){Wt._l10n??=t}async render(){const t=this.#i=document.createElement("button");t.className="altText",t.tabIndex="0";const e=this.#s=document.createElement("span");t.append(e),this.#d?(t.classList.add("new"),t.setAttribute("data-l10n-id",Wt.#f.missing),e.setAttribute("data-l10n-id",Wt.#f["missing-label"])):(t.setAttribute("data-l10n-id","pdfjs-editor-alt-text-button"),e.setAttribute("data-l10n-id","pdfjs-editor-alt-text-button-label"));const s=this.#h._uiManager._signal;t.addEventListener("contextmenu",jt,{signal:s}),t.addEventListener("pointerdown",n=>n.stopPropagation(),{signal:s});const i=n=>{n.preventDefault(),this.#h._uiManager.editAltText(this.#h),this.#d&&this.#h._reportTelemetry({action:"pdfjs.image.alt_text.image_status_label_clicked",data:{label:this.#m}})};return t.addEventListener("click",i,{capture:!0,signal:s}),t.addEventListener("keydown",n=>{n.target===t&&n.key==="Enter"&&(this.#r=!0,i(n))},{signal:s}),await this.#p(),t}get#m(){return this.#t&&"added"||this.#t===null&&this.guessedText&&"review"||"missing"}finish(){this.#i&&(this.#i.focus({focusVisible:this.#r}),this.#r=!1)}isEmpty(){return this.#d?this.#t===null:!this.#t&&!this.#e}hasData(){return this.#d?this.#t!==null||!!this.#l:this.isEmpty()}get guessedText(){return this.#l}async setGuessedText(t){this.#t===null&&(this.#l=t,this.#u=await Wt._l10n.get("pdfjs-editor-new-alt-text-generated-alt-text-with-disclaimer",{generatedAltText:t}),this.#p())}toggleAltTextBadge(t=!1){if(!this.#d||this.#t){this.#o?.remove(),this.#o=null;return}if(!this.#o){const e=this.#o=document.createElement("div");e.className="noAltTextBadge",this.#h.div.append(e)}this.#o.classList.toggle("hidden",!t)}serialize(t){let e=this.#t;return!t&&this.#l===e&&(e=this.#u),{altText:e,decorative:this.#e,guessedText:this.#l,textWithDisclaimer:this.#u}}get data(){return{altText:this.#t,decorative:this.#e}}set data({altText:t,decorative:e,guessedText:s,textWithDisclaimer:i,cancel:n=!1}){s&&(this.#l=s,this.#u=i),!(this.#t===t&&this.#e===e)&&(n||(this.#t=t,this.#e=e),this.#p())}toggle(t=!1){this.#i&&(!t&&this.#n&&(clearTimeout(this.#n),this.#n=null),this.#i.disabled=!t)}shown(){this.#h._reportTelemetry({action:"pdfjs.image.alt_text.image_status_label_displayed",data:{label:this.#m}})}destroy(){this.#i?.remove(),this.#i=null,this.#s=null,this.#a=null,this.#o?.remove(),this.#o=null}async#p(){const t=this.#i;if(!t)return;if(this.#d){if(t.classList.toggle("done",!!this.#t),t.setAttribute("data-l10n-id",Wt.#f[this.#m]),this.#s?.setAttribute("data-l10n-id",Wt.#f[`${this.#m}-label`]),!this.#t){this.#a?.remove();return}}else{if(!this.#t&&!this.#e){t.classList.remove("done"),this.#a?.remove();return}t.classList.add("done"),t.setAttribute("data-l10n-id","pdfjs-editor-alt-text-edit-button")}let e=this.#a;if(!e){this.#a=e=document.createElement("span"),e.className="tooltip",e.setAttribute("role","tooltip"),e.id=`alt-text-tooltip-${this.#h.id}`;const i=100,n=this.#h._uiManager._signal;n.addEventListener("abort",()=>{clearTimeout(this.#n),this.#n=null},{once:!0}),t.addEventListener("mouseenter",()=>{this.#n=setTimeout(()=>{this.#n=null,this.#a.classList.add("show"),this.#h._reportTelemetry({action:"alt_text_tooltip"})},i)},{signal:n}),t.addEventListener("mouseleave",()=>{this.#n&&(clearTimeout(this.#n),this.#n=null),this.#a?.classList.remove("show")},{signal:n})}this.#e?e.setAttribute("data-l10n-id","pdfjs-editor-alt-text-decorative-tooltip"):(e.removeAttribute("data-l10n-id"),e.textContent=this.#t),e.parentNode||t.append(e),this.#h.getElementForAltText()?.setAttribute("aria-describedby",e.id)}}class We{#t=null;#e=null;#i=!1;#s=null;#a=null;#n=null;#r=null;#o=null;#h=!1;#l=null;constructor(t){this.#s=t}renderForToolbar(){const t=this.#e=document.createElement("button");return t.className="comment",this.#u(t,!1)}renderForStandalone(){const t=this.#t=document.createElement("button");t.className="annotationCommentButton";const e=this.#s.commentButtonPosition;if(e){const{style:s}=t;s.insetInlineEnd=`calc(${100*(this.#s._uiManager.direction==="ltr"?1-e[0]:e[0])}% - var(--comment-button-dim))`,s.top=`calc(${100*e[1]}% - var(--comment-button-dim))`;const i=this.#s.commentButtonColor;i&&(s.backgroundColor=i)}return this.#u(t,!0)}focusButton(){setTimeout(()=>{(this.#t??this.#e)?.focus()},0)}onUpdatedColor(){if(!this.#t)return;const t=this.#s.commentButtonColor;t&&(this.#t.style.backgroundColor=t),this.#s._uiManager.updatePopupColor(this.#s)}get commentButtonWidth(){return(this.#t?.getBoundingClientRect().width??0)/this.#s.parent.boundingClientRect.width}get commentPopupPositionInLayer(){if(this.#l)return this.#l;if(!this.#t)return null;const{x:t,y:e,height:s}=this.#t.getBoundingClientRect(),{x:i,y:n,width:r,height:a}=this.#s.parent.boundingClientRect;return[(t-i)/r,(e+s-n)/a]}set commentPopupPositionInLayer(t){this.#l=t}hasDefaultPopupPosition(){return this.#l===null}removeStandaloneCommentButton(){this.#t?.remove(),this.#t=null}removeToolbarCommentButton(){this.#e?.remove(),this.#e=null}setCommentButtonStates({selected:t,hasPopup:e}){this.#t&&(this.#t.classList.toggle("selected",t),this.#t.ariaExpanded=e)}#u(t,e){if(!this.#s._uiManager.hasCommentManager())return null;t.tabIndex="0",t.ariaHasPopup="dialog",e?(t.ariaControls="commentPopup",t.setAttribute("data-l10n-id","pdfjs-show-comment-button")):(t.ariaControlsElements=[this.#s._uiManager.getCommentDialogElement()],t.setAttribute("data-l10n-id","pdfjs-editor-edit-comment-button"));const s=this.#s._uiManager._signal;if(!(s instanceof AbortSignal)||s.aborted)return t;t.addEventListener("contextmenu",jt,{signal:s}),e&&(t.addEventListener("focusin",n=>{this.#s._focusEventsAllowed=!1,ht(n)},{capture:!0,signal:s}),t.addEventListener("focusout",n=>{this.#s._focusEventsAllowed=!0,ht(n)},{capture:!0,signal:s})),t.addEventListener("pointerdown",n=>n.stopPropagation(),{signal:s});const i=n=>{n.preventDefault(),t===this.#e?this.edit():this.#s.toggleComment(!0)};return t.addEventListener("click",i,{capture:!0,signal:s}),t.addEventListener("keydown",n=>{n.target===t&&n.key==="Enter"&&(this.#i=!0,i(n))},{signal:s}),t.addEventListener("pointerenter",()=>{this.#s.toggleComment(!1,!0)},{signal:s}),t.addEventListener("pointerleave",()=>{this.#s.toggleComment(!1,!1)},{signal:s}),t}edit(t){const e=this.commentPopupPositionInLayer;let s,i;if(e)[s,i]=e;else{[s,i]=this.#s.commentButtonPosition;const{width:h,height:c,x:u,y:f}=this.#s;s=u+s*h,i=f+i*c}const n=this.#s.parent.boundingClientRect,{x:r,y:a,width:o,height:l}=n;this.#s._uiManager.editComment(this.#s,r+s*o,a+i*l,{...t,parentDimensions:n})}finish(){this.#e&&(this.#e.focus({focusVisible:this.#i}),this.#i=!1)}isDeleted(){return this.#h||this.#r===""}isEmpty(){return this.#r===null}hasBeenEdited(){return this.isDeleted()||this.#r!==this.#a}serialize(){return this.data}get data(){return{text:this.#r,richText:this.#n,date:this.#o,deleted:this.isDeleted()}}set data(t){if(t!==this.#r&&(this.#n=null),t===null){this.#r="",this.#h=!0;return}this.#r=t,this.#o=new Date,this.#h=!1}setInitialText(t,e=null){this.#a=t,this.data=t,this.#o=null,this.#n=e}shown(){}destroy(){this.#e?.remove(),this.#e=null,this.#t?.remove(),this.#t=null,this.#r="",this.#n=null,this.#o=null,this.#s=null,this.#i=!1,this.#h=!1}}class us{#t;#e=!1;#i=null;#s;#a;#n;#r;#o=null;#h;#l=null;#u;#d=null;constructor({container:t,isPinchingDisabled:e=null,isPinchingStopped:s=null,onPinchStart:i=null,onPinching:n=null,onPinchEnd:r=null,signal:a}){this.#t=t,this.#i=s,this.#s=e,this.#a=i,this.#n=n,this.#r=r,this.#u=new AbortController,this.#h=AbortSignal.any([a,this.#u.signal]),t.addEventListener("touchstart",this.#f.bind(this),{passive:!1,signal:this.#h})}get MIN_TOUCH_DISTANCE_TO_PINCH(){return 35/qt.pixelRatio}#f(t){if(this.#s?.())return;if(t.touches.length===1){if(this.#o)return;const i=this.#o=new AbortController,n=AbortSignal.any([this.#h,i.signal]),r=this.#t,a={capture:!0,signal:n,passive:!1},o=l=>{l.pointerType==="touch"&&(this.#o?.abort(),this.#o=null)};r.addEventListener("pointerdown",l=>{l.pointerType==="touch"&&(ht(l),o(l))},a),r.addEventListener("pointerup",o,a),r.addEventListener("pointercancel",o,a);return}if(!this.#d){this.#d=new AbortController;const i=AbortSignal.any([this.#h,this.#d.signal]),n=this.#t,r={signal:i,capture:!1,passive:!1};n.addEventListener("touchmove",this.#m.bind(this),r);const a=this.#p.bind(this);n.addEventListener("touchend",a,r),n.addEventListener("touchcancel",a,r),r.capture=!0,n.addEventListener("pointerdown",ht,r),n.addEventListener("pointermove",ht,r),n.addEventListener("pointercancel",ht,r),n.addEventListener("pointerup",ht,r),this.#a?.()}if(ht(t),t.touches.length!==2||this.#i?.()){this.#l=null;return}let[e,s]=t.touches;e.identifier>s.identifier&&([e,s]=[s,e]),this.#l={touch0X:e.screenX,touch0Y:e.screenY,touch1X:s.screenX,touch1Y:s.screenY}}#m(t){if(!this.#l||t.touches.length!==2)return;ht(t);let[e,s]=t.touches;e.identifier>s.identifier&&([e,s]=[s,e]);const{screenX:i,screenY:n}=e,{screenX:r,screenY:a}=s,o=this.#l,{touch0X:l,touch0Y:h,touch1X:c,touch1Y:u}=o,f=c-l,m=u-h,p=r-i,b=a-n,g=Math.hypot(p,b)||1,v=Math.hypot(f,m)||1;if(!this.#e&&Math.abs(v-g)<=us.MIN_TOUCH_DISTANCE_TO_PINCH)return;if(o.touch0X=i,o.touch0Y=n,o.touch1X=r,o.touch1Y=a,!this.#e){this.#e=!0;return}const y=[(i+r)/2,(n+a)/2];this.#n?.(y,v,g)}#p(t){t.touches.length>=2||(this.#d&&(this.#d.abort(),this.#d=null,this.#r?.()),this.#l&&(ht(t),this.#l=null,this.#e=!1))}destroy(){this.#u?.abort(),this.#u=null,this.#o?.abort(),this.#o=null}}class j{#t=null;#e=null;#i=null;#s=null;#a=null;#n=!1;#r=null;#o="";#h=null;#l=null;#u=null;#d=null;#f=null;#m="";#p=!1;#c=null;#g=!1;#b=!1;#w=!1;#y=null;#E=0;#_=0;#v=null;#T=null;isSelected=!1;_isCopy=!1;_editToolbar=null;_initialOptions=Object.create(null);_initialData=null;_isVisible=!0;_uiManager=null;_focusEventsAllowed=!0;static _l10n=null;static _l10nResizer=null;#x=!1;#S=j._zIndex++;static _borderLineWidth=-1;static _colorManager=new $s;static _zIndex=1;static _telemetryTimeout=1e3;static get _resizerKeyboardManager(){const t=j.prototype._resizeWithKeyboard,e=se.TRANSLATE_SMALL,s=se.TRANSLATE_BIG;return W(this,"_resizerKeyboardManager",new ze([[["ArrowLeft","mac+ArrowLeft"],t,{args:[-e,0]}],[["ctrl+ArrowLeft","mac+shift+ArrowLeft"],t,{args:[-s,0]}],[["ArrowRight","mac+ArrowRight"],t,{args:[e,0]}],[["ctrl+ArrowRight","mac+shift+ArrowRight"],t,{args:[s,0]}],[["ArrowUp","mac+ArrowUp"],t,{args:[0,-e]}],[["ctrl+ArrowUp","mac+shift+ArrowUp"],t,{args:[0,-s]}],[["ArrowDown","mac+ArrowDown"],t,{args:[0,e]}],[["ctrl+ArrowDown","mac+shift+ArrowDown"],t,{args:[0,s]}],[["Escape","mac+Escape"],j.prototype._stopResizingWithKeyboard]]))}constructor(t){this.parent=t.parent,this.id=t.id,this.width=this.height=null,this.pageIndex=t.parent.pageIndex,this.name=t.name,this.div=null,this._uiManager=t.uiManager,this.annotationElementId=null,this._willKeepAspectRatio=!1,this._initialOptions.isCentered=t.isCentered,this._structTreeParentId=null,this.annotationElementId=t.annotationElementId||null,this.creationDate=t.creationDate||new Date,this.modificationDate=t.modificationDate||null;const{rotation:e,rawDims:{pageWidth:s,pageHeight:i,pageX:n,pageY:r}}=this.parent.viewport;this.rotation=e,this.pageRotation=(360+e-this._uiManager.viewParameters.rotation)%360,this.pageDimensions=[s,i],this.pageTranslation=[n,r];const[a,o]=this.parentDimensions;this.x=t.x/a,this.y=t.y/o,this.isAttachedToDOM=!1,this.deleted=!1}get editorType(){return Object.getPrototypeOf(this).constructor._type}get mode(){return Object.getPrototypeOf(this).constructor._editorType}static get isDrawer(){return!1}static get _defaultLineColor(){return W(this,"_defaultLineColor",this._colorManager.getHexCode("CanvasText"))}static deleteAnnotationElement(t){const e=new qn({id:t.parent.getNextId(),parent:t.parent,uiManager:t._uiManager});e.annotationElementId=t.annotationElementId,e.deleted=!0,e._uiManager.addToAnnotationStorage(e)}static initialize(t,e){if(j._l10n??=t,j._l10nResizer||=Object.freeze({topLeft:"pdfjs-editor-resizer-top-left",topMiddle:"pdfjs-editor-resizer-top-middle",topRight:"pdfjs-editor-resizer-top-right",middleRight:"pdfjs-editor-resizer-middle-right",bottomRight:"pdfjs-editor-resizer-bottom-right",bottomMiddle:"pdfjs-editor-resizer-bottom-middle",bottomLeft:"pdfjs-editor-resizer-bottom-left",middleLeft:"pdfjs-editor-resizer-middle-left"}),j._borderLineWidth!==-1)return;const s=getComputedStyle(document.documentElement);j._borderLineWidth=parseFloat(s.getPropertyValue("--outline-width"))||0}static updateDefaultParams(t,e){}static get defaultPropertiesToUpdate(){return[]}static isHandlingMimeForPasting(t){return!1}static paste(t,e){nt("Not implemented")}get propertiesToUpdate(){return[]}get _isDraggable(){return this.#x}set _isDraggable(t){this.#x=t,this.div?.classList.toggle("draggable",t)}get uid(){return this.annotationElementId||this.id}get isEnterHandled(){return!0}center(){const[t,e]=this.pageDimensions;switch(this.parentRotation){case 90:this.x-=this.height*e/(t*2),this.y+=this.width*t/(e*2);break;case 180:this.x+=this.width/2,this.y+=this.height/2;break;case 270:this.x+=this.height*e/(t*2),this.y-=this.width*t/(e*2);break;default:this.x-=this.width/2,this.y-=this.height/2;break}this.fixAndSetPosition()}addCommands(t){this._uiManager.addCommands(t)}get currentLayer(){return this._uiManager.currentLayer}setInBackground(){this.div.style.zIndex=0}setInForeground(){this.div.style.zIndex=this.#S}setParent(t){t!==null?(this.pageIndex=t.pageIndex,this.pageDimensions=t.pageDimensions):(this.#F(),this.#d?.remove(),this.#d=null),this.parent=t}focusin(t){this._focusEventsAllowed&&(this.#p?this.#p=!1:this.parent.setSelected(this))}focusout(t){!this._focusEventsAllowed||!this.isAttachedToDOM||t.relatedTarget?.closest(`#${this.id}`)||(t.preventDefault(),this.parent?.isMultipleSelection||this.commitOrRemove())}commitOrRemove(){this.isEmpty()?this.remove():this.commit()}commit(){this.isInEditMode()&&this.addToAnnotationStorage()}addToAnnotationStorage(){this._uiManager.addToAnnotationStorage(this)}setAt(t,e,s,i){const[n,r]=this.parentDimensions;[s,i]=this.screenToPageTranslation(s,i),this.x=(t+s)/n,this.y=(e+i)/r,this.fixAndSetPosition()}_moveAfterPaste(t,e){const[s,i]=this.parentDimensions;this.setAt(t*s,e*i,this.width*s,this.height*i),this._onTranslated()}#M([t,e],s,i){[s,i]=this.screenToPageTranslation(s,i),this.x+=s/t,this.y+=i/e,this._onTranslating(this.x,this.y),this.fixAndSetPosition()}translate(t,e){this.#M(this.parentDimensions,t,e)}translateInPage(t,e){this.#c||=[this.x,this.y,this.width,this.height],this.#M(this.pageDimensions,t,e),this.div.scrollIntoView({block:"nearest"})}translationDone(){this._onTranslated(this.x,this.y)}drag(t,e){this.#c||=[this.x,this.y,this.width,this.height];const{div:s,parentDimensions:[i,n]}=this;if(this.x+=t/i,this.y+=e/n,this.parent&&(this.x<0||this.x>1||this.y<0||this.y>1)){const{x:c,y:u}=this.div.getBoundingClientRect();this.parent.findNewParent(this,c,u)&&(this.x-=Math.floor(this.x),this.y-=Math.floor(this.y))}let{x:r,y:a}=this;const[o,l]=this.getBaseTranslation();r+=o,a+=l;const{style:h}=s;h.left=`${(100*r).toFixed(2)}%`,h.top=`${(100*a).toFixed(2)}%`,this._onTranslating(r,a),s.scrollIntoView({block:"nearest"})}_onTranslating(t,e){}_onTranslated(t,e){}get _hasBeenMoved(){return!!this.#c&&(this.#c[0]!==this.x||this.#c[1]!==this.y)}get _hasBeenResized(){return!!this.#c&&(this.#c[2]!==this.width||this.#c[3]!==this.height)}getBaseTranslation(){const[t,e]=this.parentDimensions,{_borderLineWidth:s}=j,i=s/t,n=s/e;switch(this.rotation){case 90:return[-i,n];case 180:return[i,n];case 270:return[i,-n];default:return[-i,-n]}}get _mustFixPosition(){return!0}fixAndSetPosition(t=this.rotation){const{div:{style:e},pageDimensions:[s,i]}=this;let{x:n,y:r,width:a,height:o}=this;if(a*=s,o*=i,n*=s,r*=i,this._mustFixPosition)switch(t){case 0:n=Pt(n,0,s-a),r=Pt(r,0,i-o);break;case 90:n=Pt(n,0,s-o),r=Pt(r,a,i);break;case 180:n=Pt(n,a,s),r=Pt(r,o,i);break;case 270:n=Pt(n,o,s),r=Pt(r,0,i-a);break}this.x=n/=s,this.y=r/=i;const[l,h]=this.getBaseTranslation();n+=l,r+=h,e.left=`${(100*n).toFixed(2)}%`,e.top=`${(100*r).toFixed(2)}%`,this.moveInDOM()}static#k(t,e,s){switch(s){case 90:return[e,-t];case 180:return[-t,-e];case 270:return[-e,t];default:return[t,e]}}screenToPageTranslation(t,e){return j.#k(t,e,this.parentRotation)}pageTranslationToScreen(t,e){return j.#k(t,e,360-this.parentRotation)}#P(t){switch(t){case 90:{const[e,s]=this.pageDimensions;return[0,-e/s,s/e,0]}case 180:return[-1,0,0,-1];case 270:{const[e,s]=this.pageDimensions;return[0,e/s,-s/e,0]}default:return[1,0,0,1]}}get parentScale(){return this._uiManager.viewParameters.realScale}get parentRotation(){return(this._uiManager.viewParameters.rotation+this.pageRotation)%360}get parentDimensions(){const{parentScale:t,pageDimensions:[e,s]}=this;return[e*t,s*t]}setDims(){const{div:{style:t},width:e,height:s}=this;t.width=`${(100*e).toFixed(2)}%`,t.height=`${(100*s).toFixed(2)}%`}getInitialTranslation(){return[0,0]}#O(){if(this.#h)return;this.#h=document.createElement("div"),this.#h.classList.add("resizers");const t=this._willKeepAspectRatio?["topLeft","topRight","bottomRight","bottomLeft"]:["topLeft","topMiddle","topRight","middleRight","bottomRight","bottomMiddle","bottomLeft","middleLeft"],e=this._uiManager._signal;for(const s of t){const i=document.createElement("div");this.#h.append(i),i.classList.add("resizer",s),i.setAttribute("data-resizer-name",s),i.addEventListener("pointerdown",this.#L.bind(this,s),{signal:e}),i.addEventListener("contextmenu",jt,{signal:e}),i.tabIndex=-1}this.div.prepend(this.#h)}#L(t,e){e.preventDefault();const{isMac:s}=_t.platform;if(e.button!==0||e.ctrlKey&&s)return;this.#i?.toggle(!1);const i=this._isDraggable;this._isDraggable=!1,this.#l=[e.screenX,e.screenY];const n=new AbortController,r=this._uiManager.combinedSignal(n);this.parent.togglePointerEvents(!1),window.addEventListener("pointermove",this.#N.bind(this,t),{passive:!0,capture:!0,signal:r}),window.addEventListener("touchmove",ht,{passive:!1,signal:r}),window.addEventListener("contextmenu",jt,{signal:r}),this.#u={savedX:this.x,savedY:this.y,savedWidth:this.width,savedHeight:this.height};const a=this.parent.div.style.cursor,o=this.div.style.cursor;this.div.style.cursor=this.parent.div.style.cursor=window.getComputedStyle(e.target).cursor;const l=()=>{n.abort(),this.parent.togglePointerEvents(!0),this.#i?.toggle(!0),this._isDraggable=i,this.parent.div.style.cursor=a,this.div.style.cursor=o,this.#B()};window.addEventListener("pointerup",l,{signal:r}),window.addEventListener("blur",l,{signal:r})}#I(t,e,s,i){this.width=s,this.height=i,this.x=t,this.y=e,this.setDims(),this.fixAndSetPosition(),this._onResized()}_onResized(){}#B(){if(!this.#u)return;const{savedX:t,savedY:e,savedWidth:s,savedHeight:i}=this.#u;this.#u=null;const n=this.x,r=this.y,a=this.width,o=this.height;n===t&&r===e&&a===s&&o===i||this.addCommands({cmd:this.#I.bind(this,n,r,a,o),undo:this.#I.bind(this,t,e,s,i),mustExec:!0})}static _round(t){return Math.round(t*1e4)/1e4}#N(t,e){const[s,i]=this.parentDimensions,n=this.x,r=this.y,a=this.width,o=this.height,l=j.MIN_SIZE/s,h=j.MIN_SIZE/i,c=this.#P(this.rotation),u=(D,O)=>[c[0]*D+c[2]*O,c[1]*D+c[3]*O],f=this.#P(360-this.rotation),m=(D,O)=>[f[0]*D+f[2]*O,f[1]*D+f[3]*O];let p,b,g=!1,v=!1;switch(t){case"topLeft":g=!0,p=(D,O)=>[0,0],b=(D,O)=>[D,O];break;case"topMiddle":p=(D,O)=>[D/2,0],b=(D,O)=>[D/2,O];break;case"topRight":g=!0,p=(D,O)=>[D,0],b=(D,O)=>[0,O];break;case"middleRight":v=!0,p=(D,O)=>[D,O/2],b=(D,O)=>[0,O/2];break;case"bottomRight":g=!0,p=(D,O)=>[D,O],b=(D,O)=>[0,0];break;case"bottomMiddle":p=(D,O)=>[D/2,O],b=(D,O)=>[D/2,0];break;case"bottomLeft":g=!0,p=(D,O)=>[0,O],b=(D,O)=>[D,0];break;case"middleLeft":v=!0,p=(D,O)=>[0,O/2],b=(D,O)=>[D,O/2];break}const y=p(a,o),S=b(a,o);let A=u(...S);const w=j._round(n+A[0]),_=j._round(r+A[1]);let x=1,E=1,k,T;if(e.fromKeyboard)({deltaX:k,deltaY:T}=e);else{const{screenX:D,screenY:O}=e,[N,H]=this.#l;[k,T]=this.screenToPageTranslation(D-N,O-H),this.#l[0]=D,this.#l[1]=O}if([k,T]=m(k/s,T/i),g){const D=Math.hypot(a,o);x=E=Math.max(Math.min(Math.hypot(S[0]-y[0]-k,S[1]-y[1]-T)/D,1/a,1/o),l/a,h/o)}else v?x=Pt(Math.abs(S[0]-y[0]-k),l,1)/a:E=Pt(Math.abs(S[1]-y[1]-T),h,1)/o;const P=j._round(a*x),M=j._round(o*E);A=u(...b(P,M));const I=w-A[0],R=_-A[1];this.#c||=[this.x,this.y,this.width,this.height],this.width=P,this.height=M,this.x=I,this.y=R,this.setDims(),this.fixAndSetPosition(),this._onResizing()}_onResizing(){}altTextFinish(){this.#i?.finish()}get toolbarButtons(){return null}async addEditToolbar(){if(this._editToolbar||this.#b)return this._editToolbar;this._editToolbar=new Le(this),this.div.append(this._editToolbar.render());const{toolbarButtons:t}=this;if(t)for(const[e,s]of t)await this._editToolbar.addButton(e,s);return this.hasComment||this._editToolbar.addButton("comment",this.addCommentButton()),this._editToolbar.addButton("delete"),this._editToolbar}addCommentButtonInToolbar(){this._editToolbar?.addButtonBefore("comment",this.addCommentButton(),".deleteButton")}removeCommentButtonFromToolbar(){this._editToolbar?.removeButton("comment")}removeEditToolbar(){this._editToolbar?.remove(),this._editToolbar=null,this.#i?.destroy()}addContainer(t){const e=this._editToolbar?.div;e?e.before(t):this.div.append(t)}getClientDimensions(){return this.div.getBoundingClientRect()}createAltText(){return this.#i||(Wt.initialize(j._l10n),this.#i=new Wt(this),this.#t&&(this.#i.data=this.#t,this.#t=null)),this.#i}get altTextData(){return this.#i?.data}set altTextData(t){this.#i&&(this.#i.data=t)}get guessedAltText(){return this.#i?.guessedText}async setGuessedAltText(t){await this.#i?.setGuessedText(t)}serializeAltText(t){return this.#i?.serialize(t)}hasAltText(){return!!this.#i&&!this.#i.isEmpty()}hasAltTextData(){return this.#i?.hasData()??!1}focusCommentButton(){this.#s?.focusButton()}addCommentButton(){return this.#s||=new We(this)}addStandaloneCommentButton(){if(this.#a){this._uiManager.isEditingMode()&&this.#a.classList.remove("hidden");return}this.hasComment&&(this.#a=this.#s.renderForStandalone(),this.div.append(this.#a))}removeStandaloneCommentButton(){this.#s.removeStandaloneCommentButton(),this.#a=null}hideStandaloneCommentButton(){this.#a?.classList.add("hidden")}get comment(){const{data:{richText:t,text:e,date:s,deleted:i}}=this.#s;return{text:e,richText:t,date:s,deleted:i,color:this.getNonHCMColor(),opacity:this.opacity??1}}set comment(t){this.#s||=new We(this),this.#s.data=t,this.hasComment?(this.removeCommentButtonFromToolbar(),this.addStandaloneCommentButton(),this._uiManager.updateComment(this)):(this.addCommentButtonInToolbar(),this.removeStandaloneCommentButton(),this._uiManager.removeComment(this))}setCommentData({comment:t,popupRef:e,richText:s}){if(!e||(this.#s||=new We(this),this.#s.setInitialText(t,s),!this.annotationElementId))return;const i=this._uiManager.getAndRemoveDataFromAnnotationStorage(this.annotationElementId);i&&this.updateFromAnnotationLayer(i)}get hasEditedComment(){return this.#s?.hasBeenEdited()}get hasDeletedComment(){return this.#s?.isDeleted()}get hasComment(){return!!this.#s&&!this.#s.isEmpty()&&!this.#s.isDeleted()}async editComment(t){this.#s||=new We(this),this.#s.edit(t)}toggleComment(t,e=void 0){this.hasComment&&this._uiManager.toggleComment(this,t,e)}setSelectedCommentButton(t){this.#s.setSelectedButton(t)}addComment(t){if(this.hasEditedComment){const[,,,i]=t.rect,[n]=this.pageDimensions,[r]=this.pageTranslation,a=r+n+1,o=i-100,l=a+180;t.popup={contents:this.comment.text,deleted:this.comment.deleted,rect:[a,o,l,i]}}}updateFromAnnotationLayer({popup:{contents:t,deleted:e}}){this.#s.data=e?null:t}get parentBoundingClientRect(){return this.parent.boundingClientRect}render(){const t=this.div=document.createElement("div");t.setAttribute("data-editor-rotation",(360-this.rotation)%360),t.className=this.name,t.setAttribute("id",this.id),t.tabIndex=this.#n?-1:0,t.setAttribute("role","application"),this.defaultL10nId&&t.setAttribute("data-l10n-id",this.defaultL10nId),this._isVisible||t.classList.add("hidden"),this.setInForeground(),this.#U();const[e,s]=this.parentDimensions;this.parentRotation%180!==0&&(t.style.maxWidth=`${(100*s/e).toFixed(2)}%`,t.style.maxHeight=`${(100*e/s).toFixed(2)}%`);const[i,n]=this.getInitialTranslation();return this.translate(i,n),zi(this,t,["keydown","pointerdown","dblclick"]),this.isResizable&&this._uiManager._supportsPinchToZoom&&(this.#T||=new us({container:t,isPinchingDisabled:()=>!this.isSelected,onPinchStart:this.#G.bind(this),onPinching:this.#C.bind(this),onPinchEnd:this.#A.bind(this),signal:this._uiManager._signal})),this.addStandaloneCommentButton(),this._uiManager._editorUndoBar?.hide(),t}#G(){this.#u={savedX:this.x,savedY:this.y,savedWidth:this.width,savedHeight:this.height},this.#i?.toggle(!1),this.parent.togglePointerEvents(!1)}#C(t,e,s){let n=.7*(s/e)+1-.7;if(n===1)return;const r=this.#P(this.rotation),a=(w,_)=>[r[0]*w+r[2]*_,r[1]*w+r[3]*_],[o,l]=this.parentDimensions,h=this.x,c=this.y,u=this.width,f=this.height,m=j.MIN_SIZE/o,p=j.MIN_SIZE/l;n=Math.max(Math.min(n,1/u,1/f),m/u,p/f);const b=j._round(u*n),g=j._round(f*n);if(b===u&&g===f)return;this.#c||=[h,c,u,f];const v=a(u/2,f/2),y=j._round(h+v[0]),S=j._round(c+v[1]),A=a(b/2,g/2);this.x=y-A[0],this.y=S-A[1],this.width=b,this.height=g,this.setDims(),this.fixAndSetPosition(),this._onResizing()}#A(){this.#i?.toggle(!0),this.parent.togglePointerEvents(!0),this.#B()}pointerdown(t){const{isMac:e}=_t.platform;if(t.button!==0||t.ctrlKey&&e){t.preventDefault();return}if(this.#p=!0,this._isDraggable){this.#j(t);return}this.#D(t)}#D(t){const{isMac:e}=_t.platform;t.ctrlKey&&!e||t.shiftKey||t.metaKey&&e?this.parent.toggleSelected(this):this.parent.setSelected(this)}#j(t){const{isSelected:e}=this;this._uiManager.setUpDragSession();let s=!1;const i=new AbortController,n=this._uiManager.combinedSignal(i),r={capture:!0,passive:!1,signal:n},a=l=>{i.abort(),this.#r=null,this.#p=!1,this._uiManager.endDragSession()||this.#D(l),s&&this._onStopDragging()};e&&(this.#E=t.clientX,this.#_=t.clientY,this.#r=t.pointerId,this.#o=t.pointerType,window.addEventListener("pointermove",l=>{s||(s=!0,this._uiManager.toggleComment(this,!0,!1),this._onStartDragging());const{clientX:h,clientY:c,pointerId:u}=l;if(u!==this.#r){ht(l);return}const[f,m]=this.screenToPageTranslation(h-this.#E,c-this.#_);this.#E=h,this.#_=c,this._uiManager.dragSelectedEditors(f,m)},r),window.addEventListener("touchmove",ht,r),window.addEventListener("pointerdown",l=>{l.pointerType===this.#o&&(this.#T||l.isPrimary)&&a(l),ht(l)},r));const o=l=>{if(!this.#r||this.#r===l.pointerId){a(l);return}ht(l)};window.addEventListener("pointerup",o,{signal:n}),window.addEventListener("blur",o,{signal:n})}_onStartDragging(){}_onStopDragging(){}moveInDOM(){this.#y&&clearTimeout(this.#y),this.#y=setTimeout(()=>{this.#y=null,this.parent?.moveEditorInDOM(this)},0)}_setParentAndPosition(t,e,s){t.changeParent(this),this.x=e,this.y=s,this.fixAndSetPosition(),this._onTranslated()}getRect(t,e,s=this.rotation){const i=this.parentScale,[n,r]=this.pageDimensions,[a,o]=this.pageTranslation,l=t/i,h=e/i,c=this.x*n,u=this.y*r,f=this.width*n,m=this.height*r;switch(s){case 0:return[c+l+a,r-u-h-m+o,c+l+f+a,r-u-h+o];case 90:return[c+h+a,r-u+l+o,c+h+m+a,r-u+l+f+o];case 180:return[c-l-f+a,r-u+h+o,c-l+a,r-u+h+m+o];case 270:return[c-h-m+a,r-u-l-f+o,c-h+a,r-u-l+o];default:throw new Error("Invalid rotation")}}getRectInCurrentCoords(t,e){const[s,i,n,r]=t,a=n-s,o=r-i;switch(this.rotation){case 0:return[s,e-r,a,o];case 90:return[s,e-i,o,a];case 180:return[n,e-i,a,o];case 270:return[n,e-r,o,a];default:throw new Error("Invalid rotation")}}getPDFRect(){return this.getRect(0,0)}getNonHCMColor(){return this.color&&j._colorManager.convert(this._uiManager.getNonHCMColor(this.color))}onUpdatedColor(){this.#s?.onUpdatedColor()}getData(){const{comment:{text:t,color:e,date:s,opacity:i,deleted:n,richText:r},uid:a,pageIndex:o,creationDate:l,modificationDate:h}=this;return{id:a,pageIndex:o,rect:this.getPDFRect(),richText:r,contentsObj:{str:t},creationDate:l,modificationDate:s||h,popupRef:!n,color:e,opacity:i}}onceAdded(t){}isEmpty(){return!1}enableEditMode(){return this.isInEditMode()?!1:(this.parent.setEditingState(!1),this.#b=!0,!0)}disableEditMode(){return this.isInEditMode()?(this.parent.setEditingState(!0),this.#b=!1,!0):!1}isInEditMode(){return this.#b}shouldGetKeyboardEvents(){return this.#w}needsToBeRebuilt(){return this.div&&!this.isAttachedToDOM}get isOnScreen(){const{top:t,left:e,bottom:s,right:i}=this.getClientDimensions(),{innerHeight:n,innerWidth:r}=window;return e<r&&i>0&&t<n&&s>0}#U(){if(this.#f||!this.div)return;this.#f=new AbortController;const t=this._uiManager.combinedSignal(this.#f);this.div.addEventListener("focusin",this.focusin.bind(this),{signal:t}),this.div.addEventListener("focusout",this.focusout.bind(this),{signal:t})}rebuild(){this.#U()}rotate(t){}resize(){}serializeDeleted(){return{id:this.annotationElementId,deleted:!0,pageIndex:this.pageIndex,popupRef:this._initialData?.popupRef||""}}serialize(t=!1,e=null){return{annotationType:this.mode,pageIndex:this.pageIndex,rect:this.getPDFRect(),rotation:this.rotation,structTreeParentId:this._structTreeParentId,popupRef:this._initialData?.popupRef||""}}static async deserialize(t,e,s){const i=new this.prototype.constructor({parent:e,id:e.getNextId(),uiManager:s,annotationElementId:t.annotationElementId,creationDate:t.creationDate,modificationDate:t.modificationDate});i.rotation=t.rotation,i.#t=t.accessibilityData,i._isCopy=t.isCopy||!1;const[n,r]=i.pageDimensions,[a,o,l,h]=i.getRectInCurrentCoords(t.rect,r);return i.x=a/n,i.y=o/r,i.width=l/n,i.height=h/r,i}get hasBeenModified(){return!!this.annotationElementId&&(this.deleted||this.serialize()!==null)}remove(){if(this.#f?.abort(),this.#f=null,this.isEmpty()||this.commit(),this.parent?this.parent.remove(this):this._uiManager.removeEditor(this),this.#y&&(clearTimeout(this.#y),this.#y=null),this.#F(),this.removeEditToolbar(),this.#v){for(const t of this.#v.values())clearTimeout(t);this.#v=null}this.parent=null,this.#T?.destroy(),this.#T=null}get isResizable(){return!1}makeResizable(){this.isResizable&&(this.#O(),this.#h.classList.remove("hidden"))}get toolbarPosition(){return null}get commentButtonPosition(){return this._uiManager.direction==="ltr"?[1,0]:[0,0]}get commentButtonPositionInPage(){const{commentButtonPosition:[t,e]}=this,[s,i,n,r]=this.getPDFRect();return[j._round(s+(n-s)*t),j._round(i+(r-i)*(1-e))]}get commentButtonColor(){return this._uiManager.makeCommentColor(this.getNonHCMColor(),this.opacity)}get commentPopupPosition(){return this.#s.commentPopupPositionInLayer}set commentPopupPosition(t){this.#s.commentPopupPositionInLayer=t}hasDefaultPopupPosition(){return this.#s.hasDefaultPopupPosition()}get commentButtonWidth(){return this.#s.commentButtonWidth}get elementBeforePopup(){return this.div}setCommentButtonStates(t){this.#s.setCommentButtonStates(t)}keydown(t){if(!this.isResizable||t.target!==this.div||t.key!=="Enter")return;this._uiManager.setSelected(this),this.#u={savedX:this.x,savedY:this.y,savedWidth:this.width,savedHeight:this.height};const e=this.#h.children;if(!this.#e){this.#e=Array.from(e);const r=this.#q.bind(this),a=this.#W.bind(this),o=this._uiManager._signal;for(const l of this.#e){const h=l.getAttribute("data-resizer-name");l.setAttribute("role","spinbutton"),l.addEventListener("keydown",r,{signal:o}),l.addEventListener("blur",a,{signal:o}),l.addEventListener("focus",this.#X.bind(this,h),{signal:o}),l.setAttribute("data-l10n-id",j._l10nResizer[h])}}const s=this.#e[0];let i=0;for(const r of e){if(r===s)break;i++}const n=(360-this.rotation+this.parentRotation)%360/90*(this.#e.length/4);if(n!==i){if(n<i)for(let a=0;a<i-n;a++)this.#h.append(this.#h.firstChild);else if(n>i)for(let a=0;a<n-i;a++)this.#h.firstChild.before(this.#h.lastChild);let r=0;for(const a of e){const l=this.#e[r++].getAttribute("data-resizer-name");a.setAttribute("data-l10n-id",j._l10nResizer[l])}}this.#z(0),this.#w=!0,this.#h.firstChild.focus({focusVisible:!0}),t.preventDefault(),t.stopImmediatePropagation()}#q(t){j._resizerKeyboardManager.exec(this,t)}#W(t){this.#w&&t.relatedTarget?.parentNode!==this.#h&&this.#F()}#X(t){this.#m=this.#w?t:""}#z(t){if(this.#e)for(const e of this.#e)e.tabIndex=t}_resizeWithKeyboard(t,e){this.#w&&this.#N(this.#m,{deltaX:t,deltaY:e,fromKeyboard:!0})}#F(){this.#w=!1,this.#z(-1),this.#B()}_stopResizingWithKeyboard(){this.#F(),this.div.focus()}select(){if(this.isSelected&&this._editToolbar){this._editToolbar.show();return}if(this.isSelected=!0,this.makeResizable(),this.div?.classList.add("selectedEditor"),!this._editToolbar){this.addEditToolbar().then(()=>{this.div?.classList.contains("selectedEditor")&&this._editToolbar?.show()});return}this._editToolbar?.show(),this.#i?.toggleAltTextBadge(!1)}focus(){this.div&&!this.div.contains(document.activeElement)&&setTimeout(()=>this.div?.focus({preventScroll:!0}),0)}unselect(){this.isSelected&&(this.isSelected=!1,this.#h?.classList.add("hidden"),this.div?.classList.remove("selectedEditor"),this.div?.contains(document.activeElement)&&this._uiManager.currentLayer.div.focus({preventScroll:!0}),this._editToolbar?.hide(),this.#i?.toggleAltTextBadge(!0),this.hasComment&&this._uiManager.toggleComment(this,!1,!1))}updateParams(t,e){}disableEditing(){}enableEditing(){}get canChangeContent(){return!1}enterInEditMode(){this.canChangeContent&&(this.enableEditMode(),this.div.focus())}dblclick(t){t.target.nodeName!=="BUTTON"&&(this.enterInEditMode(),this.parent.updateToolbar({mode:this.constructor._editorType,editId:this.id}))}getElementForAltText(){return this.div}get contentDiv(){return this.div}get isEditing(){return this.#g}set isEditing(t){this.#g=t,this.parent&&(t?(this.parent.setSelected(this),this.parent.setActiveEditor(this)):this.parent.setActiveEditor(null))}static get MIN_SIZE(){return 16}static canCreateNewEmptyEditor(){return!0}get telemetryInitialData(){return{action:"added"}}get telemetryFinalData(){return null}_reportTelemetry(t,e=!1){if(e){this.#v||=new Map;const{action:s}=t;let i=this.#v.get(s);i&&clearTimeout(i),i=setTimeout(()=>{this._reportTelemetry(t),this.#v.delete(s),this.#v.size===0&&(this.#v=null)},j._telemetryTimeout),this.#v.set(s,i);return}t.type||=this.editorType,this._uiManager._eventBus.dispatch("reporttelemetry",{source:this,details:{type:"editing",data:t}})}show(t=this._isVisible){this.div.classList.toggle("hidden",!t),this._isVisible=t}enable(){this.div&&(this.div.tabIndex=0),this.#n=!1}disable(){this.div&&(this.div.tabIndex=-1),this.#n=!0}updateFakeAnnotationElement(t){if(!this.#d&&!this.deleted){this.#d=t.addFakeAnnotation(this);return}if(this.deleted){this.#d.remove(),this.#d=null;return}(this.hasEditedComment||this._hasBeenMoved||this._hasBeenResized)&&this.#d.updateEdited({rect:this.getPDFRect(),popup:this.comment})}renderAnnotationElement(t){if(this.deleted)return t.hide(),null;let e=t.container.querySelector(".annotationContent");if(!e)e=document.createElement("div"),e.classList.add("annotationContent",this.editorType),t.container.prepend(e);else if(e.nodeName==="CANVAS"){const s=e;e=document.createElement("div"),e.classList.add("annotationContent",this.editorType),s.before(e)}return e}resetAnnotationElement(t){const{firstChild:e}=t.container;e?.nodeName==="DIV"&&e.classList.contains("annotationContent")&&e.remove()}}class qn extends j{constructor(t){super(t),this.annotationElementId=t.annotationElementId,this.deleted=!0}serialize(){return this.serializeDeleted()}}const pi=3285377520,Ft=4294901760,Gt=65535;class $i{constructor(t){this.h1=t?t&4294967295:pi,this.h2=t?t&4294967295:pi}update(t){let e,s;if(typeof t=="string"){e=new Uint8Array(t.length*2),s=0;for(let p=0,b=t.length;p<b;p++){const g=t.charCodeAt(p);g<=255?e[s++]=g:(e[s++]=g>>>8,e[s++]=g&255)}}else if(ArrayBuffer.isView(t))e=t.slice(),s=e.byteLength;else throw new Error("Invalid data format, must be a string or TypedArray.");const i=s>>2,n=s-i*4,r=new Uint32Array(e.buffer,0,i);let a=0,o=0,l=this.h1,h=this.h2;const c=3432918353,u=461845907,f=c&Gt,m=u&Gt;for(let p=0;p<i;p++)p&1?(a=r[p],a=a*c&Ft|a*f&Gt,a=a<<15|a>>>17,a=a*u&Ft|a*m&Gt,l^=a,l=l<<13|l>>>19,l=l*5+3864292196):(o=r[p],o=o*c&Ft|o*f&Gt,o=o<<15|o>>>17,o=o*u&Ft|o*m&Gt,h^=o,h=h<<13|h>>>19,h=h*5+3864292196);switch(a=0,n){case 3:a^=e[i*4+2]<<16;case 2:a^=e[i*4+1]<<8;case 1:a^=e[i*4],a=a*c&Ft|a*f&Gt,a=a<<15|a>>>17,a=a*u&Ft|a*m&Gt,i&1?l^=a:h^=a}this.h1=l,this.h2=h}hexdigest(){let t=this.h1,e=this.h2;return t^=e>>>1,t=t*3981806797&Ft|t*36045&Gt,e=e*4283543511&Ft|((e<<16|t>>>16)*2950163797&Ft)>>>16,t^=e>>>1,t=t*444984403&Ft|t*60499&Gt,e=e*3301882366&Ft|((e<<16|t>>>16)*3120437893&Ft)>>>16,t^=e>>>1,(t>>>0).toString(16).padStart(8,"0")+(e>>>0).toString(16).padStart(8,"0")}}const Rs=Object.freeze({map:null,hash:"",transfer:void 0});class Gs{#t=!1;#e=null;#i=null;#s=new Map;constructor(){this.onSetModified=null,this.onResetModified=null,this.onAnnotationEditor=null}getValue(t,e){const s=this.#s.get(t);return s===void 0?e:Object.assign(e,s)}getRawValue(t){return this.#s.get(t)}remove(t){const e=this.#s.get(t);if(e!==void 0&&(e instanceof j&&this.#i.delete(e.annotationElementId),this.#s.delete(t),this.#s.size===0&&this.resetModified(),typeof this.onAnnotationEditor=="function")){for(const s of this.#s.values())if(s instanceof j)return;this.onAnnotationEditor(null)}}setValue(t,e){const s=this.#s.get(t);let i=!1;if(s!==void 0)for(const[n,r]of Object.entries(e))s[n]!==r&&(i=!0,s[n]=r);else i=!0,this.#s.set(t,e);i&&this.#a(),e instanceof j&&((this.#i||=new Map).set(e.annotationElementId,e),typeof this.onAnnotationEditor=="function"&&this.onAnnotationEditor(e.constructor._type))}has(t){return this.#s.has(t)}get size(){return this.#s.size}#a(){this.#t||(this.#t=!0,typeof this.onSetModified=="function"&&this.onSetModified())}resetModified(){this.#t&&(this.#t=!1,typeof this.onResetModified=="function"&&this.onResetModified())}get print(){return new Gi(this)}get serializable(){if(this.#s.size===0)return Rs;const t=new Map,e=new $i,s=[],i=Object.create(null);let n=!1;for(const[r,a]of this.#s){const o=a instanceof j?a.serialize(!1,i):a;o&&(t.set(r,o),e.update(`${r}:${JSON.stringify(o)}`),n||=!!o.bitmap)}if(n)for(const r of t.values())r.bitmap&&s.push(r.bitmap);return t.size>0?{map:t,hash:e.hexdigest(),transfer:s}:Rs}get editorStats(){let t=null;const e=new Map;let s=0,i=0;for(const n of this.#s.values()){if(!(n instanceof j)){n.popup&&(n.popup.deleted?i+=1:s+=1);continue}n.isCommentDeleted?i+=1:n.hasEditedComment&&(s+=1);const r=n.telemetryFinalData;if(!r)continue;const{type:a}=r;e.has(a)||e.set(a,Object.getPrototypeOf(n).constructor),t||=Object.create(null);const o=t[a]||=new Map;for(const[l,h]of Object.entries(r)){if(l==="type")continue;let c=o.get(l);c||(c=new Map,o.set(l,c));const u=c.get(h)??0;c.set(h,u+1)}}if((i>0||s>0)&&(t||=Object.create(null),t.comments={deleted:i,edited:s}),!t)return null;for(const[n,r]of e)t[n]=r.computeTelemetryFinalData(t[n]);return t}resetModifiedIds(){this.#e=null}updateEditor(t,e){const s=this.#i?.get(t);return s?(s.updateFromAnnotationLayer(e),!0):!1}getEditor(t){return this.#i?.get(t)||null}get modifiedIds(){if(this.#e)return this.#e;const t=[];if(this.#i)for(const e of this.#i.values())e.serialize()&&t.push(e.annotationElementId);return this.#e={ids:new Set(t),hash:t.join(",")}}[Symbol.iterator](){return this.#s.entries()}}class Gi extends Gs{#t;constructor(t){super();const{map:e,hash:s,transfer:i}=t.serializable,n=structuredClone(e,i?{transfer:i}:null);this.#t={map:n,hash:s,transfer:i}}get print(){nt("Should not call PrintAnnotationStorage.print")}get serializable(){return this.#t}get modifiedIds(){return W(this,"modifiedIds",{ids:new Set,hash:""})}}class Xn{#t=new Set;constructor({ownerDocument:t=globalThis.document,styleElement:e=null}){this._document=t,this.nativeFontFaces=new Set,this.styleElement=null,this.loadingRequests=[],this.loadTestFontId=0}addNativeFontFace(t){this.nativeFontFaces.add(t),this._document.fonts.add(t)}removeNativeFontFace(t){this.nativeFontFaces.delete(t),this._document.fonts.delete(t)}insertRule(t){this.styleElement||(this.styleElement=this._document.createElement("style"),this._document.documentElement.getElementsByTagName("head")[0].append(this.styleElement));const e=this.styleElement.sheet;e.insertRule(t,e.cssRules.length)}clear(){for(const t of this.nativeFontFaces)this._document.fonts.delete(t);this.nativeFontFaces.clear(),this.#t.clear(),this.styleElement&&(this.styleElement.remove(),this.styleElement=null)}async loadSystemFont({systemFontInfo:t,disableFontFace:e,_inspectFont:s}){if(!(!t||this.#t.has(t.loadedName))){if(Q(!e,"loadSystemFont shouldn't be called when `disableFontFace` is set."),this.isFontLoadingAPISupported){const{loadedName:i,src:n,style:r}=t,a=new FontFace(i,n,r);this.addNativeFontFace(a);try{await a.load(),this.#t.add(i),s?.(t)}catch{G(`Cannot load system font: ${t.baseFontName}, installing it could help to improve PDF rendering.`),this.removeNativeFontFace(a)}return}nt("Not implemented: loadSystemFont without the Font Loading API.")}}async bind(t){if(t.attached||t.missingFile&&!t.systemFontInfo)return;if(t.attached=!0,t.systemFontInfo){await this.loadSystemFont(t);return}if(this.isFontLoadingAPISupported){const s=t.createNativeFontFace();if(s){this.addNativeFontFace(s);try{await s.loaded}catch(i){throw G(`Failed to load font '${s.family}': '${i}'.`),t.disableFontFace=!0,i}}return}const e=t.createFontFaceRule();if(e){if(this.insertRule(e),this.isSyncFontLoadingSupported)return;await new Promise(s=>{const i=this._queueLoadingCallback(s);this._prepareFontLoadEvent(t,i)})}}get isFontLoadingAPISupported(){const t=!!this._document?.fonts;return W(this,"isFontLoadingAPISupported",t)}get isSyncFontLoadingSupported(){return W(this,"isSyncFontLoadingSupported",kt||_t.platform.isFirefox)}_queueLoadingCallback(t){function e(){for(Q(!i.done,"completeRequest() cannot be called twice."),i.done=!0;s.length>0&&s[0].done;){const n=s.shift();setTimeout(n.callback,0)}}const{loadingRequests:s}=this,i={done:!1,complete:e,callback:t};return s.push(i),i}get _loadTestFont(){const t=atob("T1RUTwALAIAAAwAwQ0ZGIDHtZg4AAAOYAAAAgUZGVE1lkzZwAAAEHAAAABxHREVGABQAFQAABDgAAAAeT1MvMlYNYwkAAAEgAAAAYGNtYXABDQLUAAACNAAAAUJoZWFk/xVFDQAAALwAAAA2aGhlYQdkA+oAAAD0AAAAJGhtdHgD6AAAAAAEWAAAAAZtYXhwAAJQAAAAARgAAAAGbmFtZVjmdH4AAAGAAAAAsXBvc3T/hgAzAAADeAAAACAAAQAAAAEAALZRFsRfDzz1AAsD6AAAAADOBOTLAAAAAM4KHDwAAAAAA+gDIQAAAAgAAgAAAAAAAAABAAADIQAAAFoD6AAAAAAD6AABAAAAAAAAAAAAAAAAAAAAAQAAUAAAAgAAAAQD6AH0AAUAAAKKArwAAACMAooCvAAAAeAAMQECAAACAAYJAAAAAAAAAAAAAQAAAAAAAAAAAAAAAFBmRWQAwAAuAC4DIP84AFoDIQAAAAAAAQAAAAAAAAAAACAAIAABAAAADgCuAAEAAAAAAAAAAQAAAAEAAAAAAAEAAQAAAAEAAAAAAAIAAQAAAAEAAAAAAAMAAQAAAAEAAAAAAAQAAQAAAAEAAAAAAAUAAQAAAAEAAAAAAAYAAQAAAAMAAQQJAAAAAgABAAMAAQQJAAEAAgABAAMAAQQJAAIAAgABAAMAAQQJAAMAAgABAAMAAQQJAAQAAgABAAMAAQQJAAUAAgABAAMAAQQJAAYAAgABWABYAAAAAAAAAwAAAAMAAAAcAAEAAAAAADwAAwABAAAAHAAEACAAAAAEAAQAAQAAAC7//wAAAC7////TAAEAAAAAAAABBgAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAMAAAAAAAD/gwAyAAAAAQAAAAAAAAAAAAAAAAAAAAABAAQEAAEBAQJYAAEBASH4DwD4GwHEAvgcA/gXBIwMAYuL+nz5tQXkD5j3CBLnEQACAQEBIVhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYAAABAQAADwACAQEEE/t3Dov6fAH6fAT+fPp8+nwHDosMCvm1Cvm1DAz6fBQAAAAAAAABAAAAAMmJbzEAAAAAzgTjFQAAAADOBOQpAAEAAAAAAAAADAAUAAQAAAABAAAAAgABAAAAAAAAAAAD6AAAAAAAAA==");return W(this,"_loadTestFont",t)}_prepareFontLoadEvent(t,e){function s(S,A){return S.charCodeAt(A)<<24|S.charCodeAt(A+1)<<16|S.charCodeAt(A+2)<<8|S.charCodeAt(A+3)&255}function i(S,A,w,_){const x=S.substring(0,A),E=S.substring(A+w);return x+_+E}let n,r;const a=this._document.createElement("canvas");a.width=1,a.height=1;const o=a.getContext("2d");let l=0;function h(S,A){if(++l>30){G("Load test font never loaded."),A();return}if(o.font="30px "+S,o.fillText(".",0,20),o.getImageData(0,0,1,1).data[3]>0){A();return}setTimeout(h.bind(null,S,A))}const c=`lt${Date.now()}${this.loadTestFontId++}`;let u=this._loadTestFont;u=i(u,976,c.length,c);const m=16,p=1482184792;let b=s(u,m);for(n=0,r=c.length-3;n<r;n+=4)b=b-p+s(c,n)|0;n<c.length&&(b=b-p+s(c+"XXX",n)|0),u=i(u,m,4,kn(b));const g=`url(data:font/opentype;base64,${btoa(u)});`,v=`@font-face {font-family:"${c}";src:${g}}`;this.insertRule(v);const y=this._document.createElement("div");y.style.visibility="hidden",y.style.width=y.style.height="10px",y.style.position="absolute",y.style.top=y.style.left="0px";for(const S of[t.loadedName,c]){const A=this._document.createElement("span");A.textContent="Hi",A.style.fontFamily=S,y.append(A)}this._document.body.append(y),h(c,()=>{y.remove(),e.complete()})}}class Yn{#t;constructor(t,e=null,s,i){this.compiledGlyphs=Object.create(null),this.#t=t,this._inspectFont=e,s&&Object.assign(this,s),i&&(this.charProcOperatorList=i)}createNativeFontFace(){if(!this.data||this.disableFontFace)return null;let t;if(!this.cssFontInfo)t=new FontFace(this.loadedName,this.data,{});else{const e={weight:this.cssFontInfo.fontWeight};this.cssFontInfo.italicAngle&&(e.style=`oblique ${this.cssFontInfo.italicAngle}deg`),t=new FontFace(this.cssFontInfo.fontFamily,this.data,e)}return this._inspectFont?.(this),t}createFontFaceRule(){if(!this.data||this.disableFontFace)return null;const t=`url(data:${this.mimetype};base64,${ji(this.data)});`;let e;if(!this.cssFontInfo)e=`@font-face {font-family:"${this.loadedName}";src:${t}}`;else{let s=`font-weight: ${this.cssFontInfo.fontWeight};`;this.cssFontInfo.italicAngle&&(s+=`font-style: oblique ${this.cssFontInfo.italicAngle}deg;`),e=`@font-face {font-family:"${this.cssFontInfo.fontFamily}";${s}src:${t}}`}return this._inspectFont?.(this,t),e}getPathGenerator(t,e){if(this.compiledGlyphs[e]!==void 0)return this.compiledGlyphs[e];const s=this.loadedName+"_path_"+e;let i;try{i=t.get(s)}catch(r){G(`getPathGenerator - ignoring character: "${r}".`)}const n=new Path2D(i||"");return this.fontExtraProperties||t.delete(s),this.compiledGlyphs[e]=n}get black(){return this.#t.black}get bold(){return this.#t.bold}get disableFontFace(){return this.#t.disableFontFace??!1}get fontExtraProperties(){return this.#t.fontExtraProperties??!1}get isInvalidPDFjsFont(){return this.#t.isInvalidPDFjsFont}get isType3Font(){return this.#t.isType3Font}get italic(){return this.#t.italic}get missingFile(){return this.#t.missingFile}get remeasure(){return this.#t.remeasure}get vertical(){return this.#t.vertical}get ascent(){return this.#t.ascent}get defaultWidth(){return this.#t.defaultWidth}get descent(){return this.#t.descent}get bbox(){return this.#t.bbox}get fontMatrix(){return this.#t.fontMatrix}get fallbackName(){return this.#t.fallbackName}get loadedName(){return this.#t.loadedName}get mimetype(){return this.#t.mimetype}get name(){return this.#t.name}get data(){return this.#t.data}clearData(){this.#t.clearData()}get cssFontInfo(){return this.#t.cssFontInfo}get systemFontInfo(){return this.#t.systemFontInfo}get defaultVMetrics(){return this.#t.defaultVMetrics}}function Kn(d){if(d instanceof URL)return d.href;if(typeof d=="string"){if(kt)return d;const t=URL.parse(d,window.location);if(t)return t.href}throw new Error("Invalid PDF url data: either string or URL-object is expected in the url property.")}function Qn(d){if(kt&&typeof Buffer<"u"&&d instanceof Buffer)throw new Error("Please provide binary data as `Uint8Array`, rather than `Buffer`.");if(d instanceof Uint8Array&&d.byteLength===d.buffer.byteLength)return d;if(typeof d=="string")return Be(d);if(d instanceof ArrayBuffer||ArrayBuffer.isView(d)||typeof d=="object"&&!isNaN(d?.length))return new Uint8Array(d);throw new Error("Invalid PDF binary data: either TypedArray, string, or array-like object is expected in the data property.")}function qe(d){if(typeof d!="string")return null;if(d.endsWith("/"))return d;throw new Error(`Invalid factory url: "${d}" must include trailing slash.`)}const Ls=d=>typeof d=="object"&&Number.isInteger(d?.num)&&d.num>=0&&Number.isInteger(d?.gen)&&d.gen>=0,Jn=d=>typeof d=="object"&&typeof d?.name=="string",Zn=Dn.bind(null,Ls,Jn);class tr{#t=new Map;#e=Promise.resolve();postMessage(t,e){const s={data:structuredClone(t,e?{transfer:e}:null)};this.#e.then(()=>{for(const[i]of this.#t)i.call(this,s)})}addEventListener(t,e,s=null){let i=null;if(s?.signal instanceof AbortSignal){const{signal:n}=s;if(n.aborted){G("LoopbackPort - cannot use an `aborted` signal.");return}const r=()=>this.removeEventListener(t,e);i=()=>n.removeEventListener("abort",r),n.addEventListener("abort",r)}this.#t.set(e,i)}removeEventListener(t,e){this.#t.get(e)?.(),this.#t.delete(e)}terminate(){for(const[,t]of this.#t)t?.();this.#t.clear()}}const Xe={DATA:1,ERROR:2},pt={CANCEL:1,CANCEL_COMPLETE:2,CLOSE:3,ENQUEUE:4,ERROR:5,PULL:6,PULL_COMPLETE:7,START_COMPLETE:8};function gi(){}function Lt(d){if(d instanceof ee||d instanceof Ts||d instanceof oi||d instanceof ns||d instanceof ys)return d;switch(d instanceof Error||typeof d=="object"&&d!==null||nt('wrapReason: Expected "reason" to be a (possibly cloned) Error.'),d.name){case"AbortException":return new ee(d.message);case"InvalidPDFException":return new Ts(d.message);case"PasswordException":return new oi(d.message,d.code);case"ResponseException":return new ns(d.message,d.status,d.missing);case"UnknownErrorException":return new ys(d.message,d.details)}return new ys(d.message,d.toString())}class Me{#t=new AbortController;constructor(t,e,s){this.sourceName=t,this.targetName=e,this.comObj=s,this.callbackId=1,this.streamId=1,this.streamSinks=Object.create(null),this.streamControllers=Object.create(null),this.callbackCapabilities=Object.create(null),this.actionHandler=Object.create(null),s.addEventListener("message",this.#e.bind(this),{signal:this.#t.signal})}#e({data:t}){if(t.targetName!==this.sourceName)return;if(t.stream){this.#s(t);return}if(t.callback){const s=t.callbackId,i=this.callbackCapabilities[s];if(!i)throw new Error(`Cannot resolve callback ${s}`);if(delete this.callbackCapabilities[s],t.callback===Xe.DATA)i.resolve(t.data);else if(t.callback===Xe.ERROR)i.reject(Lt(t.reason));else throw new Error("Unexpected callback case");return}const e=this.actionHandler[t.action];if(!e)throw new Error(`Unknown action from worker: ${t.action}`);if(t.callbackId){const s=this.sourceName,i=t.sourceName,n=this.comObj;Promise.try(e,t.data).then(function(r){n.postMessage({sourceName:s,targetName:i,callback:Xe.DATA,callbackId:t.callbackId,data:r})},function(r){n.postMessage({sourceName:s,targetName:i,callback:Xe.ERROR,callbackId:t.callbackId,reason:Lt(r)})});return}if(t.streamId){this.#i(t);return}e(t.data)}on(t,e){const s=this.actionHandler;if(s[t])throw new Error(`There is already an actionName called "${t}"`);s[t]=e}send(t,e,s){this.comObj.postMessage({sourceName:this.sourceName,targetName:this.targetName,action:t,data:e},s)}sendWithPromise(t,e,s){const i=this.callbackId++,n=Promise.withResolvers();this.callbackCapabilities[i]=n;try{this.comObj.postMessage({sourceName:this.sourceName,targetName:this.targetName,action:t,callbackId:i,data:e},s)}catch(r){n.reject(r)}return n.promise}sendWithStream(t,e,s,i){const n=this.streamId++,r=this.sourceName,a=this.targetName,o=this.comObj;return new ReadableStream({start:l=>{const h=Promise.withResolvers();return this.streamControllers[n]={controller:l,startCall:h,pullCall:null,cancelCall:null,isClosed:!1},o.postMessage({sourceName:r,targetName:a,action:t,streamId:n,data:e,desiredSize:l.desiredSize},i),h.promise},pull:l=>{const h=Promise.withResolvers();return this.streamControllers[n].pullCall=h,o.postMessage({sourceName:r,targetName:a,stream:pt.PULL,streamId:n,desiredSize:l.desiredSize}),h.promise},cancel:l=>{Q(l instanceof Error,"cancel must have a valid reason");const h=Promise.withResolvers();return this.streamControllers[n].cancelCall=h,this.streamControllers[n].isClosed=!0,o.postMessage({sourceName:r,targetName:a,stream:pt.CANCEL,streamId:n,reason:Lt(l)}),h.promise}},s)}#i(t){const e=t.streamId,s=this.sourceName,i=t.sourceName,n=this.comObj,r=this,a=this.actionHandler[t.action],o={enqueue(l,h=1,c){if(this.isCancelled)return;const u=this.desiredSize;this.desiredSize-=h,u>0&&this.desiredSize<=0&&(this.sinkCapability=Promise.withResolvers(),this.ready=this.sinkCapability.promise),n.postMessage({sourceName:s,targetName:i,stream:pt.ENQUEUE,streamId:e,chunk:l},c)},close(){this.isCancelled||(this.isCancelled=!0,n.postMessage({sourceName:s,targetName:i,stream:pt.CLOSE,streamId:e}),delete r.streamSinks[e])},error(l){Q(l instanceof Error,"error must have a valid reason"),!this.isCancelled&&(this.isCancelled=!0,n.postMessage({sourceName:s,targetName:i,stream:pt.ERROR,streamId:e,reason:Lt(l)}))},sinkCapability:Promise.withResolvers(),onPull:null,onCancel:null,isCancelled:!1,desiredSize:t.desiredSize,ready:null};o.sinkCapability.resolve(),o.ready=o.sinkCapability.promise,this.streamSinks[e]=o,Promise.try(a,t.data,o).then(function(){n.postMessage({sourceName:s,targetName:i,stream:pt.START_COMPLETE,streamId:e,success:!0})},function(l){n.postMessage({sourceName:s,targetName:i,stream:pt.START_COMPLETE,streamId:e,reason:Lt(l)})})}#s(t){const e=t.streamId,s=this.sourceName,i=t.sourceName,n=this.comObj,r=this.streamControllers[e],a=this.streamSinks[e];switch(t.stream){case pt.START_COMPLETE:t.success?r.startCall.resolve():r.startCall.reject(Lt(t.reason));break;case pt.PULL_COMPLETE:t.success?r.pullCall.resolve():r.pullCall.reject(Lt(t.reason));break;case pt.PULL:if(!a){n.postMessage({sourceName:s,targetName:i,stream:pt.PULL_COMPLETE,streamId:e,success:!0});break}a.desiredSize<=0&&t.desiredSize>0&&a.sinkCapability.resolve(),a.desiredSize=t.desiredSize,Promise.try(a.onPull||gi).then(function(){n.postMessage({sourceName:s,targetName:i,stream:pt.PULL_COMPLETE,streamId:e,success:!0})},function(l){n.postMessage({sourceName:s,targetName:i,stream:pt.PULL_COMPLETE,streamId:e,reason:Lt(l)})});break;case pt.ENQUEUE:if(Q(r,"enqueue should have stream controller"),r.isClosed)break;r.controller.enqueue(t.chunk);break;case pt.CLOSE:if(Q(r,"close should have stream controller"),r.isClosed)break;r.isClosed=!0,r.controller.close(),this.#a(r,e);break;case pt.ERROR:Q(r,"error should have stream controller"),r.controller.error(Lt(t.reason)),this.#a(r,e);break;case pt.CANCEL_COMPLETE:t.success?r.cancelCall.resolve():r.cancelCall.reject(Lt(t.reason)),this.#a(r,e);break;case pt.CANCEL:if(!a)break;const o=Lt(t.reason);Promise.try(a.onCancel||gi,o).then(function(){n.postMessage({sourceName:s,targetName:i,stream:pt.CANCEL_COMPLETE,streamId:e,success:!0})},function(l){n.postMessage({sourceName:s,targetName:i,stream:pt.CANCEL_COMPLETE,streamId:e,reason:Lt(l)})}),a.sinkCapability.reject(o),a.isCancelled=!0,delete this.streamSinks[e];break;default:throw new Error("Unexpected stream case")}}async#a(t,e){await Promise.allSettled([t.startCall?.promise,t.pullCall?.promise,t.cancelCall?.promise]),delete this.streamControllers[e]}destroy(){this.#t?.abort(),this.#t=null}}class Vi{#t=!1;constructor({enableHWA:t=!1}){this.#t=t}create(t,e){if(t<=0||e<=0)throw new Error("Invalid canvas size");const s=this._createCanvas(t,e);return{canvas:s,context:s.getContext("2d",{willReadFrequently:!this.#t})}}reset(t,e,s){if(!t.canvas)throw new Error("Canvas is not specified");if(e<=0||s<=0)throw new Error("Invalid canvas size");t.canvas.width=e,t.canvas.height=s}destroy(t){if(!t.canvas)throw new Error("Canvas is not specified");t.canvas.width=0,t.canvas.height=0,t.canvas=null,t.context=null}_createCanvas(t,e){nt("Abstract method `_createCanvas` called.")}}class er extends Vi{constructor({ownerDocument:t=globalThis.document,enableHWA:e=!1}){super({enableHWA:e}),this._document=t}_createCanvas(t,e){const s=this._document.createElement("canvas");return s.width=t,s.height=e,s}}class Wi{constructor({baseUrl:t=null,isCompressed:e=!0}){this.baseUrl=t,this.isCompressed=e}async fetch({name:t}){if(!this.baseUrl)throw new Error("Ensure that the `cMapUrl` and `cMapPacked` API parameters are provided.");if(!t)throw new Error("CMap name must be specified.");const e=this.baseUrl+t+(this.isCompressed?".bcmap":"");return this._fetch(e).then(s=>({cMapData:s,isCompressed:this.isCompressed})).catch(s=>{throw new Error(`Unable to load ${this.isCompressed?"binary ":""}CMap at: ${e}`)})}async _fetch(t){nt("Abstract method `_fetch` called.")}}class mi extends Wi{async _fetch(t){const e=await je(t,this.isCompressed?"arraybuffer":"text");return e instanceof ArrayBuffer?new Uint8Array(e):Be(e)}}class qi{addFilter(t){return"none"}addHCMFilter(t,e){return"none"}addAlphaFilter(t){return"none"}addLuminosityFilter(t){return"none"}addHighlightHCMFilter(t,e,s,i,n){return"none"}destroy(t=!1){}}class sr extends qi{#t;#e;#i;#s;#a;#n;#r=0;constructor({docId:t,ownerDocument:e=globalThis.document}){super(),this.#s=t,this.#a=e}get#o(){return this.#e||=new Map}get#h(){return this.#n||=new Map}get#l(){if(!this.#i){const t=this.#a.createElement("div"),{style:e}=t;e.visibility="hidden",e.contain="strict",e.width=e.height=0,e.position="absolute",e.top=e.left=0,e.zIndex=-1;const s=this.#a.createElementNS(Yt,"svg");s.setAttribute("width",0),s.setAttribute("height",0),this.#i=this.#a.createElementNS(Yt,"defs"),t.append(s),s.append(this.#i),this.#a.body.append(t)}return this.#i}#u(t){if(t.length===1){const o=t[0],l=new Array(256);for(let c=0;c<256;c++)l[c]=o[c]/255;const h=l.join(",");return[h,h,h]}const[e,s,i]=t,n=new Array(256),r=new Array(256),a=new Array(256);for(let o=0;o<256;o++)n[o]=e[o]/255,r[o]=s[o]/255,a[o]=i[o]/255;return[n.join(","),r.join(","),a.join(",")]}#d(t){if(this.#t===void 0){this.#t="";const e=this.#a.URL;e!==this.#a.baseURI&&(ds(e)?G('#createUrl: ignore "data:"-URL for performance reasons.'):this.#t=Fi(e,""))}return`url(${this.#t}#${t})`}addFilter(t){if(!t)return"none";let e=this.#o.get(t);if(e)return e;const[s,i,n]=this.#u(t),r=t.length===1?s:`${s}${i}${n}`;if(e=this.#o.get(r),e)return this.#o.set(t,e),e;const a=`g_${this.#s}_transfer_map_${this.#r++}`,o=this.#d(a);this.#o.set(t,o),this.#o.set(r,o);const l=this.#p(a);return this.#g(s,i,n,l),o}addHCMFilter(t,e){const s=`${t}-${e}`,i="base";let n=this.#h.get(i);if(n?.key===s||(n?(n.filter?.remove(),n.key=s,n.url="none",n.filter=null):(n={key:s,url:"none",filter:null},this.#h.set(i,n)),!t||!e))return n.url;const r=this.#w(t);t=B.makeHexColor(...r);const a=this.#w(e);if(e=B.makeHexColor(...a),this.#l.style.color="",t==="#000000"&&e==="#ffffff"||t===e)return n.url;const o=new Array(256);for(let f=0;f<=255;f++){const m=f/255;o[f]=m<=.03928?m/12.92:((m+.055)/1.055)**2.4}const l=o.join(","),h=`g_${this.#s}_hcm_filter`,c=n.filter=this.#p(h);this.#g(l,l,l,c),this.#m(c);const u=(f,m)=>{const p=r[f]/255,b=a[f]/255,g=new Array(m+1);for(let v=0;v<=m;v++)g[v]=p+v/m*(b-p);return g.join(",")};return this.#g(u(0,5),u(1,5),u(2,5),c),n.url=this.#d(h),n.url}addAlphaFilter(t){let e=this.#o.get(t);if(e)return e;const[s]=this.#u([t]),i=`alpha_${s}`;if(e=this.#o.get(i),e)return this.#o.set(t,e),e;const n=`g_${this.#s}_alpha_map_${this.#r++}`,r=this.#d(n);this.#o.set(t,r),this.#o.set(i,r);const a=this.#p(n);return this.#b(s,a),r}addLuminosityFilter(t){let e=this.#o.get(t||"luminosity");if(e)return e;let s,i;if(t?([s]=this.#u([t]),i=`luminosity_${s}`):i="luminosity",e=this.#o.get(i),e)return this.#o.set(t,e),e;const n=`g_${this.#s}_luminosity_map_${this.#r++}`,r=this.#d(n);this.#o.set(t,r),this.#o.set(i,r);const a=this.#p(n);return this.#f(a),t&&this.#b(s,a),r}addHighlightHCMFilter(t,e,s,i,n){const r=`${e}-${s}-${i}-${n}`;let a=this.#h.get(t);if(a?.key===r||(a?(a.filter?.remove(),a.key=r,a.url="none",a.filter=null):(a={key:r,url:"none",filter:null},this.#h.set(t,a)),!e||!s))return a.url;const[o,l]=[e,s].map(this.#w.bind(this));let h=Math.round(.2126*o[0]+.7152*o[1]+.0722*o[2]),c=Math.round(.2126*l[0]+.7152*l[1]+.0722*l[2]),[u,f]=[i,n].map(this.#w.bind(this));c<h&&([h,c,u,f]=[c,h,f,u]),this.#l.style.color="";const m=(g,v,y)=>{const S=new Array(256),A=(c-h)/y,w=g/255,_=(v-g)/(255*y);let x=0;for(let E=0;E<=y;E++){const k=Math.round(h+E*A),T=w+E*_;for(let P=x;P<=k;P++)S[P]=T;x=k+1}for(let E=x;E<256;E++)S[E]=S[x-1];return S.join(",")},p=`g_${this.#s}_hcm_${t}_filter`,b=a.filter=this.#p(p);return this.#m(b),this.#g(m(u[0],f[0],5),m(u[1],f[1],5),m(u[2],f[2],5),b),a.url=this.#d(p),a.url}destroy(t=!1){t&&this.#n?.size||(this.#i?.parentNode.parentNode.remove(),this.#i=null,this.#e?.clear(),this.#e=null,this.#n?.clear(),this.#n=null,this.#r=0)}#f(t){const e=this.#a.createElementNS(Yt,"feColorMatrix");e.setAttribute("type","matrix"),e.setAttribute("values","0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0.3 0.59 0.11 0 0"),t.append(e)}#m(t){const e=this.#a.createElementNS(Yt,"feColorMatrix");e.setAttribute("type","matrix"),e.setAttribute("values","0.2126 0.7152 0.0722 0 0 0.2126 0.7152 0.0722 0 0 0.2126 0.7152 0.0722 0 0 0 0 0 1 0"),t.append(e)}#p(t){const e=this.#a.createElementNS(Yt,"filter");return e.setAttribute("color-interpolation-filters","sRGB"),e.setAttribute("id",t),this.#l.append(e),e}#c(t,e,s){const i=this.#a.createElementNS(Yt,e);i.setAttribute("type","discrete"),i.setAttribute("tableValues",s),t.append(i)}#g(t,e,s,i){const n=this.#a.createElementNS(Yt,"feComponentTransfer");i.append(n),this.#c(n,"feFuncR",t),this.#c(n,"feFuncG",e),this.#c(n,"feFuncB",s)}#b(t,e){const s=this.#a.createElementNS(Yt,"feComponentTransfer");e.append(s),this.#c(s,"feFuncA",t)}#w(t){return this.#l.style.color=t,Ue(getComputedStyle(this.#l).getPropertyValue("color"))}}class Xi{constructor({baseUrl:t=null}){this.baseUrl=t}async fetch({filename:t}){if(!this.baseUrl)throw new Error("Ensure that the `standardFontDataUrl` API parameter is provided.");if(!t)throw new Error("Font filename must be specified.");const e=`${this.baseUrl}${t}`;return this._fetch(e).catch(s=>{throw new Error(`Unable to load font data at: ${e}`)})}async _fetch(t){nt("Abstract method `_fetch` called.")}}class bi extends Xi{async _fetch(t){const e=await je(t,"arraybuffer");return new Uint8Array(e)}}class Yi{constructor({baseUrl:t=null}){this.baseUrl=t}async fetch({filename:t}){if(!this.baseUrl)throw new Error("Ensure that the `wasmUrl` API parameter is provided.");if(!t)throw new Error("Wasm filename must be specified.");const e=`${this.baseUrl}${t}`;return this._fetch(e).catch(s=>{throw new Error(`Unable to load wasm data at: ${e}`)})}async _fetch(t){nt("Abstract method `_fetch` called.")}}class yi extends Yi{async _fetch(t){const e=await je(t,"arraybuffer");return new Uint8Array(e)}}kt&&G("Please use the `legacy` build in Node.js environments.");async function Vs(d){const e=await process.getBuiltinModule("fs").promises.readFile(d);return new Uint8Array(e)}class ir extends qi{}class nr extends Vi{_createCanvas(t,e){return process.getBuiltinModule("module").createRequire(import.meta.url)("@napi-rs/canvas").createCanvas(t,e)}}class rr extends Wi{async _fetch(t){return Vs(t)}}class ar extends Xi{async _fetch(t){return Vs(t)}}class or extends Yi{async _fetch(t){return Vs(t)}}const fe="__forcedDependency",{floor:wi,ceil:vi}=Math;function Ye(d,t,e,s,i,n){d[t*4+0]=Math.min(d[t*4+0],e),d[t*4+1]=Math.min(d[t*4+1],s),d[t*4+2]=Math.max(d[t*4+2],i),d[t*4+3]=Math.max(d[t*4+3],n)}const Ds=new Uint32Array(new Uint8Array([255,255,0,0]).buffer)[0];class lr{#t;#e;constructor(t,e){this.#t=t,this.#e=e}get length(){return this.#t.length}isEmpty(t){return this.#t[t]===Ds}minX(t){return this.#e[t*4+0]/256}minY(t){return this.#e[t*4+1]/256}maxX(t){return(this.#e[t*4+2]+1)/256}maxY(t){return(this.#e[t*4+3]+1)/256}}const Ke=(d,t)=>{if(!d)return;let e=d.get(t);return e||(e={dependencies:new Set,isRenderingOperation:!1},d.set(t,e)),e};class hr{#t={__proto__:null};#e={__proto__:null,transform:[],moveText:[],sameLineText:[],[fe]:[]};#i=new Map;#s=[];#a=[];#n=[[1,0,0,1,0,0]];#r=[-1/0,-1/0,1/0,1/0];#o=new Float64Array([1/0,1/0,-1/0,-1/0]);#h=-1;#l=new Set;#u=new Map;#d=new Map;#f;#m;#p;#c;#g;constructor(t,e,s=!1){this.#f=t.width,this.#m=t.height,this.#b(e),s&&(this.#g=new Map)}growOperationsCount(t){t>=this.#c.length&&this.#b(t,this.#c)}#b(t,e){const s=new ArrayBuffer(t*4);this.#p=new Uint8ClampedArray(s),this.#c=new Uint32Array(s),e&&e.length>0?(this.#c.set(e),this.#c.fill(Ds,e.length)):this.#c.fill(Ds)}save(t){return this.#t={__proto__:this.#t},this.#e={__proto__:this.#e,transform:{__proto__:this.#e.transform},moveText:{__proto__:this.#e.moveText},sameLineText:{__proto__:this.#e.sameLineText},[fe]:{__proto__:this.#e[fe]}},this.#r={__proto__:this.#r},this.#s.push(t),this}restore(t){const e=Object.getPrototypeOf(this.#t);if(e===null)return this;this.#t=e,this.#e=Object.getPrototypeOf(this.#e),this.#r=Object.getPrototypeOf(this.#r);const s=this.#s.pop();return s!==void 0&&(Ke(this.#g,t)?.dependencies.add(s),this.#c[t]=this.#c[s]),this}recordOpenMarker(t){return this.#s.push(t),this}getOpenMarker(){return this.#s.length===0?null:this.#s.at(-1)}recordCloseMarker(t){const e=this.#s.pop();return e!==void 0&&(Ke(this.#g,t)?.dependencies.add(e),this.#c[t]=this.#c[e]),this}beginMarkedContent(t){return this.#a.push(t),this}endMarkedContent(t){const e=this.#a.pop();return e!==void 0&&(Ke(this.#g,t)?.dependencies.add(e),this.#c[t]=this.#c[e]),this}pushBaseTransform(t){return this.#n.push(B.multiplyByDOMMatrix(this.#n.at(-1),t.getTransform())),this}popBaseTransform(){return this.#n.length>1&&this.#n.pop(),this}recordSimpleData(t,e){return this.#t[t]=e,this}recordIncrementalData(t,e){return this.#e[t].push(e),this}resetIncrementalData(t,e){return this.#e[t].length=0,this}recordNamedData(t,e){return this.#i.set(t,e),this}recordSimpleDataFromNamed(t,e,s){this.#t[t]=this.#i.get(e)??s}recordFutureForcedDependency(t,e){return this.recordIncrementalData(fe,e),this}inheritSimpleDataAsFutureForcedDependencies(t){for(const e of t)e in this.#t&&this.recordFutureForcedDependency(e,this.#t[e]);return this}inheritPendingDependenciesAsFutureForcedDependencies(){for(const t of this.#l)this.recordFutureForcedDependency(fe,t);return this}resetBBox(t){return this.#h!==t&&(this.#h=t,this.#o[0]=1/0,this.#o[1]=1/0,this.#o[2]=-1/0,this.#o[3]=-1/0),this}recordClipBox(t,e,s,i,n,r){const a=B.multiplyByDOMMatrix(this.#n.at(-1),e.getTransform()),o=[1/0,1/0,-1/0,-1/0];B.axialAlignedBoundingBox([s,n,i,r],a,o);const l=B.intersect(this.#r,o);return l?(this.#r[0]=l[0],this.#r[1]=l[1],this.#r[2]=l[2],this.#r[3]=l[3]):(this.#r[0]=this.#r[1]=1/0,this.#r[2]=this.#r[3]=-1/0),this}recordBBox(t,e,s,i,n,r){const a=this.#r;if(a[0]===1/0)return this;const o=B.multiplyByDOMMatrix(this.#n.at(-1),e.getTransform());if(a[0]===-1/0)return B.axialAlignedBoundingBox([s,n,i,r],o,this.#o),this;const l=[1/0,1/0,-1/0,-1/0];return B.axialAlignedBoundingBox([s,n,i,r],o,l),this.#o[0]=Math.min(this.#o[0],Math.max(l[0],a[0])),this.#o[1]=Math.min(this.#o[1],Math.max(l[1],a[1])),this.#o[2]=Math.max(this.#o[2],Math.min(l[2],a[2])),this.#o[3]=Math.max(this.#o[3],Math.min(l[3],a[3])),this}recordCharacterBBox(t,e,s,i=1,n=0,r=0,a){const o=s.bbox;let l,h;if(o&&(l=o[2]!==o[0]&&o[3]!==o[1]&&this.#d.get(s),l!==!1&&(h=[0,0,0,0],B.axialAlignedBoundingBox(o,s.fontMatrix,h),(i!==1||n!==0||r!==0)&&B.scaleMinMax([i,0,0,-i,n,r],h),l)))return this.recordBBox(t,e,h[0],h[2],h[1],h[3]);if(!a)return this.recordFullPageBBox(t);const c=a();return o&&h&&l===void 0&&(l=h[0]<=n-c.actualBoundingBoxLeft&&h[2]>=n+c.actualBoundingBoxRight&&h[1]<=r-c.actualBoundingBoxAscent&&h[3]>=r+c.actualBoundingBoxDescent,this.#d.set(s,l),l)?this.recordBBox(t,e,h[0],h[2],h[1],h[3]):this.recordBBox(t,e,n-c.actualBoundingBoxLeft,n+c.actualBoundingBoxRight,r-c.actualBoundingBoxAscent,r+c.actualBoundingBoxDescent)}recordFullPageBBox(t){return this.#o[0]=Math.max(0,this.#r[0]),this.#o[1]=Math.max(0,this.#r[1]),this.#o[2]=Math.min(this.#f,this.#r[2]),this.#o[3]=Math.min(this.#m,this.#r[3]),this}getSimpleIndex(t){return this.#t[t]}recordDependencies(t,e){const s=this.#l,i=this.#t,n=this.#e;for(const r of e)r in this.#t?s.add(i[r]):r in n&&n[r].forEach(s.add,s);return this}recordNamedDependency(t,e){return this.#i.has(e)&&this.#l.add(this.#i.get(e)),this}recordOperation(t,e=!1){if(this.recordDependencies(t,[fe]),this.#g){const s=Ke(this.#g,t),{dependencies:i}=s;this.#l.forEach(i.add,i),this.#s.forEach(i.add,i),this.#a.forEach(i.add,i),i.delete(t),s.isRenderingOperation=!0}if(this.#h===t){const s=wi(this.#o[0]*256/this.#f),i=wi(this.#o[1]*256/this.#m),n=vi(this.#o[2]*256/this.#f),r=vi(this.#o[3]*256/this.#m);Ye(this.#p,t,s,i,n,r);for(const a of this.#l)a!==t&&Ye(this.#p,a,s,i,n,r);for(const a of this.#s)a!==t&&Ye(this.#p,a,s,i,n,r);for(const a of this.#a)a!==t&&Ye(this.#p,a,s,i,n,r);e||(this.#l.clear(),this.#h=-1)}return this}recordShowTextOperation(t,e=!1){const s=Array.from(this.#l);this.recordOperation(t,e),this.recordIncrementalData("sameLineText",t);for(const i of s)this.recordIncrementalData("sameLineText",i);return this}bboxToClipBoxDropOperation(t,e=!1){return this.#h===t&&(this.#h=-1,this.#r[0]=Math.max(this.#r[0],this.#o[0]),this.#r[1]=Math.max(this.#r[1],this.#o[1]),this.#r[2]=Math.min(this.#r[2],this.#o[2]),this.#r[3]=Math.min(this.#r[3],this.#o[3]),e||this.#l.clear()),this}_takePendingDependencies(){const t=this.#l;return this.#l=new Set,t}_extractOperation(t){const e=this.#u.get(t);return this.#u.delete(t),e}_pushPendingDependencies(t){for(const e of t)this.#l.add(e)}take(){return this.#d.clear(),new lr(this.#c,this.#p)}takeDebugMetadata(){return this.#g}}class rs{#t;#e;#i;#s=0;#a=0;constructor(t,e,s){if(t instanceof rs&&t.#i===!!s)return t;this.#t=t,this.#e=e,this.#i=!!s}growOperationsCount(){throw new Error("Unreachable")}save(t){return this.#a++,this.#t.save(this.#e),this}restore(t){return this.#a>0&&(this.#t.restore(this.#e),this.#a--),this}recordOpenMarker(t){return this.#s++,this}getOpenMarker(){return this.#s>0?this.#e:this.#t.getOpenMarker()}recordCloseMarker(t){return this.#s--,this}beginMarkedContent(t){return this}endMarkedContent(t){return this}pushBaseTransform(t){return this.#t.pushBaseTransform(t),this}popBaseTransform(){return this.#t.popBaseTransform(),this}recordSimpleData(t,e){return this.#t.recordSimpleData(t,this.#e),this}recordIncrementalData(t,e){return this.#t.recordIncrementalData(t,this.#e),this}resetIncrementalData(t,e){return this.#t.resetIncrementalData(t,this.#e),this}recordNamedData(t,e){return this}recordSimpleDataFromNamed(t,e,s){return this.#t.recordSimpleDataFromNamed(t,e,this.#e),this}recordFutureForcedDependency(t,e){return this.#t.recordFutureForcedDependency(t,this.#e),this}inheritSimpleDataAsFutureForcedDependencies(t){return this.#t.inheritSimpleDataAsFutureForcedDependencies(t),this}inheritPendingDependenciesAsFutureForcedDependencies(){return this.#t.inheritPendingDependenciesAsFutureForcedDependencies(),this}resetBBox(t){return this.#i||this.#t.resetBBox(this.#e),this}recordClipBox(t,e,s,i,n,r){return this.#i||this.#t.recordClipBox(this.#e,e,s,i,n,r),this}recordBBox(t,e,s,i,n,r){return this.#i||this.#t.recordBBox(this.#e,e,s,i,n,r),this}recordCharacterBBox(t,e,s,i,n,r,a){return this.#i||this.#t.recordCharacterBBox(this.#e,e,s,i,n,r,a),this}recordFullPageBBox(t){return this.#i||this.#t.recordFullPageBBox(this.#e),this}getSimpleIndex(t){return this.#t.getSimpleIndex(t)}recordDependencies(t,e){return this.#t.recordDependencies(this.#e,e),this}recordNamedDependency(t,e){return this.#t.recordNamedDependency(this.#e,e),this}recordOperation(t){return this.#t.recordOperation(this.#e,!0),this}recordShowTextOperation(t){return this.#t.recordShowTextOperation(this.#e,!0),this}bboxToClipBoxDropOperation(t){return this.#i||this.#t.bboxToClipBoxDropOperation(this.#e,!0),this}take(){throw new Error("Unreachable")}takeDebugMetadata(){throw new Error("Unreachable")}}const Ot={stroke:["path","transform","filter","strokeColor","strokeAlpha","lineWidth","lineCap","lineJoin","miterLimit","dash"],fill:["path","transform","filter","fillColor","fillAlpha","globalCompositeOperation","SMask"],imageXObject:["transform","SMask","filter","fillAlpha","strokeAlpha","globalCompositeOperation"],rawFillPath:["filter","fillColor","fillAlpha"],showText:["transform","leading","charSpacing","wordSpacing","hScale","textRise","moveText","textMatrix","font","fontObj","filter","fillColor","textRenderingMode","SMask","fillAlpha","strokeAlpha","globalCompositeOperation","sameLineText"],transform:["transform"],transformAndFill:["transform","fillColor"]},xt={FILL:"Fill",STROKE:"Stroke",SHADING:"Shading"};function Is(d,t){if(!t)return;const e=t[2]-t[0],s=t[3]-t[1],i=new Path2D;i.rect(t[0],t[1],e,s),d.clip(i)}class Ws{isModifyingCurrentTransform(){return!1}getPattern(){nt("Abstract method `getPattern` called.")}}class cr extends Ws{constructor(t){super(),this._type=t[1],this._bbox=t[2],this._colorStops=t[3],this._p0=t[4],this._p1=t[5],this._r0=t[6],this._r1=t[7],this.matrix=null}_createGradient(t){let e;this._type==="axial"?e=t.createLinearGradient(this._p0[0],this._p0[1],this._p1[0],this._p1[1]):this._type==="radial"&&(e=t.createRadialGradient(this._p0[0],this._p0[1],this._r0,this._p1[0],this._p1[1],this._r1));for(const s of this._colorStops)e.addColorStop(s[0],s[1]);return e}getPattern(t,e,s,i){let n;if(i===xt.STROKE||i===xt.FILL){const r=e.current.getClippedPathBoundingBox(i,ot(t))||[0,0,0,0],a=Math.ceil(r[2]-r[0])||1,o=Math.ceil(r[3]-r[1])||1,l=e.cachedCanvases.getCanvas("pattern",a,o),h=l.context;h.clearRect(0,0,h.canvas.width,h.canvas.height),h.beginPath(),h.rect(0,0,h.canvas.width,h.canvas.height),h.translate(-r[0],-r[1]),s=B.transform(s,[1,0,0,1,r[0],r[1]]),h.transform(...e.baseTransform),this.matrix&&h.transform(...this.matrix),Is(h,this._bbox),h.fillStyle=this._createGradient(h),h.fill(),n=t.createPattern(l.canvas,"no-repeat");const c=new DOMMatrix(s);n.setTransform(c)}else Is(t,this._bbox),n=this._createGradient(t);return n}}function As(d,t,e,s,i,n,r,a){const o=t.coords,l=t.colors,h=d.data,c=d.width*4;let u;o[e+1]>o[s+1]&&(u=e,e=s,s=u,u=n,n=r,r=u),o[s+1]>o[i+1]&&(u=s,s=i,i=u,u=r,r=a,a=u),o[e+1]>o[s+1]&&(u=e,e=s,s=u,u=n,n=r,r=u);const f=(o[e]+t.offsetX)*t.scaleX,m=(o[e+1]+t.offsetY)*t.scaleY,p=(o[s]+t.offsetX)*t.scaleX,b=(o[s+1]+t.offsetY)*t.scaleY,g=(o[i]+t.offsetX)*t.scaleX,v=(o[i+1]+t.offsetY)*t.scaleY;if(m>=v)return;const y=l[n],S=l[n+1],A=l[n+2],w=l[r],_=l[r+1],x=l[r+2],E=l[a],k=l[a+1],T=l[a+2],P=Math.round(m),M=Math.round(v);let I,R,D,O,N,H,q,ct;for(let Y=P;Y<=M;Y++){if(Y<b){const Z=Y<m?0:(m-Y)/(m-b);I=f-(f-p)*Z,R=y-(y-w)*Z,D=S-(S-_)*Z,O=A-(A-x)*Z}else{let Z;Y>v?Z=1:b===v?Z=0:Z=(b-Y)/(b-v),I=p-(p-g)*Z,R=w-(w-E)*Z,D=_-(_-k)*Z,O=x-(x-T)*Z}let z;Y<m?z=0:Y>v?z=1:z=(m-Y)/(m-v),N=f-(f-g)*z,H=y-(y-E)*z,q=S-(S-k)*z,ct=A-(A-T)*z;const J=Math.round(Math.min(I,N)),Et=Math.round(Math.max(I,N));let ft=c*Y+J*4;for(let Z=J;Z<=Et;Z++)z=(I-Z)/(I-N),z<0?z=0:z>1&&(z=1),h[ft++]=R-(R-H)*z|0,h[ft++]=D-(D-q)*z|0,h[ft++]=O-(O-ct)*z|0,h[ft++]=255}}function dr(d,t,e){const s=t.coords,i=t.colors;let n,r;switch(t.type){case"lattice":const a=t.verticesPerRow,o=Math.floor(s.length/a)-1,l=a-1;for(n=0;n<o;n++){let h=n*a;for(let c=0;c<l;c++,h++)As(d,e,s[h],s[h+1],s[h+a],i[h],i[h+1],i[h+a]),As(d,e,s[h+a+1],s[h+1],s[h+a],i[h+a+1],i[h+1],i[h+a])}break;case"triangles":for(n=0,r=s.length;n<r;n+=3)As(d,e,s[n],s[n+1],s[n+2],i[n],i[n+1],i[n+2]);break;default:throw new Error("illegal figure")}}class ur extends Ws{constructor(t){super(),this._coords=t[2],this._colors=t[3],this._figures=t[4],this._bounds=t[5],this._bbox=t[6],this._background=t[7],this.matrix=null}_createMeshCanvas(t,e,s){const a=Math.floor(this._bounds[0]),o=Math.floor(this._bounds[1]),l=Math.ceil(this._bounds[2])-a,h=Math.ceil(this._bounds[3])-o,c=Math.min(Math.ceil(Math.abs(l*t[0]*1.1)),3e3),u=Math.min(Math.ceil(Math.abs(h*t[1]*1.1)),3e3),f=l/c,m=h/u,p={coords:this._coords,colors:this._colors,offsetX:-a,offsetY:-o,scaleX:1/f,scaleY:1/m},b=c+4,g=u+4,v=s.getCanvas("mesh",b,g),y=v.context,S=y.createImageData(c,u);if(e){const w=S.data;for(let _=0,x=w.length;_<x;_+=4)w[_]=e[0],w[_+1]=e[1],w[_+2]=e[2],w[_+3]=255}for(const w of this._figures)dr(S,w,p);return y.putImageData(S,2,2),{canvas:v.canvas,offsetX:a-2*f,offsetY:o-2*m,scaleX:f,scaleY:m}}isModifyingCurrentTransform(){return!0}getPattern(t,e,s,i){Is(t,this._bbox);const n=new Float32Array(2);if(i===xt.SHADING)B.singularValueDecompose2dScale(ot(t),n);else if(this.matrix){B.singularValueDecompose2dScale(this.matrix,n);const[a,o]=n;B.singularValueDecompose2dScale(e.baseTransform,n),n[0]*=a,n[1]*=o}else B.singularValueDecompose2dScale(e.baseTransform,n);const r=this._createMeshCanvas(n,i===xt.SHADING?null:this._background,e.cachedCanvases);return i!==xt.SHADING&&(t.setTransform(...e.baseTransform),this.matrix&&t.transform(...this.matrix)),t.translate(r.offsetX,r.offsetY),t.scale(r.scaleX,r.scaleY),t.createPattern(r.canvas,"no-repeat")}}class fr extends Ws{getPattern(){return"hotpink"}}function pr(d){switch(d[0]){case"RadialAxial":return new cr(d);case"Mesh":return new ur(d);case"Dummy":return new fr}throw new Error(`Unknown IR type: ${d[0]}`)}const Ai={COLORED:1,UNCOLORED:2};class qs{static MAX_PATTERN_SIZE=3e3;constructor(t,e,s,i){this.color=t[1],this.operatorList=t[2],this.matrix=t[3],this.bbox=t[4],this.xstep=t[5],this.ystep=t[6],this.paintType=t[7],this.tilingType=t[8],this.ctx=e,this.canvasGraphicsFactory=s,this.baseTransform=i}createPatternCanvas(t,e){const{bbox:s,operatorList:i,paintType:n,tilingType:r,color:a,canvasGraphicsFactory:o}=this;let{xstep:l,ystep:h}=this;l=Math.abs(l),h=Math.abs(h),cs("TilingType: "+r);const c=s[0],u=s[1],f=s[2],m=s[3],p=f-c,b=m-u,g=new Float32Array(2);B.singularValueDecompose2dScale(this.matrix,g);const[v,y]=g;B.singularValueDecompose2dScale(this.baseTransform,g);const S=v*g[0],A=y*g[1];let w=p,_=b,x=!1,E=!1;const k=Math.ceil(l*S),T=Math.ceil(h*A),P=Math.ceil(p*S),M=Math.ceil(b*A);k>=P?w=l:x=!0,T>=M?_=h:E=!0;const I=this.getSizeAndScale(w,this.ctx.canvas.width,S),R=this.getSizeAndScale(_,this.ctx.canvas.height,A),D=t.cachedCanvases.getCanvas("pattern",I.size,R.size),O=D.context,N=o.createCanvasGraphics(O,e);if(N.groupLevel=t.groupLevel,this.setFillAndStrokeStyleToContext(N,n,a),O.translate(-I.scale*c,-R.scale*u),N.transform(0,I.scale,0,0,R.scale,0,0),O.save(),N.dependencyTracker?.save(),this.clipBbox(N,c,u,f,m),N.baseTransform=ot(N.ctx),N.executeOperatorList(i),N.endDrawing(),N.dependencyTracker?.restore(),O.restore(),x||E){const H=D.canvas;x&&(w=l),E&&(_=h);const q=this.getSizeAndScale(w,this.ctx.canvas.width,S),ct=this.getSizeAndScale(_,this.ctx.canvas.height,A),Y=q.size,z=ct.size,J=t.cachedCanvases.getCanvas("pattern-workaround",Y,z),Et=J.context,ft=x?Math.floor(p/l):0,Z=E?Math.floor(b/h):0;for(let wt=0;wt<=ft;wt++)for(let Xt=0;Xt<=Z;Xt++)Et.drawImage(H,Y*wt,z*Xt,Y,z,0,0,Y,z);return{canvas:J.canvas,scaleX:q.scale,scaleY:ct.scale,offsetX:c,offsetY:u}}return{canvas:D.canvas,scaleX:I.scale,scaleY:R.scale,offsetX:c,offsetY:u}}getSizeAndScale(t,e,s){const i=Math.max(qs.MAX_PATTERN_SIZE,e);let n=Math.ceil(t*s);return n>=i?n=i:s=n/t,{scale:s,size:n}}clipBbox(t,e,s,i,n){const r=i-e,a=n-s;t.ctx.rect(e,s,r,a),B.axialAlignedBoundingBox([e,s,i,n],ot(t.ctx),t.current.minMax),t.clip(),t.endPath()}setFillAndStrokeStyleToContext(t,e,s){const i=t.ctx,n=t.current;switch(e){case Ai.COLORED:const{fillStyle:r,strokeStyle:a}=this.ctx;i.fillStyle=n.fillColor=r,i.strokeStyle=n.strokeColor=a;break;case Ai.UNCOLORED:i.fillStyle=i.strokeStyle=s,n.fillColor=n.strokeColor=s;break;default:throw new Tn(`Unsupported paint type: ${e}`)}}isModifyingCurrentTransform(){return!1}getPattern(t,e,s,i,n){let r=s;i!==xt.SHADING&&(r=B.transform(r,e.baseTransform),this.matrix&&(r=B.transform(r,this.matrix)));const a=this.createPatternCanvas(e,n);let o=new DOMMatrix(r);o=o.translate(a.offsetX,a.offsetY),o=o.scale(1/a.scaleX,1/a.scaleY);const l=t.createPattern(a.canvas,"repeat");return l.setTransform(o),l}}function gr({src:d,srcPos:t=0,dest:e,width:s,height:i,nonBlackColor:n=4294967295,inverseDecode:r=!1}){const a=_t.isLittleEndian?4278190080:255,[o,l]=r?[n,a]:[a,n],h=s>>3,c=s&7,u=d.length;e=new Uint32Array(e.buffer);let f=0;for(let m=0;m<i;m++){for(const b=t+h;t<b;t++){const g=t<u?d[t]:255;e[f++]=g&128?l:o,e[f++]=g&64?l:o,e[f++]=g&32?l:o,e[f++]=g&16?l:o,e[f++]=g&8?l:o,e[f++]=g&4?l:o,e[f++]=g&2?l:o,e[f++]=g&1?l:o}if(c===0)continue;const p=t<u?d[t++]:255;for(let b=0;b<c;b++)e[f++]=p&1<<7-b?l:o}return{srcPos:t,destPos:f}}const xi=16,_i=100,mr=15,Si=10,Dt=16,xs=new DOMMatrix,Nt=new Float32Array(2),be=new Float32Array([1/0,1/0,-1/0,-1/0]);function br(d,t){if(d._removeMirroring)throw new Error("Context is already forwarding operations.");d.__originalSave=d.save,d.__originalRestore=d.restore,d.__originalRotate=d.rotate,d.__originalScale=d.scale,d.__originalTranslate=d.translate,d.__originalTransform=d.transform,d.__originalSetTransform=d.setTransform,d.__originalResetTransform=d.resetTransform,d.__originalClip=d.clip,d.__originalMoveTo=d.moveTo,d.__originalLineTo=d.lineTo,d.__originalBezierCurveTo=d.bezierCurveTo,d.__originalRect=d.rect,d.__originalClosePath=d.closePath,d.__originalBeginPath=d.beginPath,d._removeMirroring=()=>{d.save=d.__originalSave,d.restore=d.__originalRestore,d.rotate=d.__originalRotate,d.scale=d.__originalScale,d.translate=d.__originalTranslate,d.transform=d.__originalTransform,d.setTransform=d.__originalSetTransform,d.resetTransform=d.__originalResetTransform,d.clip=d.__originalClip,d.moveTo=d.__originalMoveTo,d.lineTo=d.__originalLineTo,d.bezierCurveTo=d.__originalBezierCurveTo,d.rect=d.__originalRect,d.closePath=d.__originalClosePath,d.beginPath=d.__originalBeginPath,delete d._removeMirroring},d.save=function(){t.save(),this.__originalSave()},d.restore=function(){t.restore(),this.__originalRestore()},d.translate=function(e,s){t.translate(e,s),this.__originalTranslate(e,s)},d.scale=function(e,s){t.scale(e,s),this.__originalScale(e,s)},d.transform=function(e,s,i,n,r,a){t.transform(e,s,i,n,r,a),this.__originalTransform(e,s,i,n,r,a)},d.setTransform=function(e,s,i,n,r,a){t.setTransform(e,s,i,n,r,a),this.__originalSetTransform(e,s,i,n,r,a)},d.resetTransform=function(){t.resetTransform(),this.__originalResetTransform()},d.rotate=function(e){t.rotate(e),this.__originalRotate(e)},d.clip=function(e){t.clip(e),this.__originalClip(e)},d.moveTo=function(e,s){t.moveTo(e,s),this.__originalMoveTo(e,s)},d.lineTo=function(e,s){t.lineTo(e,s),this.__originalLineTo(e,s)},d.bezierCurveTo=function(e,s,i,n,r,a){t.bezierCurveTo(e,s,i,n,r,a),this.__originalBezierCurveTo(e,s,i,n,r,a)},d.rect=function(e,s,i,n){t.rect(e,s,i,n),this.__originalRect(e,s,i,n)},d.closePath=function(){t.closePath(),this.__originalClosePath()},d.beginPath=function(){t.beginPath(),this.__originalBeginPath()}}class yr{constructor(t){this.canvasFactory=t,this.cache=Object.create(null)}getCanvas(t,e,s){let i;return this.cache[t]!==void 0?(i=this.cache[t],this.canvasFactory.reset(i,e,s)):(i=this.canvasFactory.create(e,s),this.cache[t]=i),i}delete(t){delete this.cache[t]}clear(){for(const t in this.cache){const e=this.cache[t];this.canvasFactory.destroy(e),delete this.cache[t]}}}function Qe(d,t,e,s,i,n,r,a,o,l){const[h,c,u,f,m,p]=ot(d);if(c===0&&u===0){const v=r*h+m,y=Math.round(v),S=a*f+p,A=Math.round(S),w=(r+o)*h+m,_=Math.abs(Math.round(w)-y)||1,x=(a+l)*f+p,E=Math.abs(Math.round(x)-A)||1;return d.setTransform(Math.sign(h),0,0,Math.sign(f),y,A),d.drawImage(t,e,s,i,n,0,0,_,E),d.setTransform(h,c,u,f,m,p),[_,E]}if(h===0&&f===0){const v=a*u+m,y=Math.round(v),S=r*c+p,A=Math.round(S),w=(a+l)*u+m,_=Math.abs(Math.round(w)-y)||1,x=(r+o)*c+p,E=Math.abs(Math.round(x)-A)||1;return d.setTransform(0,Math.sign(c),Math.sign(u),0,y,A),d.drawImage(t,e,s,i,n,0,0,E,_),d.setTransform(h,c,u,f,m,p),[E,_]}d.drawImage(t,e,s,i,n,r,a,o,l);const b=Math.hypot(h,c),g=Math.hypot(u,f);return[b*o,g*l]}class Ei{alphaIsShape=!1;fontSize=0;fontSizeScale=1;textMatrix=null;textMatrixScale=1;fontMatrix=Cs;leading=0;x=0;y=0;lineX=0;lineY=0;charSpacing=0;wordSpacing=0;textHScale=1;textRenderingMode=vt.FILL;textRise=0;fillColor="#000000";strokeColor="#000000";patternFill=!1;patternStroke=!1;fillAlpha=1;strokeAlpha=1;lineWidth=1;activeSMask=null;transferMaps="none";constructor(t,e,s){s?.(this),this.clipBox=new Float32Array([0,0,t,e]),this.minMax=be.slice()}clone(){const t=Object.create(this);return t.clipBox=this.clipBox.slice(),t.minMax=this.minMax.slice(),t}getPathBoundingBox(t=xt.FILL,e=null){const s=this.minMax.slice();if(t===xt.STROKE){e||nt("Stroke bounding box must include transform."),B.singularValueDecompose2dScale(e,Nt);const i=Nt[0]*this.lineWidth/2,n=Nt[1]*this.lineWidth/2;s[0]-=i,s[1]-=n,s[2]+=i,s[3]+=n}return s}updateClipFromPath(){const t=B.intersect(this.clipBox,this.getPathBoundingBox());this.startNewPathAndClipBox(t||[0,0,0,0])}isEmptyClip(){return this.minMax[0]===1/0}startNewPathAndClipBox(t){this.clipBox.set(t,0),this.minMax.set(be,0)}getClippedPathBoundingBox(t=xt.FILL,e=null){return B.intersect(this.clipBox,this.getPathBoundingBox(t,e))}}function Ci(d,t){if(t instanceof ImageData){d.putImageData(t,0,0);return}const e=t.height,s=t.width,i=e%Dt,n=(e-i)/Dt,r=i===0?n:n+1,a=d.createImageData(s,Dt);let o=0,l;const h=t.data,c=a.data;let u,f,m,p;if(t.kind===es.GRAYSCALE_1BPP){const b=h.byteLength,g=new Uint32Array(c.buffer,0,c.byteLength>>2),v=g.length,y=s+7>>3,S=4294967295,A=_t.isLittleEndian?4278190080:255;for(u=0;u<r;u++){for(m=u<n?Dt:i,l=0,f=0;f<m;f++){const w=b-o;let _=0;const x=w>y?s:w*8-7,E=x&-8;let k=0,T=0;for(;_<E;_+=8)T=h[o++],g[l++]=T&128?S:A,g[l++]=T&64?S:A,g[l++]=T&32?S:A,g[l++]=T&16?S:A,g[l++]=T&8?S:A,g[l++]=T&4?S:A,g[l++]=T&2?S:A,g[l++]=T&1?S:A;for(;_<x;_++)k===0&&(T=h[o++],k=128),g[l++]=T&k?S:A,k>>=1}for(;l<v;)g[l++]=0;d.putImageData(a,0,u*Dt)}}else if(t.kind===es.RGBA_32BPP){for(f=0,p=s*Dt*4,u=0;u<n;u++)c.set(h.subarray(o,o+p)),o+=p,d.putImageData(a,0,f),f+=Dt;u<r&&(p=s*i*4,c.set(h.subarray(o,o+p)),d.putImageData(a,0,f))}else if(t.kind===es.RGB_24BPP)for(m=Dt,p=s*m,u=0;u<r;u++){for(u>=n&&(m=i,p=s*m),l=0,f=p;f--;)c[l++]=h[o++],c[l++]=h[o++],c[l++]=h[o++],c[l++]=255;d.putImageData(a,0,u*Dt)}else throw new Error(`bad image kind: ${t.kind}`)}function Ti(d,t){if(t.bitmap){d.drawImage(t.bitmap,0,0);return}const e=t.height,s=t.width,i=e%Dt,n=(e-i)/Dt,r=i===0?n:n+1,a=d.createImageData(s,Dt);let o=0;const l=t.data,h=a.data;for(let c=0;c<r;c++){const u=c<n?Dt:i;({srcPos:o}=gr({src:l,srcPos:o,dest:h,width:s,height:u,nonBlackColor:0})),d.putImageData(a,0,c*Dt)}}function Ee(d,t){const e=["strokeStyle","fillStyle","fillRule","globalAlpha","lineWidth","lineCap","lineJoin","miterLimit","globalCompositeOperation","font","filter"];for(const s of e)d[s]!==void 0&&(t[s]=d[s]);d.setLineDash!==void 0&&(t.setLineDash(d.getLineDash()),t.lineDashOffset=d.lineDashOffset)}function Je(d){d.strokeStyle=d.fillStyle="#000000",d.fillRule="nonzero",d.globalAlpha=1,d.lineWidth=1,d.lineCap="butt",d.lineJoin="miter",d.miterLimit=10,d.globalCompositeOperation="source-over",d.font="10px sans-serif",d.setLineDash!==void 0&&(d.setLineDash([]),d.lineDashOffset=0);const{filter:t}=d;t!=="none"&&t!==""&&(d.filter="none")}function ki(d,t){if(t)return!0;B.singularValueDecompose2dScale(d,Nt);const e=Math.fround(qt.pixelRatio*Se.PDF_TO_CSS_UNITS);return Nt[0]<=e&&Nt[1]<=e}const wr=["butt","round","square"],vr=["miter","round","bevel"],Ar={},Pi={};class we{constructor(t,e,s,i,n,{optionalContentConfig:r,markedContentStack:a=null},o,l,h){this.ctx=t,this.current=new Ei(this.ctx.canvas.width,this.ctx.canvas.height),this.stateStack=[],this.pendingClip=null,this.pendingEOFill=!1,this.res=null,this.xobjs=null,this.commonObjs=e,this.objs=s,this.canvasFactory=i,this.filterFactory=n,this.groupStack=[],this.baseTransform=null,this.baseTransformStack=[],this.groupLevel=0,this.smaskStack=[],this.smaskCounter=0,this.tempSMask=null,this.suspendedCtx=null,this.contentVisible=!0,this.markedContentStack=a||[],this.optionalContentConfig=r,this.cachedCanvases=new yr(this.canvasFactory),this.cachedPatterns=new Map,this.annotationCanvasMap=o,this.viewportScale=1,this.outputScaleX=1,this.outputScaleY=1,this.pageColors=l,this._cachedScaleForStroking=[-1,0],this._cachedGetSinglePixelWidth=null,this._cachedBitmapsMap=new Map,this.dependencyTracker=h??null}getObject(t,e,s=null){return typeof e=="string"?(this.dependencyTracker?.recordNamedDependency(t,e),e.startsWith("g_")?this.commonObjs.get(e):this.objs.get(e)):s}beginDrawing({transform:t,viewport:e,transparency:s=!1,background:i=null}){const n=this.ctx.canvas.width,r=this.ctx.canvas.height,a=this.ctx.fillStyle;if(this.ctx.fillStyle=i||"#ffffff",this.ctx.fillRect(0,0,n,r),this.ctx.fillStyle=a,s){const o=this.cachedCanvases.getCanvas("transparent",n,r);this.compositeCtx=this.ctx,this.transparentCanvas=o.canvas,this.ctx=o.context,this.ctx.save(),this.ctx.transform(...ot(this.compositeCtx))}this.ctx.save(),Je(this.ctx),t&&(this.ctx.transform(...t),this.outputScaleX=t[0],this.outputScaleY=t[0]),this.ctx.transform(...e.transform),this.viewportScale=e.scale,this.baseTransform=ot(this.ctx)}executeOperatorList(t,e,s,i,n){const r=t.argsArray,a=t.fnArray;let o=e||0;const l=r.length;if(l===o)return o;const h=l-o>Si&&typeof s=="function",c=h?Date.now()+mr:0;let u=0;const f=this.commonObjs,m=this.objs;let p,b;for(;;){if(i!==void 0&&o===i.nextBreakPoint)return i.breakIt(o,s),o;if(!n||n(o))if(p=a[o],b=r[o]??null,p!==Ie.dependency)b===null?this[p](o):this[p](o,...b);else for(const g of b){this.dependencyTracker?.recordNamedData(g,o);const v=g.startsWith("g_")?f:m;if(!v.has(g))return v.get(g,s),o}if(o++,o===l)return o;if(h&&++u>Si){if(Date.now()>c)return s(),o;u=0}}}#t(){for(;this.stateStack.length||this.inSMaskMode;)this.restore();this.current.activeSMask=null,this.ctx.restore(),this.transparentCanvas&&(this.ctx=this.compositeCtx,this.ctx.save(),this.ctx.setTransform(1,0,0,1,0,0),this.ctx.drawImage(this.transparentCanvas,0,0),this.ctx.restore(),this.transparentCanvas=null)}endDrawing(){this.#t(),this.cachedCanvases.clear(),this.cachedPatterns.clear();for(const t of this._cachedBitmapsMap.values()){for(const e of t.values())typeof HTMLCanvasElement<"u"&&e instanceof HTMLCanvasElement&&(e.width=e.height=0);t.clear()}this._cachedBitmapsMap.clear(),this.#e()}#e(){if(this.pageColors){const t=this.filterFactory.addHCMFilter(this.pageColors.foreground,this.pageColors.background);if(t!=="none"){const e=this.ctx.filter;this.ctx.filter=t,this.ctx.drawImage(this.ctx.canvas,0,0),this.ctx.filter=e}}}_scaleImage(t,e){const s=t.width??t.displayWidth,i=t.height??t.displayHeight;let n=Math.max(Math.hypot(e[0],e[1]),1),r=Math.max(Math.hypot(e[2],e[3]),1),a=s,o=i,l="prescale1",h,c;for(;n>2&&a>1||r>2&&o>1;){let u=a,f=o;n>2&&a>1&&(u=a>=16384?Math.floor(a/2)-1||1:Math.ceil(a/2),n/=a/u),r>2&&o>1&&(f=o>=16384?Math.floor(o/2)-1||1:Math.ceil(o)/2,r/=o/f),h=this.cachedCanvases.getCanvas(l,u,f),c=h.context,c.clearRect(0,0,u,f),c.drawImage(t,0,0,a,o,0,0,u,f),t=h.canvas,a=u,o=f,l=l==="prescale1"?"prescale2":"prescale1"}return{img:t,paintWidth:a,paintHeight:o}}_createMaskCanvas(t,e){const s=this.ctx,{width:i,height:n}=e,r=this.current.fillColor,a=this.current.patternFill,o=ot(s);let l,h,c,u;if((e.bitmap||e.data)&&e.count>1){const k=e.bitmap||e.data.buffer;h=JSON.stringify(a?o:[o.slice(0,4),r]),l=this._cachedBitmapsMap.get(k),l||(l=new Map,this._cachedBitmapsMap.set(k,l));const T=l.get(h);if(T&&!a){const P=Math.round(Math.min(o[0],o[2])+o[4]),M=Math.round(Math.min(o[1],o[3])+o[5]);return this.dependencyTracker?.recordDependencies(t,Ot.transformAndFill),{canvas:T,offsetX:P,offsetY:M}}c=T}c||(u=this.cachedCanvases.getCanvas("maskCanvas",i,n),Ti(u.context,e));let f=B.transform(o,[1/i,0,0,-1/n,0,0]);f=B.transform(f,[1,0,0,1,0,-n]);const m=be.slice();B.axialAlignedBoundingBox([0,0,i,n],f,m);const[p,b,g,v]=m,y=Math.round(g-p)||1,S=Math.round(v-b)||1,A=this.cachedCanvases.getCanvas("fillCanvas",y,S),w=A.context,_=p,x=b;w.translate(-_,-x),w.transform(...f),c||(c=this._scaleImage(u.canvas,$t(w)),c=c.img,l&&a&&l.set(h,c)),w.imageSmoothingEnabled=ki(ot(w),e.interpolate),Qe(w,c,0,0,c.width,c.height,0,0,i,n),w.globalCompositeOperation="source-in";const E=B.transform($t(w),[1,0,0,1,-_,-x]);return w.fillStyle=a?r.getPattern(s,this,E,xt.FILL,t):r,w.fillRect(0,0,i,n),l&&!a&&(this.cachedCanvases.delete("fillCanvas"),l.set(h,A.canvas)),this.dependencyTracker?.recordDependencies(t,Ot.transformAndFill),{canvas:A.canvas,offsetX:Math.round(_),offsetY:Math.round(x)}}setLineWidth(t,e){this.dependencyTracker?.recordSimpleData("lineWidth",t),e!==this.current.lineWidth&&(this._cachedScaleForStroking[0]=-1),this.current.lineWidth=e,this.ctx.lineWidth=e}setLineCap(t,e){this.dependencyTracker?.recordSimpleData("lineCap",t),this.ctx.lineCap=wr[e]}setLineJoin(t,e){this.dependencyTracker?.recordSimpleData("lineJoin",t),this.ctx.lineJoin=vr[e]}setMiterLimit(t,e){this.dependencyTracker?.recordSimpleData("miterLimit",t),this.ctx.miterLimit=e}setDash(t,e,s){this.dependencyTracker?.recordSimpleData("dash",t);const i=this.ctx;i.setLineDash!==void 0&&(i.setLineDash(e),i.lineDashOffset=s)}setRenderingIntent(t,e){}setFlatness(t,e){}setGState(t,e){for(const[s,i]of e)switch(s){case"LW":this.setLineWidth(t,i);break;case"LC":this.setLineCap(t,i);break;case"LJ":this.setLineJoin(t,i);break;case"ML":this.setMiterLimit(t,i);break;case"D":this.setDash(t,i[0],i[1]);break;case"RI":this.setRenderingIntent(t,i);break;case"FL":this.setFlatness(t,i);break;case"Font":this.setFont(t,i[0],i[1]);break;case"CA":this.dependencyTracker?.recordSimpleData("strokeAlpha",t),this.current.strokeAlpha=i;break;case"ca":this.dependencyTracker?.recordSimpleData("fillAlpha",t),this.ctx.globalAlpha=this.current.fillAlpha=i;break;case"BM":this.dependencyTracker?.recordSimpleData("globalCompositeOperation",t),this.ctx.globalCompositeOperation=i;break;case"SMask":this.dependencyTracker?.recordSimpleData("SMask",t),this.current.activeSMask=i?this.tempSMask:null,this.tempSMask=null,this.checkSMaskState();break;case"TR":this.dependencyTracker?.recordSimpleData("filter",t),this.ctx.filter=this.current.transferMaps=this.filterFactory.addFilter(i);break}}get inSMaskMode(){return!!this.suspendedCtx}checkSMaskState(){const t=this.inSMaskMode;this.current.activeSMask&&!t?this.beginSMaskMode():!this.current.activeSMask&&t&&this.endSMaskMode()}beginSMaskMode(t){if(this.inSMaskMode)throw new Error("beginSMaskMode called while already in smask mode");const e=this.ctx.canvas.width,s=this.ctx.canvas.height,i="smaskGroupAt"+this.groupLevel,n=this.cachedCanvases.getCanvas(i,e,s);this.suspendedCtx=this.ctx;const r=this.ctx=n.context;r.setTransform(this.suspendedCtx.getTransform()),Ee(this.suspendedCtx,r),br(r,this.suspendedCtx),this.setGState(t,[["BM","source-over"]])}endSMaskMode(){if(!this.inSMaskMode)throw new Error("endSMaskMode called while not in smask mode");this.ctx._removeMirroring(),Ee(this.ctx,this.suspendedCtx),this.ctx=this.suspendedCtx,this.suspendedCtx=null}compose(t){if(!this.current.activeSMask)return;t?(t[0]=Math.floor(t[0]),t[1]=Math.floor(t[1]),t[2]=Math.ceil(t[2]),t[3]=Math.ceil(t[3])):t=[0,0,this.ctx.canvas.width,this.ctx.canvas.height];const e=this.current.activeSMask,s=this.suspendedCtx;this.composeSMask(s,e,this.ctx,t),this.ctx.save(),this.ctx.setTransform(1,0,0,1,0,0),this.ctx.clearRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height),this.ctx.restore()}composeSMask(t,e,s,i){const n=i[0],r=i[1],a=i[2]-n,o=i[3]-r;a===0||o===0||(this.genericComposeSMask(e.context,s,a,o,e.subtype,e.backdrop,e.transferMap,n,r,e.offsetX,e.offsetY),t.save(),t.globalAlpha=1,t.globalCompositeOperation="source-over",t.setTransform(1,0,0,1,0,0),t.drawImage(s.canvas,0,0),t.restore())}genericComposeSMask(t,e,s,i,n,r,a,o,l,h,c){let u=t.canvas,f=o-h,m=l-c;if(r)if(f<0||m<0||f+s>u.width||m+i>u.height){const b=this.cachedCanvases.getCanvas("maskExtension",s,i),g=b.context;g.drawImage(u,-f,-m),g.globalCompositeOperation="destination-atop",g.fillStyle=r,g.fillRect(0,0,s,i),g.globalCompositeOperation="source-over",u=b.canvas,f=m=0}else{t.save(),t.globalAlpha=1,t.setTransform(1,0,0,1,0,0);const b=new Path2D;b.rect(f,m,s,i),t.clip(b),t.globalCompositeOperation="destination-atop",t.fillStyle=r,t.fillRect(f,m,s,i),t.restore()}e.save(),e.globalAlpha=1,e.setTransform(1,0,0,1,0,0),n==="Alpha"&&a?e.filter=this.filterFactory.addAlphaFilter(a):n==="Luminosity"&&(e.filter=this.filterFactory.addLuminosityFilter(a));const p=new Path2D;p.rect(o,l,s,i),e.clip(p),e.globalCompositeOperation="destination-in",e.drawImage(u,f,m,s,i,o,l,s,i),e.restore()}save(t){this.inSMaskMode&&Ee(this.ctx,this.suspendedCtx),this.ctx.save();const e=this.current;this.stateStack.push(e),this.current=e.clone(),this.dependencyTracker?.save(t)}restore(t){if(this.dependencyTracker?.restore(t),this.stateStack.length===0){this.inSMaskMode&&this.endSMaskMode();return}this.current=this.stateStack.pop(),this.ctx.restore(),this.inSMaskMode&&Ee(this.suspendedCtx,this.ctx),this.checkSMaskState(),this.pendingClip=null,this._cachedScaleForStroking[0]=-1,this._cachedGetSinglePixelWidth=null}transform(t,e,s,i,n,r,a){this.dependencyTracker?.recordIncrementalData("transform",t),this.ctx.transform(e,s,i,n,r,a),this._cachedScaleForStroking[0]=-1,this._cachedGetSinglePixelWidth=null}constructPath(t,e,s,i){let[n]=s;if(!i){n||=s[0]=new Path2D,this[e](t,n);return}if(this.dependencyTracker!==null){const r=e===Ie.stroke?this.current.lineWidth/2:0;this.dependencyTracker.resetBBox(t).recordBBox(t,this.ctx,i[0]-r,i[2]+r,i[1]-r,i[3]+r).recordDependencies(t,["transform"])}if(!(n instanceof Path2D)){const r=s[0]=new Path2D;for(let a=0,o=n.length;a<o;)switch(n[a++]){case Ve.moveTo:r.moveTo(n[a++],n[a++]);break;case Ve.lineTo:r.lineTo(n[a++],n[a++]);break;case Ve.curveTo:r.bezierCurveTo(n[a++],n[a++],n[a++],n[a++],n[a++],n[a++]);break;case Ve.closePath:r.closePath();break;default:G(`Unrecognized drawing path operator: ${n[a-1]}`);break}n=r}B.axialAlignedBoundingBox(i,ot(this.ctx),this.current.minMax),this[e](t,n),this._pathStartIdx=t}closePath(t){this.ctx.closePath()}stroke(t,e,s=!0){const i=this.ctx,n=this.current.strokeColor;if(i.globalAlpha=this.current.strokeAlpha,this.contentVisible)if(typeof n=="object"&&n?.getPattern){const r=n.isModifyingCurrentTransform()?i.getTransform():null;if(i.save(),i.strokeStyle=n.getPattern(i,this,$t(i),xt.STROKE,t),r){const a=new Path2D;a.addPath(e,i.getTransform().invertSelf().multiplySelf(r)),e=a}this.rescaleAndStroke(e,!1),i.restore()}else this.rescaleAndStroke(e,!0);this.dependencyTracker?.recordDependencies(t,Ot.stroke),s&&this.consumePath(t,e,this.current.getClippedPathBoundingBox(xt.STROKE,ot(this.ctx))),i.globalAlpha=this.current.fillAlpha}closeStroke(t,e){this.stroke(t,e)}fill(t,e,s=!0){const i=this.ctx,n=this.current.fillColor,r=this.current.patternFill;let a=!1;if(r){const l=n.isModifyingCurrentTransform()?i.getTransform():null;if(this.dependencyTracker?.save(t),i.save(),i.fillStyle=n.getPattern(i,this,$t(i),xt.FILL,t),l){const h=new Path2D;h.addPath(e,i.getTransform().invertSelf().multiplySelf(l)),e=h}a=!0}const o=this.current.getClippedPathBoundingBox();this.contentVisible&&o!==null&&(this.pendingEOFill?(i.fill(e,"evenodd"),this.pendingEOFill=!1):i.fill(e)),this.dependencyTracker?.recordDependencies(t,Ot.fill),a&&(i.restore(),this.dependencyTracker?.restore(t)),s&&this.consumePath(t,e,o)}eoFill(t,e){this.pendingEOFill=!0,this.fill(t,e)}fillStroke(t,e){this.fill(t,e,!1),this.stroke(t,e,!1),this.consumePath(t,e)}eoFillStroke(t,e){this.pendingEOFill=!0,this.fillStroke(t,e)}closeFillStroke(t,e){this.fillStroke(t,e)}closeEOFillStroke(t,e){this.pendingEOFill=!0,this.fillStroke(t,e)}endPath(t,e){this.consumePath(t,e)}rawFillPath(t,e){this.ctx.fill(e),this.dependencyTracker?.recordDependencies(t,Ot.rawFillPath).recordOperation(t)}clip(t){this.dependencyTracker?.recordFutureForcedDependency("clipMode",t),this.pendingClip=Ar}eoClip(t){this.dependencyTracker?.recordFutureForcedDependency("clipMode",t),this.pendingClip=Pi}beginText(t){this.current.textMatrix=null,this.current.textMatrixScale=1,this.current.x=this.current.lineX=0,this.current.y=this.current.lineY=0,this.dependencyTracker?.recordOpenMarker(t).resetIncrementalData("sameLineText").resetIncrementalData("moveText",t)}endText(t){const e=this.pendingTextPaths,s=this.ctx;if(this.dependencyTracker){const{dependencyTracker:i}=this;e!==void 0&&i.recordFutureForcedDependency("textClip",i.getOpenMarker()).recordFutureForcedDependency("textClip",t),i.recordCloseMarker(t)}if(e!==void 0){const i=new Path2D,n=s.getTransform().invertSelf();for(const{transform:r,x:a,y:o,fontSize:l,path:h}of e)h&&i.addPath(h,new DOMMatrix(r).preMultiplySelf(n).translate(a,o).scale(l,-l));s.clip(i)}delete this.pendingTextPaths}setCharSpacing(t,e){this.dependencyTracker?.recordSimpleData("charSpacing",t),this.current.charSpacing=e}setWordSpacing(t,e){this.dependencyTracker?.recordSimpleData("wordSpacing",t),this.current.wordSpacing=e}setHScale(t,e){this.dependencyTracker?.recordSimpleData("hScale",t),this.current.textHScale=e/100}setLeading(t,e){this.dependencyTracker?.recordSimpleData("leading",t),this.current.leading=-e}setFont(t,e,s){this.dependencyTracker?.recordSimpleData("font",t).recordSimpleDataFromNamed("fontObj",e,t);const i=this.commonObjs.get(e),n=this.current;if(!i)throw new Error(`Can't find font for ${e}`);if(n.fontMatrix=i.fontMatrix||Cs,(n.fontMatrix[0]===0||n.fontMatrix[3]===0)&&G("Invalid font matrix for font "+e),s<0?(s=-s,n.fontDirection=-1):n.fontDirection=1,this.current.font=i,this.current.fontSize=s,i.isType3Font)return;const r=i.loadedName||"sans-serif",a=i.systemFontInfo?.css||`"${r}", ${i.fallbackName}`;let o="normal";i.black?o="900":i.bold&&(o="bold");const l=i.italic?"italic":"normal";let h=s;s<xi?h=xi:s>_i&&(h=_i),this.current.fontSizeScale=s/h,this.ctx.font=`${l} ${o} ${h}px ${a}`}setTextRenderingMode(t,e){this.dependencyTracker?.recordSimpleData("textRenderingMode",t),this.current.textRenderingMode=e}setTextRise(t,e){this.dependencyTracker?.recordSimpleData("textRise",t),this.current.textRise=e}moveText(t,e,s){this.dependencyTracker?.resetIncrementalData("sameLineText").recordIncrementalData("moveText",t),this.current.x=this.current.lineX+=e,this.current.y=this.current.lineY+=s}setLeadingMoveText(t,e,s){this.setLeading(t,-s),this.moveText(t,e,s)}setTextMatrix(t,e){this.dependencyTracker?.recordSimpleData("textMatrix",t);const{current:s}=this;s.textMatrix=e,s.textMatrixScale=Math.hypot(e[0],e[1]),s.x=s.lineX=0,s.y=s.lineY=0}nextLine(t){this.moveText(t,0,this.current.leading),this.dependencyTracker?.recordIncrementalData("moveText",this.dependencyTracker.getSimpleIndex("leading")??t)}#i(t,e,s){const i=new Path2D;return i.addPath(t,new DOMMatrix(s).invertSelf().multiplySelf(e)),i}paintChar(t,e,s,i,n,r){const a=this.ctx,o=this.current,l=o.font,h=o.textRenderingMode,c=o.fontSize/o.fontSizeScale,u=h&vt.FILL_STROKE_MASK,f=!!(h&vt.ADD_TO_PATH_FLAG),m=o.patternFill&&!l.missingFile,p=o.patternStroke&&!l.missingFile;let b;if((l.disableFontFace||f||m||p)&&!l.missingFile&&(b=l.getPathGenerator(this.commonObjs,e)),b&&(l.disableFontFace||m||p)){a.save(),a.translate(s,i),a.scale(c,-c),this.dependencyTracker?.recordCharacterBBox(t,a,l);let g;if(u===vt.FILL||u===vt.FILL_STROKE)if(n){g=a.getTransform(),a.setTransform(...n);const v=this.#i(b,g,n);a.fill(v)}else a.fill(b);if(u===vt.STROKE||u===vt.FILL_STROKE)if(r){g||=a.getTransform(),a.setTransform(...r);const{a:v,b:y,c:S,d:A}=g,w=B.inverseTransform(r),_=B.transform([v,y,S,A,0,0],w);B.singularValueDecompose2dScale(_,Nt),a.lineWidth*=Math.max(Nt[0],Nt[1])/c,a.stroke(this.#i(b,g,r))}else a.lineWidth/=c,a.stroke(b);a.restore()}else(u===vt.FILL||u===vt.FILL_STROKE)&&(a.fillText(e,s,i),this.dependencyTracker?.recordCharacterBBox(t,a,l,c,s,i,()=>a.measureText(e))),(u===vt.STROKE||u===vt.FILL_STROKE)&&(this.dependencyTracker&&this.dependencyTracker?.recordCharacterBBox(t,a,l,c,s,i,()=>a.measureText(e)).recordDependencies(t,Ot.stroke),a.strokeText(e,s,i));f&&((this.pendingTextPaths||=[]).push({transform:ot(a),x:s,y:i,fontSize:c,path:b}),this.dependencyTracker?.recordCharacterBBox(t,a,l,c,s,i))}get isFontSubpixelAAEnabled(){const{context:t}=this.cachedCanvases.getCanvas("isFontSubpixelAAEnabled",10,10);t.scale(1.5,1),t.fillText("I",0,10);const e=t.getImageData(0,0,10,10).data;let s=!1;for(let i=3;i<e.length;i+=4)if(e[i]>0&&e[i]<255){s=!0;break}return W(this,"isFontSubpixelAAEnabled",s)}showText(t,e){this.dependencyTracker&&(this.dependencyTracker.recordDependencies(t,Ot.showText).resetBBox(t),this.current.textRenderingMode&vt.ADD_TO_PATH_FLAG&&this.dependencyTracker.recordFutureForcedDependency("textClip",t).inheritPendingDependenciesAsFutureForcedDependencies());const s=this.current,i=s.font;if(i.isType3Font){this.showType3Text(t,e),this.dependencyTracker?.recordShowTextOperation(t);return}const n=s.fontSize;if(n===0){this.dependencyTracker?.recordOperation(t);return}const r=this.ctx,a=s.fontSizeScale,o=s.charSpacing,l=s.wordSpacing,h=s.fontDirection,c=s.textHScale*h,u=e.length,f=i.vertical,m=f?1:-1,p=i.defaultVMetrics,b=n*s.fontMatrix[0],g=s.textRenderingMode===vt.FILL&&!i.disableFontFace&&!s.patternFill;r.save(),s.textMatrix&&r.transform(...s.textMatrix),r.translate(s.x,s.y+s.textRise),h>0?r.scale(c,-1):r.scale(c,1);let v,y;if(s.patternFill){r.save();const x=s.fillColor.getPattern(r,this,$t(r),xt.FILL,t);v=ot(r),r.restore(),r.fillStyle=x}if(s.patternStroke){r.save();const x=s.strokeColor.getPattern(r,this,$t(r),xt.STROKE,t);y=ot(r),r.restore(),r.strokeStyle=x}let S=s.lineWidth;const A=s.textMatrixScale;if(A===0||S===0){const x=s.textRenderingMode&vt.FILL_STROKE_MASK;(x===vt.STROKE||x===vt.FILL_STROKE)&&(S=this.getSinglePixelWidth())}else S/=A;if(a!==1&&(r.scale(a,a),S/=a),r.lineWidth=S,i.isInvalidPDFjsFont){const x=[];let E=0;for(const T of e)x.push(T.unicode),E+=T.width;const k=x.join("");if(r.fillText(k,0,0),this.dependencyTracker!==null){const T=r.measureText(k);this.dependencyTracker.recordBBox(t,this.ctx,-T.actualBoundingBoxLeft,T.actualBoundingBoxRight,-T.actualBoundingBoxAscent,T.actualBoundingBoxDescent).recordShowTextOperation(t)}s.x+=E*b*c,r.restore(),this.compose();return}let w=0,_;for(_=0;_<u;++_){const x=e[_];if(typeof x=="number"){w+=m*x*n/1e3;continue}let E=!1;const k=(x.isSpace?l:0)+o,T=x.fontChar,P=x.accent;let M,I,R=x.width;if(f){const N=x.vmetric||p,H=-(x.vmetric?N[1]:R*.5)*b,q=N[2]*b;R=N?-N[0]:R,M=H/a,I=(w+q)/a}else M=w/a,I=0;let D;if(i.remeasure&&R>0){D=r.measureText(T);const N=D.width*1e3/n*a;if(R<N&&this.isFontSubpixelAAEnabled){const H=R/N;E=!0,r.save(),r.scale(H,1),M/=H}else R!==N&&(M+=(R-N)/2e3*n/a)}if(this.contentVisible&&(x.isInFont||i.missingFile)){if(g&&!P)r.fillText(T,M,I),this.dependencyTracker?.recordCharacterBBox(t,r,D?{bbox:null}:i,n/a,M,I,()=>D??r.measureText(T));else if(this.paintChar(t,T,M,I,v,y),P){const N=M+n*P.offset.x/a,H=I-n*P.offset.y/a;this.paintChar(t,P.fontChar,N,H,v,y)}}const O=f?R*b-k*h:R*b+k*h;w+=O,E&&r.restore()}f?s.y-=w:s.x+=w*c,r.restore(),this.compose(),this.dependencyTracker?.recordShowTextOperation(t)}showType3Text(t,e){const s=this.ctx,i=this.current,n=i.font,r=i.fontSize,a=i.fontDirection,o=n.vertical?1:-1,l=i.charSpacing,h=i.wordSpacing,c=i.textHScale*a,u=i.fontMatrix||Cs,f=e.length,m=i.textRenderingMode===vt.INVISIBLE;let p,b,g,v;if(m||r===0)return;this._cachedScaleForStroking[0]=-1,this._cachedGetSinglePixelWidth=null,s.save(),i.textMatrix&&s.transform(...i.textMatrix),s.translate(i.x,i.y+i.textRise),s.scale(c,a);const y=this.dependencyTracker;for(this.dependencyTracker=y?new rs(y,t):null,p=0;p<f;++p){if(b=e[p],typeof b=="number"){v=o*b*r/1e3,this.ctx.translate(v,0),i.x+=v*c;continue}const S=(b.isSpace?h:0)+l,A=n.charProcOperatorList[b.operatorListId];A?this.contentVisible&&(this.save(),s.scale(r,r),s.transform(...u),this.executeOperatorList(A),this.restore()):G(`Type3 character "${b.operatorListId}" is not available.`);const w=[b.width,0];B.applyTransform(w,u),g=w[0]*r+S,s.translate(g,0),i.x+=g*c}s.restore(),y&&(this.dependencyTracker=y)}setCharWidth(t,e,s){}setCharWidthAndBounds(t,e,s,i,n,r,a){const o=new Path2D;o.rect(i,n,r-i,a-n),this.ctx.clip(o),this.dependencyTracker?.recordBBox(t,this.ctx,i,r,n,a).recordClipBox(t,this.ctx,i,r,n,a),this.endPath(t)}getColorN_Pattern(t,e){let s;if(e[0]==="TilingPattern"){const i=this.baseTransform||ot(this.ctx),n={createCanvasGraphics:(r,a)=>new we(r,this.commonObjs,this.objs,this.canvasFactory,this.filterFactory,{optionalContentConfig:this.optionalContentConfig,markedContentStack:this.markedContentStack},void 0,void 0,this.dependencyTracker?new rs(this.dependencyTracker,a,!0):null)};s=new qs(e,this.ctx,n,i)}else s=this._getPattern(t,e[1],e[2]);return s}setStrokeColorN(t,...e){this.dependencyTracker?.recordSimpleData("strokeColor",t),this.current.strokeColor=this.getColorN_Pattern(t,e),this.current.patternStroke=!0}setFillColorN(t,...e){this.dependencyTracker?.recordSimpleData("fillColor",t),this.current.fillColor=this.getColorN_Pattern(t,e),this.current.patternFill=!0}setStrokeRGBColor(t,e){this.dependencyTracker?.recordSimpleData("strokeColor",t),this.ctx.strokeStyle=this.current.strokeColor=e,this.current.patternStroke=!1}setStrokeTransparent(t){this.dependencyTracker?.recordSimpleData("strokeColor",t),this.ctx.strokeStyle=this.current.strokeColor="transparent",this.current.patternStroke=!1}setFillRGBColor(t,e){this.dependencyTracker?.recordSimpleData("fillColor",t),this.ctx.fillStyle=this.current.fillColor=e,this.current.patternFill=!1}setFillTransparent(t){this.dependencyTracker?.recordSimpleData("fillColor",t),this.ctx.fillStyle=this.current.fillColor="transparent",this.current.patternFill=!1}_getPattern(t,e,s=null){let i;return this.cachedPatterns.has(e)?i=this.cachedPatterns.get(e):(i=pr(this.getObject(t,e)),this.cachedPatterns.set(e,i)),s&&(i.matrix=s),i}shadingFill(t,e){if(!this.contentVisible)return;const s=this.ctx;this.save(t);const i=this._getPattern(t,e);s.fillStyle=i.getPattern(s,this,$t(s),xt.SHADING,t);const n=$t(s);if(n){const{width:r,height:a}=s.canvas,o=be.slice();B.axialAlignedBoundingBox([0,0,r,a],n,o);const[l,h,c,u]=o;this.ctx.fillRect(l,h,c-l,u-h)}else this.ctx.fillRect(-1e10,-1e10,2e10,2e10);this.dependencyTracker?.resetBBox(t).recordFullPageBBox(t).recordDependencies(t,Ot.transform).recordDependencies(t,Ot.fill).recordOperation(t),this.compose(this.current.getClippedPathBoundingBox()),this.restore(t)}beginInlineImage(){nt("Should not call beginInlineImage")}beginImageData(){nt("Should not call beginImageData")}paintFormXObjectBegin(t,e,s){if(this.contentVisible&&(this.save(t),this.baseTransformStack.push(this.baseTransform),e&&this.transform(t,...e),this.baseTransform=ot(this.ctx),s)){B.axialAlignedBoundingBox(s,this.baseTransform,this.current.minMax);const[i,n,r,a]=s,o=new Path2D;o.rect(i,n,r-i,a-n),this.ctx.clip(o),this.dependencyTracker?.recordClipBox(t,this.ctx,i,r,n,a),this.endPath(t)}}paintFormXObjectEnd(t){this.contentVisible&&(this.restore(t),this.baseTransform=this.baseTransformStack.pop())}beginGroup(t,e){if(!this.contentVisible)return;this.save(t),this.inSMaskMode&&(this.endSMaskMode(),this.current.activeSMask=null);const s=this.ctx;e.isolated||cs("TODO: Support non-isolated groups."),e.knockout&&G("Knockout groups not supported.");const i=ot(s);if(e.matrix&&s.transform(...e.matrix),!e.bbox)throw new Error("Bounding box is required.");let n=be.slice();B.axialAlignedBoundingBox(e.bbox,ot(s),n);const r=[0,0,s.canvas.width,s.canvas.height];n=B.intersect(n,r)||[0,0,0,0];const a=Math.floor(n[0]),o=Math.floor(n[1]),l=Math.max(Math.ceil(n[2])-a,1),h=Math.max(Math.ceil(n[3])-o,1);this.current.startNewPathAndClipBox([0,0,l,h]);let c="groupAt"+this.groupLevel;e.smask&&(c+="_smask_"+this.smaskCounter++%2);const u=this.cachedCanvases.getCanvas(c,l,h),f=u.context;f.translate(-a,-o),f.transform(...i);let m=new Path2D;const[p,b,g,v]=e.bbox;if(m.rect(p,b,g-p,v-b),e.matrix){const y=new Path2D;y.addPath(m,new DOMMatrix(e.matrix)),m=y}f.clip(m),e.smask&&this.smaskStack.push({canvas:u.canvas,context:f,offsetX:a,offsetY:o,subtype:e.smask.subtype,backdrop:e.smask.backdrop,transferMap:e.smask.transferMap||null,startTransformInverse:null}),(!e.smask||this.dependencyTracker)&&(s.setTransform(1,0,0,1,0,0),s.translate(a,o),s.save()),Ee(s,f),this.ctx=f,this.dependencyTracker?.inheritSimpleDataAsFutureForcedDependencies(["fillAlpha","strokeAlpha","globalCompositeOperation"]).pushBaseTransform(s),this.setGState(t,[["BM","source-over"],["ca",1],["CA",1]]),this.groupStack.push(s),this.groupLevel++}endGroup(t,e){if(!this.contentVisible)return;this.groupLevel--;const s=this.ctx,i=this.groupStack.pop();if(this.ctx=i,this.ctx.imageSmoothingEnabled=!1,this.dependencyTracker?.popBaseTransform(),e.smask)this.tempSMask=this.smaskStack.pop(),this.restore(t),this.dependencyTracker&&this.ctx.restore();else{this.ctx.restore();const n=ot(this.ctx);this.restore(t),this.ctx.save(),this.ctx.setTransform(...n);const r=be.slice();B.axialAlignedBoundingBox([0,0,s.canvas.width,s.canvas.height],n,r),this.ctx.drawImage(s.canvas,0,0),this.ctx.restore(),this.compose(r)}}beginAnnotation(t,e,s,i,n,r){if(this.#t(),Je(this.ctx),this.ctx.save(),this.save(t),this.baseTransform&&this.ctx.setTransform(...this.baseTransform),s){const a=s[2]-s[0],o=s[3]-s[1];if(r&&this.annotationCanvasMap){i=i.slice(),i[4]-=s[0],i[5]-=s[1],s=s.slice(),s[0]=s[1]=0,s[2]=a,s[3]=o,B.singularValueDecompose2dScale(ot(this.ctx),Nt);const{viewportScale:l}=this,h=Math.ceil(a*this.outputScaleX*l),c=Math.ceil(o*this.outputScaleY*l);this.annotationCanvas=this.canvasFactory.create(h,c);const{canvas:u,context:f}=this.annotationCanvas;this.annotationCanvasMap.set(e,u),this.annotationCanvas.savedCtx=this.ctx,this.ctx=f,this.ctx.save(),this.ctx.setTransform(Nt[0],0,0,-Nt[1],0,o*Nt[1]),Je(this.ctx)}else{Je(this.ctx),this.endPath(t);const l=new Path2D;l.rect(s[0],s[1],a,o),this.ctx.clip(l)}}this.current=new Ei(this.ctx.canvas.width,this.ctx.canvas.height),this.transform(t,...i),this.transform(t,...n)}endAnnotation(t){this.annotationCanvas&&(this.ctx.restore(),this.#e(),this.ctx=this.annotationCanvas.savedCtx,delete this.annotationCanvas.savedCtx,delete this.annotationCanvas)}paintImageMaskXObject(t,e){if(!this.contentVisible)return;const s=e.count;e=this.getObject(t,e.data,e),e.count=s;const i=this.ctx,n=this._createMaskCanvas(t,e),r=n.canvas;i.save(),i.setTransform(1,0,0,1,0,0),i.drawImage(r,n.offsetX,n.offsetY),this.dependencyTracker?.resetBBox(t).recordBBox(t,this.ctx,n.offsetX,n.offsetX+r.width,n.offsetY,n.offsetY+r.height).recordOperation(t),i.restore(),this.compose()}paintImageMaskXObjectRepeat(t,e,s,i=0,n=0,r,a){if(!this.contentVisible)return;e=this.getObject(t,e.data,e);const o=this.ctx;o.save();const l=ot(o);o.transform(s,i,n,r,0,0);const h=this._createMaskCanvas(t,e);o.setTransform(1,0,0,1,h.offsetX-l[4],h.offsetY-l[5]),this.dependencyTracker?.resetBBox(t);for(let c=0,u=a.length;c<u;c+=2){const f=B.transform(l,[s,i,n,r,a[c],a[c+1]]);o.drawImage(h.canvas,f[4],f[5]),this.dependencyTracker?.recordBBox(t,this.ctx,f[4],f[4]+h.canvas.width,f[5],f[5]+h.canvas.height)}o.restore(),this.compose(),this.dependencyTracker?.recordOperation(t)}paintImageMaskXObjectGroup(t,e){if(!this.contentVisible)return;const s=this.ctx,i=this.current.fillColor,n=this.current.patternFill;this.dependencyTracker?.resetBBox(t).recordDependencies(t,Ot.transformAndFill);for(const r of e){const{data:a,width:o,height:l,transform:h}=r,c=this.cachedCanvases.getCanvas("maskCanvas",o,l),u=c.context;u.save();const f=this.getObject(t,a,r);Ti(u,f),u.globalCompositeOperation="source-in",u.fillStyle=n?i.getPattern(u,this,$t(s),xt.FILL,t):i,u.fillRect(0,0,o,l),u.restore(),s.save(),s.transform(...h),s.scale(1,-1),Qe(s,c.canvas,0,0,o,l,0,-1,1,1),this.dependencyTracker?.recordBBox(t,s,0,o,0,l),s.restore()}this.compose(),this.dependencyTracker?.recordOperation(t)}paintImageXObject(t,e){if(!this.contentVisible)return;const s=this.getObject(t,e);if(!s){G("Dependent image isn't ready yet");return}this.paintInlineImageXObject(t,s)}paintImageXObjectRepeat(t,e,s,i,n){if(!this.contentVisible)return;const r=this.getObject(t,e);if(!r){G("Dependent image isn't ready yet");return}const a=r.width,o=r.height,l=[];for(let h=0,c=n.length;h<c;h+=2)l.push({transform:[s,0,0,i,n[h],n[h+1]],x:0,y:0,w:a,h:o});this.paintInlineImageXObjectGroup(t,r,l)}applyTransferMapsToCanvas(t){return this.current.transferMaps!=="none"&&(t.filter=this.current.transferMaps,t.drawImage(t.canvas,0,0),t.filter="none"),t.canvas}applyTransferMapsToBitmap(t){if(this.current.transferMaps==="none")return t.bitmap;const{bitmap:e,width:s,height:i}=t,n=this.cachedCanvases.getCanvas("inlineImage",s,i),r=n.context;return r.filter=this.current.transferMaps,r.drawImage(e,0,0),r.filter="none",n.canvas}paintInlineImageXObject(t,e){if(!this.contentVisible)return;const s=e.width,i=e.height,n=this.ctx;this.save(t);const{filter:r}=n;r!=="none"&&r!==""&&(n.filter="none"),n.scale(1/s,-1/i);let a;if(e.bitmap)a=this.applyTransferMapsToBitmap(e);else if(typeof HTMLElement=="function"&&e instanceof HTMLElement||!e.data)a=e;else{const h=this.cachedCanvases.getCanvas("inlineImage",s,i).context;Ci(h,e),a=this.applyTransferMapsToCanvas(h)}const o=this._scaleImage(a,$t(n));n.imageSmoothingEnabled=ki(ot(n),e.interpolate),this.dependencyTracker?.resetBBox(t).recordBBox(t,n,0,s,-i,0).recordDependencies(t,Ot.imageXObject).recordOperation(t),Qe(n,o.img,0,0,o.paintWidth,o.paintHeight,0,-i,s,i),this.compose(),this.restore(t)}paintInlineImageXObjectGroup(t,e,s){if(!this.contentVisible)return;const i=this.ctx;let n;if(e.bitmap)n=e.bitmap;else{const r=e.width,a=e.height,l=this.cachedCanvases.getCanvas("inlineImage",r,a).context;Ci(l,e),n=this.applyTransferMapsToCanvas(l)}this.dependencyTracker?.resetBBox(t);for(const r of s)i.save(),i.transform(...r.transform),i.scale(1,-1),Qe(i,n,r.x,r.y,r.w,r.h,0,-1,1,1),this.dependencyTracker?.recordBBox(t,i,0,1,-1,0),i.restore();this.dependencyTracker?.recordOperation(t),this.compose()}paintSolidColorImageMask(t){this.contentVisible&&(this.dependencyTracker?.resetBBox(t).recordBBox(t,this.ctx,0,1,0,1).recordDependencies(t,Ot.fill).recordOperation(t),this.ctx.fillRect(0,0,1,1),this.compose())}markPoint(t,e){}markPointProps(t,e,s){}beginMarkedContent(t,e){this.dependencyTracker?.beginMarkedContent(t),this.markedContentStack.push({visible:!0})}beginMarkedContentProps(t,e,s){this.dependencyTracker?.beginMarkedContent(t),e==="OC"?this.markedContentStack.push({visible:this.optionalContentConfig.isVisible(s)}):this.markedContentStack.push({visible:!0}),this.contentVisible=this.isContentVisible()}endMarkedContent(t){this.dependencyTracker?.endMarkedContent(t),this.markedContentStack.pop(),this.contentVisible=this.isContentVisible()}beginCompat(t){}endCompat(t){}consumePath(t,e,s){const i=this.current.isEmptyClip();this.pendingClip&&this.current.updateClipFromPath(),this.pendingClip||this.compose(s);const n=this.ctx;this.pendingClip?(i||(this.pendingClip===Pi?n.clip(e,"evenodd"):n.clip(e)),this.pendingClip=null,this.dependencyTracker?.bboxToClipBoxDropOperation(t).recordFutureForcedDependency("clipPath",t)):this.dependencyTracker?.recordOperation(t),this.current.startNewPathAndClipBox(this.current.clipBox)}getSinglePixelWidth(){if(!this._cachedGetSinglePixelWidth){const t=ot(this.ctx);if(t[1]===0&&t[2]===0)this._cachedGetSinglePixelWidth=1/Math.min(Math.abs(t[0]),Math.abs(t[3]));else{const e=Math.abs(t[0]*t[3]-t[2]*t[1]),s=Math.hypot(t[0],t[2]),i=Math.hypot(t[1],t[3]);this._cachedGetSinglePixelWidth=Math.max(s,i)/e}}return this._cachedGetSinglePixelWidth}getScaleForStroking(){if(this._cachedScaleForStroking[0]===-1){const{lineWidth:t}=this.current,{a:e,b:s,c:i,d:n}=this.ctx.getTransform();let r,a;if(s===0&&i===0){const o=Math.abs(e),l=Math.abs(n);if(o===l)if(t===0)r=a=1/o;else{const h=o*t;r=a=h<1?1/h:1}else if(t===0)r=1/o,a=1/l;else{const h=o*t,c=l*t;r=h<1?1/h:1,a=c<1?1/c:1}}else{const o=Math.abs(e*n-s*i),l=Math.hypot(e,s),h=Math.hypot(i,n);if(t===0)r=h/o,a=l/o;else{const c=t*o;r=h>c?h/c:1,a=l>c?l/c:1}}this._cachedScaleForStroking[0]=r,this._cachedScaleForStroking[1]=a}return this._cachedScaleForStroking}rescaleAndStroke(t,e){const{ctx:s,current:{lineWidth:i}}=this,[n,r]=this.getScaleForStroking();if(n===r){s.lineWidth=(i||1)*n,s.stroke(t);return}const a=s.getLineDash();e&&s.save(),s.scale(n,r),xs.a=1/n,xs.d=1/r;const o=new Path2D;if(o.addPath(t,xs),a.length>0){const l=Math.max(n,r);s.setLineDash(a.map(h=>h/l)),s.lineDashOffset/=l}s.lineWidth=i||1,s.stroke(o),e&&s.restore()}isContentVisible(){for(let t=this.markedContentStack.length-1;t>=0;t--)if(!this.markedContentStack[t].visible)return!1;return!0}}for(const d in Ie)we.prototype[d]!==void 0&&(we.prototype[Ie[d]]=we.prototype[d]);class ve{#t;#e;#i;static strings=["fontFamily","fontWeight","italicAngle"];static write(t){const e=new TextEncoder,s={};let i=0;for(const l of ve.strings){const h=e.encode(t[l]);s[l]=h,i+=4+h.length}const n=new ArrayBuffer(i),r=new Uint8Array(n),a=new DataView(n);let o=0;for(const l of ve.strings){const h=s[l],c=h.length;a.setUint32(o,c),r.set(h,o+4),o+=4+c}return Q(o===n.byteLength,"CssFontInfo.write: Buffer overflow"),n}constructor(t){this.#t=t,this.#e=new DataView(this.#t),this.#i=new TextDecoder}#s(t){Q(t<ve.strings.length,"Invalid string index");let e=0;for(let i=0;i<t;i++)e+=this.#e.getUint32(e)+4;const s=this.#e.getUint32(e);return this.#i.decode(new Uint8Array(this.#t,e+4,s))}get fontFamily(){return this.#s(0)}get fontWeight(){return this.#s(1)}get italicAngle(){return this.#s(2)}}class Ae{#t;#e;#i;static strings=["css","loadedName","baseFontName","src"];static write(t){const e=new TextEncoder,s={};let i=0;for(const u of Ae.strings){const f=e.encode(t[u]);s[u]=f,i+=4+f.length}i+=4;let n,r,a=1+i;t.style&&(n=e.encode(t.style.style),r=e.encode(t.style.weight),a+=4+n.length+4+r.length);const o=new ArrayBuffer(a),l=new Uint8Array(o),h=new DataView(o);let c=0;h.setUint8(c++,t.guessFallback?1:0),h.setUint32(c,0),c+=4,i=0;for(const u of Ae.strings){const f=s[u],m=f.length;i+=4+m,h.setUint32(c,m),l.set(f,c+4),c+=4+m}return h.setUint32(c-i-4,i),t.style&&(h.setUint32(c,n.length),l.set(n,c+4),c+=4+n.length,h.setUint32(c,r.length),l.set(r,c+4),c+=4+r.length),Q(c<=o.byteLength,"SubstitionInfo.write: Buffer overflow"),o.transferToFixedLength(c)}constructor(t){this.#t=t,this.#e=new DataView(this.#t),this.#i=new TextDecoder}get guessFallback(){return this.#e.getUint8(0)!==0}#s(t){Q(t<Ae.strings.length,"Invalid string index");let e=5;for(let i=0;i<t;i++)e+=this.#e.getUint32(e)+4;const s=this.#e.getUint32(e);return this.#i.decode(new Uint8Array(this.#t,e+4,s))}get css(){return this.#s(0)}get loadedName(){return this.#s(1)}get baseFontName(){return this.#s(2)}get src(){return this.#s(3)}get style(){let t=1;t+=4+this.#e.getUint32(t);const e=this.#e.getUint32(t),s=this.#i.decode(new Uint8Array(this.#t,t+4,e));t+=4+e;const i=this.#e.getUint32(t),n=this.#i.decode(new Uint8Array(this.#t,t+4,i));return{style:s,weight:n}}}class st{static bools=["black","bold","disableFontFace","fontExtraProperties","isInvalidPDFjsFont","isType3Font","italic","missingFile","remeasure","vertical"];static numbers=["ascent","defaultWidth","descent"];static strings=["fallbackName","loadedName","mimetype","name"];static#t=Math.ceil(this.bools.length*2/8);static#e=this.#t+this.numbers.length*8;static#i=this.#e+1+8;static#s=this.#i+1+48;static#a=this.#s+1+6;#n;#r;#o;constructor({data:t,extra:e}){this.#n=t,this.#r=new TextDecoder,this.#o=new DataView(this.#n),e&&Object.assign(this,e)}#h(t){Q(t<st.bools.length,"Invalid boolean index");const e=Math.floor(t/4),s=t*2%8,i=this.#o.getUint8(e)>>s&3;return i===0?void 0:i===2}get black(){return this.#h(0)}get bold(){return this.#h(1)}get disableFontFace(){return this.#h(2)}get fontExtraProperties(){return this.#h(3)}get isInvalidPDFjsFont(){return this.#h(4)}get isType3Font(){return this.#h(5)}get italic(){return this.#h(6)}get missingFile(){return this.#h(7)}get remeasure(){return this.#h(8)}get vertical(){return this.#h(9)}#l(t){return Q(t<st.numbers.length,"Invalid number index"),this.#o.getFloat64(st.#t+t*8)}get ascent(){return this.#l(0)}get defaultWidth(){return this.#l(1)}get descent(){return this.#l(2)}get bbox(){let t=st.#e;if(this.#o.getUint8(t)===0)return;t+=1;const s=[];for(let i=0;i<4;i++)s.push(this.#o.getInt16(t,!0)),t+=2;return s}get fontMatrix(){let t=st.#i;if(this.#o.getUint8(t)===0)return;t+=1;const s=[];for(let i=0;i<6;i++)s.push(this.#o.getFloat64(t,!0)),t+=8;return s}get defaultVMetrics(){let t=st.#s;if(this.#o.getUint8(t)===0)return;t+=1;const s=[];for(let i=0;i<3;i++)s.push(this.#o.getInt16(t,!0)),t+=2;return s}#u(t){Q(t<st.strings.length,"Invalid string index");let e=st.#a+4;for(let n=0;n<t;n++)e+=this.#o.getUint32(e)+4;const s=this.#o.getUint32(e),i=new Uint8Array(s);return i.set(new Uint8Array(this.#n,e+4,s)),this.#r.decode(i)}get fallbackName(){return this.#u(0)}get loadedName(){return this.#u(1)}get mimetype(){return this.#u(2)}get name(){return this.#u(3)}get data(){let t=st.#a;const e=this.#o.getUint32(t);t+=4+e;const s=this.#o.getUint32(t);t+=4+s;const i=this.#o.getUint32(t);t+=4+i;const n=this.#o.getUint32(t);if(n!==0)return new Uint8Array(this.#n,t+4,n)}clearData(){let t=st.#a;const e=this.#o.getUint32(t);t+=4+e;const s=this.#o.getUint32(t);t+=4+s;const i=this.#o.getUint32(t);t+=4+i;const n=this.#o.getUint32(t);new Uint8Array(this.#n,t+4,n).fill(0),this.#o.setUint32(t,0)}get cssFontInfo(){let t=st.#a;const e=this.#o.getUint32(t);t+=4+e;const s=this.#o.getUint32(t);t+=4+s;const i=this.#o.getUint32(t);if(i===0)return null;const n=new Uint8Array(i);return n.set(new Uint8Array(this.#n,t+4,i)),new ve(n.buffer)}get systemFontInfo(){let t=st.#a;const e=this.#o.getUint32(t);t+=4+e;const s=this.#o.getUint32(t);if(s===0)return null;const i=new Uint8Array(s);return i.set(new Uint8Array(this.#n,t+4,s)),new Ae(i.buffer)}static write(t){const e=t.systemFontInfo?Ae.write(t.systemFontInfo):null,s=t.cssFontInfo?ve.write(t.cssFontInfo):null,i=new TextEncoder,n={};let r=0;for(const p of st.strings)n[p]=i.encode(t[p]),r+=4+n[p].length;const a=st.#a+4+r+4+(e?e.byteLength:0)+4+(s?s.byteLength:0)+4+(t.data?t.data.length:0),o=new ArrayBuffer(a),l=new Uint8Array(o),h=new DataView(o);let c=0;const u=st.bools.length;let f=0,m=0;for(let p=0;p<u;p++){const b=t[st.bools[p]];f|=(b===void 0?0:b?2:1)<<m,m+=2,(m===8||p===u-1)&&(h.setUint8(c++,f),f=0,m=0)}Q(c===st.#t,"FontInfo.write: Boolean properties offset mismatch");for(const p of st.numbers)h.setFloat64(c,t[p]),c+=8;if(Q(c===st.#e,"FontInfo.write: Number properties offset mismatch"),t.bbox){h.setUint8(c++,4);for(const p of t.bbox)h.setInt16(c,p,!0),c+=2}else h.setUint8(c++,0),c+=8;if(Q(c===st.#i,"FontInfo.write: BBox properties offset mismatch"),t.fontMatrix){h.setUint8(c++,6);for(const p of t.fontMatrix)h.setFloat64(c,p,!0),c+=8}else h.setUint8(c++,0),c+=48;if(Q(c===st.#s,"FontInfo.write: FontMatrix properties offset mismatch"),t.defaultVMetrics){h.setUint8(c++,1);for(const p of t.defaultVMetrics)h.setInt16(c,p,!0),c+=2}else h.setUint8(c++,0),c+=6;Q(c===st.#a,"FontInfo.write: DefaultVMetrics properties offset mismatch"),h.setUint32(st.#a,0),c+=4;for(const p of st.strings){const b=n[p],g=b.length;h.setUint32(c,g),l.set(b,c+4),c+=4+g}if(h.setUint32(st.#a,c-st.#a-4),!e)h.setUint32(c,0),c+=4;else{const p=e.byteLength;h.setUint32(c,p),Q(c+4+p<=o.byteLength,"FontInfo.write: Buffer overflow at systemFontInfo"),l.set(new Uint8Array(e),c+4),c+=4+p}if(!s)h.setUint32(c,0),c+=4;else{const p=s.byteLength;h.setUint32(c,p),Q(c+4+p<=o.byteLength,"FontInfo.write: Buffer overflow at cssFontInfo"),l.set(new Uint8Array(s),c+4),c+=4+p}return t.data===void 0?(h.setUint32(c,0),c+=4):(h.setUint32(c,t.data.length),l.set(t.data,c+4),c+=4+t.data.length),Q(c<=o.byteLength,"FontInfo.write: Buffer overflow"),o.transferToFixedLength(c)}}class xe{static#t=null;static#e="";static get workerPort(){return this.#t}static set workerPort(t){if(!(typeof Worker<"u"&&t instanceof Worker)&&t!==null)throw new Error("Invalid `workerPort` type.");this.#t=t}static get workerSrc(){return this.#e}static set workerSrc(t){if(typeof t!="string")throw new Error("Invalid `workerSrc` type.");this.#e=t}}class xr{#t;#e;constructor({parsedData:t,rawData:e}){this.#t=t,this.#e=e}getRaw(){return this.#e}get(t){return this.#t.get(t)??null}[Symbol.iterator](){return this.#t.entries()}}const ge=Symbol("INTERNAL");class _r{#t=!1;#e=!1;#i=!1;#s=!0;constructor(t,{name:e,intent:s,usage:i,rbGroups:n}){this.#t=!!(t&It.DISPLAY),this.#e=!!(t&It.PRINT),this.name=e,this.intent=s,this.usage=i,this.rbGroups=n}get visible(){if(this.#i)return this.#s;if(!this.#s)return!1;const{print:t,view:e}=this.usage;return this.#t?e?.viewState!=="OFF":this.#e?t?.printState!=="OFF":!0}_setVisible(t,e,s=!1){t!==ge&&nt("Internal method `_setVisible` called."),this.#i=s,this.#s=e}}class Sr{#t=null;#e=new Map;#i=null;#s=null;constructor(t,e=It.DISPLAY){if(this.renderingIntent=e,this.name=null,this.creator=null,t!==null){this.name=t.name,this.creator=t.creator,this.#s=t.order;for(const s of t.groups)this.#e.set(s.id,new _r(e,s));if(t.baseState==="OFF")for(const s of this.#e.values())s._setVisible(ge,!1);for(const s of t.on)this.#e.get(s)._setVisible(ge,!0);for(const s of t.off)this.#e.get(s)._setVisible(ge,!1);this.#i=this.getHash()}}#a(t){const e=t.length;if(e<2)return!0;const s=t[0];for(let i=1;i<e;i++){const n=t[i];let r;if(Array.isArray(n))r=this.#a(n);else if(this.#e.has(n))r=this.#e.get(n).visible;else return G(`Optional content group not found: ${n}`),!0;switch(s){case"And":if(!r)return!1;break;case"Or":if(r)return!0;break;case"Not":return!r;default:return!0}}return s==="And"}isVisible(t){if(this.#e.size===0)return!0;if(!t)return cs("Optional content group not defined."),!0;if(t.type==="OCG")return this.#e.has(t.id)?this.#e.get(t.id).visible:(G(`Optional content group not found: ${t.id}`),!0);if(t.type==="OCMD"){if(t.expression)return this.#a(t.expression);if(!t.policy||t.policy==="AnyOn"){for(const e of t.ids){if(!this.#e.has(e))return G(`Optional content group not found: ${e}`),!0;if(this.#e.get(e).visible)return!0}return!1}else if(t.policy==="AllOn"){for(const e of t.ids){if(!this.#e.has(e))return G(`Optional content group not found: ${e}`),!0;if(!this.#e.get(e).visible)return!1}return!0}else if(t.policy==="AnyOff"){for(const e of t.ids){if(!this.#e.has(e))return G(`Optional content group not found: ${e}`),!0;if(!this.#e.get(e).visible)return!0}return!1}else if(t.policy==="AllOff"){for(const e of t.ids){if(!this.#e.has(e))return G(`Optional content group not found: ${e}`),!0;if(this.#e.get(e).visible)return!1}return!0}return G(`Unknown optional content policy ${t.policy}.`),!0}return G(`Unknown group type ${t.type}.`),!0}setVisibility(t,e=!0,s=!0){const i=this.#e.get(t);if(!i){G(`Optional content group not found: ${t}`);return}if(s&&e&&i.rbGroups.length)for(const n of i.rbGroups)for(const r of n)r!==t&&this.#e.get(r)?._setVisible(ge,!1,!0);i._setVisible(ge,!!e,!0),this.#t=null}setOCGState({state:t,preserveRB:e}){let s;for(const i of t){switch(i){case"ON":case"OFF":case"Toggle":s=i;continue}const n=this.#e.get(i);if(n)switch(s){case"ON":this.setVisibility(i,!0,e);break;case"OFF":this.setVisibility(i,!1,e);break;case"Toggle":this.setVisibility(i,!n.visible,e);break}}this.#t=null}get hasInitialVisibility(){return this.#i===null||this.getHash()===this.#i}getOrder(){return this.#e.size?this.#s?this.#s.slice():[...this.#e.keys()]:null}getGroup(t){return this.#e.get(t)||null}getHash(){if(this.#t!==null)return this.#t;const t=new $i;for(const[e,s]of this.#e)t.update(`${e}:${s.visible}`);return this.#t=t.hexdigest()}[Symbol.iterator](){return this.#e.entries()}}class Er{constructor(t,{disableRange:e=!1,disableStream:s=!1}){Q(t,'PDFDataTransportStream - missing required "pdfDataRangeTransport" argument.');const{length:i,initialData:n,progressiveDone:r,contentDispositionFilename:a}=t;if(this._queuedChunks=[],this._progressiveDone=r,this._contentDispositionFilename=a,n?.length>0){const o=n instanceof Uint8Array&&n.byteLength===n.buffer.byteLength?n.buffer:new Uint8Array(n).buffer;this._queuedChunks.push(o)}this._pdfDataRangeTransport=t,this._isStreamingSupported=!s,this._isRangeSupported=!e,this._contentLength=i,this._fullRequestReader=null,this._rangeReaders=[],t.addRangeListener((o,l)=>{this._onReceiveData({begin:o,chunk:l})}),t.addProgressListener((o,l)=>{this._onProgress({loaded:o,total:l})}),t.addProgressiveReadListener(o=>{this._onReceiveData({chunk:o})}),t.addProgressiveDoneListener(()=>{this._onProgressiveDone()}),t.transportReady()}_onReceiveData({begin:t,chunk:e}){const s=e instanceof Uint8Array&&e.byteLength===e.buffer.byteLength?e.buffer:new Uint8Array(e).buffer;if(t===void 0)this._fullRequestReader?this._fullRequestReader._enqueue(s):this._queuedChunks.push(s);else{const i=this._rangeReaders.some(function(n){return n._begin!==t?!1:(n._enqueue(s),!0)});Q(i,"_onReceiveData - no `PDFDataTransportStreamRangeReader` instance found.")}}get _progressiveDataLength(){return this._fullRequestReader?._loaded??0}_onProgress(t){t.total===void 0?this._rangeReaders[0]?.onProgress?.({loaded:t.loaded}):this._fullRequestReader?.onProgress?.({loaded:t.loaded,total:t.total})}_onProgressiveDone(){this._fullRequestReader?.progressiveDone(),this._progressiveDone=!0}_removeRangeReader(t){const e=this._rangeReaders.indexOf(t);e>=0&&this._rangeReaders.splice(e,1)}getFullReader(){Q(!this._fullRequestReader,"PDFDataTransportStream.getFullReader can only be called once.");const t=this._queuedChunks;return this._queuedChunks=null,new Cr(this,t,this._progressiveDone,this._contentDispositionFilename)}getRangeReader(t,e){if(e<=this._progressiveDataLength)return null;const s=new Tr(this,t,e);return this._pdfDataRangeTransport.requestDataRange(t,e),this._rangeReaders.push(s),s}cancelAllRequests(t){this._fullRequestReader?.cancel(t);for(const e of this._rangeReaders.slice(0))e.cancel(t);this._pdfDataRangeTransport.abort()}}class Cr{constructor(t,e,s=!1,i=null){this._stream=t,this._done=s||!1,this._filename=Us(i)?i:null,this._queuedChunks=e||[],this._loaded=0;for(const n of this._queuedChunks)this._loaded+=n.byteLength;this._requests=[],this._headersReady=Promise.resolve(),t._fullRequestReader=this,this.onProgress=null}_enqueue(t){this._done||(this._requests.length>0?this._requests.shift().resolve({value:t,done:!1}):this._queuedChunks.push(t),this._loaded+=t.byteLength)}get headersReady(){return this._headersReady}get filename(){return this._filename}get isRangeSupported(){return this._stream._isRangeSupported}get isStreamingSupported(){return this._stream._isStreamingSupported}get contentLength(){return this._stream._contentLength}async read(){if(this._queuedChunks.length>0)return{value:this._queuedChunks.shift(),done:!1};if(this._done)return{value:void 0,done:!0};const t=Promise.withResolvers();return this._requests.push(t),t.promise}cancel(t){this._done=!0;for(const e of this._requests)e.resolve({value:void 0,done:!0});this._requests.length=0}progressiveDone(){this._done||(this._done=!0)}}class Tr{constructor(t,e,s){this._stream=t,this._begin=e,this._end=s,this._queuedChunk=null,this._requests=[],this._done=!1,this.onProgress=null}_enqueue(t){if(!this._done){if(this._requests.length===0)this._queuedChunk=t;else{this._requests.shift().resolve({value:t,done:!1});for(const s of this._requests)s.resolve({value:void 0,done:!0});this._requests.length=0}this._done=!0,this._stream._removeRangeReader(this)}}get isStreamingSupported(){return!1}async read(){if(this._queuedChunk){const e=this._queuedChunk;return this._queuedChunk=null,{value:e,done:!1}}if(this._done)return{value:void 0,done:!0};const t=Promise.withResolvers();return this._requests.push(t),t.promise}cancel(t){this._done=!0;for(const e of this._requests)e.resolve({value:void 0,done:!0});this._requests.length=0,this._stream._removeRangeReader(this)}}function kr(d){let t=!0,e=s("filename\\*","i").exec(d);if(e){e=e[1];let h=a(e);return h=unescape(h),h=o(h),h=l(h),n(h)}if(e=r(d),e){const h=l(e);return n(h)}if(e=s("filename","i").exec(d),e){e=e[1];let h=a(e);return h=l(h),n(h)}function s(h,c){return new RegExp("(?:^|;)\\s*"+h+'\\s*=\\s*([^";\\s][^;\\s]*|"(?:[^"\\\\]|\\\\"?)+"?)',c)}function i(h,c){if(h){if(!/^[\x00-\xFF]+$/.test(c))return c;try{const u=new TextDecoder(h,{fatal:!0}),f=Be(c);c=u.decode(f),t=!1}catch{}}return c}function n(h){return t&&/[\x80-\xff]/.test(h)&&(h=i("utf-8",h),t&&(h=i("iso-8859-1",h))),h}function r(h){const c=[];let u;const f=s("filename\\*((?!0\\d)\\d+)(\\*?)","ig");for(;(u=f.exec(h))!==null;){let[,p,b,g]=u;if(p=parseInt(p,10),p in c){if(p===0)break;continue}c[p]=[b,g]}const m=[];for(let p=0;p<c.length&&p in c;++p){let[b,g]=c[p];g=a(g),b&&(g=unescape(g),p===0&&(g=o(g))),m.push(g)}return m.join("")}function a(h){if(h.startsWith('"')){const c=h.slice(1).split('\\"');for(let u=0;u<c.length;++u){const f=c[u].indexOf('"');f!==-1&&(c[u]=c[u].slice(0,f),c.length=u+1),c[u]=c[u].replaceAll(/\\(.)/g,"$1")}h=c.join('"')}return h}function o(h){const c=h.indexOf("'");if(c===-1)return h;const u=h.slice(0,c),m=h.slice(c+1).replace(/^[^']*'/,"");return i(u,m)}function l(h){return!h.startsWith("=?")||/[\x00-\x19\x80-\xff]/.test(h)?h:h.replaceAll(/=\?([\w-]*)\?([QqBb])\?((?:[^?]|\?(?!=))*)\?=/g,function(c,u,f,m){if(f==="q"||f==="Q")return m=m.replaceAll("_"," "),m=m.replaceAll(/=([0-9a-fA-F]{2})/g,function(p,b){return String.fromCharCode(parseInt(b,16))}),i(u,m);try{m=atob(m)}catch{}return i(u,m)})}return""}function Ki(d,t){const e=new Headers;if(!d||!t||typeof t!="object")return e;for(const s in t){const i=t[s];i!==void 0&&e.append(s,i)}return e}function fs(d){return URL.parse(d)?.origin??null}function Qi({responseHeaders:d,isHttp:t,rangeChunkSize:e,disableRange:s}){const i={allowRangeRequests:!1,suggestedLength:void 0},n=parseInt(d.get("Content-Length"),10);return!Number.isInteger(n)||(i.suggestedLength=n,n<=2*e)||s||!t||d.get("Accept-Ranges")!=="bytes"||(d.get("Content-Encoding")||"identity")!=="identity"||(i.allowRangeRequests=!0),i}function Ji(d){const t=d.get("Content-Disposition");if(t){let e=kr(t);if(e.includes("%"))try{e=decodeURIComponent(e)}catch{}if(Us(e))return e}return null}function $e(d,t){return new ns(`Unexpected server response (${d}) while retrieving PDF "${t}".`,d,d===404||d===0&&t.startsWith("file:"))}function Zi(d){return d===200||d===206}function tn(d,t,e){return{method:"GET",headers:d,signal:e.signal,mode:"cors",credentials:t?"include":"same-origin",redirect:"follow"}}function en(d){return d instanceof Uint8Array?d.buffer:d instanceof ArrayBuffer?d:(G(`getArrayBuffer - unexpected data format: ${d}`),new Uint8Array(d).buffer)}class Pr{_responseOrigin=null;constructor(t){this.source=t,this.isHttp=/^https?:/i.test(t.url),this.headers=Ki(this.isHttp,t.httpHeaders),this._fullRequestReader=null,this._rangeRequestReaders=[]}get _progressiveDataLength(){return this._fullRequestReader?._loaded??0}getFullReader(){return Q(!this._fullRequestReader,"PDFFetchStream.getFullReader can only be called once."),this._fullRequestReader=new Mr(this),this._fullRequestReader}getRangeReader(t,e){if(e<=this._progressiveDataLength)return null;const s=new Rr(this,t,e);return this._rangeRequestReaders.push(s),s}cancelAllRequests(t){this._fullRequestReader?.cancel(t);for(const e of this._rangeRequestReaders.slice(0))e.cancel(t)}}class Mr{constructor(t){this._stream=t,this._reader=null,this._loaded=0,this._filename=null;const e=t.source;this._withCredentials=e.withCredentials||!1,this._contentLength=e.length,this._headersCapability=Promise.withResolvers(),this._disableRange=e.disableRange||!1,this._rangeChunkSize=e.rangeChunkSize,!this._rangeChunkSize&&!this._disableRange&&(this._disableRange=!0),this._abortController=new AbortController,this._isStreamingSupported=!e.disableStream,this._isRangeSupported=!e.disableRange;const s=new Headers(t.headers),i=e.url;fetch(i,tn(s,this._withCredentials,this._abortController)).then(n=>{if(t._responseOrigin=fs(n.url),!Zi(n.status))throw $e(n.status,i);this._reader=n.body.getReader(),this._headersCapability.resolve();const r=n.headers,{allowRangeRequests:a,suggestedLength:o}=Qi({responseHeaders:r,isHttp:t.isHttp,rangeChunkSize:this._rangeChunkSize,disableRange:this._disableRange});this._isRangeSupported=a,this._contentLength=o||this._contentLength,this._filename=Ji(r),!this._isStreamingSupported&&this._isRangeSupported&&this.cancel(new ee("Streaming is disabled."))}).catch(this._headersCapability.reject),this.onProgress=null}get headersReady(){return this._headersCapability.promise}get filename(){return this._filename}get contentLength(){return this._contentLength}get isRangeSupported(){return this._isRangeSupported}get isStreamingSupported(){return this._isStreamingSupported}async read(){await this._headersCapability.promise;const{value:t,done:e}=await this._reader.read();return e?{value:t,done:e}:(this._loaded+=t.byteLength,this.onProgress?.({loaded:this._loaded,total:this._contentLength}),{value:en(t),done:!1})}cancel(t){this._reader?.cancel(t),this._abortController.abort()}}class Rr{constructor(t,e,s){this._stream=t,this._reader=null,this._loaded=0;const i=t.source;this._withCredentials=i.withCredentials||!1,this._readCapability=Promise.withResolvers(),this._isStreamingSupported=!i.disableStream,this._abortController=new AbortController;const n=new Headers(t.headers);n.append("Range",`bytes=${e}-${s-1}`);const r=i.url;fetch(r,tn(n,this._withCredentials,this._abortController)).then(a=>{const o=fs(a.url);if(o!==t._responseOrigin)throw new Error(`Expected range response-origin "${o}" to match "${t._responseOrigin}".`);if(!Zi(a.status))throw $e(a.status,r);this._readCapability.resolve(),this._reader=a.body.getReader()}).catch(this._readCapability.reject),this.onProgress=null}get isStreamingSupported(){return this._isStreamingSupported}async read(){await this._readCapability.promise;const{value:t,done:e}=await this._reader.read();return e?{value:t,done:e}:(this._loaded+=t.byteLength,this.onProgress?.({loaded:this._loaded}),{value:en(t),done:!1})}cancel(t){this._reader?.cancel(t),this._abortController.abort()}}const _s=200,Ss=206;function Lr(d){const t=d.response;return typeof t!="string"?t:Be(t).buffer}class Dr{_responseOrigin=null;constructor({url:t,httpHeaders:e,withCredentials:s}){this.url=t,this.isHttp=/^https?:/i.test(t),this.headers=Ki(this.isHttp,e),this.withCredentials=s||!1,this.currXhrId=0,this.pendingRequests=Object.create(null)}request(t){const e=new XMLHttpRequest,s=this.currXhrId++,i=this.pendingRequests[s]={xhr:e};e.open("GET",this.url),e.withCredentials=this.withCredentials;for(const[n,r]of this.headers)e.setRequestHeader(n,r);return this.isHttp&&"begin"in t&&"end"in t?(e.setRequestHeader("Range",`bytes=${t.begin}-${t.end-1}`),i.expectedStatus=Ss):i.expectedStatus=_s,e.responseType="arraybuffer",Q(t.onError,"Expected `onError` callback to be provided."),e.onerror=()=>{t.onError(e.status)},e.onreadystatechange=this.onStateChange.bind(this,s),e.onprogress=this.onProgress.bind(this,s),i.onHeadersReceived=t.onHeadersReceived,i.onDone=t.onDone,i.onError=t.onError,i.onProgress=t.onProgress,e.send(null),s}onProgress(t,e){const s=this.pendingRequests[t];s&&s.onProgress?.(e)}onStateChange(t,e){const s=this.pendingRequests[t];if(!s)return;const i=s.xhr;if(i.readyState>=2&&s.onHeadersReceived&&(s.onHeadersReceived(),delete s.onHeadersReceived),i.readyState!==4||!(t in this.pendingRequests))return;if(delete this.pendingRequests[t],i.status===0&&this.isHttp){s.onError(i.status);return}const n=i.status||_s;if(!(n===_s&&s.expectedStatus===Ss)&&n!==s.expectedStatus){s.onError(i.status);return}const a=Lr(i);if(n===Ss){const o=i.getResponseHeader("Content-Range"),l=/bytes (\d+)-(\d+)\/(\d+)/.exec(o);l?s.onDone({begin:parseInt(l[1],10),chunk:a}):(G('Missing or invalid "Content-Range" header.'),s.onError(0))}else a?s.onDone({begin:0,chunk:a}):s.onError(i.status)}getRequestXhr(t){return this.pendingRequests[t].xhr}isPendingRequest(t){return t in this.pendingRequests}abortRequest(t){const e=this.pendingRequests[t].xhr;delete this.pendingRequests[t],e.abort()}}class Ir{constructor(t){this._source=t,this._manager=new Dr(t),this._rangeChunkSize=t.rangeChunkSize,this._fullRequestReader=null,this._rangeRequestReaders=[]}_onRangeRequestReaderClosed(t){const e=this._rangeRequestReaders.indexOf(t);e>=0&&this._rangeRequestReaders.splice(e,1)}getFullReader(){return Q(!this._fullRequestReader,"PDFNetworkStream.getFullReader can only be called once."),this._fullRequestReader=new Nr(this._manager,this._source),this._fullRequestReader}getRangeReader(t,e){const s=new Fr(this._manager,t,e);return s.onClosed=this._onRangeRequestReaderClosed.bind(this),this._rangeRequestReaders.push(s),s}cancelAllRequests(t){this._fullRequestReader?.cancel(t);for(const e of this._rangeRequestReaders.slice(0))e.cancel(t)}}class Nr{constructor(t,e){this._manager=t,this._url=e.url,this._fullRequestId=t.request({onHeadersReceived:this._onHeadersReceived.bind(this),onDone:this._onDone.bind(this),onError:this._onError.bind(this),onProgress:this._onProgress.bind(this)}),this._headersCapability=Promise.withResolvers(),this._disableRange=e.disableRange||!1,this._contentLength=e.length,this._rangeChunkSize=e.rangeChunkSize,!this._rangeChunkSize&&!this._disableRange&&(this._disableRange=!0),this._isStreamingSupported=!1,this._isRangeSupported=!1,this._cachedChunks=[],this._requests=[],this._done=!1,this._storedError=void 0,this._filename=null,this.onProgress=null}_onHeadersReceived(){const t=this._fullRequestId,e=this._manager.getRequestXhr(t);this._manager._responseOrigin=fs(e.responseURL);const s=e.getAllResponseHeaders(),i=new Headers(s?s.trimStart().replace(/[^\S ]+$/,"").split(/[\r\n]+/).map(a=>{const[o,...l]=a.split(": ");return[o,l.join(": ")]}):[]),{allowRangeRequests:n,suggestedLength:r}=Qi({responseHeaders:i,isHttp:this._manager.isHttp,rangeChunkSize:this._rangeChunkSize,disableRange:this._disableRange});n&&(this._isRangeSupported=!0),this._contentLength=r||this._contentLength,this._filename=Ji(i),this._isRangeSupported&&this._manager.abortRequest(t),this._headersCapability.resolve()}_onDone(t){if(t&&(this._requests.length>0?this._requests.shift().resolve({value:t.chunk,done:!1}):this._cachedChunks.push(t.chunk)),this._done=!0,!(this._cachedChunks.length>0)){for(const e of this._requests)e.resolve({value:void 0,done:!0});this._requests.length=0}}_onError(t){this._storedError=$e(t,this._url),this._headersCapability.reject(this._storedError);for(const e of this._requests)e.reject(this._storedError);this._requests.length=0,this._cachedChunks.length=0}_onProgress(t){this.onProgress?.({loaded:t.loaded,total:t.lengthComputable?t.total:this._contentLength})}get filename(){return this._filename}get isRangeSupported(){return this._isRangeSupported}get isStreamingSupported(){return this._isStreamingSupported}get contentLength(){return this._contentLength}get headersReady(){return this._headersCapability.promise}async read(){if(await this._headersCapability.promise,this._storedError)throw this._storedError;if(this._cachedChunks.length>0)return{value:this._cachedChunks.shift(),done:!1};if(this._done)return{value:void 0,done:!0};const t=Promise.withResolvers();return this._requests.push(t),t.promise}cancel(t){this._done=!0,this._headersCapability.reject(t);for(const e of this._requests)e.resolve({value:void 0,done:!0});this._requests.length=0,this._manager.isPendingRequest(this._fullRequestId)&&this._manager.abortRequest(this._fullRequestId),this._fullRequestReader=null}}class Fr{constructor(t,e,s){this._manager=t,this._url=t.url,this._requestId=t.request({begin:e,end:s,onHeadersReceived:this._onHeadersReceived.bind(this),onDone:this._onDone.bind(this),onError:this._onError.bind(this),onProgress:this._onProgress.bind(this)}),this._requests=[],this._queuedChunk=null,this._done=!1,this._storedError=void 0,this.onProgress=null,this.onClosed=null}_onHeadersReceived(){const t=fs(this._manager.getRequestXhr(this._requestId)?.responseURL);t!==this._manager._responseOrigin&&(this._storedError=new Error(`Expected range response-origin "${t}" to match "${this._manager._responseOrigin}".`),this._onError(0))}_close(){this.onClosed?.(this)}_onDone(t){const e=t.chunk;this._requests.length>0?this._requests.shift().resolve({value:e,done:!1}):this._queuedChunk=e,this._done=!0;for(const s of this._requests)s.resolve({value:void 0,done:!0});this._requests.length=0,this._close()}_onError(t){this._storedError??=$e(t,this._url);for(const e of this._requests)e.reject(this._storedError);this._requests.length=0,this._queuedChunk=null}_onProgress(t){this.isStreamingSupported||this.onProgress?.({loaded:t.loaded})}get isStreamingSupported(){return!1}async read(){if(this._storedError)throw this._storedError;if(this._queuedChunk!==null){const e=this._queuedChunk;return this._queuedChunk=null,{value:e,done:!1}}if(this._done)return{value:void 0,done:!0};const t=Promise.withResolvers();return this._requests.push(t),t.promise}cancel(t){this._done=!0;for(const e of this._requests)e.resolve({value:void 0,done:!0});this._requests.length=0,this._manager.isPendingRequest(this._requestId)&&this._manager.abortRequest(this._requestId),this._close()}}const Or=/^[a-z][a-z0-9\-+.]+:/i;function Br(d){if(Or.test(d))return new URL(d);const t=process.getBuiltinModule("url");return new URL(t.pathToFileURL(d))}class jr{constructor(t){this.source=t,this.url=Br(t.url),Q(this.url.protocol==="file:","PDFNodeStream only supports file:// URLs."),this._fullRequestReader=null,this._rangeRequestReaders=[]}get _progressiveDataLength(){return this._fullRequestReader?._loaded??0}getFullReader(){return Q(!this._fullRequestReader,"PDFNodeStream.getFullReader can only be called once."),this._fullRequestReader=new Hr(this),this._fullRequestReader}getRangeReader(t,e){if(e<=this._progressiveDataLength)return null;const s=new Ur(this,t,e);return this._rangeRequestReaders.push(s),s}cancelAllRequests(t){this._fullRequestReader?.cancel(t);for(const e of this._rangeRequestReaders.slice(0))e.cancel(t)}}class Hr{constructor(t){this._url=t.url,this._done=!1,this._storedError=null,this.onProgress=null;const e=t.source;this._contentLength=e.length,this._loaded=0,this._filename=null,this._disableRange=e.disableRange||!1,this._rangeChunkSize=e.rangeChunkSize,!this._rangeChunkSize&&!this._disableRange&&(this._disableRange=!0),this._isStreamingSupported=!e.disableStream,this._isRangeSupported=!e.disableRange,this._readableStream=null,this._readCapability=Promise.withResolvers(),this._headersCapability=Promise.withResolvers();const s=process.getBuiltinModule("fs");s.promises.lstat(this._url).then(i=>{this._contentLength=i.size,this._setReadableStream(s.createReadStream(this._url)),this._headersCapability.resolve()},i=>{i.code==="ENOENT"&&(i=$e(0,this._url.href)),this._storedError=i,this._headersCapability.reject(i)})}get headersReady(){return this._headersCapability.promise}get filename(){return this._filename}get contentLength(){return this._contentLength}get isRangeSupported(){return this._isRangeSupported}get isStreamingSupported(){return this._isStreamingSupported}async read(){if(await this._readCapability.promise,this._done)return{value:void 0,done:!0};if(this._storedError)throw this._storedError;const t=this._readableStream.read();return t===null?(this._readCapability=Promise.withResolvers(),this.read()):(this._loaded+=t.length,this.onProgress?.({loaded:this._loaded,total:this._contentLength}),{value:new Uint8Array(t).buffer,done:!1})}cancel(t){if(!this._readableStream){this._error(t);return}this._readableStream.destroy(t)}_error(t){this._storedError=t,this._readCapability.resolve()}_setReadableStream(t){this._readableStream=t,t.on("readable",()=>{this._readCapability.resolve()}),t.on("end",()=>{t.destroy(),this._done=!0,this._readCapability.resolve()}),t.on("error",e=>{this._error(e)}),!this._isStreamingSupported&&this._isRangeSupported&&this._error(new ee("streaming is disabled")),this._storedError&&this._readableStream.destroy(this._storedError)}}class Ur{constructor(t,e,s){this._url=t.url,this._done=!1,this._storedError=null,this.onProgress=null,this._loaded=0,this._readableStream=null,this._readCapability=Promise.withResolvers();const i=t.source;this._isStreamingSupported=!i.disableStream;const n=process.getBuiltinModule("fs");this._setReadableStream(n.createReadStream(this._url,{start:e,end:s-1}))}get isStreamingSupported(){return this._isStreamingSupported}async read(){if(await this._readCapability.promise,this._done)return{value:void 0,done:!0};if(this._storedError)throw this._storedError;const t=this._readableStream.read();return t===null?(this._readCapability=Promise.withResolvers(),this.read()):(this._loaded+=t.length,this.onProgress?.({loaded:this._loaded}),{value:new Uint8Array(t).buffer,done:!1})}cancel(t){if(!this._readableStream){this._error(t);return}this._readableStream.destroy(t)}_error(t){this._storedError=t,this._readCapability.resolve()}_setReadableStream(t){this._readableStream=t,t.on("readable",()=>{this._readCapability.resolve()}),t.on("end",()=>{t.destroy(),this._done=!0,this._readCapability.resolve()}),t.on("error",e=>{this._error(e)}),this._storedError&&this._readableStream.destroy(this._storedError)}}const Ce=Symbol("INITIAL_DATA");class sn{#t=Object.create(null);#e(t){return this.#t[t]||={...Promise.withResolvers(),data:Ce}}get(t,e=null){if(e){const i=this.#e(t);return i.promise.then(()=>e(i.data)),null}const s=this.#t[t];if(!s||s.data===Ce)throw new Error(`Requesting object that isn't resolved yet ${t}.`);return s.data}has(t){const e=this.#t[t];return!!e&&e.data!==Ce}delete(t){const e=this.#t[t];return!e||e.data===Ce?!1:(delete this.#t[t],!0)}resolve(t,e=null){const s=this.#e(t);s.data=e,s.resolve()}clear(){for(const t in this.#t){const{data:e}=this.#t[t];e?.bitmap?.close()}this.#t=Object.create(null)}*[Symbol.iterator](){for(const t in this.#t){const{data:e}=this.#t[t];e!==Ce&&(yield[t,e])}}}const zr=1e5,Mi=30;class Tt{#t=Promise.withResolvers();#e=null;#i=!1;#s=!!globalThis.FontInspector?.enabled;#a=null;#n=null;#r=0;#o=0;#h=null;#l=null;#u=0;#d=0;#f=Object.create(null);#m=[];#p=null;#c=[];#g=new WeakMap;#b=null;static#w=new Map;static#y=new Map;static#E=new WeakMap;static#_=null;static#v=new Set;constructor({textContentSource:t,container:e,viewport:s}){if(t instanceof ReadableStream)this.#p=t;else if(typeof t=="object")this.#p=new ReadableStream({start(o){o.enqueue(t),o.close()}});else throw new Error('No "textContentSource" parameter specified.');this.#e=this.#l=e,this.#d=s.scale*qt.pixelRatio,this.#u=s.rotation,this.#n={div:null,properties:null,ctx:null};const{pageWidth:i,pageHeight:n,pageX:r,pageY:a}=s.rawDims;this.#b=[1,0,0,-1,-r,a+n],this.#o=i,this.#r=n,Tt.#P(),le(e,s),this.#t.promise.finally(()=>{Tt.#v.delete(this),this.#n=null,this.#f=null}).catch(()=>{})}static get fontFamilyMap(){const{isWindows:t,isFirefox:e}=_t.platform;return W(this,"fontFamilyMap",new Map([["sans-serif",`${t&&e?"Calibri, ":""}sans-serif`],["monospace",`${t&&e?"Lucida Console, ":""}monospace`]]))}render(){const t=()=>{this.#h.read().then(({value:e,done:s})=>{if(s){this.#t.resolve();return}this.#a??=e.lang,Object.assign(this.#f,e.styles),this.#T(e.items),t()},this.#t.reject)};return this.#h=this.#p.getReader(),Tt.#v.add(this),t(),this.#t.promise}update({viewport:t,onBefore:e=null}){const s=t.scale*qt.pixelRatio,i=t.rotation;if(i!==this.#u&&(e?.(),this.#u=i,le(this.#l,{rotation:i})),s!==this.#d){e?.(),this.#d=s;const n={div:null,properties:null,ctx:Tt.#M(this.#a)};for(const r of this.#c)n.properties=this.#g.get(r),n.div=r,this.#S(n)}}cancel(){const t=new ee("TextLayer task cancelled.");this.#h?.cancel(t).catch(()=>{}),this.#h=null,this.#t.reject(t)}get textDivs(){return this.#c}get textContentItemsStr(){return this.#m}#T(t){if(this.#i)return;this.#n.ctx??=Tt.#M(this.#a);const e=this.#c,s=this.#m;for(const i of t){if(e.length>zr){G("Ignoring additional textDivs for performance reasons."),this.#i=!0;return}if(i.str===void 0){if(i.type==="beginMarkedContentProps"||i.type==="beginMarkedContent"){const n=this.#e;this.#e=document.createElement("span"),this.#e.classList.add("markedContent"),i.id&&this.#e.setAttribute("id",`${i.id}`),n.append(this.#e)}else i.type==="endMarkedContent"&&(this.#e=this.#e.parentNode);continue}s.push(i.str),this.#x(i)}}#x(t){const e=document.createElement("span"),s={angle:0,canvasWidth:0,hasText:t.str!=="",hasEOL:t.hasEOL,fontSize:0};this.#c.push(e);const i=B.transform(this.#b,t.transform);let n=Math.atan2(i[1],i[0]);const r=this.#f[t.fontName];r.vertical&&(n+=Math.PI/2);let a=this.#s&&r.fontSubstitution||r.fontFamily;a=Tt.fontFamilyMap.get(a)||a;const o=Math.hypot(i[2],i[3]),l=o*Tt.#O(a,r,this.#a);let h,c;n===0?(h=i[4],c=i[5]-l):(h=i[4]+l*Math.sin(n),c=i[5]-l*Math.cos(n));const u="calc(var(--total-scale-factor) *",f=e.style;this.#e===this.#l?(f.left=`${(100*h/this.#o).toFixed(2)}%`,f.top=`${(100*c/this.#r).toFixed(2)}%`):(f.left=`${u}${h.toFixed(2)}px)`,f.top=`${u}${c.toFixed(2)}px)`),f.fontSize=`${u}${(Tt.#_*o).toFixed(2)}px)`,f.fontFamily=a,s.fontSize=o,e.setAttribute("role","presentation"),e.textContent=t.str,e.dir=t.dir,this.#s&&(e.dataset.fontName=r.fontSubstitutionLoadedName||t.fontName),n!==0&&(s.angle=n*(180/Math.PI));let m=!1;if(t.str.length>1)m=!0;else if(t.str!==" "&&t.transform[0]!==t.transform[3]){const p=Math.abs(t.transform[0]),b=Math.abs(t.transform[3]);p!==b&&Math.max(p,b)/Math.min(p,b)>1.5&&(m=!0)}if(m&&(s.canvasWidth=r.vertical?t.height:t.width),this.#g.set(e,s),this.#n.div=e,this.#n.properties=s,this.#S(this.#n),s.hasText&&this.#e.append(e),s.hasEOL){const p=document.createElement("br");p.setAttribute("role","presentation"),this.#e.append(p)}}#S(t){const{div:e,properties:s,ctx:i}=t,{style:n}=e;let r="";if(Tt.#_>1&&(r=`scale(${1/Tt.#_})`),s.canvasWidth!==0&&s.hasText){const{fontFamily:a}=n,{canvasWidth:o,fontSize:l}=s;Tt.#k(i,l*this.#d,a);const{width:h}=i.measureText(e.textContent);h>0&&(r=`scaleX(${o*this.#d/h}) ${r}`)}s.angle!==0&&(r=`rotate(${s.angle}deg) ${r}`),r.length>0&&(n.transform=r)}static cleanup(){if(!(this.#v.size>0)){this.#w.clear();for(const{canvas:t}of this.#y.values())t.remove();this.#y.clear()}}static#M(t=null){let e=this.#y.get(t||="");if(!e){const s=document.createElement("canvas");s.className="hiddenCanvasElement",s.lang=t,document.body.append(s),e=s.getContext("2d",{alpha:!1,willReadFrequently:!0}),this.#y.set(t,e),this.#E.set(e,{size:0,family:""})}return e}static#k(t,e,s){const i=this.#E.get(t);e===i.size&&s===i.family||(t.font=`${e}px ${s}`,i.size=e,i.family=s)}static#P(){if(this.#_!==null)return;const t=document.createElement("div");t.style.opacity=0,t.style.lineHeight=1,t.style.fontSize="1px",t.style.position="absolute",t.textContent="X",document.body.append(t),this.#_=t.getBoundingClientRect().height,t.remove()}static#O(t,e,s){const i=this.#w.get(t);if(i)return i;const n=this.#M(s);n.canvas.width=n.canvas.height=Mi,this.#k(n,Mi,t);const r=n.measureText(""),a=r.fontBoundingBoxAscent,o=Math.abs(r.fontBoundingBoxDescent);n.canvas.width=n.canvas.height=0;let l=.8;return a?l=a/(a+o):(_t.platform.isFirefox&&G("Enable the `dom.textMetrics.fontBoundingBox.enabled` preference in `about:config` to improve TextLayer rendering."),e.ascent?l=e.ascent:e.descent&&(l=1+e.descent)),this.#w.set(t,l),l}}const $r=100;function nn(d={}){typeof d=="string"||d instanceof URL?d={url:d}:(d instanceof ArrayBuffer||ArrayBuffer.isView(d))&&(d={data:d});const t=new Xs,{docId:e}=t,s=d.url?Kn(d.url):null,i=d.data?Qn(d.data):null,n=d.httpHeaders||null,r=d.withCredentials===!0,a=d.password??null,o=d.range instanceof rn?d.range:null,l=Number.isInteger(d.rangeChunkSize)&&d.rangeChunkSize>0?d.rangeChunkSize:2**16;let h=d.worker instanceof Fe?d.worker:null;const c=d.verbosity,u=typeof d.docBaseUrl=="string"&&!ds(d.docBaseUrl)?d.docBaseUrl:null,f=qe(d.cMapUrl),m=d.cMapPacked!==!1,p=d.CMapReaderFactory||(kt?rr:mi),b=qe(d.iccUrl),g=qe(d.standardFontDataUrl),v=d.StandardFontDataFactory||(kt?ar:bi),y=qe(d.wasmUrl),S=d.WasmFactory||(kt?or:yi),A=d.stopAtErrors!==!0,w=Number.isInteger(d.maxImageSize)&&d.maxImageSize>-1?d.maxImageSize:-1,_=d.isEvalSupported!==!1,x=typeof d.isOffscreenCanvasSupported=="boolean"?d.isOffscreenCanvasSupported:!kt,E=typeof d.isImageDecoderSupported=="boolean"?d.isImageDecoderSupported:!kt&&(_t.platform.isFirefox||!globalThis.chrome),k=Number.isInteger(d.canvasMaxAreaInBytes)?d.canvasMaxAreaInBytes:-1,T=typeof d.disableFontFace=="boolean"?d.disableFontFace:kt,P=d.fontExtraProperties===!0,M=d.enableXfa===!0,I=d.ownerDocument||globalThis.document,R=d.disableRange===!0,D=d.disableStream===!0,O=d.disableAutoFetch===!0,N=d.pdfBug===!0,H=d.CanvasFactory||(kt?nr:er),q=d.FilterFactory||(kt?ir:sr),ct=d.enableHWA===!0,Y=d.useWasm!==!1,z=o?o.length:d.length??NaN,J=typeof d.useSystemFonts=="boolean"?d.useSystemFonts:!kt&&!T,Et=typeof d.useWorkerFetch=="boolean"?d.useWorkerFetch:!!(p===mi&&v===bi&&S===yi&&f&&g&&y&&Pe(f,document.baseURI)&&Pe(g,document.baseURI)&&Pe(y,document.baseURI)),ft=null;Sn(c);const Z={canvasFactory:new H({ownerDocument:I,enableHWA:ct}),filterFactory:new q({docId:e,ownerDocument:I}),cMapReaderFactory:Et?null:new p({baseUrl:f,isCompressed:m}),standardFontDataFactory:Et?null:new v({baseUrl:g}),wasmFactory:Et?null:new S({baseUrl:y})};h||(h=Fe.create({verbosity:c,port:xe.workerPort}),t._worker=h);const wt={docId:e,apiVersion:"5.4.296",data:i,password:a,disableAutoFetch:O,rangeChunkSize:l,length:z,docBaseUrl:u,enableXfa:M,evaluatorOptions:{maxImageSize:w,disableFontFace:T,ignoreErrors:A,isEvalSupported:_,isOffscreenCanvasSupported:x,isImageDecoderSupported:E,canvasMaxAreaInBytes:k,fontExtraProperties:P,useSystemFonts:J,useWasm:Y,useWorkerFetch:Et,cMapUrl:f,iccUrl:b,standardFontDataUrl:g,wasmUrl:y}},Xt={ownerDocument:I,pdfBug:N,styleElement:ft,loadingParams:{disableAutoFetch:O,enableXfa:M}};return h.promise.then(function(){if(t.destroyed)throw new Error("Loading aborted");if(h.destroyed)throw new Error("Worker was destroyed");const L=h.messageHandler.sendWithPromise("GetDocRequest",wt,i?[i.buffer]:null);let $;if(o)$=new Er(o,{disableRange:R,disableStream:D});else if(!i){if(!s)throw new Error("getDocument - no `url` parameter provided.");const it=Pe(s)?Pr:kt?jr:Ir;$=new it({url:s,length:z,httpHeaders:n,withCredentials:r,rangeChunkSize:l,disableRange:R,disableStream:D})}return L.then(it=>{if(t.destroyed)throw new Error("Loading aborted");if(h.destroyed)throw new Error("Worker was destroyed");const X=new Me(e,it,h.port),mt=new Wr(X,t,$,Xt,Z,ct);t._transport=mt,X.send("Ready",null)})}).catch(t._capability.reject),t}class Xs{static#t=0;_capability=Promise.withResolvers();_transport=null;_worker=null;docId=`d${Xs.#t++}`;destroyed=!1;onPassword=null;onProgress=null;get promise(){return this._capability.promise}async destroy(){this.destroyed=!0;try{this._worker?.port&&(this._worker._pendingDestroy=!0),await this._transport?.destroy()}catch(t){throw this._worker?.port&&delete this._worker._pendingDestroy,t}this._transport=null,this._worker?.destroy(),this._worker=null}async getData(){return this._transport.getData()}}class rn{#t=Promise.withResolvers();#e=[];#i=[];#s=[];#a=[];constructor(t,e,s=!1,i=null){this.length=t,this.initialData=e,this.progressiveDone=s,this.contentDispositionFilename=i}addRangeListener(t){this.#a.push(t)}addProgressListener(t){this.#s.push(t)}addProgressiveReadListener(t){this.#i.push(t)}addProgressiveDoneListener(t){this.#e.push(t)}onDataRange(t,e){for(const s of this.#a)s(t,e)}onDataProgress(t,e){this.#t.promise.then(()=>{for(const s of this.#s)s(t,e)})}onDataProgressiveRead(t){this.#t.promise.then(()=>{for(const e of this.#i)e(t)})}onDataProgressiveDone(){this.#t.promise.then(()=>{for(const t of this.#e)t()})}transportReady(){this.#t.resolve()}requestDataRange(t,e){nt("Abstract method PDFDataRangeTransport.requestDataRange")}abort(){}}class Gr{constructor(t,e){this._pdfInfo=t,this._transport=e}get annotationStorage(){return this._transport.annotationStorage}get canvasFactory(){return this._transport.canvasFactory}get filterFactory(){return this._transport.filterFactory}get numPages(){return this._pdfInfo.numPages}get fingerprints(){return this._pdfInfo.fingerprints}get isPureXfa(){return W(this,"isPureXfa",!!this._transport._htmlForXfa)}get allXfaHtml(){return this._transport._htmlForXfa}getPage(t){return this._transport.getPage(t)}getPageIndex(t){return this._transport.getPageIndex(t)}getDestinations(){return this._transport.getDestinations()}getDestination(t){return this._transport.getDestination(t)}getPageLabels(){return this._transport.getPageLabels()}getPageLayout(){return this._transport.getPageLayout()}getPageMode(){return this._transport.getPageMode()}getViewerPreferences(){return this._transport.getViewerPreferences()}getOpenAction(){return this._transport.getOpenAction()}getAttachments(){return this._transport.getAttachments()}getAnnotationsByType(t,e){return this._transport.getAnnotationsByType(t,e)}getJSActions(){return this._transport.getDocJSActions()}getOutline(){return this._transport.getOutline()}getOptionalContentConfig({intent:t="display"}={}){const{renderingIntent:e}=this._transport.getRenderingIntent(t);return this._transport.getOptionalContentConfig(e)}getPermissions(){return this._transport.getPermissions()}getMetadata(){return this._transport.getMetadata()}getMarkInfo(){return this._transport.getMarkInfo()}getData(){return this._transport.getData()}saveDocument(){return this._transport.saveDocument()}getDownloadInfo(){return this._transport.downloadInfoCapability.promise}cleanup(t=!1){return this._transport.startCleanup(t||this.isPureXfa)}destroy(){return this.loadingTask.destroy()}cachedPageNumber(t){return this._transport.cachedPageNumber(t)}get loadingParams(){return this._transport.loadingParams}get loadingTask(){return this._transport.loadingTask}getFieldObjects(){return this._transport.getFieldObjects()}hasJSActions(){return this._transport.hasJSActions()}getCalculationOrderIds(){return this._transport.getCalculationOrderIds()}}class Vr{#t=!1;constructor(t,e,s,i=!1){this._pageIndex=t,this._pageInfo=e,this._transport=s,this._stats=i?new hi:null,this._pdfBug=i,this.commonObjs=s.commonObjs,this.objs=new sn,this._intentStates=new Map,this.destroyed=!1,this.recordedBBoxes=null}get pageNumber(){return this._pageIndex+1}get rotate(){return this._pageInfo.rotate}get ref(){return this._pageInfo.ref}get userUnit(){return this._pageInfo.userUnit}get view(){return this._pageInfo.view}getViewport({scale:t,rotation:e=this.rotate,offsetX:s=0,offsetY:i=0,dontFlip:n=!1}={}){return new He({viewBox:this.view,userUnit:this.userUnit,scale:t,rotation:e,offsetX:s,offsetY:i,dontFlip:n})}getAnnotations({intent:t="display"}={}){const{renderingIntent:e}=this._transport.getRenderingIntent(t);return this._transport.getAnnotations(this._pageIndex,e)}getJSActions(){return this._transport.getPageJSActions(this._pageIndex)}get filterFactory(){return this._transport.filterFactory}get isPureXfa(){return W(this,"isPureXfa",!!this._transport._htmlForXfa)}async getXfa(){return this._transport._htmlForXfa?.children[this._pageIndex]||null}render({canvasContext:t,canvas:e=t.canvas,viewport:s,intent:i="display",annotationMode:n=Zt.ENABLE,transform:r=null,background:a=null,optionalContentConfigPromise:o=null,annotationCanvasMap:l=null,pageColors:h=null,printAnnotationStorage:c=null,isEditing:u=!1,recordOperations:f=!1,operationsFilter:m=null}){this._stats?.time("Overall");const p=this._transport.getRenderingIntent(i,n,c,u),{renderingIntent:b,cacheKey:g}=p;this.#t=!1,o||=this._transport.getOptionalContentConfig(b);let v=this._intentStates.get(g);v||(v=Object.create(null),this._intentStates.set(g,v)),v.streamReaderCancelTimeout&&(clearTimeout(v.streamReaderCancelTimeout),v.streamReaderCancelTimeout=null);const y=!!(b&It.PRINT);v.displayReadyCapability||(v.displayReadyCapability=Promise.withResolvers(),v.operatorList={fnArray:[],argsArray:[],lastChunk:!1,separateAnnots:null},this._stats?.time("Page Request"),this._pumpOperatorList(p));const S=!!(this._pdfBug&&globalThis.StepperManager?.enabled),A=!this.recordedBBoxes&&(f||S),w=E=>{if(v.renderTasks.delete(_),A){const k=_.gfx?.dependencyTracker.take();k&&(_.stepper&&_.stepper.setOperatorBBoxes(k,_.gfx.dependencyTracker.takeDebugMetadata()),f&&(this.recordedBBoxes=k))}y&&(this.#t=!0),this.#e(),E?(_.capability.reject(E),this._abortOperatorList({intentState:v,reason:E instanceof Error?E:new Error(E)})):_.capability.resolve(),this._stats&&(this._stats.timeEnd("Rendering"),this._stats.timeEnd("Overall"),globalThis.Stats?.enabled&&globalThis.Stats.add(this.pageNumber,this._stats))},_=new ye({callback:w,params:{canvas:e,canvasContext:t,dependencyTracker:A?new hr(e,v.operatorList.length,S):null,viewport:s,transform:r,background:a},objs:this.objs,commonObjs:this.commonObjs,annotationCanvasMap:l,operatorList:v.operatorList,pageIndex:this._pageIndex,canvasFactory:this._transport.canvasFactory,filterFactory:this._transport.filterFactory,useRequestAnimationFrame:!y,pdfBug:this._pdfBug,pageColors:h,enableHWA:this._transport.enableHWA,operationsFilter:m});(v.renderTasks||=new Set).add(_);const x=_.task;return Promise.all([v.displayReadyCapability.promise,o]).then(([E,k])=>{if(this.destroyed){w();return}if(this._stats?.time("Rendering"),!(k.renderingIntent&b))throw new Error("Must use the same `intent`-argument when calling the `PDFPageProxy.render` and `PDFDocumentProxy.getOptionalContentConfig` methods.");_.initializeGraphics({transparency:E,optionalContentConfig:k}),_.operatorListChanged()}).catch(w),x}getOperatorList({intent:t="display",annotationMode:e=Zt.ENABLE,printAnnotationStorage:s=null,isEditing:i=!1}={}){function n(){a.operatorList.lastChunk&&(a.opListReadCapability.resolve(a.operatorList),a.renderTasks.delete(o))}const r=this._transport.getRenderingIntent(t,e,s,i,!0);let a=this._intentStates.get(r.cacheKey);a||(a=Object.create(null),this._intentStates.set(r.cacheKey,a));let o;return a.opListReadCapability||(o=Object.create(null),o.operatorListChanged=n,a.opListReadCapability=Promise.withResolvers(),(a.renderTasks||=new Set).add(o),a.operatorList={fnArray:[],argsArray:[],lastChunk:!1,separateAnnots:null},this._stats?.time("Page Request"),this._pumpOperatorList(r)),a.opListReadCapability.promise}streamTextContent({includeMarkedContent:t=!1,disableNormalization:e=!1}={}){return this._transport.messageHandler.sendWithStream("GetTextContent",{pageIndex:this._pageIndex,includeMarkedContent:t===!0,disableNormalization:e===!0},{highWaterMark:100,size(i){return i.items.length}})}getTextContent(t={}){if(this._transport._htmlForXfa)return this.getXfa().then(s=>Ne.textContent(s));const e=this.streamTextContent(t);return new Promise(function(s,i){function n(){r.read().then(function({value:o,done:l}){if(l){s(a);return}a.lang??=o.lang,Object.assign(a.styles,o.styles),a.items.push(...o.items),n()},i)}const r=e.getReader(),a={items:[],styles:Object.create(null),lang:null};n()})}getStructTree(){return this._transport.getStructTree(this._pageIndex)}_destroy(){this.destroyed=!0;const t=[];for(const e of this._intentStates.values())if(this._abortOperatorList({intentState:e,reason:new Error("Page was destroyed."),force:!0}),!e.opListReadCapability)for(const s of e.renderTasks)t.push(s.completed),s.cancel();return this.objs.clear(),this.#t=!1,Promise.all(t)}cleanup(t=!1){this.#t=!0;const e=this.#e();return t&&e&&(this._stats&&=new hi),e}#e(){if(!this.#t||this.destroyed)return!1;for(const{renderTasks:t,operatorList:e}of this._intentStates.values())if(t.size>0||!e.lastChunk)return!1;return this._intentStates.clear(),this.objs.clear(),this.#t=!1,!0}_startRenderPage(t,e){const s=this._intentStates.get(e);s&&(this._stats?.timeEnd("Page Request"),s.displayReadyCapability?.resolve(t))}_renderPageChunk(t,e){for(let s=0,i=t.length;s<i;s++)e.operatorList.fnArray.push(t.fnArray[s]),e.operatorList.argsArray.push(t.argsArray[s]);e.operatorList.lastChunk=t.lastChunk,e.operatorList.separateAnnots=t.separateAnnots;for(const s of e.renderTasks)s.operatorListChanged();t.lastChunk&&this.#e()}_pumpOperatorList({renderingIntent:t,cacheKey:e,annotationStorageSerializable:s,modifiedIds:i}){const{map:n,transfer:r}=s,o=this._transport.messageHandler.sendWithStream("GetOperatorList",{pageIndex:this._pageIndex,intent:t,cacheKey:e,annotationStorage:n,modifiedIds:i},r).getReader(),l=this._intentStates.get(e);l.streamReader=o;const h=()=>{o.read().then(({value:c,done:u})=>{if(u){l.streamReader=null;return}this._transport.destroyed||(this._renderPageChunk(c,l),h())},c=>{if(l.streamReader=null,!this._transport.destroyed){if(l.operatorList){l.operatorList.lastChunk=!0;for(const u of l.renderTasks)u.operatorListChanged();this.#e()}if(l.displayReadyCapability)l.displayReadyCapability.reject(c);else if(l.opListReadCapability)l.opListReadCapability.reject(c);else throw c}})};h()}_abortOperatorList({intentState:t,reason:e,force:s=!1}){if(t.streamReader){if(t.streamReaderCancelTimeout&&(clearTimeout(t.streamReaderCancelTimeout),t.streamReaderCancelTimeout=null),!s){if(t.renderTasks.size>0)return;if(e instanceof Hs){let i=$r;e.extraDelay>0&&e.extraDelay<1e3&&(i+=e.extraDelay),t.streamReaderCancelTimeout=setTimeout(()=>{t.streamReaderCancelTimeout=null,this._abortOperatorList({intentState:t,reason:e,force:!0})},i);return}}if(t.streamReader.cancel(new ee(e.message)).catch(()=>{}),t.streamReader=null,!this._transport.destroyed){for(const[i,n]of this._intentStates)if(n===t){this._intentStates.delete(i);break}this.cleanup()}}}get stats(){return this._stats}}var te,Ht,Qt,re,os,ae,oe,Mt,ss,an,on,Re,_e,is;const at=class at{constructor({name:t=null,port:e=null,verbosity:s=En()}={}){Ut(this,Mt);Ut(this,te,Promise.withResolvers());Ut(this,Ht,null);Ut(this,Qt,null);Ut(this,re,null);if(this.name=t,this.destroyed=!1,this.verbosity=s,e){if(rt(at,oe).has(e))throw new Error("Cannot use more than one PDFWorker per port.");rt(at,oe).set(e,this),zt(this,Mt,an).call(this,e)}else zt(this,Mt,on).call(this)}get promise(){return rt(this,te).promise}get port(){return rt(this,Qt)}get messageHandler(){return rt(this,Ht)}destroy(){this.destroyed=!0,rt(this,re)?.terminate(),Rt(this,re,null),rt(at,oe).delete(rt(this,Qt)),Rt(this,Qt,null),rt(this,Ht)?.destroy(),Rt(this,Ht,null)}static create(t){const e=rt(this,oe).get(t?.port);if(e){if(e._pendingDestroy)throw new Error("PDFWorker.create - the worker is being destroyed.\nPlease remember to await `PDFDocumentLoadingTask.destroy()`-calls.");return e}return new at(t)}static get workerSrc(){if(xe.workerSrc)return xe.workerSrc;throw new Error('No "GlobalWorkerOptions.workerSrc" specified.')}static get _setupFakeWorkerGlobal(){return W(this,"_setupFakeWorkerGlobal",(async()=>rt(this,_e,is)?rt(this,_e,is):(await import(this.workerSrc)).WorkerMessageHandler)())}};te=new WeakMap,Ht=new WeakMap,Qt=new WeakMap,re=new WeakMap,os=new WeakMap,ae=new WeakMap,oe=new WeakMap,Mt=new WeakSet,ss=function(){rt(this,te).resolve(),rt(this,Ht).send("configure",{verbosity:this.verbosity})},an=function(t){Rt(this,Qt,t),Rt(this,Ht,new Me("main","worker",t)),rt(this,Ht).on("ready",()=>{}),zt(this,Mt,ss).call(this)},on=function(){if(rt(at,ae)||rt(at,_e,is)){zt(this,Mt,Re).call(this);return}let{workerSrc:t}=at;try{at._isSameOrigin(window.location,t)||(t=at._createCDNWrapper(new URL(t,window.location).href));const e=new Worker(t,{type:"module"}),s=new Me("main","worker",e),i=()=>{n.abort(),s.destroy(),e.terminate(),this.destroyed?rt(this,te).reject(new Error("Worker was destroyed")):zt(this,Mt,Re).call(this)},n=new AbortController;e.addEventListener("error",()=>{rt(this,re)||i()},{signal:n.signal}),s.on("test",a=>{if(n.abort(),this.destroyed||!a){i();return}Rt(this,Ht,s),Rt(this,Qt,e),Rt(this,re,e),zt(this,Mt,ss).call(this)}),s.on("ready",a=>{if(n.abort(),this.destroyed){i();return}try{r()}catch{zt(this,Mt,Re).call(this)}});const r=()=>{const a=new Uint8Array;s.send("test",a,[a.buffer])};r();return}catch{cs("The worker has been disabled.")}zt(this,Mt,Re).call(this)},Re=function(){rt(at,ae)||(G("Setting up fake worker."),Rt(at,ae,!0)),at._setupFakeWorkerGlobal.then(t=>{if(this.destroyed){rt(this,te).reject(new Error("Worker was destroyed"));return}const e=new tr;Rt(this,Qt,e);const s=`fake${ri(at,os)._++}`,i=new Me(s+"_worker",s,e);t.setup(i,e),Rt(this,Ht,new Me(s,s+"_worker",e)),zt(this,Mt,ss).call(this)}).catch(t=>{rt(this,te).reject(new Error(`Setting up fake worker failed: "${t.message}".`))})},_e=new WeakSet,is=function(){try{return globalThis.pdfjsWorker?.WorkerMessageHandler||null}catch{return null}},Ut(at,_e),Ut(at,os,0),Ut(at,ae,!1),Ut(at,oe,new WeakMap),kt&&(Rt(at,ae,!0),xe.workerSrc||="./pdf.worker.mjs"),at._isSameOrigin=(t,e)=>{const s=URL.parse(t);if(!s?.origin||s.origin==="null")return!1;const i=new URL(e,s);return s.origin===i.origin},at._createCDNWrapper=t=>{const e=`await import("${t}");`;return URL.createObjectURL(new Blob([e],{type:"text/javascript"}))},at.fromPort=t=>{if(On("`PDFWorker.fromPort` - please use `PDFWorker.create` instead."),!t?.port)throw new Error("PDFWorker.fromPort - invalid method signature.");return at.create(t)};let Fe=at;class Wr{#t=new Map;#e=new Map;#i=new Map;#s=new Map;#a=null;constructor(t,e,s,i,n,r){this.messageHandler=t,this.loadingTask=e,this.commonObjs=new sn,this.fontLoader=new Xn({ownerDocument:i.ownerDocument,styleElement:i.styleElement}),this.loadingParams=i.loadingParams,this._params=i,this.canvasFactory=n.canvasFactory,this.filterFactory=n.filterFactory,this.cMapReaderFactory=n.cMapReaderFactory,this.standardFontDataFactory=n.standardFontDataFactory,this.wasmFactory=n.wasmFactory,this.destroyed=!1,this.destroyCapability=null,this._networkStream=s,this._fullReader=null,this._lastProgress=null,this.downloadInfoCapability=Promise.withResolvers(),this.enableHWA=r,this.setupMessageHandler()}#n(t,e=null){const s=this.#t.get(t);if(s)return s;const i=this.messageHandler.sendWithPromise(t,e);return this.#t.set(t,i),i}get annotationStorage(){return W(this,"annotationStorage",new Gs)}getRenderingIntent(t,e=Zt.ENABLE,s=null,i=!1,n=!1){let r=It.DISPLAY,a=Rs;switch(t){case"any":r=It.ANY;break;case"display":break;case"print":r=It.PRINT;break;default:G(`getRenderingIntent - invalid intent: ${t}`)}const o=r&It.PRINT&&s instanceof Gi?s:this.annotationStorage;switch(e){case Zt.DISABLE:r+=It.ANNOTATIONS_DISABLE;break;case Zt.ENABLE:break;case Zt.ENABLE_FORMS:r+=It.ANNOTATIONS_FORMS;break;case Zt.ENABLE_STORAGE:r+=It.ANNOTATIONS_STORAGE,a=o.serializable;break;default:G(`getRenderingIntent - invalid annotationMode: ${e}`)}i&&(r+=It.IS_EDITING),n&&(r+=It.OPLIST);const{ids:l,hash:h}=o.modifiedIds,c=[r,a.hash,h];return{renderingIntent:r,cacheKey:c.join("_"),annotationStorageSerializable:a,modifiedIds:l}}destroy(){if(this.destroyCapability)return this.destroyCapability.promise;this.destroyed=!0,this.destroyCapability=Promise.withResolvers(),this.#a?.reject(new Error("Worker was destroyed during onPassword callback"));const t=[];for(const s of this.#e.values())t.push(s._destroy());this.#e.clear(),this.#i.clear(),this.#s.clear(),this.hasOwnProperty("annotationStorage")&&this.annotationStorage.resetModified();const e=this.messageHandler.sendWithPromise("Terminate",null);return t.push(e),Promise.all(t).then(()=>{this.commonObjs.clear(),this.fontLoader.clear(),this.#t.clear(),this.filterFactory.destroy(),Tt.cleanup(),this._networkStream?.cancelAllRequests(new ee("Worker was terminated.")),this.messageHandler?.destroy(),this.messageHandler=null,this.destroyCapability.resolve()},this.destroyCapability.reject),this.destroyCapability.promise}setupMessageHandler(){const{messageHandler:t,loadingTask:e}=this;t.on("GetReader",(s,i)=>{Q(this._networkStream,"GetReader - no `IPDFStream` instance available."),this._fullReader=this._networkStream.getFullReader(),this._fullReader.onProgress=n=>{this._lastProgress={loaded:n.loaded,total:n.total}},i.onPull=()=>{this._fullReader.read().then(function({value:n,done:r}){if(r){i.close();return}Q(n instanceof ArrayBuffer,"GetReader - expected an ArrayBuffer."),i.enqueue(new Uint8Array(n),1,[n])}).catch(n=>{i.error(n)})},i.onCancel=n=>{this._fullReader.cancel(n),i.ready.catch(r=>{if(!this.destroyed)throw r})}}),t.on("ReaderHeadersReady",async s=>{await this._fullReader.headersReady;const{isStreamingSupported:i,isRangeSupported:n,contentLength:r}=this._fullReader;return(!i||!n)&&(this._lastProgress&&e.onProgress?.(this._lastProgress),this._fullReader.onProgress=a=>{e.onProgress?.({loaded:a.loaded,total:a.total})}),{isStreamingSupported:i,isRangeSupported:n,contentLength:r}}),t.on("GetRangeReader",(s,i)=>{Q(this._networkStream,"GetRangeReader - no `IPDFStream` instance available.");const n=this._networkStream.getRangeReader(s.begin,s.end);if(!n){i.close();return}i.onPull=()=>{n.read().then(function({value:r,done:a}){if(a){i.close();return}Q(r instanceof ArrayBuffer,"GetRangeReader - expected an ArrayBuffer."),i.enqueue(new Uint8Array(r),1,[r])}).catch(r=>{i.error(r)})},i.onCancel=r=>{n.cancel(r),i.ready.catch(a=>{if(!this.destroyed)throw a})}}),t.on("GetDoc",({pdfInfo:s})=>{this._numPages=s.numPages,this._htmlForXfa=s.htmlForXfa,delete s.htmlForXfa,e._capability.resolve(new Gr(s,this))}),t.on("DocException",s=>{e._capability.reject(Lt(s))}),t.on("PasswordRequest",s=>{this.#a=Promise.withResolvers();try{if(!e.onPassword)throw Lt(s);const i=n=>{n instanceof Error?this.#a.reject(n):this.#a.resolve({password:n})};e.onPassword(i,s.code)}catch(i){this.#a.reject(i)}return this.#a.promise}),t.on("DataLoaded",s=>{e.onProgress?.({loaded:s.length,total:s.length}),this.downloadInfoCapability.resolve(s)}),t.on("StartRenderPage",s=>{if(this.destroyed)return;this.#e.get(s.pageIndex)._startRenderPage(s.transparency,s.cacheKey)}),t.on("commonobj",([s,i,n])=>{if(this.destroyed||this.commonObjs.has(s))return null;switch(i){case"Font":if("error"in n){const h=n.error;G(`Error during font loading: ${h}`),this.commonObjs.resolve(s,h);break}const r=new st(n),a=this._params.pdfBug&&globalThis.FontInspector?.enabled?(h,c)=>globalThis.FontInspector.fontAdded(h,c):null,o=new Yn(r,a,n.extra,n.charProcOperatorList);this.fontLoader.bind(o).catch(()=>t.sendWithPromise("FontFallback",{id:s})).finally(()=>{!o.fontExtraProperties&&o.data&&o.clearData(),this.commonObjs.resolve(s,o)});break;case"CopyLocalImage":const{imageRef:l}=n;Q(l,"The imageRef must be defined.");for(const h of this.#e.values())for(const[,c]of h.objs)if(c?.ref===l)return c.dataLen?(this.commonObjs.resolve(s,structuredClone(c)),c.dataLen):null;break;case"FontPath":case"Image":case"Pattern":this.commonObjs.resolve(s,n);break;default:throw new Error(`Got unknown common object type ${i}`)}return null}),t.on("obj",([s,i,n,r])=>{if(this.destroyed)return;const a=this.#e.get(i);if(!a.objs.has(s)){if(a._intentStates.size===0){r?.bitmap?.close();return}switch(n){case"Image":case"Pattern":a.objs.resolve(s,r);break;default:throw new Error(`Got unknown object type ${n}`)}}}),t.on("DocProgress",s=>{this.destroyed||e.onProgress?.({loaded:s.loaded,total:s.total})}),t.on("FetchBinaryData",async s=>{if(this.destroyed)throw new Error("Worker was destroyed.");const i=this[s.type];if(!i)throw new Error(`${s.type} not initialized, see the \`useWorkerFetch\` parameter.`);return i.fetch(s)})}getData(){return this.messageHandler.sendWithPromise("GetData",null)}saveDocument(){this.annotationStorage.size<=0&&G("saveDocument called while `annotationStorage` is empty, please use the getData-method instead.");const{map:t,transfer:e}=this.annotationStorage.serializable;return this.messageHandler.sendWithPromise("SaveDocument",{isPureXfa:!!this._htmlForXfa,numPages:this._numPages,annotationStorage:t,filename:this._fullReader?.filename??null},e).finally(()=>{this.annotationStorage.resetModified()})}getPage(t){if(!Number.isInteger(t)||t<=0||t>this._numPages)return Promise.reject(new Error("Invalid page request."));const e=t-1,s=this.#i.get(e);if(s)return s;const i=this.messageHandler.sendWithPromise("GetPage",{pageIndex:e}).then(n=>{if(this.destroyed)throw new Error("Transport destroyed");n.refStr&&this.#s.set(n.refStr,t);const r=new Vr(e,n,this,this._params.pdfBug);return this.#e.set(e,r),r});return this.#i.set(e,i),i}getPageIndex(t){return Ls(t)?this.messageHandler.sendWithPromise("GetPageIndex",{num:t.num,gen:t.gen}):Promise.reject(new Error("Invalid pageIndex request."))}getAnnotations(t,e){return this.messageHandler.sendWithPromise("GetAnnotations",{pageIndex:t,intent:e})}getFieldObjects(){return this.#n("GetFieldObjects")}hasJSActions(){return this.#n("HasJSActions")}getCalculationOrderIds(){return this.messageHandler.sendWithPromise("GetCalculationOrderIds",null)}getDestinations(){return this.messageHandler.sendWithPromise("GetDestinations",null)}getDestination(t){return typeof t!="string"?Promise.reject(new Error("Invalid destination request.")):this.messageHandler.sendWithPromise("GetDestination",{id:t})}getPageLabels(){return this.messageHandler.sendWithPromise("GetPageLabels",null)}getPageLayout(){return this.messageHandler.sendWithPromise("GetPageLayout",null)}getPageMode(){return this.messageHandler.sendWithPromise("GetPageMode",null)}getViewerPreferences(){return this.messageHandler.sendWithPromise("GetViewerPreferences",null)}getOpenAction(){return this.messageHandler.sendWithPromise("GetOpenAction",null)}getAttachments(){return this.messageHandler.sendWithPromise("GetAttachments",null)}getAnnotationsByType(t,e){return this.messageHandler.sendWithPromise("GetAnnotationsByType",{types:t,pageIndexesToSkip:e})}getDocJSActions(){return this.#n("GetDocJSActions")}getPageJSActions(t){return this.messageHandler.sendWithPromise("GetPageJSActions",{pageIndex:t})}getStructTree(t){return this.messageHandler.sendWithPromise("GetStructTree",{pageIndex:t})}getOutline(){return this.messageHandler.sendWithPromise("GetOutline",null)}getOptionalContentConfig(t){return this.#n("GetOptionalContentConfig").then(e=>new Sr(e,t))}getPermissions(){return this.messageHandler.sendWithPromise("GetPermissions",null)}getMetadata(){const t="GetMetadata",e=this.#t.get(t);if(e)return e;const s=this.messageHandler.sendWithPromise(t,null).then(i=>({info:i[0],metadata:i[1]?new xr(i[1]):null,contentDispositionFilename:this._fullReader?.filename??null,contentLength:this._fullReader?.contentLength??null}));return this.#t.set(t,s),s}getMarkInfo(){return this.messageHandler.sendWithPromise("GetMarkInfo",null)}async startCleanup(t=!1){if(!this.destroyed){await this.messageHandler.sendWithPromise("Cleanup",null);for(const e of this.#e.values())if(!e.cleanup())throw new Error(`startCleanup: Page ${e.pageNumber} is currently rendering.`);this.commonObjs.clear(),t||this.fontLoader.clear(),this.#t.clear(),this.filterFactory.destroy(!0),Tt.cleanup()}}cachedPageNumber(t){if(!Ls(t))return null;const e=t.gen===0?`${t.num}R`:`${t.num}R${t.gen}`;return this.#s.get(e)??null}}class qr{#t=null;onContinue=null;onError=null;constructor(t){this.#t=t}get promise(){return this.#t.capability.promise}cancel(t=0){this.#t.cancel(null,t)}get separateAnnots(){const{separateAnnots:t}=this.#t.operatorList;if(!t)return!1;const{annotationCanvasMap:e}=this.#t;return t.form||t.canvas&&e?.size>0}}class ye{#t=null;static#e=new WeakSet;constructor({callback:t,params:e,objs:s,commonObjs:i,annotationCanvasMap:n,operatorList:r,pageIndex:a,canvasFactory:o,filterFactory:l,useRequestAnimationFrame:h=!1,pdfBug:c=!1,pageColors:u=null,enableHWA:f=!1,operationsFilter:m=null}){this.callback=t,this.params=e,this.objs=s,this.commonObjs=i,this.annotationCanvasMap=n,this.operatorListIdx=null,this.operatorList=r,this._pageIndex=a,this.canvasFactory=o,this.filterFactory=l,this._pdfBug=c,this.pageColors=u,this.running=!1,this.graphicsReadyCallback=null,this.graphicsReady=!1,this._useRequestAnimationFrame=h===!0&&typeof window<"u",this.cancelled=!1,this.capability=Promise.withResolvers(),this.task=new qr(this),this._cancelBound=this.cancel.bind(this),this._continueBound=this._continue.bind(this),this._scheduleNextBound=this._scheduleNext.bind(this),this._nextBound=this._next.bind(this),this._canvas=e.canvas,this._canvasContext=e.canvas?null:e.canvasContext,this._enableHWA=f,this._dependencyTracker=e.dependencyTracker,this._operationsFilter=m}get completed(){return this.capability.promise.catch(function(){})}initializeGraphics({transparency:t=!1,optionalContentConfig:e}){if(this.cancelled)return;if(this._canvas){if(ye.#e.has(this._canvas))throw new Error("Cannot use the same canvas during multiple render() operations. Use different canvas or ensure previous operations were cancelled or completed.");ye.#e.add(this._canvas)}this._pdfBug&&globalThis.StepperManager?.enabled&&(this.stepper=globalThis.StepperManager.create(this._pageIndex),this.stepper.init(this.operatorList),this.stepper.nextBreakPoint=this.stepper.getNextBreakPoint());const{viewport:s,transform:i,background:n,dependencyTracker:r}=this.params,a=this._canvasContext||this._canvas.getContext("2d",{alpha:!1,willReadFrequently:!this._enableHWA});this.gfx=new we(a,this.commonObjs,this.objs,this.canvasFactory,this.filterFactory,{optionalContentConfig:e},this.annotationCanvasMap,this.pageColors,r),this.gfx.beginDrawing({transform:i,viewport:s,transparency:t,background:n}),this.operatorListIdx=0,this.graphicsReady=!0,this.graphicsReadyCallback?.()}cancel(t=null,e=0){this.running=!1,this.cancelled=!0,this.gfx?.endDrawing(),this.#t&&(window.cancelAnimationFrame(this.#t),this.#t=null),ye.#e.delete(this._canvas),t||=new Hs(`Rendering cancelled, page ${this._pageIndex+1}`,e),this.callback(t),this.task.onError?.(t)}operatorListChanged(){if(!this.graphicsReady){this.graphicsReadyCallback||=this._continueBound;return}this.gfx.dependencyTracker?.growOperationsCount(this.operatorList.fnArray.length),this.stepper?.updateOperatorList(this.operatorList),!this.running&&this._continue()}_continue(){this.running=!0,!this.cancelled&&(this.task.onContinue?this.task.onContinue(this._scheduleNextBound):this._scheduleNext())}_scheduleNext(){this._useRequestAnimationFrame?this.#t=window.requestAnimationFrame(()=>{this.#t=null,this._nextBound().catch(this._cancelBound)}):Promise.resolve().then(this._nextBound).catch(this._cancelBound)}async _next(){this.cancelled||(this.operatorListIdx=this.gfx.executeOperatorList(this.operatorList,this.operatorListIdx,this._continueBound,this.stepper,this._operationsFilter),this.operatorListIdx===this.operatorList.argsArray.length&&(this.running=!1,this.operatorList.lastChunk&&(this.gfx.endDrawing(),ye.#e.delete(this._canvas),this.callback())))}}const Xr="5.4.296",Yr="f56dc8601";class Bt{#t=null;#e=null;#i;#s=null;#a=!1;#n=!1;#r=null;#o;#h=null;#l=null;static#u=null;static get _keyboardManager(){return W(this,"_keyboardManager",new ze([[["Escape","mac+Escape"],Bt.prototype._hideDropdownFromKeyboard],[[" ","mac+ "],Bt.prototype._colorSelectFromKeyboard],[["ArrowDown","ArrowRight","mac+ArrowDown","mac+ArrowRight"],Bt.prototype._moveToNext],[["ArrowUp","ArrowLeft","mac+ArrowUp","mac+ArrowLeft"],Bt.prototype._moveToPrevious],[["Home","mac+Home"],Bt.prototype._moveToBeginning],[["End","mac+End"],Bt.prototype._moveToEnd]]))}constructor({editor:t=null,uiManager:e=null}){t?(this.#n=!1,this.#r=t):this.#n=!0,this.#l=t?._uiManager||e,this.#o=this.#l._eventBus,this.#i=t?.color?.toUpperCase()||this.#l?.highlightColors.values().next().value||"#FFFF98",Bt.#u||=Object.freeze({blue:"pdfjs-editor-colorpicker-blue",green:"pdfjs-editor-colorpicker-green",pink:"pdfjs-editor-colorpicker-pink",red:"pdfjs-editor-colorpicker-red",yellow:"pdfjs-editor-colorpicker-yellow"})}renderButton(){const t=this.#t=document.createElement("button");t.className="colorPicker",t.tabIndex="0",t.setAttribute("data-l10n-id","pdfjs-editor-colorpicker-button"),t.ariaHasPopup="true",this.#r&&(t.ariaControls=`${this.#r.id}_colorpicker_dropdown`);const e=this.#l._signal;t.addEventListener("click",this.#p.bind(this),{signal:e}),t.addEventListener("keydown",this.#m.bind(this),{signal:e});const s=this.#e=document.createElement("span");return s.className="swatch",s.ariaHidden="true",s.style.backgroundColor=this.#i,t.append(s),t}renderMainDropdown(){const t=this.#s=this.#d();return t.ariaOrientation="horizontal",t.ariaLabelledBy="highlightColorPickerLabel",t}#d(){const t=document.createElement("div"),e=this.#l._signal;t.addEventListener("contextmenu",jt,{signal:e}),t.className="dropdown",t.role="listbox",t.ariaMultiSelectable="false",t.ariaOrientation="vertical",t.setAttribute("data-l10n-id","pdfjs-editor-colorpicker-dropdown"),this.#r&&(t.id=`${this.#r.id}_colorpicker_dropdown`);for(const[s,i]of this.#l.highlightColors){const n=document.createElement("button");n.tabIndex="0",n.role="option",n.setAttribute("data-color",i),n.title=s,n.setAttribute("data-l10n-id",Bt.#u[s]);const r=document.createElement("span");n.append(r),r.className="swatch",r.style.backgroundColor=i,n.ariaSelected=i===this.#i,n.addEventListener("click",this.#f.bind(this,i),{signal:e}),t.append(n)}return t.addEventListener("keydown",this.#m.bind(this),{signal:e}),t}#f(t,e){e.stopPropagation(),this.#o.dispatch("switchannotationeditorparams",{source:this,type:K.HIGHLIGHT_COLOR,value:t}),this.updateColor(t)}_colorSelectFromKeyboard(t){if(t.target===this.#t){this.#p(t);return}const e=t.target.getAttribute("data-color");e&&this.#f(e,t)}_moveToNext(t){if(!this.#g){this.#p(t);return}if(t.target===this.#t){this.#s.firstChild?.focus();return}t.target.nextSibling?.focus()}_moveToPrevious(t){if(t.target===this.#s?.firstChild||t.target===this.#t){this.#g&&this._hideDropdownFromKeyboard();return}this.#g||this.#p(t),t.target.previousSibling?.focus()}_moveToBeginning(t){if(!this.#g){this.#p(t);return}this.#s.firstChild?.focus()}_moveToEnd(t){if(!this.#g){this.#p(t);return}this.#s.lastChild?.focus()}#m(t){Bt._keyboardManager.exec(this,t)}#p(t){if(this.#g){this.hideDropdown();return}if(this.#a=t.detail===0,this.#h||(this.#h=new AbortController,window.addEventListener("pointerdown",this.#c.bind(this),{signal:this.#l.combinedSignal(this.#h)})),this.#t.ariaExpanded="true",this.#s){this.#s.classList.remove("hidden");return}const e=this.#s=this.#d();this.#t.append(e)}#c(t){this.#s?.contains(t.target)||this.hideDropdown()}hideDropdown(){this.#s?.classList.add("hidden"),this.#t.ariaExpanded="false",this.#h?.abort(),this.#h=null}get#g(){return this.#s&&!this.#s.classList.contains("hidden")}_hideDropdownFromKeyboard(){if(!this.#n){if(!this.#g){this.#r?.unselect();return}this.hideDropdown(),this.#t.focus({preventScroll:!0,focusVisible:this.#a})}}updateColor(t){if(this.#e&&(this.#e.style.backgroundColor=t),!this.#s)return;const e=this.#l.highlightColors.values();for(const s of this.#s.children)s.ariaSelected=e.next().value===t.toUpperCase()}destroy(){this.#t?.remove(),this.#t=null,this.#e=null,this.#s?.remove(),this.#s=null}}class Oe{#t=null;#e=null;#i=null;static#s=null;constructor(t){this.#e=t,this.#i=t._uiManager,Oe.#s||=Object.freeze({freetext:"pdfjs-editor-color-picker-free-text-input",ink:"pdfjs-editor-color-picker-ink-input"})}renderButton(){if(this.#t)return this.#t;const{editorType:t,colorType:e,colorValue:s}=this.#e,i=this.#t=document.createElement("input");return i.type="color",i.value=s||"#000000",i.className="basicColorPicker",i.tabIndex=0,i.setAttribute("data-l10n-id",Oe.#s[t]),i.addEventListener("input",()=>{this.#i.updateParams(e,i.value)},{signal:this.#i._signal}),i}update(t){this.#t&&(this.#t.value=t)}destroy(){this.#t?.remove(),this.#t=null}hideDropdown(){}}function Ri(d){return Math.floor(Math.max(0,Math.min(1,d))*255).toString(16).padStart(2,"0")}function Te(d){return Math.max(0,Math.min(255,255*d))}class Li{static CMYK_G([t,e,s,i]){return["G",1-Math.min(1,.3*t+.59*s+.11*e+i)]}static G_CMYK([t]){return["CMYK",0,0,0,1-t]}static G_RGB([t]){return["RGB",t,t,t]}static G_rgb([t]){return t=Te(t),[t,t,t]}static G_HTML([t]){const e=Ri(t);return`#${e}${e}${e}`}static RGB_G([t,e,s]){return["G",.3*t+.59*e+.11*s]}static RGB_rgb(t){return t.map(Te)}static RGB_HTML(t){return`#${t.map(Ri).join("")}`}static T_HTML(){return"#00000000"}static T_rgb(){return[null]}static CMYK_RGB([t,e,s,i]){return["RGB",1-Math.min(1,t+i),1-Math.min(1,s+i),1-Math.min(1,e+i)]}static CMYK_rgb([t,e,s,i]){return[Te(1-Math.min(1,t+i)),Te(1-Math.min(1,s+i)),Te(1-Math.min(1,e+i))]}static CMYK_HTML(t){const e=this.CMYK_RGB(t).slice(1);return this.RGB_HTML(e)}static RGB_CMYK([t,e,s]){const i=1-t,n=1-e,r=1-s,a=Math.min(i,n,r);return["CMYK",i,n,r,a]}}class Kr{create(t,e,s=!1){if(t<=0||e<=0)throw new Error("Invalid SVG dimensions");const i=this._createSVG("svg:svg");return i.setAttribute("version","1.1"),s||(i.setAttribute("width",`${t}px`),i.setAttribute("height",`${e}px`)),i.setAttribute("preserveAspectRatio","none"),i.setAttribute("viewBox",`0 0 ${t} ${e}`),i}createElement(t){if(typeof t!="string")throw new Error("Invalid SVG element type");return this._createSVG(t)}_createSVG(t){nt("Abstract method `_createSVG` called.")}}class as extends Kr{_createSVG(t){return document.createElementNS(Yt,t)}}const Qr=9,he=new WeakSet,Jr=new Date().getTimezoneOffset()*60*1e3;class Di{static create(t){switch(t.data.annotationType){case gt.LINK:return new Ys(t);case gt.TEXT:return new ta(t);case gt.WIDGET:switch(t.data.fieldType){case"Tx":return new ea(t);case"Btn":return t.data.radioButton?new ln(t):t.data.checkBox?new ia(t):new na(t);case"Ch":return new ra(t);case"Sig":return new sa(t)}return new de(t);case gt.POPUP:return new Ns(t);case gt.FREETEXT:return new hn(t);case gt.LINE:return new oa(t);case gt.SQUARE:return new la(t);case gt.CIRCLE:return new ha(t);case gt.POLYLINE:return new cn(t);case gt.CARET:return new da(t);case gt.INK:return new Ks(t);case gt.POLYGON:return new ca(t);case gt.HIGHLIGHT:return new dn(t);case gt.UNDERLINE:return new ua(t);case gt.SQUIGGLY:return new fa(t);case gt.STRIKEOUT:return new pa(t);case gt.STAMP:return new un(t);case gt.FILEATTACHMENT:return new ga(t);default:return new lt(t)}}}class lt{#t=null;#e=!1;#i=null;constructor(t,{isRenderable:e=!1,ignoreBorder:s=!1,createQuadrilaterals:i=!1}={}){this.isRenderable=e,this.data=t.data,this.layer=t.layer,this.linkService=t.linkService,this.downloadManager=t.downloadManager,this.imageResourcesPath=t.imageResourcesPath,this.renderForms=t.renderForms,this.svgFactory=t.svgFactory,this.annotationStorage=t.annotationStorage,this.enableComment=t.enableComment,this.enableScripting=t.enableScripting,this.hasJSActions=t.hasJSActions,this._fieldObjects=t.fieldObjects,this.parent=t.parent,e&&(this.container=this._createContainer(s)),i&&this._createQuadrilaterals()}static _hasPopupData({contentsObj:t,richText:e}){return!!(t?.str||e?.str)}get _isEditable(){return this.data.isEditable}get hasPopupData(){return lt._hasPopupData(this.data)||this.enableComment&&!!this.commentText}get commentData(){const{data:t}=this,e=this.annotationStorage?.getEditor(t.id);return e?e.getData():t}get hasCommentButton(){return this.enableComment&&this.hasPopupElement}get commentButtonPosition(){const t=this.annotationStorage?.getEditor(this.data.id);if(t)return t.commentButtonPositionInPage;const{quadPoints:e,inkLists:s,rect:i}=this.data;let n=-1/0,r=-1/0;if(e?.length>=8){for(let a=0;a<e.length;a+=8)e[a+1]>r?(r=e[a+1],n=e[a+2]):e[a+1]===r&&(n=Math.max(n,e[a+2]));return[n,r]}if(s?.length>=1){for(const a of s)for(let o=0,l=a.length;o<l;o+=2)a[o+1]>r?(r=a[o+1],n=a[o]):a[o+1]===r&&(n=Math.max(n,a[o]));if(n!==1/0)return[n,r]}return i?[i[2],i[3]]:null}_normalizePoint(t){const{page:{view:e},viewport:{rawDims:{pageWidth:s,pageHeight:i,pageX:n,pageY:r}}}=this.parent;return t[1]=e[3]-t[1]+e[1],t[0]=100*(t[0]-n)/s,t[1]=100*(t[1]-r)/i,t}get commentText(){const{data:t}=this;return this.annotationStorage.getRawValue(`${De}${t.id}`)?.popup?.contents||t.contentsObj?.str||""}set commentText(t){const{data:e}=this,s={deleted:!t,contents:t||""};this.annotationStorage.updateEditor(e.id,{popup:s})||this.annotationStorage.setValue(`${De}${e.id}`,{id:e.id,annotationType:e.annotationType,pageIndex:this.parent.page._pageIndex,popup:s,popupRef:e.popupRef,modificationDate:new Date}),t||this.removePopup()}removePopup(){(this.#i?.popup||this.popup)?.remove(),this.#i=this.popup=null}updateEdited(t){if(!this.container)return;t.rect&&(this.#t||={rect:this.data.rect.slice(0)});const{rect:e,popup:s}=t;e&&this.#s(e);let i=this.#i?.popup||this.popup;!i&&s?.text&&(this._createPopup(s),i=this.#i.popup),i&&(i.updateEdited(t),s?.deleted&&(i.remove(),this.#i=null,this.popup=null))}resetEdited(){this.#t&&(this.#s(this.#t.rect),this.#i?.popup.resetEdited(),this.#t=null)}#s(t){const{container:{style:e},data:{rect:s,rotation:i},parent:{viewport:{rawDims:{pageWidth:n,pageHeight:r,pageX:a,pageY:o}}}}=this;s?.splice(0,4,...t),e.left=`${100*(t[0]-a)/n}%`,e.top=`${100*(r-t[3]+o)/r}%`,i===0?(e.width=`${100*(t[2]-t[0])/n}%`,e.height=`${100*(t[3]-t[1])/r}%`):this.setRotation(i)}_createContainer(t){const{data:e,parent:{page:s,viewport:i}}=this,n=document.createElement("section");n.setAttribute("data-annotation-id",e.id),!(this instanceof de)&&!(this instanceof Ys)&&(n.tabIndex=0);const{style:r}=n;if(r.zIndex=this.parent.zIndex,this.parent.zIndex+=2,e.alternativeText&&(n.title=e.alternativeText),e.noRotate&&n.classList.add("norotate"),!e.rect||this instanceof Ns){const{rotation:p}=e;return!e.hasOwnCanvas&&p!==0&&this.setRotation(p,n),n}const{width:a,height:o}=this;if(!t&&e.borderStyle.width>0){r.borderWidth=`${e.borderStyle.width}px`;const p=e.borderStyle.horizontalCornerRadius,b=e.borderStyle.verticalCornerRadius;if(p>0||b>0){const v=`calc(${p}px * var(--total-scale-factor)) / calc(${b}px * var(--total-scale-factor))`;r.borderRadius=v}else if(this instanceof ln){const v=`calc(${a}px * var(--total-scale-factor)) / calc(${o}px * var(--total-scale-factor))`;r.borderRadius=v}switch(e.borderStyle.style){case pe.SOLID:r.borderStyle="solid";break;case pe.DASHED:r.borderStyle="dashed";break;case pe.BEVELED:G("Unimplemented border style: beveled");break;case pe.INSET:G("Unimplemented border style: inset");break;case pe.UNDERLINE:r.borderBottomStyle="solid";break}const g=e.borderColor||null;g?(this.#e=!0,r.borderColor=B.makeHexColor(g[0]|0,g[1]|0,g[2]|0)):r.borderWidth=0}const l=B.normalizeRect([e.rect[0],s.view[3]-e.rect[1]+s.view[1],e.rect[2],s.view[3]-e.rect[3]+s.view[1]]),{pageWidth:h,pageHeight:c,pageX:u,pageY:f}=i.rawDims;r.left=`${100*(l[0]-u)/h}%`,r.top=`${100*(l[1]-f)/c}%`;const{rotation:m}=e;return e.hasOwnCanvas||m===0?(r.width=`${100*a/h}%`,r.height=`${100*o/c}%`):this.setRotation(m,n),n}setRotation(t,e=this.container){if(!this.data.rect)return;const{pageWidth:s,pageHeight:i}=this.parent.viewport.rawDims;let{width:n,height:r}=this;t%180!==0&&([n,r]=[r,n]),e.style.width=`${100*n/s}%`,e.style.height=`${100*r/i}%`,e.setAttribute("data-main-rotation",(360-t)%360)}get _commonActions(){const t=(e,s,i)=>{const n=i.detail[e],r=n[0],a=n.slice(1);i.target.style[s]=Li[`${r}_HTML`](a),this.annotationStorage.setValue(this.data.id,{[s]:Li[`${r}_rgb`](a)})};return W(this,"_commonActions",{display:e=>{const{display:s}=e.detail,i=s%2===1;this.container.style.visibility=i?"hidden":"visible",this.annotationStorage.setValue(this.data.id,{noView:i,noPrint:s===1||s===2})},print:e=>{this.annotationStorage.setValue(this.data.id,{noPrint:!e.detail.print})},hidden:e=>{const{hidden:s}=e.detail;this.container.style.visibility=s?"hidden":"visible",this.annotationStorage.setValue(this.data.id,{noPrint:s,noView:s})},focus:e=>{setTimeout(()=>e.target.focus({preventScroll:!1}),0)},userName:e=>{e.target.title=e.detail.userName},readonly:e=>{e.target.disabled=e.detail.readonly},required:e=>{this._setRequired(e.target,e.detail.required)},bgColor:e=>{t("bgColor","backgroundColor",e)},fillColor:e=>{t("fillColor","backgroundColor",e)},fgColor:e=>{t("fgColor","color",e)},textColor:e=>{t("textColor","color",e)},borderColor:e=>{t("borderColor","borderColor",e)},strokeColor:e=>{t("strokeColor","borderColor",e)},rotation:e=>{const s=e.detail.rotation;this.setRotation(s),this.annotationStorage.setValue(this.data.id,{rotation:s})}})}_dispatchEventFromSandbox(t,e){const s=this._commonActions;for(const i of Object.keys(e.detail))(t[i]||s[i])?.(e)}_setDefaultPropertiesFromJS(t){if(!this.enableScripting)return;const e=this.annotationStorage.getRawValue(this.data.id);if(!e)return;const s=this._commonActions;for(const[i,n]of Object.entries(e)){const r=s[i];if(r){const a={detail:{[i]:n},target:t};r(a),delete e[i]}}}_createQuadrilaterals(){if(!this.container)return;const{quadPoints:t}=this.data;if(!t)return;const[e,s,i,n]=this.data.rect.map(p=>Math.fround(p));if(t.length===8){const[p,b,g,v]=t.subarray(2,6);if(i===p&&n===b&&e===g&&s===v)return}const{style:r}=this.container;let a;if(this.#e){const{borderColor:p,borderWidth:b}=r;r.borderWidth=0,a=["url('data:image/svg+xml;utf8,",'<svg xmlns="http://www.w3.org/2000/svg"',' preserveAspectRatio="none" viewBox="0 0 1 1">',`<g fill="transparent" stroke="${p}" stroke-width="${b}">`],this.container.classList.add("hasBorder")}const o=i-e,l=n-s,{svgFactory:h}=this,c=h.createElement("svg");c.classList.add("quadrilateralsContainer"),c.setAttribute("width",0),c.setAttribute("height",0),c.role="none";const u=h.createElement("defs");c.append(u);const f=h.createElement("clipPath"),m=`clippath_${this.data.id}`;f.setAttribute("id",m),f.setAttribute("clipPathUnits","objectBoundingBox"),u.append(f);for(let p=2,b=t.length;p<b;p+=8){const g=t[p],v=t[p+1],y=t[p+2],S=t[p+3],A=h.createElement("rect"),w=(y-e)/o,_=(n-v)/l,x=(g-y)/o,E=(v-S)/l;A.setAttribute("x",w),A.setAttribute("y",_),A.setAttribute("width",x),A.setAttribute("height",E),f.append(A),a?.push(`<rect vector-effect="non-scaling-stroke" x="${w}" y="${_}" width="${x}" height="${E}"/>`)}this.#e&&(a.push("</g></svg>')"),r.backgroundImage=a.join("")),this.container.append(c),this.container.style.clipPath=`url(#${m})`}_createPopup(t=null){const{data:e}=this;let s,i;t?(s={str:t.text},i=t.date):(s=e.contentsObj,i=e.modificationDate);const n=this.#i=new Ns({data:{color:e.color,titleObj:e.titleObj,modificationDate:i,contentsObj:s,richText:e.richText,parentRect:e.rect,borderStyle:0,id:`popup_${e.id}`,rotation:e.rotation,noRotate:!0},linkService:this.linkService,parent:this.parent,elements:[this]});this.parent._commentManager||this.parent.div.append(n.render())}get hasPopupElement(){return!!(this.#i||this.popup||this.data.popupRef)}get extraPopupElement(){return this.#i}render(){nt("Abstract method `AnnotationElement.render` called")}_getElementsByName(t,e=null){const s=[];if(this._fieldObjects){const i=this._fieldObjects[t];if(i)for(const{page:n,id:r,exportValues:a}of i){if(n===-1||r===e)continue;const o=typeof a=="string"?a:null,l=document.querySelector(`[data-element-id="${r}"]`);if(l&&!he.has(l)){G(`_getElementsByName - element not allowed: ${r}`);continue}s.push({id:r,exportValue:o,domElement:l})}return s}for(const i of document.getElementsByName(t)){const{exportValue:n}=i,r=i.getAttribute("data-element-id");r!==e&&he.has(i)&&s.push({id:r,exportValue:n,domElement:i})}return s}show(){this.container&&(this.container.hidden=!1),this.popup?.maybeShow()}hide(){this.container&&(this.container.hidden=!0),this.popup?.forceHide()}getElementsToTriggerPopup(){return this.container}addHighlightArea(){const t=this.getElementsToTriggerPopup();if(Array.isArray(t))for(const e of t)e.classList.add("highlightArea");else t.classList.add("highlightArea")}_editOnDoubleClick(){if(!this._isEditable)return;const{annotationEditorType:t,data:{id:e}}=this;this.container.addEventListener("dblclick",()=>{this.linkService.eventBus?.dispatch("switchannotationeditormode",{source:this,mode:t,editId:e,mustEnterInEditMode:!0})})}get width(){return this.data.rect[2]-this.data.rect[0]}get height(){return this.data.rect[3]-this.data.rect[1]}}class Zr extends lt{constructor(t){super(t,{isRenderable:!0,ignoreBorder:!0}),this.editor=t.editor}render(){return this.container.className="editorAnnotation",this.container}createOrUpdatePopup(){const{editor:t}=this;t.hasComment&&(this._createPopup(t.comment),this.extraPopupElement.popup.renderCommentButton())}get hasCommentButton(){return this.enableComment&&this.editor.hasComment}get commentButtonPosition(){return this.editor.commentButtonPositionInPage}get commentText(){return this.editor.comment.text}set commentText(t){this.editor.comment=t,t||this.removePopup()}get commentData(){return this.editor.getData()}remove(){this.container.remove(),this.container=null,this.removePopup()}}class Ys extends lt{constructor(t,e=null){super(t,{isRenderable:!0,ignoreBorder:!!e?.ignoreBorder,createQuadrilaterals:!0}),this.isTooltipOnly=t.data.isTooltipOnly}render(){const{data:t,linkService:e}=this,s=document.createElement("a");s.setAttribute("data-element-id",t.id);let i=!1;return t.url?(e.addLinkAttributes(s,t.url,t.newWindow),i=!0):t.action?(this._bindNamedAction(s,t.action,t.overlaidText),i=!0):t.attachment?(this.#e(s,t.attachment,t.overlaidText,t.attachmentDest),i=!0):t.setOCGState?(this.#i(s,t.setOCGState,t.overlaidText),i=!0):t.dest?(this._bindLink(s,t.dest,t.overlaidText),i=!0):(t.actions&&(t.actions.Action||t.actions["Mouse Up"]||t.actions["Mouse Down"])&&this.enableScripting&&this.hasJSActions&&(this._bindJSAction(s,t),i=!0),t.resetForm?(this._bindResetFormAction(s,t.resetForm),i=!0):this.isTooltipOnly&&!i&&(this._bindLink(s,""),i=!0)),this.container.classList.add("linkAnnotation"),i&&this.container.append(s),this.container}#t(){this.container.setAttribute("data-internal-link","")}_bindLink(t,e,s=""){t.href=this.linkService.getDestinationHash(e),t.onclick=()=>(e&&this.linkService.goToDestination(e),!1),(e||e==="")&&this.#t(),s&&(t.title=s)}_bindNamedAction(t,e,s=""){t.href=this.linkService.getAnchorUrl(""),t.onclick=()=>(this.linkService.executeNamedAction(e),!1),s&&(t.title=s),this.#t()}#e(t,e,s="",i=null){t.href=this.linkService.getAnchorUrl(""),e.description?t.title=e.description:s&&(t.title=s),t.onclick=()=>(this.downloadManager?.openOrDownloadData(e.content,e.filename,i),!1),this.#t()}#i(t,e,s=""){t.href=this.linkService.getAnchorUrl(""),t.onclick=()=>(this.linkService.executeSetOCGState(e),!1),s&&(t.title=s),this.#t()}_bindJSAction(t,e){t.href=this.linkService.getAnchorUrl("");const s=new Map([["Action","onclick"],["Mouse Up","onmouseup"],["Mouse Down","onmousedown"]]);for(const i of Object.keys(e.actions)){const n=s.get(i);n&&(t[n]=()=>(this.linkService.eventBus?.dispatch("dispatcheventinsandbox",{source:this,detail:{id:e.id,name:i}}),!1))}e.overlaidText&&(t.title=e.overlaidText),t.onclick||(t.onclick=()=>!1),this.#t()}_bindResetFormAction(t,e){const s=t.onclick;if(s||(t.href=this.linkService.getAnchorUrl("")),this.#t(),!this._fieldObjects){G('_bindResetFormAction - "resetForm" action not supported, ensure that the `fieldObjects` parameter is provided.'),s||(t.onclick=()=>!1);return}t.onclick=()=>{s?.();const{fields:i,refs:n,include:r}=e,a=[];if(i.length!==0||n.length!==0){const h=new Set(n);for(const c of i){const u=this._fieldObjects[c]||[];for(const{id:f}of u)h.add(f)}for(const c of Object.values(this._fieldObjects))for(const u of c)h.has(u.id)===r&&a.push(u)}else for(const h of Object.values(this._fieldObjects))a.push(...h);const o=this.annotationStorage,l=[];for(const h of a){const{id:c}=h;switch(l.push(c),h.type){case"text":{const f=h.defaultValue||"";o.setValue(c,{value:f});break}case"checkbox":case"radiobutton":{const f=h.defaultValue===h.exportValues;o.setValue(c,{value:f});break}case"combobox":case"listbox":{const f=h.defaultValue||"";o.setValue(c,{value:f});break}default:continue}const u=document.querySelector(`[data-element-id="${c}"]`);if(u){if(!he.has(u)){G(`_bindResetFormAction - element not allowed: ${c}`);continue}}else continue;u.dispatchEvent(new Event("resetform"))}return this.enableScripting&&this.linkService.eventBus?.dispatch("dispatcheventinsandbox",{source:this,detail:{id:"app",ids:l,name:"ResetForm"}}),!1}}}class ta extends lt{constructor(t){super(t,{isRenderable:!0})}render(){this.container.classList.add("textAnnotation");const t=document.createElement("img");return t.src=this.imageResourcesPath+"annotation-"+this.data.name.toLowerCase()+".svg",t.setAttribute("data-l10n-id","pdfjs-text-annotation-type"),t.setAttribute("data-l10n-args",JSON.stringify({type:this.data.name})),!this.data.popupRef&&this.hasPopupData&&this._createPopup(),this.container.append(t),this.container}}class de extends lt{render(){return this.container}showElementAndHideCanvas(t){this.data.hasOwnCanvas&&(t.previousSibling?.nodeName==="CANVAS"&&(t.previousSibling.hidden=!0),t.hidden=!1)}_getKeyModifier(t){return _t.platform.isMac?t.metaKey:t.ctrlKey}_setEventListener(t,e,s,i,n){s.includes("mouse")?t.addEventListener(s,r=>{this.linkService.eventBus?.dispatch("dispatcheventinsandbox",{source:this,detail:{id:this.data.id,name:i,value:n(r),shift:r.shiftKey,modifier:this._getKeyModifier(r)}})}):t.addEventListener(s,r=>{if(s==="blur"){if(!e.focused||!r.relatedTarget)return;e.focused=!1}else if(s==="focus"){if(e.focused)return;e.focused=!0}n&&this.linkService.eventBus?.dispatch("dispatcheventinsandbox",{source:this,detail:{id:this.data.id,name:i,value:n(r)}})})}_setEventListeners(t,e,s,i){for(const[n,r]of s)(r==="Action"||this.data.actions?.[r])&&((r==="Focus"||r==="Blur")&&(e||={focused:!1}),this._setEventListener(t,e,n,r,i),r==="Focus"&&!this.data.actions?.Blur?this._setEventListener(t,e,"blur","Blur",null):r==="Blur"&&!this.data.actions?.Focus&&this._setEventListener(t,e,"focus","Focus",null))}_setBackgroundColor(t){const e=this.data.backgroundColor||null;t.style.backgroundColor=e===null?"transparent":B.makeHexColor(e[0],e[1],e[2])}_setTextStyle(t){const e=["left","center","right"],{fontColor:s}=this.data.defaultAppearanceData,i=this.data.defaultAppearanceData.fontSize||Qr,n=t.style;let r;const a=2,o=l=>Math.round(10*l)/10;if(this.data.multiLine){const l=Math.abs(this.data.rect[3]-this.data.rect[1]-a),h=Math.round(l/(bs*i))||1,c=l/h;r=Math.min(i,o(c/bs))}else{const l=Math.abs(this.data.rect[3]-this.data.rect[1]-a);r=Math.min(i,o(l/bs))}n.fontSize=`calc(${r}px * var(--total-scale-factor))`,n.color=B.makeHexColor(s[0],s[1],s[2]),this.data.textAlignment!==null&&(n.textAlign=e[this.data.textAlignment])}_setRequired(t,e){e?t.setAttribute("required",!0):t.removeAttribute("required"),t.setAttribute("aria-required",e)}}class ea extends de{constructor(t){const e=t.renderForms||t.data.hasOwnCanvas||!t.data.hasAppearance&&!!t.data.fieldValue;super(t,{isRenderable:e})}setPropertyOnSiblings(t,e,s,i){const n=this.annotationStorage;for(const r of this._getElementsByName(t.name,t.id))r.domElement&&(r.domElement[e]=s),n.setValue(r.id,{[i]:s})}render(){const t=this.annotationStorage,e=this.data.id;this.container.classList.add("textWidgetAnnotation");let s=null;if(this.renderForms){const i=t.getValue(e,{value:this.data.fieldValue});let n=i.value||"";const r=t.getValue(e,{charLimit:this.data.maxLen}).charLimit;r&&n.length>r&&(n=n.slice(0,r));let a=i.formattedValue||this.data.textContent?.join(`
`)||null;a&&this.data.comb&&(a=a.replaceAll(/\s+/g,""));const o={userValue:n,formattedValue:a,lastCommittedValue:null,commitKey:1,focused:!1};this.data.multiLine?(s=document.createElement("textarea"),s.textContent=a??n,this.data.doNotScroll&&(s.style.overflowY="hidden")):(s=document.createElement("input"),s.type=this.data.password?"password":"text",s.setAttribute("value",a??n),this.data.doNotScroll&&(s.style.overflowX="hidden")),this.data.hasOwnCanvas&&(s.hidden=!0),he.add(s),s.setAttribute("data-element-id",e),s.disabled=this.data.readOnly,s.name=this.data.fieldName,s.tabIndex=0;const{datetimeFormat:l,datetimeType:h,timeStep:c}=this.data,u=!!h&&this.enableScripting;l&&(s.title=l),this._setRequired(s,this.data.required),r&&(s.maxLength=r),s.addEventListener("input",m=>{t.setValue(e,{value:m.target.value}),this.setPropertyOnSiblings(s,"value",m.target.value,"value"),o.formattedValue=null}),s.addEventListener("resetform",m=>{const p=this.data.defaultFieldValue??"";s.value=o.userValue=p,o.formattedValue=null});let f=m=>{const{formattedValue:p}=o;p!=null&&(m.target.value=p),m.target.scrollLeft=0};if(this.enableScripting&&this.hasJSActions){s.addEventListener("focus",p=>{if(o.focused)return;const{target:b}=p;if(u&&(b.type=h,c&&(b.step=c)),o.userValue){const g=o.userValue;if(u)if(h==="time"){const v=new Date(g),y=[v.getHours(),v.getMinutes(),v.getSeconds()];b.value=y.map(S=>S.toString().padStart(2,"0")).join(":")}else b.value=new Date(g-Jr).toISOString().split(h==="date"?"T":".",1)[0];else b.value=g}o.lastCommittedValue=b.value,o.commitKey=1,this.data.actions?.Focus||(o.focused=!0)}),s.addEventListener("updatefromsandbox",p=>{this.showElementAndHideCanvas(p.target);const b={value(g){o.userValue=g.detail.value??"",u||t.setValue(e,{value:o.userValue.toString()}),g.target.value=o.userValue},formattedValue(g){const{formattedValue:v}=g.detail;o.formattedValue=v,v!=null&&g.target!==document.activeElement&&(g.target.value=v);const y={formattedValue:v};u&&(y.value=v),t.setValue(e,y)},selRange(g){g.target.setSelectionRange(...g.detail.selRange)},charLimit:g=>{const{charLimit:v}=g.detail,{target:y}=g;if(v===0){y.removeAttribute("maxLength");return}y.setAttribute("maxLength",v);let S=o.userValue;!S||S.length<=v||(S=S.slice(0,v),y.value=o.userValue=S,t.setValue(e,{value:S}),this.linkService.eventBus?.dispatch("dispatcheventinsandbox",{source:this,detail:{id:e,name:"Keystroke",value:S,willCommit:!0,commitKey:1,selStart:y.selectionStart,selEnd:y.selectionEnd}}))}};this._dispatchEventFromSandbox(b,p)}),s.addEventListener("keydown",p=>{o.commitKey=1;let b=-1;if(p.key==="Escape"?b=0:p.key==="Enter"&&!this.data.multiLine?b=2:p.key==="Tab"&&(o.commitKey=3),b===-1)return;const{value:g}=p.target;o.lastCommittedValue!==g&&(o.lastCommittedValue=g,o.userValue=g,this.linkService.eventBus?.dispatch("dispatcheventinsandbox",{source:this,detail:{id:e,name:"Keystroke",value:g,willCommit:!0,commitKey:b,selStart:p.target.selectionStart,selEnd:p.target.selectionEnd}}))});const m=f;f=null,s.addEventListener("blur",p=>{if(!o.focused||!p.relatedTarget)return;this.data.actions?.Blur||(o.focused=!1);const{target:b}=p;let{value:g}=b;if(u){if(g&&h==="time"){const v=g.split(":").map(y=>parseInt(y,10));g=new Date(2e3,0,1,v[0],v[1],v[2]||0).valueOf(),b.step=""}else g.includes("T")||(g=`${g}T00:00`),g=new Date(g).valueOf();b.type="text"}o.userValue=g,o.lastCommittedValue!==g&&this.linkService.eventBus?.dispatch("dispatcheventinsandbox",{source:this,detail:{id:e,name:"Keystroke",value:g,willCommit:!0,commitKey:o.commitKey,selStart:p.target.selectionStart,selEnd:p.target.selectionEnd}}),m(p)}),this.data.actions?.Keystroke&&s.addEventListener("beforeinput",p=>{o.lastCommittedValue=null;const{data:b,target:g}=p,{value:v,selectionStart:y,selectionEnd:S}=g;let A=y,w=S;switch(p.inputType){case"deleteWordBackward":{const _=v.substring(0,y).match(/\w*[^\w]*$/);_&&(A-=_[0].length);break}case"deleteWordForward":{const _=v.substring(y).match(/^[^\w]*\w*/);_&&(w+=_[0].length);break}case"deleteContentBackward":y===S&&(A-=1);break;case"deleteContentForward":y===S&&(w+=1);break}p.preventDefault(),this.linkService.eventBus?.dispatch("dispatcheventinsandbox",{source:this,detail:{id:e,name:"Keystroke",value:v,change:b||"",willCommit:!1,selStart:A,selEnd:w}})}),this._setEventListeners(s,o,[["focus","Focus"],["blur","Blur"],["mousedown","Mouse Down"],["mouseenter","Mouse Enter"],["mouseleave","Mouse Exit"],["mouseup","Mouse Up"]],p=>p.target.value)}if(f&&s.addEventListener("blur",f),this.data.comb){const p=(this.data.rect[2]-this.data.rect[0])/r;s.classList.add("comb"),s.style.letterSpacing=`calc(${p}px * var(--total-scale-factor) - 1ch)`}}else s=document.createElement("div"),s.textContent=this.data.fieldValue,s.style.verticalAlign="middle",s.style.display="table-cell",this.data.hasOwnCanvas&&(s.hidden=!0);return this._setTextStyle(s),this._setBackgroundColor(s),this._setDefaultPropertiesFromJS(s),this.container.append(s),this.container}}class sa extends de{constructor(t){super(t,{isRenderable:!!t.data.hasOwnCanvas})}}class ia extends de{constructor(t){super(t,{isRenderable:t.renderForms})}render(){const t=this.annotationStorage,e=this.data,s=e.id;let i=t.getValue(s,{value:e.exportValue===e.fieldValue}).value;typeof i=="string"&&(i=i!=="Off",t.setValue(s,{value:i})),this.container.classList.add("buttonWidgetAnnotation","checkBox");const n=document.createElement("input");return he.add(n),n.setAttribute("data-element-id",s),n.disabled=e.readOnly,this._setRequired(n,this.data.required),n.type="checkbox",n.name=e.fieldName,i&&n.setAttribute("checked",!0),n.setAttribute("exportValue",e.exportValue),n.tabIndex=0,n.addEventListener("change",r=>{const{name:a,checked:o}=r.target;for(const l of this._getElementsByName(a,s)){const h=o&&l.exportValue===e.exportValue;l.domElement&&(l.domElement.checked=h),t.setValue(l.id,{value:h})}t.setValue(s,{value:o})}),n.addEventListener("resetform",r=>{const a=e.defaultFieldValue||"Off";r.target.checked=a===e.exportValue}),this.enableScripting&&this.hasJSActions&&(n.addEventListener("updatefromsandbox",r=>{const a={value(o){o.target.checked=o.detail.value!=="Off",t.setValue(s,{value:o.target.checked})}};this._dispatchEventFromSandbox(a,r)}),this._setEventListeners(n,null,[["change","Validate"],["change","Action"],["focus","Focus"],["blur","Blur"],["mousedown","Mouse Down"],["mouseenter","Mouse Enter"],["mouseleave","Mouse Exit"],["mouseup","Mouse Up"]],r=>r.target.checked)),this._setBackgroundColor(n),this._setDefaultPropertiesFromJS(n),this.container.append(n),this.container}}class ln extends de{constructor(t){super(t,{isRenderable:t.renderForms})}render(){this.container.classList.add("buttonWidgetAnnotation","radioButton");const t=this.annotationStorage,e=this.data,s=e.id;let i=t.getValue(s,{value:e.fieldValue===e.buttonValue}).value;if(typeof i=="string"&&(i=i!==e.buttonValue,t.setValue(s,{value:i})),i)for(const r of this._getElementsByName(e.fieldName,s))t.setValue(r.id,{value:!1});const n=document.createElement("input");if(he.add(n),n.setAttribute("data-element-id",s),n.disabled=e.readOnly,this._setRequired(n,this.data.required),n.type="radio",n.name=e.fieldName,i&&n.setAttribute("checked",!0),n.tabIndex=0,n.addEventListener("change",r=>{const{name:a,checked:o}=r.target;for(const l of this._getElementsByName(a,s))t.setValue(l.id,{value:!1});t.setValue(s,{value:o})}),n.addEventListener("resetform",r=>{const a=e.defaultFieldValue;r.target.checked=a!=null&&a===e.buttonValue}),this.enableScripting&&this.hasJSActions){const r=e.buttonValue;n.addEventListener("updatefromsandbox",a=>{const o={value:l=>{const h=r===l.detail.value;for(const c of this._getElementsByName(l.target.name)){const u=h&&c.id===s;c.domElement&&(c.domElement.checked=u),t.setValue(c.id,{value:u})}}};this._dispatchEventFromSandbox(o,a)}),this._setEventListeners(n,null,[["change","Validate"],["change","Action"],["focus","Focus"],["blur","Blur"],["mousedown","Mouse Down"],["mouseenter","Mouse Enter"],["mouseleave","Mouse Exit"],["mouseup","Mouse Up"]],a=>a.target.checked)}return this._setBackgroundColor(n),this._setDefaultPropertiesFromJS(n),this.container.append(n),this.container}}class na extends Ys{constructor(t){super(t,{ignoreBorder:t.data.hasAppearance})}render(){const t=super.render();t.classList.add("buttonWidgetAnnotation","pushButton");const e=t.lastChild;return this.enableScripting&&this.hasJSActions&&e&&(this._setDefaultPropertiesFromJS(e),e.addEventListener("updatefromsandbox",s=>{this._dispatchEventFromSandbox({},s)})),t}}class ra extends de{constructor(t){super(t,{isRenderable:t.renderForms})}render(){this.container.classList.add("choiceWidgetAnnotation");const t=this.annotationStorage,e=this.data.id,s=t.getValue(e,{value:this.data.fieldValue}),i=document.createElement("select");he.add(i),i.setAttribute("data-element-id",e),i.disabled=this.data.readOnly,this._setRequired(i,this.data.required),i.name=this.data.fieldName,i.tabIndex=0;let n=this.data.combo&&this.data.options.length>0;this.data.combo||(i.size=this.data.options.length,this.data.multiSelect&&(i.multiple=!0)),i.addEventListener("resetform",h=>{const c=this.data.defaultFieldValue;for(const u of i.options)u.selected=u.value===c});for(const h of this.data.options){const c=document.createElement("option");c.textContent=h.displayValue,c.value=h.exportValue,s.value.includes(h.exportValue)&&(c.setAttribute("selected",!0),n=!1),i.append(c)}let r=null;if(n){const h=document.createElement("option");h.value=" ",h.setAttribute("hidden",!0),h.setAttribute("selected",!0),i.prepend(h),r=()=>{h.remove(),i.removeEventListener("input",r),r=null},i.addEventListener("input",r)}const a=h=>{const c=h?"value":"textContent",{options:u,multiple:f}=i;return f?Array.prototype.filter.call(u,m=>m.selected).map(m=>m[c]):u.selectedIndex===-1?null:u[u.selectedIndex][c]};let o=a(!1);const l=h=>{const c=h.target.options;return Array.prototype.map.call(c,u=>({displayValue:u.textContent,exportValue:u.value}))};return this.enableScripting&&this.hasJSActions?(i.addEventListener("updatefromsandbox",h=>{const c={value(u){r?.();const f=u.detail.value,m=new Set(Array.isArray(f)?f:[f]);for(const p of i.options)p.selected=m.has(p.value);t.setValue(e,{value:a(!0)}),o=a(!1)},multipleSelection(u){i.multiple=!0},remove(u){const f=i.options,m=u.detail.remove;f[m].selected=!1,i.remove(m),f.length>0&&Array.prototype.findIndex.call(f,b=>b.selected)===-1&&(f[0].selected=!0),t.setValue(e,{value:a(!0),items:l(u)}),o=a(!1)},clear(u){for(;i.length!==0;)i.remove(0);t.setValue(e,{value:null,items:[]}),o=a(!1)},insert(u){const{index:f,displayValue:m,exportValue:p}=u.detail.insert,b=i.children[f],g=document.createElement("option");g.textContent=m,g.value=p,b?b.before(g):i.append(g),t.setValue(e,{value:a(!0),items:l(u)}),o=a(!1)},items(u){const{items:f}=u.detail;for(;i.length!==0;)i.remove(0);for(const m of f){const{displayValue:p,exportValue:b}=m,g=document.createElement("option");g.textContent=p,g.value=b,i.append(g)}i.options.length>0&&(i.options[0].selected=!0),t.setValue(e,{value:a(!0),items:l(u)}),o=a(!1)},indices(u){const f=new Set(u.detail.indices);for(const m of u.target.options)m.selected=f.has(m.index);t.setValue(e,{value:a(!0)}),o=a(!1)},editable(u){u.target.disabled=!u.detail.editable}};this._dispatchEventFromSandbox(c,h)}),i.addEventListener("input",h=>{const c=a(!0),u=a(!1);t.setValue(e,{value:c}),h.preventDefault(),this.linkService.eventBus?.dispatch("dispatcheventinsandbox",{source:this,detail:{id:e,name:"Keystroke",value:o,change:u,changeEx:c,willCommit:!1,commitKey:1,keyDown:!1}})}),this._setEventListeners(i,null,[["focus","Focus"],["blur","Blur"],["mousedown","Mouse Down"],["mouseenter","Mouse Enter"],["mouseleave","Mouse Exit"],["mouseup","Mouse Up"],["input","Action"],["input","Validate"]],h=>h.target.value)):i.addEventListener("input",function(h){t.setValue(e,{value:a(!0)})}),this.data.combo&&this._setTextStyle(i),this._setBackgroundColor(i),this._setDefaultPropertiesFromJS(i),this.container.append(i),this.container}}class Ns extends lt{constructor(t){const{data:e,elements:s,parent:i}=t,n=!!i._commentManager;if(super(t,{isRenderable:!n&&lt._hasPopupData(e)}),this.elements=s,n&&lt._hasPopupData(e)){const r=this.popup=this.#t();for(const a of s)a.popup=r}else this.popup=null}#t(){return new aa({container:this.container,color:this.data.color,titleObj:this.data.titleObj,modificationDate:this.data.modificationDate||this.data.creationDate,contentsObj:this.data.contentsObj,richText:this.data.richText,rect:this.data.rect,parentRect:this.data.parentRect||null,parent:this.parent,elements:this.elements,open:this.data.open,commentManager:this.parent._commentManager})}render(){const{container:t}=this;t.classList.add("popupAnnotation"),t.role="comment";const e=this.popup=this.#t(),s=[];for(const i of this.elements)i.popup=e,i.container.ariaHasPopup="dialog",s.push(i.data.id),i.addHighlightArea();return this.container.setAttribute("aria-controls",s.map(i=>`${js}${i}`).join(",")),this.container}}class aa{#t=null;#e=this.#G.bind(this);#i=this.#j.bind(this);#s=this.#D.bind(this);#a=this.#A.bind(this);#n=null;#r=null;#o=null;#h=null;#l=null;#u=null;#d=null;#f=!1;#m=null;#p=null;#c=null;#g=null;#b=null;#w=null;#y=null;#E=null;#_=null;#v=null;#T=!1;#x=null;#S=null;constructor({container:t,color:e,elements:s,titleObj:i,modificationDate:n,contentsObj:r,richText:a,parent:o,rect:l,parentRect:h,open:c,commentManager:u=null}){this.#r=t,this.#_=i,this.#o=r,this.#E=a,this.#u=o,this.#n=e,this.#y=l,this.#d=h,this.#l=s,this.#t=u,this.#x=s[0],this.#h=ks.toDateObject(n),this.trigger=s.flatMap(f=>f.getElementsToTriggerPopup()),u?this.renderCommentButton():(this.#M(),this.#r.hidden=!0,c&&this.#A())}#M(){if(this.#p)return;this.#p=new AbortController;const{signal:t}=this.#p;for(const e of this.trigger)e.addEventListener("click",this.#a,{signal:t}),e.addEventListener("pointerenter",this.#s,{signal:t}),e.addEventListener("pointerleave",this.#i,{signal:t}),e.classList.add("popupTriggerArea");for(const e of this.#l)e.container?.addEventListener("keydown",this.#e,{signal:t})}#k(){const t=this.#l.find(e=>e.hasCommentButton);t&&(this.#b=t._normalizePoint(t.commentButtonPosition))}renderCommentButton(){if(this.#g||(this.#b||this.#k(),!this.#b))return;const{signal:t}=this.#p=new AbortController,e=!!this.#x.extraPopupElement,s=()=>{this.#t.toggleCommentPopup(this,!0,void 0,!e)},i=()=>{this.#t.toggleCommentPopup(this,!1,!0,!e)},n=()=>{this.#t.toggleCommentPopup(this,!1,!1)};if(e){this.#g=this.#x.container;for(const r of this.trigger)r.ariaHasPopup="dialog",r.ariaControls="commentPopup",r.addEventListener("keydown",this.#e,{signal:t}),r.addEventListener("click",s,{signal:t}),r.addEventListener("pointerenter",i,{signal:t}),r.addEventListener("pointerleave",n,{signal:t}),r.classList.add("popupTriggerArea")}else{const r=this.#g=document.createElement("button");r.className="annotationCommentButton";const a=this.#x.container;r.style.zIndex=a.style.zIndex+1,r.tabIndex=0,r.ariaHasPopup="dialog",r.ariaControls="commentPopup",r.setAttribute("data-l10n-id","pdfjs-show-comment-button"),this.#O(),this.#P(),r.addEventListener("keydown",this.#e,{signal:t}),r.addEventListener("click",s,{signal:t}),r.addEventListener("pointerenter",i,{signal:t}),r.addEventListener("pointerleave",n,{signal:t}),a.after(r)}}#P(){if(this.#x.extraPopupElement&&!this.#x.editor)return;this.renderCommentButton();const[t,e]=this.#b,{style:s}=this.#g;s.left=`calc(${t}%)`,s.top=`calc(${e}% - var(--comment-button-dim))`}#O(){this.#x.extraPopupElement||(this.renderCommentButton(),this.#g.style.backgroundColor=this.commentButtonColor||"")}get commentButtonColor(){const{color:t,opacity:e}=this.#x.commentData;return t?this.#u._commentManager.makeCommentColor(t,e):null}focusCommentButton(){setTimeout(()=>{this.#g?.focus()},0)}getData(){const{richText:t,color:e,opacity:s,creationDate:i,modificationDate:n}=this.#x.commentData;return{contentsObj:{str:this.comment},richText:t,color:e,opacity:s,creationDate:i,modificationDate:n}}get elementBeforePopup(){return this.#g}get comment(){return this.#S||=this.#x.commentText,this.#S}set comment(t){t!==this.comment&&(this.#x.commentText=this.#S=t)}get parentBoundingClientRect(){return this.#x.layer.getBoundingClientRect()}setCommentButtonStates({selected:t,hasPopup:e}){this.#g&&(this.#g.classList.toggle("selected",t),this.#g.ariaExpanded=e)}setSelectedCommentButton(t){this.#g.classList.toggle("selected",t)}get commentPopupPosition(){if(this.#w)return this.#w;const{x:t,y:e,height:s}=this.#g.getBoundingClientRect(),{x:i,y:n,width:r,height:a}=this.#x.layer.getBoundingClientRect();return[(t-i)/r,(e+s-n)/a]}set commentPopupPosition(t){this.#w=t}hasDefaultPopupPosition(){return this.#w===null}get commentButtonPosition(){return this.#b}get commentButtonWidth(){return this.#g.getBoundingClientRect().width/this.parentBoundingClientRect.width}editComment(t){const[e,s]=this.#w||this.commentButtonPosition.map(l=>l/100),i=this.parentBoundingClientRect,{x:n,y:r,width:a,height:o}=i;this.#t.showDialog(null,this,n+e*a,r+s*o,{...t,parentDimensions:i})}render(){if(this.#m)return;const t=this.#m=document.createElement("div");if(t.className="popup",this.#n){const s=t.style.outlineColor=B.makeHexColor(...this.#n);t.style.backgroundColor=`color-mix(in srgb, ${s} 30%, white)`}const e=document.createElement("span");if(e.className="header",this.#_?.str){const s=document.createElement("span");s.className="title",e.append(s),{dir:s.dir,str:s.textContent}=this.#_}if(t.append(e),this.#h){const s=document.createElement("time");s.className="popupDate",s.setAttribute("data-l10n-id","pdfjs-annotation-date-time-string"),s.setAttribute("data-l10n-args",JSON.stringify({dateObj:this.#h.valueOf()})),s.dateTime=this.#h.toISOString(),e.append(s)}Ui({html:this.#L||this.#o.str,dir:this.#o?.dir,className:"popupContent"},t),this.#r.append(t)}get#L(){const t=this.#E,e=this.#o;return t?.str&&(!e?.str||e.str===t.str)&&this.#E.html||null}get#I(){return this.#L?.attributes?.style?.fontSize||0}get#B(){return this.#L?.attributes?.style?.color||null}#N(t){const e=[],s={str:t,html:{name:"div",attributes:{dir:"auto"},children:[{name:"p",children:e}]}},i={style:{color:this.#B,fontSize:this.#I?`calc(${this.#I}px * var(--total-scale-factor))`:""}};for(const n of t.split(`
`))e.push({name:"span",value:n,attributes:i});return s}#G(t){t.altKey||t.shiftKey||t.ctrlKey||t.metaKey||(t.key==="Enter"||t.key==="Escape"&&this.#f)&&this.#A()}updateEdited({rect:t,popup:e,deleted:s}){if(this.#t){s?(this.remove(),this.#S=null):e&&(e.deleted?this.remove():(this.#O(),this.#S=e.text)),t&&(this.#b=null,this.#k(),this.#P());return}if(s||e?.deleted){this.remove();return}this.#M(),this.#v||={contentsObj:this.#o,richText:this.#E},t&&(this.#c=null),e&&e.text&&(this.#E=this.#N(e.text),this.#h=ks.toDateObject(e.date),this.#o=null),this.#m?.remove(),this.#m=null}resetEdited(){this.#v&&({contentsObj:this.#o,richText:this.#E}=this.#v,this.#v=null,this.#m?.remove(),this.#m=null,this.#c=null)}remove(){if(this.#p?.abort(),this.#p=null,this.#m?.remove(),this.#m=null,this.#T=!1,this.#f=!1,this.#g?.remove(),this.#g=null,this.trigger)for(const t of this.trigger)t.classList.remove("popupTriggerArea")}#C(){if(this.#c!==null)return;const{page:{view:t},viewport:{rawDims:{pageWidth:e,pageHeight:s,pageX:i,pageY:n}}}=this.#u;let r=!!this.#d,a=r?this.#d:this.#y;for(const m of this.#l)if(!a||B.intersect(m.data.rect,a)!==null){a=m.data.rect,r=!0;break}const o=B.normalizeRect([a[0],t[3]-a[1]+t[1],a[2],t[3]-a[3]+t[1]]),h=r?a[2]-a[0]+5:0,c=o[0]+h,u=o[1];this.#c=[100*(c-i)/e,100*(u-n)/s];const{style:f}=this.#r;f.left=`${this.#c[0]}%`,f.top=`${this.#c[1]}%`}#A(){if(this.#t){this.#t.toggleCommentPopup(this,!1);return}this.#f=!this.#f,this.#f?(this.#D(),this.#r.addEventListener("click",this.#a),this.#r.addEventListener("keydown",this.#e)):(this.#j(),this.#r.removeEventListener("click",this.#a),this.#r.removeEventListener("keydown",this.#e))}#D(){this.#m||this.render(),this.isVisible?this.#f&&this.#r.classList.add("focused"):(this.#C(),this.#r.hidden=!1,this.#r.style.zIndex=parseInt(this.#r.style.zIndex)+1e3)}#j(){this.#r.classList.remove("focused"),!(this.#f||!this.isVisible)&&(this.#r.hidden=!0,this.#r.style.zIndex=parseInt(this.#r.style.zIndex)-1e3)}forceHide(){this.#T=this.isVisible,this.#T&&(this.#r.hidden=!0)}maybeShow(){this.#t||(this.#M(),this.#T&&(this.#m||this.#D(),this.#T=!1,this.#r.hidden=!1))}get isVisible(){return this.#t?!1:this.#r.hidden===!1}}class hn extends lt{constructor(t){super(t,{isRenderable:!0,ignoreBorder:!0}),this.textContent=t.data.textContent,this.textPosition=t.data.textPosition,this.annotationEditorType=V.FREETEXT}render(){if(this.container.classList.add("freeTextAnnotation"),this.textContent){const t=document.createElement("div");t.classList.add("annotationTextContent"),t.setAttribute("role","comment");for(const e of this.textContent){const s=document.createElement("span");s.textContent=e,t.append(s)}this.container.append(t)}return!this.data.popupRef&&this.hasPopupData&&this._createPopup(),this._editOnDoubleClick(),this.container}}class oa extends lt{#t=null;constructor(t){super(t,{isRenderable:!0,ignoreBorder:!0})}render(){this.container.classList.add("lineAnnotation");const{data:t,width:e,height:s}=this,i=this.svgFactory.create(e,s,!0),n=this.#t=this.svgFactory.createElement("svg:line");return n.setAttribute("x1",t.rect[2]-t.lineCoordinates[0]),n.setAttribute("y1",t.rect[3]-t.lineCoordinates[1]),n.setAttribute("x2",t.rect[2]-t.lineCoordinates[2]),n.setAttribute("y2",t.rect[3]-t.lineCoordinates[3]),n.setAttribute("stroke-width",t.borderStyle.width||1),n.setAttribute("stroke","transparent"),n.setAttribute("fill","transparent"),i.append(n),this.container.append(i),!t.popupRef&&this.hasPopupData&&this._createPopup(),this.container}getElementsToTriggerPopup(){return this.#t}addHighlightArea(){this.container.classList.add("highlightArea")}}class la extends lt{#t=null;constructor(t){super(t,{isRenderable:!0,ignoreBorder:!0})}render(){this.container.classList.add("squareAnnotation");const{data:t,width:e,height:s}=this,i=this.svgFactory.create(e,s,!0),n=t.borderStyle.width,r=this.#t=this.svgFactory.createElement("svg:rect");return r.setAttribute("x",n/2),r.setAttribute("y",n/2),r.setAttribute("width",e-n),r.setAttribute("height",s-n),r.setAttribute("stroke-width",n||1),r.setAttribute("stroke","transparent"),r.setAttribute("fill","transparent"),i.append(r),this.container.append(i),!t.popupRef&&this.hasPopupData&&this._createPopup(),this.container}getElementsToTriggerPopup(){return this.#t}addHighlightArea(){this.container.classList.add("highlightArea")}}class ha extends lt{#t=null;constructor(t){super(t,{isRenderable:!0,ignoreBorder:!0})}render(){this.container.classList.add("circleAnnotation");const{data:t,width:e,height:s}=this,i=this.svgFactory.create(e,s,!0),n=t.borderStyle.width,r=this.#t=this.svgFactory.createElement("svg:ellipse");return r.setAttribute("cx",e/2),r.setAttribute("cy",s/2),r.setAttribute("rx",e/2-n/2),r.setAttribute("ry",s/2-n/2),r.setAttribute("stroke-width",n||1),r.setAttribute("stroke","transparent"),r.setAttribute("fill","transparent"),i.append(r),this.container.append(i),!t.popupRef&&this.hasPopupData&&this._createPopup(),this.container}getElementsToTriggerPopup(){return this.#t}addHighlightArea(){this.container.classList.add("highlightArea")}}class cn extends lt{#t=null;constructor(t){super(t,{isRenderable:!0,ignoreBorder:!0}),this.containerClassName="polylineAnnotation",this.svgElementName="svg:polyline"}render(){this.container.classList.add(this.containerClassName);const{data:{rect:t,vertices:e,borderStyle:s,popupRef:i},width:n,height:r}=this;if(!e)return this.container;const a=this.svgFactory.create(n,r,!0);let o=[];for(let h=0,c=e.length;h<c;h+=2){const u=e[h]-t[0],f=t[3]-e[h+1];o.push(`${u},${f}`)}o=o.join(" ");const l=this.#t=this.svgFactory.createElement(this.svgElementName);return l.setAttribute("points",o),l.setAttribute("stroke-width",s.width||1),l.setAttribute("stroke","transparent"),l.setAttribute("fill","transparent"),a.append(l),this.container.append(a),!i&&this.hasPopupData&&this._createPopup(),this.container}getElementsToTriggerPopup(){return this.#t}addHighlightArea(){this.container.classList.add("highlightArea")}}class ca extends cn{constructor(t){super(t),this.containerClassName="polygonAnnotation",this.svgElementName="svg:polygon"}}class da extends lt{constructor(t){super(t,{isRenderable:!0,ignoreBorder:!0})}render(){return this.container.classList.add("caretAnnotation"),!this.data.popupRef&&this.hasPopupData&&this._createPopup(),this.container}}class Ks extends lt{#t=null;#e=[];constructor(t){super(t,{isRenderable:!0,ignoreBorder:!0}),this.containerClassName="inkAnnotation",this.svgElementName="svg:polyline",this.annotationEditorType=this.data.it==="InkHighlight"?V.HIGHLIGHT:V.INK}#i(t,e){switch(t){case 90:return{transform:`rotate(90) translate(${-e[0]},${e[1]}) scale(1,-1)`,width:e[3]-e[1],height:e[2]-e[0]};case 180:return{transform:`rotate(180) translate(${-e[2]},${e[1]}) scale(1,-1)`,width:e[2]-e[0],height:e[3]-e[1]};case 270:return{transform:`rotate(270) translate(${-e[2]},${e[3]}) scale(1,-1)`,width:e[3]-e[1],height:e[2]-e[0]};default:return{transform:`translate(${-e[0]},${e[3]}) scale(1,-1)`,width:e[2]-e[0],height:e[3]-e[1]}}}render(){this.container.classList.add(this.containerClassName);const{data:{rect:t,rotation:e,inkLists:s,borderStyle:i,popupRef:n}}=this,{transform:r,width:a,height:o}=this.#i(e,t),l=this.svgFactory.create(a,o,!0),h=this.#t=this.svgFactory.createElement("svg:g");l.append(h),h.setAttribute("stroke-width",i.width||1),h.setAttribute("stroke-linecap","round"),h.setAttribute("stroke-linejoin","round"),h.setAttribute("stroke-miterlimit",10),h.setAttribute("stroke","transparent"),h.setAttribute("fill","transparent"),h.setAttribute("transform",r);for(let c=0,u=s.length;c<u;c++){const f=this.svgFactory.createElement(this.svgElementName);this.#e.push(f),f.setAttribute("points",s[c].join(",")),h.append(f)}return!n&&this.hasPopupData&&this._createPopup(),this.container.append(l),this._editOnDoubleClick(),this.container}updateEdited(t){super.updateEdited(t);const{thickness:e,points:s,rect:i}=t,n=this.#t;if(e>=0&&n.setAttribute("stroke-width",e||1),s)for(let r=0,a=this.#e.length;r<a;r++)this.#e[r].setAttribute("points",s[r].join(","));if(i){const{transform:r,width:a,height:o}=this.#i(this.data.rotation,i);n.parentElement.setAttribute("viewBox",`0 0 ${a} ${o}`),n.setAttribute("transform",r)}}getElementsToTriggerPopup(){return this.#e}addHighlightArea(){this.container.classList.add("highlightArea")}}class dn extends lt{constructor(t){super(t,{isRenderable:!0,ignoreBorder:!0,createQuadrilaterals:!0}),this.annotationEditorType=V.HIGHLIGHT}render(){const{data:{overlaidText:t,popupRef:e}}=this;if(!e&&this.hasPopupData&&this._createPopup(),this.container.classList.add("highlightAnnotation"),this._editOnDoubleClick(),t){const s=document.createElement("mark");s.classList.add("overlaidText"),s.textContent=t,this.container.append(s)}return this.container}}class ua extends lt{constructor(t){super(t,{isRenderable:!0,ignoreBorder:!0,createQuadrilaterals:!0})}render(){const{data:{overlaidText:t,popupRef:e}}=this;if(!e&&this.hasPopupData&&this._createPopup(),this.container.classList.add("underlineAnnotation"),t){const s=document.createElement("u");s.classList.add("overlaidText"),s.textContent=t,this.container.append(s)}return this.container}}class fa extends lt{constructor(t){super(t,{isRenderable:!0,ignoreBorder:!0,createQuadrilaterals:!0})}render(){const{data:{overlaidText:t,popupRef:e}}=this;if(!e&&this.hasPopupData&&this._createPopup(),this.container.classList.add("squigglyAnnotation"),t){const s=document.createElement("u");s.classList.add("overlaidText"),s.textContent=t,this.container.append(s)}return this.container}}class pa extends lt{constructor(t){super(t,{isRenderable:!0,ignoreBorder:!0,createQuadrilaterals:!0})}render(){const{data:{overlaidText:t,popupRef:e}}=this;if(!e&&this.hasPopupData&&this._createPopup(),this.container.classList.add("strikeoutAnnotation"),t){const s=document.createElement("s");s.classList.add("overlaidText"),s.textContent=t,this.container.append(s)}return this.container}}class un extends lt{constructor(t){super(t,{isRenderable:!0,ignoreBorder:!0}),this.annotationEditorType=V.STAMP}render(){return this.container.classList.add("stampAnnotation"),this.container.setAttribute("role","img"),!this.data.popupRef&&this.hasPopupData&&this._createPopup(),this._editOnDoubleClick(),this.container}}class ga extends lt{#t=null;constructor(t){super(t,{isRenderable:!0});const{file:e}=this.data;this.filename=e.filename,this.content=e.content,this.linkService.eventBus?.dispatch("fileattachmentannotation",{source:this,...e})}render(){this.container.classList.add("fileAttachmentAnnotation");const{container:t,data:e}=this;let s;e.hasAppearance||e.fillAlpha===0?s=document.createElement("div"):(s=document.createElement("img"),s.src=`${this.imageResourcesPath}annotation-${/paperclip/i.test(e.name)?"paperclip":"pushpin"}.svg`,e.fillAlpha&&e.fillAlpha<1&&(s.style=`filter: opacity(${Math.round(e.fillAlpha*100)}%);`)),s.addEventListener("dblclick",this.#e.bind(this)),this.#t=s;const{isMac:i}=_t.platform;return t.addEventListener("keydown",n=>{n.key==="Enter"&&(i?n.metaKey:n.ctrlKey)&&this.#e()}),!e.popupRef&&this.hasPopupData?this._createPopup():s.classList.add("popupTriggerArea"),t.append(s),t}getElementsToTriggerPopup(){return this.#t}addHighlightArea(){this.container.classList.add("highlightArea")}#e(){this.downloadManager?.openOrDownloadData(this.content,this.filename)}}class Qs{#t=null;#e=null;#i=null;#s=new Map;#a=null;#n=null;constructor({div:t,accessibilityManager:e,annotationCanvasMap:s,annotationEditorUIManager:i,page:n,viewport:r,structTreeLayer:a,commentManager:o,linkService:l,annotationStorage:h}){this.div=t,this.#t=e,this.#e=s,this.#a=a||null,this.#n=l||null,this.#i=h||new Gs,this.page=n,this.viewport=r,this.zIndex=0,this._annotationEditorUIManager=i,this._commentManager=o||null}hasEditableAnnotations(){return this.#s.size>0}async#r(t,e,s){const i=t.firstChild||t,n=i.id=`${js}${e}`,r=await this.#a?.getAriaAttributes(n);if(r)for(const[a,o]of r)i.setAttribute(a,o);s?s.at(-1).container.after(t):(this.div.append(t),this.#t?.moveElementInDOM(this.div,t,i,!1))}async render(t){const{annotations:e}=t,s=this.div;le(s,this.viewport);const i=new Map,n={data:null,layer:s,linkService:this.#n,downloadManager:t.downloadManager,imageResourcesPath:t.imageResourcesPath||"",renderForms:t.renderForms!==!1,svgFactory:new as,annotationStorage:this.#i,enableComment:t.enableComment===!0,enableScripting:t.enableScripting===!0,hasJSActions:t.hasJSActions,fieldObjects:t.fieldObjects,parent:this,elements:null};for(const r of e){if(r.noHTML)continue;const a=r.annotationType===gt.POPUP;if(a){const h=i.get(r.id);if(!h)continue;n.elements=h}else if(r.rect[2]===r.rect[0]||r.rect[3]===r.rect[1])continue;n.data=r;const o=Di.create(n);if(!o.isRenderable)continue;if(!a&&r.popupRef){const h=i.get(r.popupRef);h?h.push(o):i.set(r.popupRef,[o])}const l=o.render();r.hidden&&(l.style.visibility="hidden"),await this.#r(l,r.id,n.elements),o.extraPopupElement?.popup?.renderCommentButton(),o._isEditable&&(this.#s.set(o.data.id,o),this._annotationEditorUIManager?.renderAnnotationElement(o))}this.#o()}async addLinkAnnotations(t){const e={data:null,layer:this.div,linkService:this.#n,svgFactory:new as,parent:this};for(const s of t){s.borderStyle||=Qs._defaultBorderStyle,e.data=s;const i=Di.create(e);if(!i.isRenderable)continue;const n=i.render();await this.#r(n,s.id,null)}}update({viewport:t}){const e=this.div;this.viewport=t,le(e,{rotation:t.rotation}),this.#o(),e.hidden=!1}#o(){if(!this.#e)return;const t=this.div;for(const[e,s]of this.#e){const i=t.querySelector(`[data-annotation-id="${e}"]`);if(!i)continue;s.className="annotationContent";const{firstChild:n}=i;n?n.nodeName==="CANVAS"?n.replaceWith(s):n.classList.contains("annotationContent")?n.after(s):n.before(s):i.append(s);const r=this.#s.get(e);r&&(r._hasNoCanvas?(this._annotationEditorUIManager?.setMissingCanvas(e,i.id,s),r._hasNoCanvas=!1):r.canvas=s)}this.#e.clear()}getEditableAnnotations(){return Array.from(this.#s.values())}getEditableAnnotation(t){return this.#s.get(t)}addFakeAnnotation(t){const{div:e}=this,{id:s,rotation:i}=t,n=new Zr({data:{id:s,rect:t.getPDFRect(),rotation:i},editor:t,layer:e,parent:this,enableComment:!!this._commentManager,linkService:this.#n,annotationStorage:this.#i}),r=n.render();return e.append(r),this.#t?.moveElementInDOM(e,r,r,!1),n.createOrUpdatePopup(),n}static get _defaultBorderStyle(){return W(this,"_defaultBorderStyle",Object.freeze({width:1,rawWidth:1,style:pe.SOLID,dashArray:[3],horizontalCornerRadius:0,verticalCornerRadius:0}))}}const Ze=/\r\n?|\n/g;class yt extends j{#t="";#e=`${this.id}-editor`;#i=null;#s;_colorPicker=null;static _freeTextDefaultContent="";static _internalPadding=0;static _defaultColor=null;static _defaultFontSize=10;static get _keyboardManager(){const t=yt.prototype,e=n=>n.isEmpty(),s=se.TRANSLATE_SMALL,i=se.TRANSLATE_BIG;return W(this,"_keyboardManager",new ze([[["ctrl+s","mac+meta+s","ctrl+p","mac+meta+p"],t.commitOrRemove,{bubbles:!0}],[["ctrl+Enter","mac+meta+Enter","Escape","mac+Escape"],t.commitOrRemove],[["ArrowLeft","mac+ArrowLeft"],t._translateEmpty,{args:[-s,0],checker:e}],[["ctrl+ArrowLeft","mac+shift+ArrowLeft"],t._translateEmpty,{args:[-i,0],checker:e}],[["ArrowRight","mac+ArrowRight"],t._translateEmpty,{args:[s,0],checker:e}],[["ctrl+ArrowRight","mac+shift+ArrowRight"],t._translateEmpty,{args:[i,0],checker:e}],[["ArrowUp","mac+ArrowUp"],t._translateEmpty,{args:[0,-s],checker:e}],[["ctrl+ArrowUp","mac+shift+ArrowUp"],t._translateEmpty,{args:[0,-i],checker:e}],[["ArrowDown","mac+ArrowDown"],t._translateEmpty,{args:[0,s],checker:e}],[["ctrl+ArrowDown","mac+shift+ArrowDown"],t._translateEmpty,{args:[0,i],checker:e}]]))}static _type="freetext";static _editorType=V.FREETEXT;constructor(t){super({...t,name:"freeTextEditor"}),this.color=t.color||yt._defaultColor||j._defaultLineColor,this.#s=t.fontSize||yt._defaultFontSize,this.annotationElementId||this._uiManager.a11yAlert("pdfjs-editor-freetext-added-alert")}static initialize(t,e){j.initialize(t,e);const s=getComputedStyle(document.documentElement);this._internalPadding=parseFloat(s.getPropertyValue("--freetext-padding"))}static updateDefaultParams(t,e){switch(t){case K.FREETEXT_SIZE:yt._defaultFontSize=e;break;case K.FREETEXT_COLOR:yt._defaultColor=e;break}}updateParams(t,e){switch(t){case K.FREETEXT_SIZE:this.#a(e);break;case K.FREETEXT_COLOR:this.#n(e);break}}static get defaultPropertiesToUpdate(){return[[K.FREETEXT_SIZE,yt._defaultFontSize],[K.FREETEXT_COLOR,yt._defaultColor||j._defaultLineColor]]}get propertiesToUpdate(){return[[K.FREETEXT_SIZE,this.#s],[K.FREETEXT_COLOR,this.color]]}get toolbarButtons(){return this._colorPicker||=new Oe(this),[["colorPicker",this._colorPicker]]}get colorType(){return K.FREETEXT_COLOR}#a(t){const e=i=>{this.editorDiv.style.fontSize=`calc(${i}px * var(--total-scale-factor))`,this.translate(0,-(i-this.#s)*this.parentScale),this.#s=i,this.#o()},s=this.#s;this.addCommands({cmd:e.bind(this,t),undo:e.bind(this,s),post:this._uiManager.updateUI.bind(this._uiManager,this),mustExec:!0,type:K.FREETEXT_SIZE,overwriteIfSameType:!0,keepUndo:!0})}onUpdatedColor(){this.editorDiv.style.color=this.color,this._colorPicker?.update(this.color),super.onUpdatedColor()}#n(t){const e=i=>{this.color=i,this.onUpdatedColor()},s=this.color;this.addCommands({cmd:e.bind(this,t),undo:e.bind(this,s),post:this._uiManager.updateUI.bind(this._uiManager,this),mustExec:!0,type:K.FREETEXT_COLOR,overwriteIfSameType:!0,keepUndo:!0})}_translateEmpty(t,e){this._uiManager.translateSelectedEditors(t,e,!0)}getInitialTranslation(){const t=this.parentScale;return[-yt._internalPadding*t,-(yt._internalPadding+this.#s)*t]}rebuild(){this.parent&&(super.rebuild(),this.div!==null&&(this.isAttachedToDOM||this.parent.add(this)))}enableEditMode(){if(!super.enableEditMode())return!1;this.overlayDiv.classList.remove("enabled"),this.editorDiv.contentEditable=!0,this._isDraggable=!1,this.div.removeAttribute("aria-activedescendant"),this.#i=new AbortController;const t=this._uiManager.combinedSignal(this.#i);return this.editorDiv.addEventListener("keydown",this.editorDivKeydown.bind(this),{signal:t}),this.editorDiv.addEventListener("focus",this.editorDivFocus.bind(this),{signal:t}),this.editorDiv.addEventListener("blur",this.editorDivBlur.bind(this),{signal:t}),this.editorDiv.addEventListener("input",this.editorDivInput.bind(this),{signal:t}),this.editorDiv.addEventListener("paste",this.editorDivPaste.bind(this),{signal:t}),!0}disableEditMode(){return super.disableEditMode()?(this.overlayDiv.classList.add("enabled"),this.editorDiv.contentEditable=!1,this.div.setAttribute("aria-activedescendant",this.#e),this._isDraggable=!0,this.#i?.abort(),this.#i=null,this.div.focus({preventScroll:!0}),this.isEditing=!1,this.parent.div.classList.add("freetextEditing"),!0):!1}focusin(t){this._focusEventsAllowed&&(super.focusin(t),t.target!==this.editorDiv&&this.editorDiv.focus())}onceAdded(t){this.width||(this.enableEditMode(),t&&this.editorDiv.focus(),this._initialOptions?.isCentered&&this.center(),this._initialOptions=null)}isEmpty(){return!this.editorDiv||this.editorDiv.innerText.trim()===""}remove(){this.isEditing=!1,this.parent&&(this.parent.setEditingState(!0),this.parent.div.classList.add("freetextEditing")),super.remove()}#r(){const t=[];this.editorDiv.normalize();let e=null;for(const s of this.editorDiv.childNodes)e?.nodeType===Node.TEXT_NODE&&s.nodeName==="BR"||(t.push(yt.#h(s)),e=s);return t.join(`
`)}#o(){const[t,e]=this.parentDimensions;let s;if(this.isAttachedToDOM)s=this.div.getBoundingClientRect();else{const{currentLayer:i,div:n}=this,r=n.style.display,a=n.classList.contains("hidden");n.classList.remove("hidden"),n.style.display="hidden",i.div.append(this.div),s=n.getBoundingClientRect(),n.remove(),n.style.display=r,n.classList.toggle("hidden",a)}this.rotation%180===this.parentRotation%180?(this.width=s.width/t,this.height=s.height/e):(this.width=s.height/t,this.height=s.width/e),this.fixAndSetPosition()}commit(){if(!this.isInEditMode())return;super.commit(),this.disableEditMode();const t=this.#t,e=this.#t=this.#r().trimEnd();if(t===e)return;const s=i=>{if(this.#t=i,!i){this.remove();return}this.#l(),this._uiManager.rebuild(this),this.#o()};this.addCommands({cmd:()=>{s(e)},undo:()=>{s(t)},mustExec:!1}),this.#o()}shouldGetKeyboardEvents(){return this.isInEditMode()}enterInEditMode(){this.enableEditMode(),this.editorDiv.focus()}keydown(t){t.target===this.div&&t.key==="Enter"&&(this.enterInEditMode(),t.preventDefault())}editorDivKeydown(t){yt._keyboardManager.exec(this,t)}editorDivFocus(t){this.isEditing=!0}editorDivBlur(t){this.isEditing=!1}editorDivInput(t){this.parent.div.classList.toggle("freetextEditing",this.isEmpty())}disableEditing(){this.editorDiv.setAttribute("role","comment"),this.editorDiv.removeAttribute("aria-multiline")}enableEditing(){this.editorDiv.setAttribute("role","textbox"),this.editorDiv.setAttribute("aria-multiline",!0)}get canChangeContent(){return!0}render(){if(this.div)return this.div;let t,e;(this._isCopy||this.annotationElementId)&&(t=this.x,e=this.y),super.render(),this.editorDiv=document.createElement("div"),this.editorDiv.className="internal",this.editorDiv.setAttribute("id",this.#e),this.editorDiv.setAttribute("data-l10n-id","pdfjs-free-text2"),this.editorDiv.setAttribute("data-l10n-attrs","default-content"),this.enableEditing(),this.editorDiv.contentEditable=!0;const{style:s}=this.editorDiv;if(s.fontSize=`calc(${this.#s}px * var(--total-scale-factor))`,s.color=this.color,this.div.append(this.editorDiv),this.overlayDiv=document.createElement("div"),this.overlayDiv.classList.add("overlay","enabled"),this.div.append(this.overlayDiv),this._isCopy||this.annotationElementId){const[i,n]=this.parentDimensions;if(this.annotationElementId){const{position:r}=this._initialData;let[a,o]=this.getInitialTranslation();[a,o]=this.pageTranslationToScreen(a,o);const[l,h]=this.pageDimensions,[c,u]=this.pageTranslation;let f,m;switch(this.rotation){case 0:f=t+(r[0]-c)/l,m=e+this.height-(r[1]-u)/h;break;case 90:f=t+(r[0]-c)/l,m=e-(r[1]-u)/h,[a,o]=[o,-a];break;case 180:f=t-this.width+(r[0]-c)/l,m=e-(r[1]-u)/h,[a,o]=[-a,-o];break;case 270:f=t+(r[0]-c-this.height*h)/l,m=e+(r[1]-u-this.width*l)/h,[a,o]=[-o,a];break}this.setAt(f*i,m*n,a,o)}else this._moveAfterPaste(t,e);this.#l(),this._isDraggable=!0,this.editorDiv.contentEditable=!1}else this._isDraggable=!1,this.editorDiv.contentEditable=!0;return this.div}static#h(t){return(t.nodeType===Node.TEXT_NODE?t.nodeValue:t.innerText).replaceAll(Ze,"")}editorDivPaste(t){const e=t.clipboardData||window.clipboardData,{types:s}=e;if(s.length===1&&s[0]==="text/plain")return;t.preventDefault();const i=yt.#d(e.getData("text")||"").replaceAll(Ze,`
`);if(!i)return;const n=window.getSelection();if(!n.rangeCount)return;this.editorDiv.normalize(),n.deleteFromDocument();const r=n.getRangeAt(0);if(!i.includes(`
`)){r.insertNode(document.createTextNode(i)),this.editorDiv.normalize(),n.collapseToStart();return}const{startContainer:a,startOffset:o}=r,l=[],h=[];if(a.nodeType===Node.TEXT_NODE){const f=a.parentElement;if(h.push(a.nodeValue.slice(o).replaceAll(Ze,"")),f!==this.editorDiv){let m=l;for(const p of this.editorDiv.childNodes){if(p===f){m=h;continue}m.push(yt.#h(p))}}l.push(a.nodeValue.slice(0,o).replaceAll(Ze,""))}else if(a===this.editorDiv){let f=l,m=0;for(const p of this.editorDiv.childNodes)m++===o&&(f=h),f.push(yt.#h(p))}this.#t=`${l.join(`
`)}${i}${h.join(`
`)}`,this.#l();const c=new Range;let u=Math.sumPrecise(l.map(f=>f.length));for(const{firstChild:f}of this.editorDiv.childNodes)if(f.nodeType===Node.TEXT_NODE){const m=f.nodeValue.length;if(u<=m){c.setStart(f,u),c.setEnd(f,u);break}u-=m}n.removeAllRanges(),n.addRange(c)}#l(){if(this.editorDiv.replaceChildren(),!!this.#t)for(const t of this.#t.split(`
`)){const e=document.createElement("div");e.append(t?document.createTextNode(t):document.createElement("br")),this.editorDiv.append(e)}}#u(){return this.#t.replaceAll(" "," ")}static#d(t){return t.replaceAll(" "," ")}get contentDiv(){return this.editorDiv}getPDFRect(){const t=yt._internalPadding*this.parentScale;return this.getRect(t,t)}static async deserialize(t,e,s){let i=null;if(t instanceof hn){const{data:{defaultAppearanceData:{fontSize:r,fontColor:a},rect:o,rotation:l,id:h,popupRef:c,richText:u,contentsObj:f,creationDate:m,modificationDate:p},textContent:b,textPosition:g,parent:{page:{pageNumber:v}}}=t;if(!b||b.length===0)return null;i=t={annotationType:V.FREETEXT,color:Array.from(a),fontSize:r,value:b.join(`
`),position:g,pageIndex:v-1,rect:o.slice(0),rotation:l,annotationElementId:h,id:h,deleted:!1,popupRef:c,comment:f?.str||null,richText:u,creationDate:m,modificationDate:p}}const n=await super.deserialize(t,e,s);return n.#s=t.fontSize,n.color=B.makeHexColor(...t.color),n.#t=yt.#d(t.value),n._initialData=i,t.comment&&n.setCommentData(t),n}serialize(t=!1){if(this.isEmpty())return null;if(this.deleted)return this.serializeDeleted();const e=j._colorManager.convert(this.isAttachedToDOM?getComputedStyle(this.editorDiv).color:this.color),s=Object.assign(super.serialize(t),{color:e,fontSize:this.#s,value:this.#u()});return this.addComment(s),t?(s.isCopy=!0,s):this.annotationElementId&&!this.#f(s)?null:(s.id=this.annotationElementId,s)}#f(t){const{value:e,fontSize:s,color:i,pageIndex:n}=this._initialData;return this.hasEditedComment||this._hasBeenMoved||t.value!==e||t.fontSize!==s||t.color.some((r,a)=>r!==i[a])||t.pageIndex!==n}renderAnnotationElement(t){const e=super.renderAnnotationElement(t);if(!e)return null;const{style:s}=e;s.fontSize=`calc(${this.#s}px * var(--total-scale-factor))`,s.color=this.color,e.replaceChildren();for(const i of this.#t.split(`
`)){const n=document.createElement("div");n.append(i?document.createTextNode(i):document.createElement("br")),e.append(n)}return t.updateEdited({rect:this.getPDFRect(),popup:this._uiManager.hasCommentManager()||this.hasEditedComment?this.comment:{text:this.#t}}),e}resetAnnotationElement(t){super.resetAnnotationElement(t),t.resetEdited()}}class F{static PRECISION=1e-4;toSVGPath(){nt("Abstract method `toSVGPath` must be implemented.")}get box(){nt("Abstract getter `box` must be implemented.")}serialize(t,e){nt("Abstract method `serialize` must be implemented.")}static _rescale(t,e,s,i,n,r){r||=new Float32Array(t.length);for(let a=0,o=t.length;a<o;a+=2)r[a]=e+t[a]*i,r[a+1]=s+t[a+1]*n;return r}static _rescaleAndSwap(t,e,s,i,n,r){r||=new Float32Array(t.length);for(let a=0,o=t.length;a<o;a+=2)r[a]=e+t[a+1]*i,r[a+1]=s+t[a]*n;return r}static _translate(t,e,s,i){i||=new Float32Array(t.length);for(let n=0,r=t.length;n<r;n+=2)i[n]=e+t[n],i[n+1]=s+t[n+1];return i}static svgRound(t){return Math.round(t*1e4)}static _normalizePoint(t,e,s,i,n){switch(n){case 90:return[1-e/s,t/i];case 180:return[1-t/s,1-e/i];case 270:return[e/s,1-t/i];default:return[t/s,e/i]}}static _normalizePagePoint(t,e,s){switch(s){case 90:return[1-e,t];case 180:return[1-t,1-e];case 270:return[e,1-t];default:return[t,e]}}static createBezierPoints(t,e,s,i,n,r){return[(t+5*s)/6,(e+5*i)/6,(5*s+n)/6,(5*i+r)/6,(s+n)/2,(i+r)/2]}}class ne{#t;#e=[];#i;#s;#a=[];#n=new Float32Array(18);#r;#o;#h;#l;#u;#d;#f=[];static#m=8;static#p=2;static#c=ne.#m+ne.#p;constructor({x:t,y:e},s,i,n,r,a=0){this.#t=s,this.#d=n*i,this.#s=r,this.#n.set([NaN,NaN,NaN,NaN,t,e],6),this.#i=a,this.#l=ne.#m*i,this.#h=ne.#c*i,this.#u=i,this.#f.push(t,e)}isEmpty(){return isNaN(this.#n[8])}#g(){const t=this.#n.subarray(4,6),e=this.#n.subarray(16,18),[s,i,n,r]=this.#t;return[(this.#r+(t[0]-e[0])/2-s)/n,(this.#o+(t[1]-e[1])/2-i)/r,(this.#r+(e[0]-t[0])/2-s)/n,(this.#o+(e[1]-t[1])/2-i)/r]}add({x:t,y:e}){this.#r=t,this.#o=e;const[s,i,n,r]=this.#t;let[a,o,l,h]=this.#n.subarray(8,12);const c=t-l,u=e-h,f=Math.hypot(c,u);if(f<this.#h)return!1;const m=f-this.#l,p=m/f,b=p*c,g=p*u;let v=a,y=o;a=l,o=h,l+=b,h+=g,this.#f?.push(t,e);const S=-g/m,A=b/m,w=S*this.#d,_=A*this.#d;return this.#n.set(this.#n.subarray(2,8),0),this.#n.set([l+w,h+_],4),this.#n.set(this.#n.subarray(14,18),12),this.#n.set([l-w,h-_],16),isNaN(this.#n[6])?(this.#a.length===0&&(this.#n.set([a+w,o+_],2),this.#a.push(NaN,NaN,NaN,NaN,(a+w-s)/n,(o+_-i)/r),this.#n.set([a-w,o-_],14),this.#e.push(NaN,NaN,NaN,NaN,(a-w-s)/n,(o-_-i)/r)),this.#n.set([v,y,a,o,l,h],6),!this.isEmpty()):(this.#n.set([v,y,a,o,l,h],6),Math.abs(Math.atan2(y-o,v-a)-Math.atan2(g,b))<Math.PI/2?([a,o,l,h]=this.#n.subarray(2,6),this.#a.push(NaN,NaN,NaN,NaN,((a+l)/2-s)/n,((o+h)/2-i)/r),[a,o,v,y]=this.#n.subarray(14,18),this.#e.push(NaN,NaN,NaN,NaN,((v+a)/2-s)/n,((y+o)/2-i)/r),!0):([v,y,a,o,l,h]=this.#n.subarray(0,6),this.#a.push(((v+5*a)/6-s)/n,((y+5*o)/6-i)/r,((5*a+l)/6-s)/n,((5*o+h)/6-i)/r,((a+l)/2-s)/n,((o+h)/2-i)/r),[l,h,a,o,v,y]=this.#n.subarray(12,18),this.#e.push(((v+5*a)/6-s)/n,((y+5*o)/6-i)/r,((5*a+l)/6-s)/n,((5*o+h)/6-i)/r,((a+l)/2-s)/n,((o+h)/2-i)/r),!0))}toSVGPath(){if(this.isEmpty())return"";const t=this.#a,e=this.#e;if(isNaN(this.#n[6])&&!this.isEmpty())return this.#b();const s=[];s.push(`M${t[4]} ${t[5]}`);for(let i=6;i<t.length;i+=6)isNaN(t[i])?s.push(`L${t[i+4]} ${t[i+5]}`):s.push(`C${t[i]} ${t[i+1]} ${t[i+2]} ${t[i+3]} ${t[i+4]} ${t[i+5]}`);this.#y(s);for(let i=e.length-6;i>=6;i-=6)isNaN(e[i])?s.push(`L${e[i+4]} ${e[i+5]}`):s.push(`C${e[i]} ${e[i+1]} ${e[i+2]} ${e[i+3]} ${e[i+4]} ${e[i+5]}`);return this.#w(s),s.join(" ")}#b(){const[t,e,s,i]=this.#t,[n,r,a,o]=this.#g();return`M${(this.#n[2]-t)/s} ${(this.#n[3]-e)/i} L${(this.#n[4]-t)/s} ${(this.#n[5]-e)/i} L${n} ${r} L${a} ${o} L${(this.#n[16]-t)/s} ${(this.#n[17]-e)/i} L${(this.#n[14]-t)/s} ${(this.#n[15]-e)/i} Z`}#w(t){const e=this.#e;t.push(`L${e[4]} ${e[5]} Z`)}#y(t){const[e,s,i,n]=this.#t,r=this.#n.subarray(4,6),a=this.#n.subarray(16,18),[o,l,h,c]=this.#g();t.push(`L${(r[0]-e)/i} ${(r[1]-s)/n} L${o} ${l} L${h} ${c} L${(a[0]-e)/i} ${(a[1]-s)/n}`)}newFreeDrawOutline(t,e,s,i,n,r){return new fn(t,e,s,i,n,r)}getOutlines(){const t=this.#a,e=this.#e,s=this.#n,[i,n,r,a]=this.#t,o=new Float32Array((this.#f?.length??0)+2);for(let c=0,u=o.length-2;c<u;c+=2)o[c]=(this.#f[c]-i)/r,o[c+1]=(this.#f[c+1]-n)/a;if(o[o.length-2]=(this.#r-i)/r,o[o.length-1]=(this.#o-n)/a,isNaN(s[6])&&!this.isEmpty())return this.#E(o);const l=new Float32Array(this.#a.length+24+this.#e.length);let h=t.length;for(let c=0;c<h;c+=2){if(isNaN(t[c])){l[c]=l[c+1]=NaN;continue}l[c]=t[c],l[c+1]=t[c+1]}h=this.#v(l,h);for(let c=e.length-6;c>=6;c-=6)for(let u=0;u<6;u+=2){if(isNaN(e[c+u])){l[h]=l[h+1]=NaN,h+=2;continue}l[h]=e[c+u],l[h+1]=e[c+u+1],h+=2}return this.#_(l,h),this.newFreeDrawOutline(l,o,this.#t,this.#u,this.#i,this.#s)}#E(t){const e=this.#n,[s,i,n,r]=this.#t,[a,o,l,h]=this.#g(),c=new Float32Array(36);return c.set([NaN,NaN,NaN,NaN,(e[2]-s)/n,(e[3]-i)/r,NaN,NaN,NaN,NaN,(e[4]-s)/n,(e[5]-i)/r,NaN,NaN,NaN,NaN,a,o,NaN,NaN,NaN,NaN,l,h,NaN,NaN,NaN,NaN,(e[16]-s)/n,(e[17]-i)/r,NaN,NaN,NaN,NaN,(e[14]-s)/n,(e[15]-i)/r],0),this.newFreeDrawOutline(c,t,this.#t,this.#u,this.#i,this.#s)}#_(t,e){const s=this.#e;return t.set([NaN,NaN,NaN,NaN,s[4],s[5]],e),e+=6}#v(t,e){const s=this.#n.subarray(4,6),i=this.#n.subarray(16,18),[n,r,a,o]=this.#t,[l,h,c,u]=this.#g();return t.set([NaN,NaN,NaN,NaN,(s[0]-n)/a,(s[1]-r)/o,NaN,NaN,NaN,NaN,l,h,NaN,NaN,NaN,NaN,c,u,NaN,NaN,NaN,NaN,(i[0]-n)/a,(i[1]-r)/o],e),e+=24}}class fn extends F{#t;#e=new Float32Array(4);#i;#s;#a;#n;#r;constructor(t,e,s,i,n,r){super(),this.#r=t,this.#a=e,this.#t=s,this.#n=i,this.#i=n,this.#s=r,this.firstPoint=[NaN,NaN],this.lastPoint=[NaN,NaN],this.#o(r);const[a,o,l,h]=this.#e;for(let c=0,u=t.length;c<u;c+=2)t[c]=(t[c]-a)/l,t[c+1]=(t[c+1]-o)/h;for(let c=0,u=e.length;c<u;c+=2)e[c]=(e[c]-a)/l,e[c+1]=(e[c+1]-o)/h}toSVGPath(){const t=[`M${this.#r[4]} ${this.#r[5]}`];for(let e=6,s=this.#r.length;e<s;e+=6){if(isNaN(this.#r[e])){t.push(`L${this.#r[e+4]} ${this.#r[e+5]}`);continue}t.push(`C${this.#r[e]} ${this.#r[e+1]} ${this.#r[e+2]} ${this.#r[e+3]} ${this.#r[e+4]} ${this.#r[e+5]}`)}return t.push("Z"),t.join(" ")}serialize([t,e,s,i],n){const r=s-t,a=i-e;let o,l;switch(n){case 0:o=F._rescale(this.#r,t,i,r,-a),l=F._rescale(this.#a,t,i,r,-a);break;case 90:o=F._rescaleAndSwap(this.#r,t,e,r,a),l=F._rescaleAndSwap(this.#a,t,e,r,a);break;case 180:o=F._rescale(this.#r,s,e,-r,a),l=F._rescale(this.#a,s,e,-r,a);break;case 270:o=F._rescaleAndSwap(this.#r,s,i,-r,-a),l=F._rescaleAndSwap(this.#a,s,i,-r,-a);break}return{outline:Array.from(o),points:[Array.from(l)]}}#o(t){const e=this.#r;let s=e[4],i=e[5];const n=[s,i,s,i];let r=s,a=i,o=s,l=i;const h=t?Math.max:Math.min,c=new Float32Array(4);for(let f=6,m=e.length;f<m;f+=6){const p=e[f+4],b=e[f+5];isNaN(e[f])?(B.pointBoundingBox(p,b,n),a>b?(r=p,a=b):a===b&&(r=h(r,p)),l<b?(o=p,l=b):l===b&&(o=h(o,p))):(c[0]=c[1]=1/0,c[2]=c[3]=-1/0,B.bezierBoundingBox(s,i,...e.slice(f,f+6),c),B.rectBoundingBox(c[0],c[1],c[2],c[3],n),a>c[1]?(r=c[0],a=c[1]):a===c[1]&&(r=h(r,c[0])),l<c[3]?(o=c[2],l=c[3]):l===c[3]&&(o=h(o,c[2]))),s=p,i=b}const u=this.#e;u[0]=n[0]-this.#i,u[1]=n[1]-this.#i,u[2]=n[2]-n[0]+2*this.#i,u[3]=n[3]-n[1]+2*this.#i,this.firstPoint=[r,a],this.lastPoint=[o,l]}get box(){return this.#e}newOutliner(t,e,s,i,n,r=0){return new ne(t,e,s,i,n,r)}getNewOutline(t,e){const[s,i,n,r]=this.#e,[a,o,l,h]=this.#t,c=n*l,u=r*h,f=s*l+a,m=i*h+o,p=this.newOutliner({x:this.#a[0]*c+f,y:this.#a[1]*u+m},this.#t,this.#n,t,this.#s,e??this.#i);for(let b=2;b<this.#a.length;b+=2)p.add({x:this.#a[b]*c+f,y:this.#a[b+1]*u+m});return p.getOutlines()}}class Fs{#t;#e;#i;#s=[];#a=[];constructor(t,e=0,s=0,i=!0){const n=[1/0,1/0,-1/0,-1/0],r=10**-4;for(const{x:p,y:b,width:g,height:v}of t){const y=Math.floor((p-e)/r)*r,S=Math.ceil((p+g+e)/r)*r,A=Math.floor((b-e)/r)*r,w=Math.ceil((b+v+e)/r)*r,_=[y,A,w,!0],x=[S,A,w,!1];this.#s.push(_,x),B.rectBoundingBox(y,A,S,w,n)}const a=n[2]-n[0]+2*s,o=n[3]-n[1]+2*s,l=n[0]-s,h=n[1]-s;let c=i?-1/0:1/0,u=1/0;const f=this.#s.at(i?-1:-2),m=[f[0],f[2]];for(const p of this.#s){const[b,g,v,y]=p;!y&&i?g<u?(u=g,c=b):g===u&&(c=Math.max(c,b)):y&&!i&&(g<u?(u=g,c=b):g===u&&(c=Math.min(c,b))),p[0]=(b-l)/a,p[1]=(g-h)/o,p[2]=(v-h)/o}this.#t=new Float32Array([l,h,a,o]),this.#e=[c,u],this.#i=m}getOutlines(){this.#s.sort((e,s)=>e[0]-s[0]||e[1]-s[1]||e[2]-s[2]);const t=[];for(const e of this.#s)e[3]?(t.push(...this.#l(e)),this.#o(e)):(this.#h(e),t.push(...this.#l(e)));return this.#n(t)}#n(t){const e=[],s=new Set;for(const r of t){const[a,o,l]=r;e.push([a,o,r],[a,l,r])}e.sort((r,a)=>r[1]-a[1]||r[0]-a[0]);for(let r=0,a=e.length;r<a;r+=2){const o=e[r][2],l=e[r+1][2];o.push(l),l.push(o),s.add(o),s.add(l)}const i=[];let n;for(;s.size>0;){const r=s.values().next().value;let[a,o,l,h,c]=r;s.delete(r);let u=a,f=o;for(n=[a,l],i.push(n);;){let m;if(s.has(h))m=h;else if(s.has(c))m=c;else break;s.delete(m),[a,o,l,h,c]=m,u!==a&&(n.push(u,f,a,f===o?o:l),u=a),f=f===o?l:o}n.push(u,f)}return new ma(i,this.#t,this.#e,this.#i)}#r(t){const e=this.#a;let s=0,i=e.length-1;for(;s<=i;){const n=s+i>>1,r=e[n][0];if(r===t)return n;r<t?s=n+1:i=n-1}return i+1}#o([,t,e]){const s=this.#r(t);this.#a.splice(s,0,[t,e])}#h([,t,e]){const s=this.#r(t);for(let i=s;i<this.#a.length;i++){const[n,r]=this.#a[i];if(n!==t)break;if(n===t&&r===e){this.#a.splice(i,1);return}}for(let i=s-1;i>=0;i--){const[n,r]=this.#a[i];if(n!==t)break;if(n===t&&r===e){this.#a.splice(i,1);return}}}#l(t){const[e,s,i]=t,n=[[e,s,i]],r=this.#r(i);for(let a=0;a<r;a++){const[o,l]=this.#a[a];for(let h=0,c=n.length;h<c;h++){const[,u,f]=n[h];if(!(l<=u||f<=o)){if(u>=o){if(f>l)n[h][1]=l;else{if(c===1)return[];n.splice(h,1),h--,c--}continue}n[h][2]=o,f>l&&n.push([e,l,f])}}}return n}}class ma extends F{#t;#e;constructor(t,e,s,i){super(),this.#e=t,this.#t=e,this.firstPoint=s,this.lastPoint=i}toSVGPath(){const t=[];for(const e of this.#e){let[s,i]=e;t.push(`M${s} ${i}`);for(let n=2;n<e.length;n+=2){const r=e[n],a=e[n+1];r===s?(t.push(`V${a}`),i=a):a===i&&(t.push(`H${r}`),s=r)}t.push("Z")}return t.join(" ")}serialize([t,e,s,i],n){const r=[],a=s-t,o=i-e;for(const l of this.#e){const h=new Array(l.length);for(let c=0;c<l.length;c+=2)h[c]=t+l[c]*a,h[c+1]=i-l[c+1]*o;r.push(h)}return r}get box(){return this.#t}get classNamesForOutlining(){return["highlightOutline"]}}class Os extends ne{newFreeDrawOutline(t,e,s,i,n,r){return new ba(t,e,s,i,n,r)}}class ba extends fn{newOutliner(t,e,s,i,n,r=0){return new Os(t,e,s,i,n,r)}}class ut extends j{#t=null;#e=0;#i;#s=null;#a=null;#n=null;#r=null;#o=0;#h=null;#l=null;#u=null;#d=!1;#f=null;#m=null;#p=null;#c="";#g;#b="";static _defaultColor=null;static _defaultOpacity=1;static _defaultThickness=12;static _type="highlight";static _editorType=V.HIGHLIGHT;static _freeHighlightId=-1;static _freeHighlight=null;static _freeHighlightClipId="";static get _keyboardManager(){const t=ut.prototype;return W(this,"_keyboardManager",new ze([[["ArrowLeft","mac+ArrowLeft"],t._moveCaret,{args:[0]}],[["ArrowRight","mac+ArrowRight"],t._moveCaret,{args:[1]}],[["ArrowUp","mac+ArrowUp"],t._moveCaret,{args:[2]}],[["ArrowDown","mac+ArrowDown"],t._moveCaret,{args:[3]}]]))}constructor(t){super({...t,name:"highlightEditor"}),this.color=t.color||ut._defaultColor,this.#g=t.thickness||ut._defaultThickness,this.opacity=t.opacity||ut._defaultOpacity,this.#i=t.boxes||null,this.#b=t.methodOfCreation||"",this.#c=t.text||"",this._isDraggable=!1,this.defaultL10nId="pdfjs-editor-highlight-editor",t.highlightId>-1?(this.#d=!0,this.#y(t),this.#x()):this.#i&&(this.#t=t.anchorNode,this.#e=t.anchorOffset,this.#r=t.focusNode,this.#o=t.focusOffset,this.#w(),this.#x(),this.rotate(this.rotation)),this.annotationElementId||this._uiManager.a11yAlert("pdfjs-editor-highlight-added-alert")}get telemetryInitialData(){return{action:"added",type:this.#d?"free_highlight":"highlight",color:this._uiManager.getNonHCMColorName(this.color),thickness:this.#g,methodOfCreation:this.#b}}get telemetryFinalData(){return{type:"highlight",color:this._uiManager.getNonHCMColorName(this.color)}}static computeTelemetryFinalData(t){return{numberOfColors:t.get("color").size}}#w(){const t=new Fs(this.#i,.001);this.#l=t.getOutlines(),[this.x,this.y,this.width,this.height]=this.#l.box;const e=new Fs(this.#i,.0025,.001,this._uiManager.direction==="ltr");this.#n=e.getOutlines();const{firstPoint:s}=this.#l;this.#f=[(s[0]-this.x)/this.width,(s[1]-this.y)/this.height];const{lastPoint:i}=this.#n;this.#m=[(i[0]-this.x)/this.width,(i[1]-this.y)/this.height]}#y({highlightOutlines:t,highlightId:e,clipPathId:s}){this.#l=t;const i=1.5;if(this.#n=t.getNewOutline(this.#g/2+i,.0025),e>=0)this.#u=e,this.#s=s,this.parent.drawLayer.finalizeDraw(e,{bbox:t.box,path:{d:t.toSVGPath()}}),this.#p=this.parent.drawLayer.drawOutline({rootClass:{highlightOutline:!0,free:!0},bbox:this.#n.box,path:{d:this.#n.toSVGPath()}},!0);else if(this.parent){const c=this.parent.viewport.rotation;this.parent.drawLayer.updateProperties(this.#u,{bbox:ut.#S(this.#l.box,(c-this.rotation+360)%360),path:{d:t.toSVGPath()}}),this.parent.drawLayer.updateProperties(this.#p,{bbox:ut.#S(this.#n.box,c),path:{d:this.#n.toSVGPath()}})}const[n,r,a,o]=t.box;switch(this.rotation){case 0:this.x=n,this.y=r,this.width=a,this.height=o;break;case 90:{const[c,u]=this.parentDimensions;this.x=r,this.y=1-n,this.width=a*u/c,this.height=o*c/u;break}case 180:this.x=1-n,this.y=1-r,this.width=a,this.height=o;break;case 270:{const[c,u]=this.parentDimensions;this.x=1-r,this.y=n,this.width=a*u/c,this.height=o*c/u;break}}const{firstPoint:l}=t;this.#f=[(l[0]-n)/a,(l[1]-r)/o];const{lastPoint:h}=this.#n;this.#m=[(h[0]-n)/a,(h[1]-r)/o]}static initialize(t,e){j.initialize(t,e),ut._defaultColor||=e.highlightColors?.values().next().value||"#fff066"}static updateDefaultParams(t,e){switch(t){case K.HIGHLIGHT_COLOR:ut._defaultColor=e;break;case K.HIGHLIGHT_THICKNESS:ut._defaultThickness=e;break}}translateInPage(t,e){}get toolbarPosition(){return this.#m}get commentButtonPosition(){return this.#f}updateParams(t,e){switch(t){case K.HIGHLIGHT_COLOR:this.#E(e);break;case K.HIGHLIGHT_THICKNESS:this.#_(e);break}}static get defaultPropertiesToUpdate(){return[[K.HIGHLIGHT_COLOR,ut._defaultColor],[K.HIGHLIGHT_THICKNESS,ut._defaultThickness]]}get propertiesToUpdate(){return[[K.HIGHLIGHT_COLOR,this.color||ut._defaultColor],[K.HIGHLIGHT_THICKNESS,this.#g||ut._defaultThickness],[K.HIGHLIGHT_FREE,this.#d]]}onUpdatedColor(){this.parent?.drawLayer.updateProperties(this.#u,{root:{fill:this.color,"fill-opacity":this.opacity}}),this.#a?.updateColor(this.color),super.onUpdatedColor()}#E(t){const e=(n,r)=>{this.color=n,this.opacity=r,this.onUpdatedColor()},s=this.color,i=this.opacity;this.addCommands({cmd:e.bind(this,t,ut._defaultOpacity),undo:e.bind(this,s,i),post:this._uiManager.updateUI.bind(this._uiManager,this),mustExec:!0,type:K.HIGHLIGHT_COLOR,overwriteIfSameType:!0,keepUndo:!0}),this._reportTelemetry({action:"color_changed",color:this._uiManager.getNonHCMColorName(t)},!0)}#_(t){const e=this.#g,s=i=>{this.#g=i,this.#v(i)};this.addCommands({cmd:s.bind(this,t),undo:s.bind(this,e),post:this._uiManager.updateUI.bind(this._uiManager,this),mustExec:!0,type:K.INK_THICKNESS,overwriteIfSameType:!0,keepUndo:!0}),this._reportTelemetry({action:"thickness_changed",thickness:t},!0)}get toolbarButtons(){return this._uiManager.highlightColors?[["colorPicker",this.#a=new Bt({editor:this})]]:super.toolbarButtons}disableEditing(){super.disableEditing(),this.div.classList.toggle("disabled",!0)}enableEditing(){super.enableEditing(),this.div.classList.toggle("disabled",!1)}fixAndSetPosition(){return super.fixAndSetPosition(this.#P())}getBaseTranslation(){return[0,0]}getRect(t,e){return super.getRect(t,e,this.#P())}onceAdded(t){this.annotationElementId||this.parent.addUndoableEditor(this),t&&this.div.focus()}remove(){this.#T(),this._reportTelemetry({action:"deleted"}),super.remove()}rebuild(){this.parent&&(super.rebuild(),this.div!==null&&(this.#x(),this.isAttachedToDOM||this.parent.add(this)))}setParent(t){let e=!1;this.parent&&!t?this.#T():t&&(this.#x(t),e=!this.parent&&this.div?.classList.contains("selectedEditor")),super.setParent(t),this.show(this._isVisible),e&&this.select()}#v(t){this.#d&&(this.#y({highlightOutlines:this.#l.getNewOutline(t/2)}),this.fixAndSetPosition(),this.setDims(this.width,this.height))}#T(){this.#u===null||!this.parent||(this.parent.drawLayer.remove(this.#u),this.#u=null,this.parent.drawLayer.remove(this.#p),this.#p=null)}#x(t=this.parent){this.#u===null&&({id:this.#u,clipPathId:this.#s}=t.drawLayer.draw({bbox:this.#l.box,root:{viewBox:"0 0 1 1",fill:this.color,"fill-opacity":this.opacity},rootClass:{highlight:!0,free:this.#d},path:{d:this.#l.toSVGPath()}},!1,!0),this.#p=t.drawLayer.drawOutline({rootClass:{highlightOutline:!0,free:this.#d},bbox:this.#n.box,path:{d:this.#n.toSVGPath()}},this.#d),this.#h&&(this.#h.style.clipPath=this.#s))}static#S([t,e,s,i],n){switch(n){case 90:return[1-e-i,t,i,s];case 180:return[1-t-s,1-e-i,s,i];case 270:return[e,1-t-s,i,s]}return[t,e,s,i]}rotate(t){const{drawLayer:e}=this.parent;let s;this.#d?(t=(t-this.rotation+360)%360,s=ut.#S(this.#l.box,t)):s=ut.#S([this.x,this.y,this.width,this.height],t),e.updateProperties(this.#u,{bbox:s,root:{"data-main-rotation":t}}),e.updateProperties(this.#p,{bbox:ut.#S(this.#n.box,t),root:{"data-main-rotation":t}})}render(){if(this.div)return this.div;const t=super.render();this.#c&&(t.setAttribute("aria-label",this.#c),t.setAttribute("role","mark")),this.#d?t.classList.add("free"):this.div.addEventListener("keydown",this.#M.bind(this),{signal:this._uiManager._signal});const e=this.#h=document.createElement("div");return t.append(e),e.setAttribute("aria-hidden","true"),e.className="internal",e.style.clipPath=this.#s,this.setDims(this.width,this.height),zi(this,this.#h,["pointerover","pointerleave"]),this.enableEditing(),t}pointerover(){this.isSelected||this.parent?.drawLayer.updateProperties(this.#p,{rootClass:{hovered:!0}})}pointerleave(){this.isSelected||this.parent?.drawLayer.updateProperties(this.#p,{rootClass:{hovered:!1}})}#M(t){ut._keyboardManager.exec(this,t)}_moveCaret(t){switch(this.parent.unselect(this),t){case 0:case 2:this.#k(!0);break;case 1:case 3:this.#k(!1);break}}#k(t){if(!this.#t)return;const e=window.getSelection();t?e.setPosition(this.#t,this.#e):e.setPosition(this.#r,this.#o)}select(){super.select(),this.#p&&this.parent?.drawLayer.updateProperties(this.#p,{rootClass:{hovered:!1,selected:!0}})}unselect(){super.unselect(),this.#p&&(this.parent?.drawLayer.updateProperties(this.#p,{rootClass:{selected:!1}}),this.#d||this.#k(!1))}get _mustFixPosition(){return!this.#d}show(t=this._isVisible){super.show(t),this.parent&&(this.parent.drawLayer.updateProperties(this.#u,{rootClass:{hidden:!t}}),this.parent.drawLayer.updateProperties(this.#p,{rootClass:{hidden:!t}}))}#P(){return this.#d?this.rotation:0}#O(){if(this.#d)return null;const[t,e]=this.pageDimensions,[s,i]=this.pageTranslation,n=this.#i,r=new Float32Array(n.length*8);let a=0;for(const{x:o,y:l,width:h,height:c}of n){const u=o*t+s,f=(1-l)*e+i;r[a]=r[a+4]=u,r[a+1]=r[a+3]=f,r[a+2]=r[a+6]=u+h*t,r[a+5]=r[a+7]=f-c*e,a+=8}return r}#L(t){return this.#l.serialize(t,this.#P())}static startHighlighting(t,e,{target:s,x:i,y:n}){const{x:r,y:a,width:o,height:l}=s.getBoundingClientRect(),h=new AbortController,c=t.combinedSignal(h),u=f=>{h.abort(),this.#B(t,f)};window.addEventListener("blur",u,{signal:c}),window.addEventListener("pointerup",u,{signal:c}),window.addEventListener("pointerdown",ht,{capture:!0,passive:!1,signal:c}),window.addEventListener("contextmenu",jt,{signal:c}),s.addEventListener("pointermove",this.#I.bind(this,t),{signal:c}),this._freeHighlight=new Os({x:i,y:n},[r,a,o,l],t.scale,this._defaultThickness/2,e,.001),{id:this._freeHighlightId,clipPathId:this._freeHighlightClipId}=t.drawLayer.draw({bbox:[0,0,1,1],root:{viewBox:"0 0 1 1",fill:this._defaultColor,"fill-opacity":this._defaultOpacity},rootClass:{highlight:!0,free:!0},path:{d:this._freeHighlight.toSVGPath()}},!0,!0)}static#I(t,e){this._freeHighlight.add(e)&&t.drawLayer.updateProperties(this._freeHighlightId,{path:{d:this._freeHighlight.toSVGPath()}})}static#B(t,e){this._freeHighlight.isEmpty()?t.drawLayer.remove(this._freeHighlightId):t.createAndAddNewEditor(e,!1,{highlightId:this._freeHighlightId,highlightOutlines:this._freeHighlight.getOutlines(),clipPathId:this._freeHighlightClipId,methodOfCreation:"main_toolbar"}),this._freeHighlightId=-1,this._freeHighlight=null,this._freeHighlightClipId=""}static async deserialize(t,e,s){let i=null;if(t instanceof dn){const{data:{quadPoints:m,rect:p,rotation:b,id:g,color:v,opacity:y,popupRef:S,richText:A,contentsObj:w,creationDate:_,modificationDate:x},parent:{page:{pageNumber:E}}}=t;i=t={annotationType:V.HIGHLIGHT,color:Array.from(v),opacity:y,quadPoints:m,boxes:null,pageIndex:E-1,rect:p.slice(0),rotation:b,annotationElementId:g,id:g,deleted:!1,popupRef:S,richText:A,comment:w?.str||null,creationDate:_,modificationDate:x}}else if(t instanceof Ks){const{data:{inkLists:m,rect:p,rotation:b,id:g,color:v,borderStyle:{rawWidth:y},popupRef:S,richText:A,contentsObj:w,creationDate:_,modificationDate:x},parent:{page:{pageNumber:E}}}=t;i=t={annotationType:V.HIGHLIGHT,color:Array.from(v),thickness:y,inkLists:m,boxes:null,pageIndex:E-1,rect:p.slice(0),rotation:b,annotationElementId:g,id:g,deleted:!1,popupRef:S,richText:A,comment:w?.str||null,creationDate:_,modificationDate:x}}const{color:n,quadPoints:r,inkLists:a,opacity:o}=t,l=await super.deserialize(t,e,s);l.color=B.makeHexColor(...n),l.opacity=o||1,a&&(l.#g=t.thickness),l._initialData=i,t.comment&&l.setCommentData(t);const[h,c]=l.pageDimensions,[u,f]=l.pageTranslation;if(r){const m=l.#i=[];for(let p=0;p<r.length;p+=8)m.push({x:(r[p]-u)/h,y:1-(r[p+1]-f)/c,width:(r[p+2]-r[p])/h,height:(r[p+1]-r[p+5])/c});l.#w(),l.#x(),l.rotate(l.rotation)}else if(a){l.#d=!0;const m=a[0],p={x:m[0]-u,y:c-(m[1]-f)},b=new Os(p,[0,0,h,c],1,l.#g/2,!0,.001);for(let y=0,S=m.length;y<S;y+=2)p.x=m[y]-u,p.y=c-(m[y+1]-f),b.add(p);const{id:g,clipPathId:v}=e.drawLayer.draw({bbox:[0,0,1,1],root:{viewBox:"0 0 1 1",fill:l.color,"fill-opacity":l._defaultOpacity},rootClass:{highlight:!0,free:!0},path:{d:b.toSVGPath()}},!0,!0);l.#y({highlightOutlines:b.getOutlines(),highlightId:g,clipPathId:v}),l.#x(),l.rotate(l.parentRotation)}return l}serialize(t=!1){if(this.isEmpty()||t)return null;if(this.deleted)return this.serializeDeleted();const e=j._colorManager.convert(this._uiManager.getNonHCMColor(this.color)),s=super.serialize(t);return Object.assign(s,{color:e,opacity:this.opacity,thickness:this.#g,quadPoints:this.#O(),outlines:this.#L(s.rect)}),this.addComment(s),this.annotationElementId&&!this.#N(s)?null:(s.id=this.annotationElementId,s)}#N(t){const{color:e}=this._initialData;return this.hasEditedComment||t.color.some((s,i)=>s!==e[i])}renderAnnotationElement(t){return this.deleted?(t.hide(),null):(t.updateEdited({rect:this.getPDFRect(),popup:this.comment}),null)}static canCreateNewEmptyEditor(){return!1}}class pn{#t=Object.create(null);updateProperty(t,e){this[t]=e,this.updateSVGProperty(t,e)}updateProperties(t){if(t)for(const[e,s]of Object.entries(t))e.startsWith("_")||this.updateProperty(e,s)}updateSVGProperty(t,e){this.#t[t]=e}toSVGProperties(){const t=this.#t;return this.#t=Object.create(null),{root:t}}reset(){this.#t=Object.create(null)}updateAll(t=this){this.updateProperties(t)}clone(){nt("Not implemented")}}class U extends j{#t=null;#e;_colorPicker=null;_drawId=null;static _currentDrawId=-1;static _currentParent=null;static#i=null;static#s=null;static#a=null;static#n=NaN;static#r=null;static#o=null;static#h=NaN;static _INNER_MARGIN=3;constructor(t){super(t),this.#e=t.mustBeCommitted||!1,this._addOutlines(t)}onUpdatedColor(){this._colorPicker?.update(this.color),super.onUpdatedColor()}_addOutlines(t){t.drawOutlines&&(this.#l(t),this.#f())}#l({drawOutlines:t,drawId:e,drawingOptions:s}){this.#t=t,this._drawingOptions||=s,this.annotationElementId||this._uiManager.a11yAlert(`pdfjs-editor-${this.editorType}-added-alert`),e>=0?(this._drawId=e,this.parent.drawLayer.finalizeDraw(e,t.defaultProperties)):this._drawId=this.#u(t,this.parent),this.#c(t.box)}#u(t,e){const{id:s}=e.drawLayer.draw(U._mergeSVGProperties(this._drawingOptions.toSVGProperties(),t.defaultSVGProperties),!1,!1);return s}static _mergeSVGProperties(t,e){const s=new Set(Object.keys(t));for(const[i,n]of Object.entries(e))s.has(i)?Object.assign(t[i],n):t[i]=n;return t}static getDefaultDrawingOptions(t){nt("Not implemented")}static get typesMap(){nt("Not implemented")}static get isDrawer(){return!0}static get supportMultipleDrawings(){return!1}static updateDefaultParams(t,e){const s=this.typesMap.get(t);s&&this._defaultDrawingOptions.updateProperty(s,e),this._currentParent&&(U.#i.updateProperty(s,e),this._currentParent.drawLayer.updateProperties(this._currentDrawId,this._defaultDrawingOptions.toSVGProperties()))}updateParams(t,e){const s=this.constructor.typesMap.get(t);s&&this._updateProperty(t,s,e)}static get defaultPropertiesToUpdate(){const t=[],e=this._defaultDrawingOptions;for(const[s,i]of this.typesMap)t.push([s,e[i]]);return t}get propertiesToUpdate(){const t=[],{_drawingOptions:e}=this;for(const[s,i]of this.constructor.typesMap)t.push([s,e[i]]);return t}_updateProperty(t,e,s){const i=this._drawingOptions,n=i[e],r=a=>{i.updateProperty(e,a);const o=this.#t.updateProperty(e,a);o&&this.#c(o),this.parent?.drawLayer.updateProperties(this._drawId,i.toSVGProperties()),t===this.colorType&&this.onUpdatedColor()};this.addCommands({cmd:r.bind(this,s),undo:r.bind(this,n),post:this._uiManager.updateUI.bind(this._uiManager,this),mustExec:!0,type:t,overwriteIfSameType:!0,keepUndo:!0})}_onResizing(){this.parent?.drawLayer.updateProperties(this._drawId,U._mergeSVGProperties(this.#t.getPathResizingSVGProperties(this.#p()),{bbox:this.#g()}))}_onResized(){this.parent?.drawLayer.updateProperties(this._drawId,U._mergeSVGProperties(this.#t.getPathResizedSVGProperties(this.#p()),{bbox:this.#g()}))}_onTranslating(t,e){this.parent?.drawLayer.updateProperties(this._drawId,{bbox:this.#g()})}_onTranslated(){this.parent?.drawLayer.updateProperties(this._drawId,U._mergeSVGProperties(this.#t.getPathTranslatedSVGProperties(this.#p(),this.parentDimensions),{bbox:this.#g()}))}_onStartDragging(){this.parent?.drawLayer.updateProperties(this._drawId,{rootClass:{moving:!0}})}_onStopDragging(){this.parent?.drawLayer.updateProperties(this._drawId,{rootClass:{moving:!1}})}commit(){super.commit(),this.disableEditMode(),this.disableEditing()}disableEditing(){super.disableEditing(),this.div.classList.toggle("disabled",!0)}enableEditing(){super.enableEditing(),this.div.classList.toggle("disabled",!1)}getBaseTranslation(){return[0,0]}get isResizable(){return!0}onceAdded(t){this.annotationElementId||this.parent.addUndoableEditor(this),this._isDraggable=!0,this.#e&&(this.#e=!1,this.commit(),this.parent.setSelected(this),t&&this.isOnScreen&&this.div.focus())}remove(){this.#d(),super.remove()}rebuild(){this.parent&&(super.rebuild(),this.div!==null&&(this.#f(),this.#c(this.#t.box),this.isAttachedToDOM||this.parent.add(this)))}setParent(t){let e=!1;this.parent&&!t?(this._uiManager.removeShouldRescale(this),this.#d()):t&&(this._uiManager.addShouldRescale(this),this.#f(t),e=!this.parent&&this.div?.classList.contains("selectedEditor")),super.setParent(t),e&&this.select()}#d(){this._drawId===null||!this.parent||(this.parent.drawLayer.remove(this._drawId),this._drawId=null,this._drawingOptions.reset())}#f(t=this.parent){if(!(this._drawId!==null&&this.parent===t)){if(this._drawId!==null){this.parent.drawLayer.updateParent(this._drawId,t.drawLayer);return}this._drawingOptions.updateAll(),this._drawId=this.#u(this.#t,t)}}#m([t,e,s,i]){const{parentDimensions:[n,r],rotation:a}=this;switch(a){case 90:return[e,1-t,s*(r/n),i*(n/r)];case 180:return[1-t,1-e,s,i];case 270:return[1-e,t,s*(r/n),i*(n/r)];default:return[t,e,s,i]}}#p(){const{x:t,y:e,width:s,height:i,parentDimensions:[n,r],rotation:a}=this;switch(a){case 90:return[1-e,t,s*(n/r),i*(r/n)];case 180:return[1-t,1-e,s,i];case 270:return[e,1-t,s*(n/r),i*(r/n)];default:return[t,e,s,i]}}#c(t){[this.x,this.y,this.width,this.height]=this.#m(t),this.div&&(this.fixAndSetPosition(),this.setDims()),this._onResized()}#g(){const{x:t,y:e,width:s,height:i,rotation:n,parentRotation:r,parentDimensions:[a,o]}=this;switch((n*4+r)/90){case 1:return[1-e-i,t,i,s];case 2:return[1-t-s,1-e-i,s,i];case 3:return[e,1-t-s,i,s];case 4:return[t,e-s*(a/o),i*(o/a),s*(a/o)];case 5:return[1-e,t,s*(a/o),i*(o/a)];case 6:return[1-t-i*(o/a),1-e,i*(o/a),s*(a/o)];case 7:return[e-s*(a/o),1-t-i*(o/a),s*(a/o),i*(o/a)];case 8:return[t-s,e-i,s,i];case 9:return[1-e,t-s,i,s];case 10:return[1-t,1-e,s,i];case 11:return[e-i,1-t,i,s];case 12:return[t-i*(o/a),e,i*(o/a),s*(a/o)];case 13:return[1-e-s*(a/o),t-i*(o/a),s*(a/o),i*(o/a)];case 14:return[1-t,1-e-s*(a/o),i*(o/a),s*(a/o)];case 15:return[e,1-t,s*(a/o),i*(o/a)];default:return[t,e,s,i]}}rotate(){this.parent&&this.parent.drawLayer.updateProperties(this._drawId,U._mergeSVGProperties({bbox:this.#g()},this.#t.updateRotation((this.parentRotation-this.rotation+360)%360)))}onScaleChanging(){this.parent&&this.#c(this.#t.updateParentDimensions(this.parentDimensions,this.parent.scale))}static onScaleChangingWhenDrawing(){}render(){if(this.div)return this.div;let t,e;this._isCopy&&(t=this.x,e=this.y);const s=super.render();s.classList.add("draw");const i=document.createElement("div");return s.append(i),i.setAttribute("aria-hidden","true"),i.className="internal",this.setDims(),this._uiManager.addShouldRescale(this),this.disableEditing(),this._isCopy&&this._moveAfterPaste(t,e),s}static createDrawerInstance(t,e,s,i,n){nt("Not implemented")}static startDrawing(t,e,s,i){const{target:n,offsetX:r,offsetY:a,pointerId:o,pointerType:l}=i;if(U.#r&&U.#r!==l)return;const{viewport:{rotation:h}}=t,{width:c,height:u}=n.getBoundingClientRect(),f=U.#s=new AbortController,m=t.combinedSignal(f);if(U.#n||=o,U.#r??=l,window.addEventListener("pointerup",p=>{U.#n===p.pointerId?this._endDraw(p):U.#o?.delete(p.pointerId)},{signal:m}),window.addEventListener("pointercancel",p=>{U.#n===p.pointerId?this._currentParent.endDrawingSession():U.#o?.delete(p.pointerId)},{signal:m}),window.addEventListener("pointerdown",p=>{U.#r===p.pointerType&&((U.#o||=new Set).add(p.pointerId),U.#i.isCancellable()&&(U.#i.removeLastElement(),U.#i.isEmpty()?this._currentParent.endDrawingSession(!0):this._endDraw(null)))},{capture:!0,passive:!1,signal:m}),window.addEventListener("contextmenu",jt,{signal:m}),n.addEventListener("pointermove",this._drawMove.bind(this),{signal:m}),n.addEventListener("touchmove",p=>{p.timeStamp===U.#h&&ht(p)},{signal:m}),t.toggleDrawing(),e._editorUndoBar?.hide(),U.#i){t.drawLayer.updateProperties(this._currentDrawId,U.#i.startNew(r,a,c,u,h));return}e.updateUIForDefaultProperties(this),U.#i=this.createDrawerInstance(r,a,c,u,h),U.#a=this.getDefaultDrawingOptions(),this._currentParent=t,{id:this._currentDrawId}=t.drawLayer.draw(this._mergeSVGProperties(U.#a.toSVGProperties(),U.#i.defaultSVGProperties),!0,!1)}static _drawMove(t){if(U.#h=-1,!U.#i)return;const{offsetX:e,offsetY:s,pointerId:i}=t;if(U.#n===i){if(U.#o?.size>=1){this._endDraw(t);return}this._currentParent.drawLayer.updateProperties(this._currentDrawId,U.#i.add(e,s)),U.#h=t.timeStamp,ht(t)}}static _cleanup(t){t&&(this._currentDrawId=-1,this._currentParent=null,U.#i=null,U.#a=null,U.#r=null,U.#h=NaN),U.#s&&(U.#s.abort(),U.#s=null,U.#n=NaN,U.#o=null)}static _endDraw(t){const e=this._currentParent;if(e){if(e.toggleDrawing(!0),this._cleanup(!1),t?.target===e.div&&e.drawLayer.updateProperties(this._currentDrawId,U.#i.end(t.offsetX,t.offsetY)),this.supportMultipleDrawings){const s=U.#i,i=this._currentDrawId,n=s.getLastElement();e.addCommands({cmd:()=>{e.drawLayer.updateProperties(i,s.setLastElement(n))},undo:()=>{e.drawLayer.updateProperties(i,s.removeLastElement())},mustExec:!1,type:K.DRAW_STEP});return}this.endDrawing(!1)}}static endDrawing(t){const e=this._currentParent;if(!e)return null;if(e.toggleDrawing(!0),e.cleanUndoStack(K.DRAW_STEP),!U.#i.isEmpty()){const{pageDimensions:[s,i],scale:n}=e,r=e.createAndAddNewEditor({offsetX:0,offsetY:0},!1,{drawId:this._currentDrawId,drawOutlines:U.#i.getOutlines(s*n,i*n,n,this._INNER_MARGIN),drawingOptions:U.#a,mustBeCommitted:!t});return this._cleanup(!0),r}return e.drawLayer.remove(this._currentDrawId),this._cleanup(!0),null}createDrawingOptions(t){}static deserializeDraw(t,e,s,i,n,r){nt("Not implemented")}static async deserialize(t,e,s){const{rawDims:{pageWidth:i,pageHeight:n,pageX:r,pageY:a}}=e.viewport,o=this.deserializeDraw(r,a,i,n,this._INNER_MARGIN,t),l=await super.deserialize(t,e,s);return l.createDrawingOptions(t),l.#l({drawOutlines:o}),l.#f(),l.onScaleChanging(),l.rotate(),l}serializeDraw(t){const[e,s]=this.pageTranslation,[i,n]=this.pageDimensions;return this.#t.serialize([e,s,i,n],t)}renderAnnotationElement(t){return t.updateEdited({rect:this.getPDFRect()}),null}static canCreateNewEmptyEditor(){return!1}}class ya{#t=new Float64Array(6);#e;#i;#s;#a;#n;#r="";#o=0;#h=new Ge;#l;#u;constructor(t,e,s,i,n,r){this.#l=s,this.#u=i,this.#s=n,this.#a=r,[t,e]=this.#d(t,e);const a=this.#e=[NaN,NaN,NaN,NaN,t,e];this.#n=[t,e],this.#i=[{line:a,points:this.#n}],this.#t.set(a,0)}updateProperty(t,e){t==="stroke-width"&&(this.#a=e)}#d(t,e){return F._normalizePoint(t,e,this.#l,this.#u,this.#s)}isEmpty(){return!this.#i||this.#i.length===0}isCancellable(){return this.#n.length<=10}add(t,e){[t,e]=this.#d(t,e);const[s,i,n,r]=this.#t.subarray(2,6),a=t-n,o=e-r;return Math.hypot(this.#l*a,this.#u*o)<=2?null:(this.#n.push(t,e),isNaN(s)?(this.#t.set([n,r,t,e],2),this.#e.push(NaN,NaN,NaN,NaN,t,e),{path:{d:this.toSVGPath()}}):(isNaN(this.#t[0])&&this.#e.splice(6,6),this.#t.set([s,i,n,r,t,e],0),this.#e.push(...F.createBezierPoints(s,i,n,r,t,e)),{path:{d:this.toSVGPath()}}))}end(t,e){const s=this.add(t,e);return s||(this.#n.length===2?{path:{d:this.toSVGPath()}}:null)}startNew(t,e,s,i,n){this.#l=s,this.#u=i,this.#s=n,[t,e]=this.#d(t,e);const r=this.#e=[NaN,NaN,NaN,NaN,t,e];this.#n=[t,e];const a=this.#i.at(-1);return a&&(a.line=new Float32Array(a.line),a.points=new Float32Array(a.points)),this.#i.push({line:r,points:this.#n}),this.#t.set(r,0),this.#o=0,this.toSVGPath(),null}getLastElement(){return this.#i.at(-1)}setLastElement(t){return this.#i?(this.#i.push(t),this.#e=t.line,this.#n=t.points,this.#o=0,{path:{d:this.toSVGPath()}}):this.#h.setLastElement(t)}removeLastElement(){if(!this.#i)return this.#h.removeLastElement();this.#i.pop(),this.#r="";for(let t=0,e=this.#i.length;t<e;t++){const{line:s,points:i}=this.#i[t];this.#e=s,this.#n=i,this.#o=0,this.toSVGPath()}return{path:{d:this.#r}}}toSVGPath(){const t=F.svgRound(this.#e[4]),e=F.svgRound(this.#e[5]);if(this.#n.length===2)return this.#r=`${this.#r} M ${t} ${e} Z`,this.#r;if(this.#n.length<=6){const i=this.#r.lastIndexOf("M");this.#r=`${this.#r.slice(0,i)} M ${t} ${e}`,this.#o=6}if(this.#n.length===4){const i=F.svgRound(this.#e[10]),n=F.svgRound(this.#e[11]);return this.#r=`${this.#r} L ${i} ${n}`,this.#o=12,this.#r}const s=[];this.#o===0&&(s.push(`M ${t} ${e}`),this.#o=6);for(let i=this.#o,n=this.#e.length;i<n;i+=6){const[r,a,o,l,h,c]=this.#e.slice(i,i+6).map(F.svgRound);s.push(`C${r} ${a} ${o} ${l} ${h} ${c}`)}return this.#r+=s.join(" "),this.#o=this.#e.length,this.#r}getOutlines(t,e,s,i){const n=this.#i.at(-1);return n.line=new Float32Array(n.line),n.points=new Float32Array(n.points),this.#h.build(this.#i,t,e,s,this.#s,this.#a,i),this.#t=null,this.#e=null,this.#i=null,this.#r=null,this.#h}get defaultSVGProperties(){return{root:{viewBox:"0 0 10000 10000"},rootClass:{draw:!0},bbox:[0,0,1,1]}}}class Ge extends F{#t;#e=0;#i;#s;#a;#n;#r;#o;#h;build(t,e,s,i,n,r,a){this.#a=e,this.#n=s,this.#r=i,this.#o=n,this.#h=r,this.#i=a??0,this.#s=t,this.#d()}get thickness(){return this.#h}setLastElement(t){return this.#s.push(t),{path:{d:this.toSVGPath()}}}removeLastElement(){return this.#s.pop(),{path:{d:this.toSVGPath()}}}toSVGPath(){const t=[];for(const{line:e}of this.#s){if(t.push(`M${F.svgRound(e[4])} ${F.svgRound(e[5])}`),e.length===6){t.push("Z");continue}if(e.length===12&&isNaN(e[6])){t.push(`L${F.svgRound(e[10])} ${F.svgRound(e[11])}`);continue}for(let s=6,i=e.length;s<i;s+=6){const[n,r,a,o,l,h]=e.subarray(s,s+6).map(F.svgRound);t.push(`C${n} ${r} ${a} ${o} ${l} ${h}`)}}return t.join("")}serialize([t,e,s,i],n){const r=[],a=[],[o,l,h,c]=this.#u();let u,f,m,p,b,g,v,y,S;switch(this.#o){case 0:S=F._rescale,u=t,f=e+i,m=s,p=-i,b=t+o*s,g=e+(1-l-c)*i,v=t+(o+h)*s,y=e+(1-l)*i;break;case 90:S=F._rescaleAndSwap,u=t,f=e,m=s,p=i,b=t+l*s,g=e+o*i,v=t+(l+c)*s,y=e+(o+h)*i;break;case 180:S=F._rescale,u=t+s,f=e,m=-s,p=i,b=t+(1-o-h)*s,g=e+l*i,v=t+(1-o)*s,y=e+(l+c)*i;break;case 270:S=F._rescaleAndSwap,u=t+s,f=e+i,m=-s,p=-i,b=t+(1-l-c)*s,g=e+(1-o-h)*i,v=t+(1-l)*s,y=e+(1-o)*i;break}for(const{line:A,points:w}of this.#s)r.push(S(A,u,f,m,p,n?new Array(A.length):null)),a.push(S(w,u,f,m,p,n?new Array(w.length):null));return{lines:r,points:a,rect:[b,g,v,y]}}static deserialize(t,e,s,i,n,{paths:{lines:r,points:a},rotation:o,thickness:l}){const h=[];let c,u,f,m,p;switch(o){case 0:p=F._rescale,c=-t/s,u=e/i+1,f=1/s,m=-1/i;break;case 90:p=F._rescaleAndSwap,c=-e/i,u=-t/s,f=1/i,m=1/s;break;case 180:p=F._rescale,c=t/s+1,u=-e/i,f=-1/s,m=1/i;break;case 270:p=F._rescaleAndSwap,c=e/i+1,u=t/s+1,f=-1/i,m=-1/s;break}if(!r){r=[];for(const g of a){const v=g.length;if(v===2){r.push(new Float32Array([NaN,NaN,NaN,NaN,g[0],g[1]]));continue}if(v===4){r.push(new Float32Array([NaN,NaN,NaN,NaN,g[0],g[1],NaN,NaN,NaN,NaN,g[2],g[3]]));continue}const y=new Float32Array(3*(v-2));r.push(y);let[S,A,w,_]=g.subarray(0,4);y.set([NaN,NaN,NaN,NaN,S,A],0);for(let x=4;x<v;x+=2){const E=g[x],k=g[x+1];y.set(F.createBezierPoints(S,A,w,_,E,k),(x-2)*3),[S,A,w,_]=[w,_,E,k]}}}for(let g=0,v=r.length;g<v;g++)h.push({line:p(r[g].map(y=>y??NaN),c,u,f,m),points:p(a[g].map(y=>y??NaN),c,u,f,m)});const b=new this.prototype.constructor;return b.build(h,s,i,1,o,l,n),b}#l(t=this.#h){const e=this.#i+t/2*this.#r;return this.#o%180===0?[e/this.#a,e/this.#n]:[e/this.#n,e/this.#a]}#u(){const[t,e,s,i]=this.#t,[n,r]=this.#l(0);return[t+n,e+r,s-2*n,i-2*r]}#d(){const t=this.#t=new Float32Array([1/0,1/0,-1/0,-1/0]);for(const{line:i}of this.#s){if(i.length<=12){for(let a=4,o=i.length;a<o;a+=6)B.pointBoundingBox(i[a],i[a+1],t);continue}let n=i[4],r=i[5];for(let a=6,o=i.length;a<o;a+=6){const[l,h,c,u,f,m]=i.subarray(a,a+6);B.bezierBoundingBox(n,r,l,h,c,u,f,m,t),n=f,r=m}}const[e,s]=this.#l();t[0]=Pt(t[0]-e,0,1),t[1]=Pt(t[1]-s,0,1),t[2]=Pt(t[2]+e,0,1),t[3]=Pt(t[3]+s,0,1),t[2]-=t[0],t[3]-=t[1]}get box(){return this.#t}updateProperty(t,e){return t==="stroke-width"?this.#f(e):null}#f(t){const[e,s]=this.#l();this.#h=t;const[i,n]=this.#l(),[r,a]=[i-e,n-s],o=this.#t;return o[0]-=r,o[1]-=a,o[2]+=2*r,o[3]+=2*a,o}updateParentDimensions([t,e],s){const[i,n]=this.#l();this.#a=t,this.#n=e,this.#r=s;const[r,a]=this.#l(),o=r-i,l=a-n,h=this.#t;return h[0]-=o,h[1]-=l,h[2]+=2*o,h[3]+=2*l,h}updateRotation(t){return this.#e=t,{path:{transform:this.rotationTransform}}}get viewBox(){return this.#t.map(F.svgRound).join(" ")}get defaultProperties(){const[t,e]=this.#t;return{root:{viewBox:this.viewBox},path:{"transform-origin":`${F.svgRound(t)} ${F.svgRound(e)}`}}}get rotationTransform(){const[,,t,e]=this.#t;let s=0,i=0,n=0,r=0,a=0,o=0;switch(this.#e){case 90:i=e/t,n=-t/e,a=t;break;case 180:s=-1,r=-1,a=t,o=e;break;case 270:i=-e/t,n=t/e,o=e;break;default:return""}return`matrix(${s} ${i} ${n} ${r} ${F.svgRound(a)} ${F.svgRound(o)})`}getPathResizingSVGProperties([t,e,s,i]){const[n,r]=this.#l(),[a,o,l,h]=this.#t;if(Math.abs(l-n)<=F.PRECISION||Math.abs(h-r)<=F.PRECISION){const p=t+s/2-(a+l/2),b=e+i/2-(o+h/2);return{path:{"transform-origin":`${F.svgRound(t)} ${F.svgRound(e)}`,transform:`${this.rotationTransform} translate(${p} ${b})`}}}const c=(s-2*n)/(l-2*n),u=(i-2*r)/(h-2*r),f=l/s,m=h/i;return{path:{"transform-origin":`${F.svgRound(a)} ${F.svgRound(o)}`,transform:`${this.rotationTransform} scale(${f} ${m}) translate(${F.svgRound(n)} ${F.svgRound(r)}) scale(${c} ${u}) translate(${F.svgRound(-n)} ${F.svgRound(-r)})`}}}getPathResizedSVGProperties([t,e,s,i]){const[n,r]=this.#l(),a=this.#t,[o,l,h,c]=a;if(a[0]=t,a[1]=e,a[2]=s,a[3]=i,Math.abs(h-n)<=F.PRECISION||Math.abs(c-r)<=F.PRECISION){const b=t+s/2-(o+h/2),g=e+i/2-(l+c/2);for(const{line:v,points:y}of this.#s)F._translate(v,b,g,v),F._translate(y,b,g,y);return{root:{viewBox:this.viewBox},path:{"transform-origin":`${F.svgRound(t)} ${F.svgRound(e)}`,transform:this.rotationTransform||null,d:this.toSVGPath()}}}const u=(s-2*n)/(h-2*n),f=(i-2*r)/(c-2*r),m=-u*(o+n)+t+n,p=-f*(l+r)+e+r;if(u!==1||f!==1||m!==0||p!==0)for(const{line:b,points:g}of this.#s)F._rescale(b,m,p,u,f,b),F._rescale(g,m,p,u,f,g);return{root:{viewBox:this.viewBox},path:{"transform-origin":`${F.svgRound(t)} ${F.svgRound(e)}`,transform:this.rotationTransform||null,d:this.toSVGPath()}}}getPathTranslatedSVGProperties([t,e],s){const[i,n]=s,r=this.#t,a=t-r[0],o=e-r[1];if(this.#a===i&&this.#n===n)for(const{line:l,points:h}of this.#s)F._translate(l,a,o,l),F._translate(h,a,o,h);else{const l=this.#a/i,h=this.#n/n;this.#a=i,this.#n=n;for(const{line:c,points:u}of this.#s)F._rescale(c,a,o,l,h,c),F._rescale(u,a,o,l,h,u);r[2]*=l,r[3]*=h}return r[0]=t,r[1]=e,{root:{viewBox:this.viewBox},path:{d:this.toSVGPath(),"transform-origin":`${F.svgRound(t)} ${F.svgRound(e)}`}}}get defaultSVGProperties(){const t=this.#t;return{root:{viewBox:this.viewBox},rootClass:{draw:!0},path:{d:this.toSVGPath(),"transform-origin":`${F.svgRound(t[0])} ${F.svgRound(t[1])}`,transform:this.rotationTransform||null},bbox:t}}}class ps extends pn{constructor(t){super(),this._viewParameters=t,super.updateProperties({fill:"none",stroke:j._defaultLineColor,"stroke-opacity":1,"stroke-width":1,"stroke-linecap":"round","stroke-linejoin":"round","stroke-miterlimit":10})}updateSVGProperty(t,e){t==="stroke-width"&&(e??=this["stroke-width"],e*=this._viewParameters.realScale),super.updateSVGProperty(t,e)}clone(){const t=new ps(this._viewParameters);return t.updateAll(this),t}}class Js extends U{static _type="ink";static _editorType=V.INK;static _defaultDrawingOptions=null;constructor(t){super({...t,name:"inkEditor"}),this._willKeepAspectRatio=!0,this.defaultL10nId="pdfjs-editor-ink-editor"}static initialize(t,e){j.initialize(t,e),this._defaultDrawingOptions=new ps(e.viewParameters)}static getDefaultDrawingOptions(t){const e=this._defaultDrawingOptions.clone();return e.updateProperties(t),e}static get supportMultipleDrawings(){return!0}static get typesMap(){return W(this,"typesMap",new Map([[K.INK_THICKNESS,"stroke-width"],[K.INK_COLOR,"stroke"],[K.INK_OPACITY,"stroke-opacity"]]))}static createDrawerInstance(t,e,s,i,n){return new ya(t,e,s,i,n,this._defaultDrawingOptions["stroke-width"])}static deserializeDraw(t,e,s,i,n,r){return Ge.deserialize(t,e,s,i,n,r)}static async deserialize(t,e,s){let i=null;if(t instanceof Ks){const{data:{inkLists:r,rect:a,rotation:o,id:l,color:h,opacity:c,borderStyle:{rawWidth:u},popupRef:f,richText:m,contentsObj:p,creationDate:b,modificationDate:g},parent:{page:{pageNumber:v}}}=t;i=t={annotationType:V.INK,color:Array.from(h),thickness:u,opacity:c,paths:{points:r},boxes:null,pageIndex:v-1,rect:a.slice(0),rotation:o,annotationElementId:l,id:l,deleted:!1,popupRef:f,richText:m,comment:p?.str||null,creationDate:b,modificationDate:g}}const n=await super.deserialize(t,e,s);return n._initialData=i,t.comment&&n.setCommentData(t),n}get toolbarButtons(){return this._colorPicker||=new Oe(this),[["colorPicker",this._colorPicker]]}get colorType(){return K.INK_COLOR}get color(){return this._drawingOptions.stroke}get opacity(){return this._drawingOptions["stroke-opacity"]}onScaleChanging(){if(!this.parent)return;super.onScaleChanging();const{_drawId:t,_drawingOptions:e,parent:s}=this;e.updateSVGProperty("stroke-width"),s.drawLayer.updateProperties(t,e.toSVGProperties())}static onScaleChangingWhenDrawing(){const t=this._currentParent;t&&(super.onScaleChangingWhenDrawing(),this._defaultDrawingOptions.updateSVGProperty("stroke-width"),t.drawLayer.updateProperties(this._currentDrawId,this._defaultDrawingOptions.toSVGProperties()))}createDrawingOptions({color:t,thickness:e,opacity:s}){this._drawingOptions=Js.getDefaultDrawingOptions({stroke:B.makeHexColor(...t),"stroke-width":e,"stroke-opacity":s})}serialize(t=!1){if(this.isEmpty())return null;if(this.deleted)return this.serializeDeleted();const{lines:e,points:s}=this.serializeDraw(t),{_drawingOptions:{stroke:i,"stroke-opacity":n,"stroke-width":r}}=this,a=Object.assign(super.serialize(t),{color:j._colorManager.convert(i),opacity:n,thickness:r,paths:{lines:e,points:s}});return this.addComment(a),t?(a.isCopy=!0,a):this.annotationElementId&&!this.#t(a)?null:(a.id=this.annotationElementId,a)}#t(t){const{color:e,thickness:s,opacity:i,pageIndex:n}=this._initialData;return this.hasEditedComment||this._hasBeenMoved||this._hasBeenResized||t.color.some((r,a)=>r!==e[a])||t.thickness!==s||t.opacity!==i||t.pageIndex!==n}renderAnnotationElement(t){if(this.deleted)return t.hide(),null;const{points:e,rect:s}=this.serializeDraw(!1);return t.updateEdited({rect:s,thickness:this._drawingOptions["stroke-width"],points:e,popup:this.comment}),null}}class Bs extends Ge{toSVGPath(){let t=super.toSVGPath();return t.endsWith("Z")||(t+="Z"),t}}const ts=8,ke=3;class me{static#t={maxDim:512,sigmaSFactor:.02,sigmaR:25,kernelSize:16};static#e(t,e,s,i){return s-=t,i-=e,s===0?i>0?0:4:s===1?i+6:2-i}static#i=new Int32Array([0,1,-1,1,-1,0,-1,-1,0,-1,1,-1,1,0,1,1]);static#s(t,e,s,i,n,r,a){const o=this.#e(s,i,n,r);for(let l=0;l<8;l++){const h=(-l+o-a+16)%8,c=this.#i[2*h],u=this.#i[2*h+1];if(t[(s+c)*e+(i+u)]!==0)return h}return-1}static#a(t,e,s,i,n,r,a){const o=this.#e(s,i,n,r);for(let l=0;l<8;l++){const h=(l+o+a+16)%8,c=this.#i[2*h],u=this.#i[2*h+1];if(t[(s+c)*e+(i+u)]!==0)return h}return-1}static#n(t,e,s,i){const n=t.length,r=new Int32Array(n);for(let h=0;h<n;h++)r[h]=t[h]<=i?1:0;for(let h=1;h<s-1;h++)r[h*e]=r[h*e+e-1]=0;for(let h=0;h<e;h++)r[h]=r[e*s-1-h]=0;let a=1,o;const l=[];for(let h=1;h<s-1;h++){o=1;for(let c=1;c<e-1;c++){const u=h*e+c,f=r[u];if(f===0)continue;let m=h,p=c;if(f===1&&r[u-1]===0)a+=1,p-=1;else if(f>=1&&r[u+1]===0)a+=1,p+=1,f>1&&(o=f);else{f!==1&&(o=Math.abs(f));continue}const b=[c,h],g=p===c+1,v={isHole:g,points:b,id:a,parent:0};l.push(v);let y;for(const T of l)if(T.id===o){y=T;break}y?y.isHole?v.parent=g?y.parent:o:v.parent=g?o:y.parent:v.parent=g?o:0;const S=this.#s(r,e,h,c,m,p,0);if(S===-1){r[u]=-a,r[u]!==1&&(o=Math.abs(r[u]));continue}let A=this.#i[2*S],w=this.#i[2*S+1];const _=h+A,x=c+w;m=_,p=x;let E=h,k=c;for(;;){const T=this.#a(r,e,E,k,m,p,1);A=this.#i[2*T],w=this.#i[2*T+1];const P=E+A,M=k+w;b.push(M,P);const I=E*e+k;if(r[I+1]===0?r[I]=-a:r[I]===1&&(r[I]=a),P===h&&M===c&&E===_&&k===x){r[u]!==1&&(o=Math.abs(r[u]));break}else m=E,p=k,E=P,k=M}}}return l}static#r(t,e,s,i){if(s-e<=4){for(let _=e;_<s-2;_+=2)i.push(t[_],t[_+1]);return}const n=t[e],r=t[e+1],a=t[s-4]-n,o=t[s-3]-r,l=Math.hypot(a,o),h=a/l,c=o/l,u=h*r-c*n,f=o/a,m=1/l,p=Math.atan(f),b=Math.cos(p),g=Math.sin(p),v=m*(Math.abs(b)+Math.abs(g)),y=m*(1-v+v**2),S=Math.max(Math.atan(Math.abs(g+b)*y),Math.atan(Math.abs(g-b)*y));let A=0,w=e;for(let _=e+2;_<s-2;_+=2){const x=Math.abs(u-h*t[_+1]+c*t[_]);x>A&&(w=_,A=x)}A>(l*S)**2?(this.#r(t,e,w+2,i),this.#r(t,w,s,i)):i.push(n,r)}static#o(t){const e=[],s=t.length;return this.#r(t,0,s,e),e.push(t[s-2],t[s-1]),e.length<=4?null:e}static#h(t,e,s,i,n,r){const a=new Float32Array(r**2),o=-2*i**2,l=r>>1;for(let p=0;p<r;p++){const b=(p-l)**2;for(let g=0;g<r;g++)a[p*r+g]=Math.exp((b+(g-l)**2)/o)}const h=new Float32Array(256),c=-2*n**2;for(let p=0;p<256;p++)h[p]=Math.exp(p**2/c);const u=t.length,f=new Uint8Array(u),m=new Uint32Array(256);for(let p=0;p<s;p++)for(let b=0;b<e;b++){const g=p*e+b,v=t[g];let y=0,S=0;for(let w=0;w<r;w++){const _=p+w-l;if(!(_<0||_>=s))for(let x=0;x<r;x++){const E=b+x-l;if(E<0||E>=e)continue;const k=t[_*e+E],T=a[w*r+x]*h[Math.abs(k-v)];y+=k*T,S+=T}}const A=f[g]=Math.round(y/S);m[A]++}return[f,m]}static#l(t){const e=new Uint32Array(256);for(const s of t)e[s]++;return e}static#u(t){const e=t.length,s=new Uint8ClampedArray(e>>2);let i=-1/0,n=1/0;for(let a=0,o=s.length;a<o;a++){const l=s[a]=t[a<<2];i=Math.max(i,l),n=Math.min(n,l)}const r=255/(i-n);for(let a=0,o=s.length;a<o;a++)s[a]=(s[a]-n)*r;return s}static#d(t){let e,s=-1/0,i=-1/0;const n=t.findIndex(o=>o!==0);let r=n,a=n;for(e=n;e<256;e++){const o=t[e];o>s&&(e-r>i&&(i=e-r,a=e-1),s=o,r=e)}for(e=a-1;e>=0&&!(t[e]>t[e+1]);e--);return e}static#f(t){const e=t,{width:s,height:i}=t,{maxDim:n}=this.#t;let r=s,a=i;if(s>n||i>n){let u=s,f=i,m=Math.log2(Math.max(s,i)/n);const p=Math.floor(m);m=m===p?p-1:p;for(let g=0;g<m;g++){r=Math.ceil(u/2),a=Math.ceil(f/2);const v=new OffscreenCanvas(r,a);v.getContext("2d").drawImage(t,0,0,u,f,0,0,r,a),u=r,f=a,t!==e&&t.close(),t=v.transferToImageBitmap()}const b=Math.min(n/r,n/a);r=Math.round(r*b),a=Math.round(a*b)}const l=new OffscreenCanvas(r,a).getContext("2d",{willReadFrequently:!0});l.fillStyle="white",l.fillRect(0,0,r,a),l.filter="grayscale(1)",l.drawImage(t,0,0,t.width,t.height,0,0,r,a);const h=l.getImageData(0,0,r,a).data;return[this.#u(h),r,a]}static extractContoursFromText(t,{fontFamily:e,fontStyle:s,fontWeight:i},n,r,a,o){let l=new OffscreenCanvas(1,1),h=l.getContext("2d",{alpha:!1});const c=200,u=h.font=`${s} ${i} ${c}px ${e}`,{actualBoundingBoxLeft:f,actualBoundingBoxRight:m,actualBoundingBoxAscent:p,actualBoundingBoxDescent:b,fontBoundingBoxAscent:g,fontBoundingBoxDescent:v,width:y}=h.measureText(t),S=1.5,A=Math.ceil(Math.max(Math.abs(f)+Math.abs(m)||0,y)*S),w=Math.ceil(Math.max(Math.abs(p)+Math.abs(b)||c,Math.abs(g)+Math.abs(v)||c)*S);l=new OffscreenCanvas(A,w),h=l.getContext("2d",{alpha:!0,willReadFrequently:!0}),h.font=u,h.filter="grayscale(1)",h.fillStyle="white",h.fillRect(0,0,A,w),h.fillStyle="black",h.fillText(t,A*(S-1)/2,w*(3-S)/2);const _=this.#u(h.getImageData(0,0,A,w).data),x=this.#l(_),E=this.#d(x),k=this.#n(_,A,w,E);return this.processDrawnLines({lines:{curves:k,width:A,height:w},pageWidth:n,pageHeight:r,rotation:a,innerMargin:o,mustSmooth:!0,areContours:!0})}static process(t,e,s,i,n){const[r,a,o]=this.#f(t),[l,h]=this.#h(r,a,o,Math.hypot(a,o)*this.#t.sigmaSFactor,this.#t.sigmaR,this.#t.kernelSize),c=this.#d(h),u=this.#n(l,a,o,c);return this.processDrawnLines({lines:{curves:u,width:a,height:o},pageWidth:e,pageHeight:s,rotation:i,innerMargin:n,mustSmooth:!0,areContours:!0})}static processDrawnLines({lines:t,pageWidth:e,pageHeight:s,rotation:i,innerMargin:n,mustSmooth:r,areContours:a}){i%180!==0&&([e,s]=[s,e]);const{curves:o,width:l,height:h}=t,c=t.thickness??0,u=[],f=Math.min(e/l,s/h),m=f/e,p=f/s,b=[];for(const{points:v}of o){const y=r?this.#o(v):v;if(!y)continue;b.push(y);const S=y.length,A=new Float32Array(S),w=new Float32Array(3*(S===2?2:S-2));if(u.push({line:w,points:A}),S===2){A[0]=y[0]*m,A[1]=y[1]*p,w.set([NaN,NaN,NaN,NaN,A[0],A[1]],0);continue}let[_,x,E,k]=y;_*=m,x*=p,E*=m,k*=p,A.set([_,x,E,k],0),w.set([NaN,NaN,NaN,NaN,_,x],0);for(let T=4;T<S;T+=2){const P=A[T]=y[T]*m,M=A[T+1]=y[T+1]*p;w.set(F.createBezierPoints(_,x,E,k,P,M),(T-2)*3),[_,x,E,k]=[E,k,P,M]}}if(u.length===0)return null;const g=a?new Bs:new Ge;return g.build(u,e,s,1,i,a?0:c,n),{outline:g,newCurves:b,areContours:a,thickness:c,width:l,height:h}}static async compressSignature({outlines:t,areContours:e,thickness:s,width:i,height:n}){let r=1/0,a=-1/0,o=0;for(const y of t){o+=y.length;for(let S=2,A=y.length;S<A;S++){const w=y[S]-y[S-2];r=Math.min(r,w),a=Math.max(a,w)}}let l;r>=-128&&a<=127?l=Int8Array:r>=-32768&&a<=32767?l=Int16Array:l=Int32Array;const h=t.length,c=ts+ke*h,u=new Uint32Array(c);let f=0;u[f++]=c*Uint32Array.BYTES_PER_ELEMENT+(o-2*h)*l.BYTES_PER_ELEMENT,u[f++]=0,u[f++]=i,u[f++]=n,u[f++]=e?0:1,u[f++]=Math.max(0,Math.floor(s??0)),u[f++]=h,u[f++]=l.BYTES_PER_ELEMENT;for(const y of t)u[f++]=y.length-2,u[f++]=y[0],u[f++]=y[1];const m=new CompressionStream("deflate-raw"),p=m.writable.getWriter();await p.ready,p.write(u);const b=l.prototype.constructor;for(const y of t){const S=new b(y.length-2);for(let A=2,w=y.length;A<w;A++)S[A-2]=y[A]-y[A-2];p.write(S)}p.close();const g=await new Response(m.readable).arrayBuffer(),v=new Uint8Array(g);return ji(v)}static async decompressSignature(t){try{const e=In(t),{readable:s,writable:i}=new DecompressionStream("deflate-raw"),n=i.getWriter();await n.ready,n.write(e).then(async()=>{await n.ready,await n.close()}).catch(()=>{});let r=null,a=0;for await(const y of s)r||=new Uint8Array(new Uint32Array(y.buffer,0,4)[0]),r.set(y,a),a+=y.length;const o=new Uint32Array(r.buffer,0,r.length>>2),l=o[1];if(l!==0)throw new Error(`Invalid version: ${l}`);const h=o[2],c=o[3],u=o[4]===0,f=o[5],m=o[6],p=o[7],b=[],g=(ts+ke*m)*Uint32Array.BYTES_PER_ELEMENT;let v;switch(p){case Int8Array.BYTES_PER_ELEMENT:v=new Int8Array(r.buffer,g);break;case Int16Array.BYTES_PER_ELEMENT:v=new Int16Array(r.buffer,g);break;case Int32Array.BYTES_PER_ELEMENT:v=new Int32Array(r.buffer,g);break}a=0;for(let y=0;y<m;y++){const S=o[ke*y+ts],A=new Float32Array(S+2);b.push(A);for(let w=0;w<ke-1;w++)A[w]=o[ke*y+ts+w+1];for(let w=0;w<S;w++)A[w+2]=A[w]+v[a++]}return{areContours:u,thickness:f,outlines:b,width:h,height:c}}catch(e){return G(`decompressSignature: ${e}`),null}}}class Zs extends pn{constructor(){super(),super.updateProperties({fill:j._defaultLineColor,"stroke-width":0})}clone(){const t=new Zs;return t.updateAll(this),t}}class ti extends ps{constructor(t){super(t),super.updateProperties({stroke:j._defaultLineColor,"stroke-width":1})}clone(){const t=new ti(this._viewParameters);return t.updateAll(this),t}}class Vt extends U{#t=!1;#e=null;#i=null;#s=null;static _type="signature";static _editorType=V.SIGNATURE;static _defaultDrawingOptions=null;constructor(t){super({...t,mustBeCommitted:!0,name:"signatureEditor"}),this._willKeepAspectRatio=!0,this.#i=t.signatureData||null,this.#e=null,this.defaultL10nId="pdfjs-editor-signature-editor1"}static initialize(t,e){j.initialize(t,e),this._defaultDrawingOptions=new Zs,this._defaultDrawnSignatureOptions=new ti(e.viewParameters)}static getDefaultDrawingOptions(t){const e=this._defaultDrawingOptions.clone();return e.updateProperties(t),e}static get supportMultipleDrawings(){return!1}static get typesMap(){return W(this,"typesMap",new Map)}static get isDrawer(){return!1}get telemetryFinalData(){return{type:"signature",hasDescription:!!this.#e}}static computeTelemetryFinalData(t){const e=t.get("hasDescription");return{hasAltText:e.get(!0)??0,hasNoAltText:e.get(!1)??0}}get isResizable(){return!0}onScaleChanging(){this._drawId!==null&&super.onScaleChanging()}render(){if(this.div)return this.div;let t,e;const{_isCopy:s}=this;if(s&&(this._isCopy=!1,t=this.x,e=this.y),super.render(),this._drawId===null)if(this.#i){const{lines:i,mustSmooth:n,areContours:r,description:a,uuid:o,heightInPage:l}=this.#i,{rawDims:{pageWidth:h,pageHeight:c},rotation:u}=this.parent.viewport,f=me.processDrawnLines({lines:i,pageWidth:h,pageHeight:c,rotation:u,innerMargin:Vt._INNER_MARGIN,mustSmooth:n,areContours:r});this.addSignature(f,l,a,o)}else this.div.setAttribute("data-l10n-args",JSON.stringify({description:""})),this.div.hidden=!0,this._uiManager.getSignature(this);else this.div.setAttribute("data-l10n-args",JSON.stringify({description:this.#e||""}));return s&&(this._isCopy=!0,this._moveAfterPaste(t,e)),this.div}setUuid(t){this.#s=t,this.addEditToolbar()}getUuid(){return this.#s}get description(){return this.#e}set description(t){this.#e=t,this.div&&(this.div.setAttribute("data-l10n-args",JSON.stringify({description:t})),super.addEditToolbar().then(e=>{e?.updateEditSignatureButton(t)}))}getSignaturePreview(){const{newCurves:t,areContours:e,thickness:s,width:i,height:n}=this.#i,r=Math.max(i,n),a=me.processDrawnLines({lines:{curves:t.map(o=>({points:o})),thickness:s,width:i,height:n},pageWidth:r,pageHeight:r,rotation:0,innerMargin:0,mustSmooth:!1,areContours:e});return{areContours:e,outline:a.outline}}get toolbarButtons(){return this._uiManager.signatureManager?[["editSignature",this._uiManager.signatureManager]]:super.toolbarButtons}addSignature(t,e,s,i){const{x:n,y:r}=this,{outline:a}=this.#i=t;this.#t=a instanceof Bs,this.description=s;let o;this.#t?o=Vt.getDefaultDrawingOptions():(o=Vt._defaultDrawnSignatureOptions.clone(),o.updateProperties({"stroke-width":a.thickness})),this._addOutlines({drawOutlines:a,drawingOptions:o});const[,l]=this.pageDimensions;let h=e/l;h=h>=1?.5:h,this.width*=h/this.height,this.width>=1&&(h*=.9/this.width,this.width=.9),this.height=h,this.setDims(),this.x=n,this.y=r,this.center(),this._onResized(),this.onScaleChanging(),this.rotate(),this._uiManager.addToAnnotationStorage(this),this.setUuid(i),this._reportTelemetry({action:"pdfjs.signature.inserted",data:{hasBeenSaved:!!i,hasDescription:!!s}}),this.div.hidden=!1}getFromImage(t){const{rawDims:{pageWidth:e,pageHeight:s},rotation:i}=this.parent.viewport;return me.process(t,e,s,i,Vt._INNER_MARGIN)}getFromText(t,e){const{rawDims:{pageWidth:s,pageHeight:i},rotation:n}=this.parent.viewport;return me.extractContoursFromText(t,e,s,i,n,Vt._INNER_MARGIN)}getDrawnSignature(t){const{rawDims:{pageWidth:e,pageHeight:s},rotation:i}=this.parent.viewport;return me.processDrawnLines({lines:t,pageWidth:e,pageHeight:s,rotation:i,innerMargin:Vt._INNER_MARGIN,mustSmooth:!1,areContours:!1})}createDrawingOptions({areContours:t,thickness:e}){t?this._drawingOptions=Vt.getDefaultDrawingOptions():(this._drawingOptions=Vt._defaultDrawnSignatureOptions.clone(),this._drawingOptions.updateProperties({"stroke-width":e}))}serialize(t=!1){if(this.isEmpty())return null;const{lines:e,points:s}=this.serializeDraw(t),{_drawingOptions:{"stroke-width":i}}=this,n=Object.assign(super.serialize(t),{isSignature:!0,areContours:this.#t,color:[0,0,0],thickness:this.#t?0:i});return this.addComment(n),t?(n.paths={lines:e,points:s},n.uuid=this.#s,n.isCopy=!0):n.lines=e,this.#e&&(n.accessibilityData={type:"Figure",alt:this.#e}),n}static deserializeDraw(t,e,s,i,n,r){return r.areContours?Bs.deserialize(t,e,s,i,n,r):Ge.deserialize(t,e,s,i,n,r)}static async deserialize(t,e,s){const i=await super.deserialize(t,e,s);return i.#t=t.areContours,i.description=t.accessibilityData?.alt||"",i.#s=t.uuid,i}}class wa extends j{#t=null;#e=null;#i=null;#s=null;#a=null;#n="";#r=null;#o=!1;#h=null;#l=!1;#u=!1;static _type="stamp";static _editorType=V.STAMP;constructor(t){super({...t,name:"stampEditor"}),this.#s=t.bitmapUrl,this.#a=t.bitmapFile,this.defaultL10nId="pdfjs-editor-stamp-editor"}static initialize(t,e){j.initialize(t,e)}static isHandlingMimeForPasting(t){return Ps.includes(t)}static paste(t,e){e.pasteEditor({mode:V.STAMP},{bitmapFile:t.getAsFile()})}altTextFinish(){this._uiManager.useNewAltTextFlow&&(this.div.hidden=!1),super.altTextFinish()}get telemetryFinalData(){return{type:"stamp",hasAltText:!!this.altTextData?.altText}}static computeTelemetryFinalData(t){const e=t.get("hasAltText");return{hasAltText:e.get(!0)??0,hasNoAltText:e.get(!1)??0}}#d(t,e=!1){if(!t){this.remove();return}this.#t=t.bitmap,e||(this.#e=t.id,this.#l=t.isSvg),t.file&&(this.#n=t.file.name),this.#p()}#f(){if(this.#i=null,this._uiManager.enableWaiting(!1),!!this.#r){if(this._uiManager.useNewAltTextWhenAddingImage&&this._uiManager.useNewAltTextFlow&&this.#t){this.addEditToolbar().then(()=>{this._editToolbar.hide(),this._uiManager.editAltText(this,!0)});return}if(!this._uiManager.useNewAltTextWhenAddingImage&&this._uiManager.useNewAltTextFlow&&this.#t){this._reportTelemetry({action:"pdfjs.image.image_added",data:{alt_text_modal:!1,alt_text_type:"empty"}});try{this.mlGuessAltText()}catch{}}this.div.focus()}}async mlGuessAltText(t=null,e=!0){if(this.hasAltTextData())return null;const{mlManager:s}=this._uiManager;if(!s)throw new Error("No ML.");if(!await s.isEnabledFor("altText"))throw new Error("ML isn't enabled for alt text.");const{data:i,width:n,height:r}=t||this.copyCanvas(null,null,!0).imageData,a=await s.guess({name:"altText",request:{data:i,width:n,height:r,channels:i.length/(n*r)}});if(!a)throw new Error("No response from the AI service.");if(a.error)throw new Error("Error from the AI service.");if(a.cancel)return null;if(!a.output)throw new Error("No valid response from the AI service.");const o=a.output;return await this.setGuessedAltText(o),e&&!this.hasAltTextData()&&(this.altTextData={alt:o,decorative:!1}),o}#m(){if(this.#e){this._uiManager.enableWaiting(!0),this._uiManager.imageManager.getFromId(this.#e).then(s=>this.#d(s,!0)).finally(()=>this.#f());return}if(this.#s){const s=this.#s;this.#s=null,this._uiManager.enableWaiting(!0),this.#i=this._uiManager.imageManager.getFromUrl(s).then(i=>this.#d(i)).finally(()=>this.#f());return}if(this.#a){const s=this.#a;this.#a=null,this._uiManager.enableWaiting(!0),this.#i=this._uiManager.imageManager.getFromFile(s).then(i=>this.#d(i)).finally(()=>this.#f());return}const t=document.createElement("input");t.type="file",t.accept=Ps.join(",");const e=this._uiManager._signal;this.#i=new Promise(s=>{t.addEventListener("change",async()=>{if(!t.files||t.files.length===0)this.remove();else{this._uiManager.enableWaiting(!0);const i=await this._uiManager.imageManager.getFromFile(t.files[0]);this._reportTelemetry({action:"pdfjs.image.image_selected",data:{alt_text_modal:this._uiManager.useNewAltTextFlow}}),this.#d(i)}s()},{signal:e}),t.addEventListener("cancel",()=>{this.remove(),s()},{signal:e})}).finally(()=>this.#f()),t.click()}remove(){this.#e&&(this.#t=null,this._uiManager.imageManager.deleteId(this.#e),this.#r?.remove(),this.#r=null,this.#h&&(clearTimeout(this.#h),this.#h=null)),super.remove()}rebuild(){if(!this.parent){this.#e&&this.#m();return}super.rebuild(),this.div!==null&&(this.#e&&this.#r===null&&this.#m(),this.isAttachedToDOM||this.parent.add(this))}onceAdded(t){this._isDraggable=!0,t&&this.div.focus()}isEmpty(){return!(this.#i||this.#t||this.#s||this.#a||this.#e||this.#o)}get toolbarButtons(){return[["altText",this.createAltText()]]}get isResizable(){return!0}render(){if(this.div)return this.div;let t,e;return this._isCopy&&(t=this.x,e=this.y),super.render(),this.div.hidden=!0,this.createAltText(),this.#o||(this.#t?this.#p():this.#m()),this._isCopy&&this._moveAfterPaste(t,e),this._uiManager.addShouldRescale(this),this.div}setCanvas(t,e){const{id:s,bitmap:i}=this._uiManager.imageManager.getFromCanvas(t,e);e.remove(),s&&this._uiManager.imageManager.isValidId(s)&&(this.#e=s,i&&(this.#t=i),this.#o=!1,this.#p())}_onResized(){this.onScaleChanging()}onScaleChanging(){if(!this.parent)return;this.#h!==null&&clearTimeout(this.#h);const t=200;this.#h=setTimeout(()=>{this.#h=null,this.#g()},t)}#p(){const{div:t}=this;let{width:e,height:s}=this.#t;const[i,n]=this.pageDimensions,r=.75;if(this.width)e=this.width*i,s=this.height*n;else if(e>r*i||s>r*n){const o=Math.min(r*i/e,r*n/s);e*=o,s*=o}this._uiManager.enableWaiting(!1);const a=this.#r=document.createElement("canvas");a.setAttribute("role","img"),this.addContainer(a),this.width=e/i,this.height=s/n,this.setDims(),this._initialOptions?.isCentered?this.center():this.fixAndSetPosition(),this._initialOptions=null,(!this._uiManager.useNewAltTextWhenAddingImage||!this._uiManager.useNewAltTextFlow||this.annotationElementId)&&(t.hidden=!1),this.#g(),this.#u||(this.parent.addUndoableEditor(this),this.#u=!0),this._reportTelemetry({action:"inserted_image"}),this.#n&&this.div.setAttribute("aria-description",this.#n),this.annotationElementId||this._uiManager.a11yAlert("pdfjs-editor-stamp-added-alert")}copyCanvas(t,e,s=!1){t||(t=224);const{width:i,height:n}=this.#t,r=new qt;let a=this.#t,o=i,l=n,h=null;if(e){if(i>e||n>e){const w=Math.min(e/i,e/n);o=Math.floor(i*w),l=Math.floor(n*w)}h=document.createElement("canvas");const u=h.width=Math.ceil(o*r.sx),f=h.height=Math.ceil(l*r.sy);this.#l||(a=this.#c(u,f));const m=h.getContext("2d");m.filter=this._uiManager.hcmFilter;let p="white",b="#cfcfd8";this._uiManager.hcmFilter!=="none"?b="black":Hn.isDarkMode&&(p="#8f8f9d",b="#42414d");const g=15,v=g*r.sx,y=g*r.sy,S=new OffscreenCanvas(v*2,y*2),A=S.getContext("2d");A.fillStyle=p,A.fillRect(0,0,v*2,y*2),A.fillStyle=b,A.fillRect(0,0,v,y),A.fillRect(v,y,v,y),m.fillStyle=m.createPattern(S,"repeat"),m.fillRect(0,0,u,f),m.drawImage(a,0,0,a.width,a.height,0,0,u,f)}let c=null;if(s){let u,f;if(r.symmetric&&a.width<t&&a.height<t)u=a.width,f=a.height;else if(a=this.#t,i>t||n>t){const b=Math.min(t/i,t/n);u=Math.floor(i*b),f=Math.floor(n*b),this.#l||(a=this.#c(u,f))}const p=new OffscreenCanvas(u,f).getContext("2d",{willReadFrequently:!0});p.drawImage(a,0,0,a.width,a.height,0,0,u,f),c={width:u,height:f,data:p.getImageData(0,0,u,f).data}}return{canvas:h,width:o,height:l,imageData:c}}#c(t,e){const{width:s,height:i}=this.#t;let n=s,r=i,a=this.#t;for(;n>2*t||r>2*e;){const o=n,l=r;n>2*t&&(n=n>=16384?Math.floor(n/2)-1:Math.ceil(n/2)),r>2*e&&(r=r>=16384?Math.floor(r/2)-1:Math.ceil(r/2));const h=new OffscreenCanvas(n,r);h.getContext("2d").drawImage(a,0,0,o,l,0,0,n,r),a=h.transferToImageBitmap()}return a}#g(){const[t,e]=this.parentDimensions,{width:s,height:i}=this,n=new qt,r=Math.ceil(s*t*n.sx),a=Math.ceil(i*e*n.sy),o=this.#r;if(!o||o.width===r&&o.height===a)return;o.width=r,o.height=a;const l=this.#l?this.#t:this.#c(r,a),h=o.getContext("2d");h.filter=this._uiManager.hcmFilter,h.drawImage(l,0,0,l.width,l.height,0,0,r,a)}#b(t){if(t){if(this.#l){const i=this._uiManager.imageManager.getSvgUrl(this.#e);if(i)return i}const e=document.createElement("canvas");return{width:e.width,height:e.height}=this.#t,e.getContext("2d").drawImage(this.#t,0,0),e.toDataURL()}if(this.#l){const[e,s]=this.pageDimensions,i=Math.round(this.width*e*Se.PDF_TO_CSS_UNITS),n=Math.round(this.height*s*Se.PDF_TO_CSS_UNITS),r=new OffscreenCanvas(i,n);return r.getContext("2d").drawImage(this.#t,0,0,this.#t.width,this.#t.height,0,0,i,n),r.transferToImageBitmap()}return structuredClone(this.#t)}static async deserialize(t,e,s){let i=null,n=!1;if(t instanceof un){const{data:{rect:p,rotation:b,id:g,structParent:v,popupRef:y,richText:S,contentsObj:A,creationDate:w,modificationDate:_},container:x,parent:{page:{pageNumber:E}},canvas:k}=t;let T,P;k?(delete t.canvas,{id:T,bitmap:P}=s.imageManager.getFromCanvas(x.id,k),k.remove()):(n=!0,t._hasNoCanvas=!0);const M=(await e._structTree.getAriaAttributes(`${js}${g}`))?.get("aria-label")||"";i=t={annotationType:V.STAMP,bitmapId:T,bitmap:P,pageIndex:E-1,rect:p.slice(0),rotation:b,annotationElementId:g,id:g,deleted:!1,accessibilityData:{decorative:!1,altText:M},isSvg:!1,structParent:v,popupRef:y,richText:S,comment:A?.str||null,creationDate:w,modificationDate:_}}const r=await super.deserialize(t,e,s),{rect:a,bitmap:o,bitmapUrl:l,bitmapId:h,isSvg:c,accessibilityData:u}=t;n?(s.addMissingCanvas(t.id,r),r.#o=!0):h&&s.imageManager.isValidId(h)?(r.#e=h,o&&(r.#t=o)):r.#s=l,r.#l=c;const[f,m]=r.pageDimensions;return r.width=(a[2]-a[0])/f,r.height=(a[3]-a[1])/m,u&&(r.altTextData=u),r._initialData=i,t.comment&&r.setCommentData(t),r.#u=!!i,r}serialize(t=!1,e=null){if(this.isEmpty())return null;if(this.deleted)return this.serializeDeleted();const s=Object.assign(super.serialize(t),{bitmapId:this.#e,isSvg:this.#l});if(this.addComment(s),t)return s.bitmapUrl=this.#b(!0),s.accessibilityData=this.serializeAltText(!0),s.isCopy=!0,s;const{decorative:i,altText:n}=this.serializeAltText(!1);if(!i&&n&&(s.accessibilityData={type:"Figure",alt:n}),this.annotationElementId){const a=this.#w(s);return a.isSame?null:(a.isSameAltText?delete s.accessibilityData:s.accessibilityData.structParent=this._initialData.structParent??-1,s.id=this.annotationElementId,delete s.bitmapId,s)}if(e===null)return s;e.stamps||=new Map;const r=this.#l?(s.rect[2]-s.rect[0])*(s.rect[3]-s.rect[1]):null;if(!e.stamps.has(this.#e))e.stamps.set(this.#e,{area:r,serialized:s}),s.bitmap=this.#b(!1);else if(this.#l){const a=e.stamps.get(this.#e);r>a.area&&(a.area=r,a.serialized.bitmap.close(),a.serialized.bitmap=this.#b(!1))}return s}#w(t){const{pageIndex:e,accessibilityData:{altText:s}}=this._initialData,i=t.pageIndex===e,n=(t.accessibilityData?.alt||"")===s;return{isSame:!this.hasEditedComment&&!this._hasBeenMoved&&!this._hasBeenResized&&i&&n,isSameAltText:n}}renderAnnotationElement(t){return this.deleted?(t.hide(),null):(t.updateEdited({rect:this.getPDFRect(),popup:this.comment}),null)}}class Kt{#t;#e=!1;#i=null;#s=null;#a=null;#n=new Map;#r=!1;#o=!1;#h=!1;#l=null;#u=null;#d=null;#f=null;#m=null;#p=-1;#c;static _initialized=!1;static#g=new Map([yt,Js,wa,ut,Vt].map(t=>[t._editorType,t]));constructor({uiManager:t,pageIndex:e,div:s,structTreeLayer:i,accessibilityManager:n,annotationLayer:r,drawLayer:a,textLayer:o,viewport:l,l10n:h}){const c=[...Kt.#g.values()];if(!Kt._initialized){Kt._initialized=!0;for(const u of c)u.initialize(h,t)}t.registerEditorTypes(c),this.#c=t,this.pageIndex=e,this.div=s,this.#t=n,this.#i=r,this.viewport=l,this.#d=o,this.drawLayer=a,this._structTree=i,this.#c.addLayer(this)}get isEmpty(){return this.#n.size===0}get isInvisible(){return this.isEmpty&&this.#c.getMode()===V.NONE}updateToolbar(t){this.#c.updateToolbar(t)}updateMode(t=this.#c.getMode()){switch(this.#v(),t){case V.NONE:this.div.classList.toggle("nonEditing",!0),this.disableTextSelection(),this.togglePointerEvents(!1),this.toggleAnnotationLayerPointerEvents(!0),this.disableClick();return;case V.INK:this.disableTextSelection(),this.togglePointerEvents(!0),this.enableClick();break;case V.HIGHLIGHT:this.enableTextSelection(),this.togglePointerEvents(!1),this.disableClick();break;default:this.disableTextSelection(),this.togglePointerEvents(!0),this.enableClick()}this.toggleAnnotationLayerPointerEvents(!1);const{classList:e}=this.div;if(e.toggle("nonEditing",!1),t===V.POPUP)e.toggle("commentEditing",!0);else{e.toggle("commentEditing",!1);for(const s of Kt.#g.values())e.toggle(`${s._type}Editing`,t===s._editorType)}this.div.hidden=!1}hasTextLayer(t){return t===this.#d?.div}setEditingState(t){this.#c.setEditingState(t)}addCommands(t){this.#c.addCommands(t)}cleanUndoStack(t){this.#c.cleanUndoStack(t)}toggleDrawing(t=!1){this.div.classList.toggle("drawing",!t)}togglePointerEvents(t=!1){this.div.classList.toggle("disabled",!t)}toggleAnnotationLayerPointerEvents(t=!1){this.#i?.div.classList.toggle("disabled",!t)}get#b(){return this.#n.size!==0?this.#n.values():this.#c.getEditors(this.pageIndex)}async enable(){this.#h=!0,this.div.tabIndex=0,this.togglePointerEvents(!0),this.div.classList.toggle("nonEditing",!1),this.#m?.abort(),this.#m=null;const t=new Set;for(const s of this.#b)s.enableEditing(),s.show(!0),s.annotationElementId&&(this.#c.removeChangedExistingAnnotation(s),t.add(s.annotationElementId));const e=this.#i;if(e)for(const s of e.getEditableAnnotations()){if(s.hide(),this.#c.isDeletedAnnotationElement(s.data.id)||t.has(s.data.id))continue;const i=await this.deserialize(s);i&&(this.addOrRebuild(i),i.enableEditing())}this.#h=!1,this.#c._eventBus.dispatch("editorsrendered",{source:this,pageNumber:this.pageIndex+1})}disable(){if(this.#o=!0,this.div.tabIndex=-1,this.togglePointerEvents(!1),this.div.classList.toggle("nonEditing",!0),this.#d&&!this.#m){this.#m=new AbortController;const s=this.#c.combinedSignal(this.#m);this.#d.div.addEventListener("pointerdown",i=>{const{clientX:r,clientY:a,timeStamp:o}=i,l=this.#p;if(o-l>500){this.#p=o;return}this.#p=-1;const{classList:h}=this.div;h.toggle("getElements",!0);const c=document.elementsFromPoint(r,a);if(h.toggle("getElements",!1),!this.div.contains(c[0]))return;let u;const f=new RegExp(`^${De}[0-9]+$`);for(const p of c)if(f.test(p.id)){u=p.id;break}if(!u)return;const m=this.#n.get(u);m?.annotationElementId===null&&(i.stopPropagation(),i.preventDefault(),m.dblclick(i))},{signal:s,capture:!0})}const t=this.#i;if(t){const s=new Map,i=new Map;for(const r of this.#b){if(r.disableEditing(),!r.annotationElementId){r.updateFakeAnnotationElement(t);continue}if(r.serialize()!==null){s.set(r.annotationElementId,r);continue}else i.set(r.annotationElementId,r);this.getEditableAnnotation(r.annotationElementId)?.show(),r.remove()}const n=t.getEditableAnnotations();for(const r of n){const{id:a}=r.data;if(this.#c.isDeletedAnnotationElement(a)){r.updateEdited({deleted:!0});continue}let o=i.get(a);if(o){o.resetAnnotationElement(r),o.show(!1),r.show();continue}o=s.get(a),o&&(this.#c.addChangedExistingAnnotation(o),o.renderAnnotationElement(r)&&o.show(!1)),r.show()}}this.#v(),this.isEmpty&&(this.div.hidden=!0);const{classList:e}=this.div;for(const s of Kt.#g.values())e.remove(`${s._type}Editing`);this.disableTextSelection(),this.toggleAnnotationLayerPointerEvents(!0),this.#o=!1}getEditableAnnotation(t){return this.#i?.getEditableAnnotation(t)||null}setActiveEditor(t){this.#c.getActive()!==t&&this.#c.setActiveEditor(t)}enableTextSelection(){if(this.div.tabIndex=-1,this.#d?.div&&!this.#f){this.#f=new AbortController;const t=this.#c.combinedSignal(this.#f);this.#d.div.addEventListener("pointerdown",this.#w.bind(this),{signal:t}),this.#d.div.classList.add("highlighting")}}disableTextSelection(){this.div.tabIndex=0,this.#d?.div&&this.#f&&(this.#f.abort(),this.#f=null,this.#d.div.classList.remove("highlighting"))}#w(t){this.#c.unselectAll();const{target:e}=t;if(e===this.#d.div||(e.getAttribute("role")==="img"||e.classList.contains("endOfContent"))&&this.#d.div.contains(e)){const{isMac:s}=_t.platform;if(t.button!==0||t.ctrlKey&&s)return;this.#c.showAllEditors("highlight",!0,!0),this.#d.div.classList.add("free"),this.toggleDrawing(),ut.startHighlighting(this,this.#c.direction==="ltr",{target:this.#d.div,x:t.x,y:t.y}),this.#d.div.addEventListener("pointerup",()=>{this.#d.div.classList.remove("free"),this.toggleDrawing(!0)},{once:!0,signal:this.#c._signal}),t.preventDefault()}}enableClick(){if(this.#s)return;this.#s=new AbortController;const t=this.#c.combinedSignal(this.#s);this.div.addEventListener("pointerdown",this.pointerdown.bind(this),{signal:t});const e=this.pointerup.bind(this);this.div.addEventListener("pointerup",e,{signal:t}),this.div.addEventListener("pointercancel",e,{signal:t})}disableClick(){this.#s?.abort(),this.#s=null}attach(t){this.#n.set(t.id,t);const{annotationElementId:e}=t;e&&this.#c.isDeletedAnnotationElement(e)&&this.#c.removeDeletedAnnotationElement(t)}detach(t){this.#n.delete(t.id),this.#t?.removePointerInTextLayer(t.contentDiv),!this.#o&&t.annotationElementId&&this.#c.addDeletedAnnotationElement(t)}remove(t){this.detach(t),this.#c.removeEditor(t),t.div.remove(),t.isAttachedToDOM=!1}changeParent(t){t.parent!==this&&(t.parent&&t.annotationElementId&&(this.#c.addDeletedAnnotationElement(t.annotationElementId),j.deleteAnnotationElement(t),t.annotationElementId=null),this.attach(t),t.parent?.detach(t),t.setParent(this),t.div&&t.isAttachedToDOM&&(t.div.remove(),this.div.append(t.div)))}add(t){if(!(t.parent===this&&t.isAttachedToDOM)){if(this.changeParent(t),this.#c.addEditor(t),this.attach(t),!t.isAttachedToDOM){const e=t.render();this.div.append(e),t.isAttachedToDOM=!0}t.fixAndSetPosition(),t.onceAdded(!this.#h),this.#c.addToAnnotationStorage(t),t._reportTelemetry(t.telemetryInitialData)}}moveEditorInDOM(t){if(!t.isAttachedToDOM)return;const{activeElement:e}=document;t.div.contains(e)&&!this.#a&&(t._focusEventsAllowed=!1,this.#a=setTimeout(()=>{this.#a=null,t.div.contains(document.activeElement)?t._focusEventsAllowed=!0:(t.div.addEventListener("focusin",()=>{t._focusEventsAllowed=!0},{once:!0,signal:this.#c._signal}),e.focus())},0)),t._structTreeParentId=this.#t?.moveElementInDOM(this.div,t.div,t.contentDiv,!0)}addOrRebuild(t){t.needsToBeRebuilt()?(t.parent||=this,t.rebuild(),t.show()):this.add(t)}addUndoableEditor(t){const e=()=>t._uiManager.rebuild(t),s=()=>{t.remove()};this.addCommands({cmd:e,undo:s,mustExec:!1})}getEditorByUID(t){for(const e of this.#n.values())if(e.uid===t)return e;return null}getNextId(){return this.#c.getId()}get#y(){return Kt.#g.get(this.#c.getMode())}combinedSignal(t){return this.#c.combinedSignal(t)}#E(t){const e=this.#y;return e?new e.prototype.constructor(t):null}canCreateNewEmptyEditor(){return this.#y?.canCreateNewEmptyEditor()}async pasteEditor(t,e){this.updateToolbar(t),await this.#c.updateMode(t.mode);const{offsetX:s,offsetY:i}=this.#_(),n=this.getNextId(),r=this.#E({parent:this,id:n,x:s,y:i,uiManager:this.#c,isCentered:!0,...e});r&&this.add(r)}async deserialize(t){return await Kt.#g.get(t.annotationType??t.annotationEditorType)?.deserialize(t,this,this.#c)||null}createAndAddNewEditor(t,e,s={}){const i=this.getNextId(),n=this.#E({parent:this,id:i,x:t.offsetX,y:t.offsetY,uiManager:this.#c,isCentered:e,...s});return n&&this.add(n),n}get boundingClientRect(){return this.div.getBoundingClientRect()}#_(){const{x:t,y:e,width:s,height:i}=this.boundingClientRect,n=Math.max(0,t),r=Math.max(0,e),a=Math.min(window.innerWidth,t+s),o=Math.min(window.innerHeight,e+i),l=(n+a)/2-t,h=(r+o)/2-e,[c,u]=this.viewport.rotation%180===0?[l,h]:[h,l];return{offsetX:c,offsetY:u}}addNewEditor(t={}){this.createAndAddNewEditor(this.#_(),!0,t)}setSelected(t){this.#c.setSelected(t)}toggleSelected(t){this.#c.toggleSelected(t)}unselect(t){this.#c.unselect(t)}pointerup(t){const{isMac:e}=_t.platform;if(t.button!==0||t.ctrlKey&&e||t.target!==this.div||!this.#r||(this.#r=!1,this.#y?.isDrawer&&this.#y.supportMultipleDrawings))return;if(!this.#e){this.#e=!0;return}const s=this.#c.getMode();if(s===V.STAMP||s===V.SIGNATURE){this.#c.unselectAll();return}this.createAndAddNewEditor(t,!1)}pointerdown(t){if(this.#c.getMode()===V.HIGHLIGHT&&this.enableTextSelection(),this.#r){this.#r=!1;return}const{isMac:e}=_t.platform;if(t.button!==0||t.ctrlKey&&e||t.target!==this.div)return;if(this.#r=!0,this.#y?.isDrawer){this.startDrawingSession(t);return}const s=this.#c.getActive();this.#e=!s||s.isEmpty()}startDrawingSession(t){if(this.div.focus({preventScroll:!0}),this.#l){this.#y.startDrawing(this,this.#c,!1,t);return}this.#c.setCurrentDrawingSession(this),this.#l=new AbortController;const e=this.#c.combinedSignal(this.#l);this.div.addEventListener("blur",({relatedTarget:s})=>{s&&!this.div.contains(s)&&(this.#u=null,this.commitOrRemove())},{signal:e}),this.#y.startDrawing(this,this.#c,!1,t)}pause(t){if(t){const{activeElement:e}=document;this.div.contains(e)&&(this.#u=e);return}this.#u&&setTimeout(()=>{this.#u?.focus(),this.#u=null},0)}endDrawingSession(t=!1){return this.#l?(this.#c.setCurrentDrawingSession(null),this.#l.abort(),this.#l=null,this.#u=null,this.#y.endDrawing(t)):null}findNewParent(t,e,s){const i=this.#c.findParent(e,s);return i===null||i===this?!1:(i.changeParent(t),!0)}commitOrRemove(){return this.#l?(this.endDrawingSession(),!0):!1}onScaleChanging(){this.#l&&this.#y.onScaleChangingWhenDrawing(this)}destroy(){this.commitOrRemove(),this.#c.getActive()?.parent===this&&(this.#c.commitOrRemove(),this.#c.setActiveEditor(null)),this.#a&&(clearTimeout(this.#a),this.#a=null);for(const t of this.#n.values())this.#t?.removePointerInTextLayer(t.contentDiv),t.setParent(null),t.isAttachedToDOM=!1,t.div.remove();this.div=null,this.#n.clear(),this.#c.removeLayer(this)}#v(){for(const t of this.#n.values())t.isEmpty()&&t.remove()}render({viewport:t}){this.viewport=t,le(this.div,t);for(const e of this.#c.getEditors(this.pageIndex))this.add(e),e.rebuild();this.updateMode()}update({viewport:t}){this.#c.commitOrRemove(),this.#v();const e=this.viewport.rotation,s=t.rotation;if(this.viewport=t,le(this.div,{rotation:s}),e!==s)for(const i of this.#n.values())i.rotate(s)}get pageDimensions(){const{pageWidth:t,pageHeight:e}=this.viewport.rawDims;return[t,e]}get scale(){return this.#c.viewParameters.realScale}}class At{#t=null;#e=new Map;#i=new Map;static#s=0;constructor({pageIndex:t}){this.pageIndex=t}setParent(t){if(!this.#t){this.#t=t;return}if(this.#t!==t){if(this.#e.size>0)for(const e of this.#e.values())e.remove(),t.append(e);this.#t=t}}static get _svgFactory(){return W(this,"_svgFactory",new as)}static#a(t,[e,s,i,n]){const{style:r}=t;r.top=`${100*s}%`,r.left=`${100*e}%`,r.width=`${100*i}%`,r.height=`${100*n}%`}#n(){const t=At._svgFactory.create(1,1,!0);return this.#t.append(t),t.setAttribute("aria-hidden",!0),t}#r(t,e){const s=At._svgFactory.createElement("clipPath");t.append(s);const i=`clip_${e}`;s.setAttribute("id",i),s.setAttribute("clipPathUnits","objectBoundingBox");const n=At._svgFactory.createElement("use");return s.append(n),n.setAttribute("href",`#${e}`),n.classList.add("clip"),i}#o(t,e){for(const[s,i]of Object.entries(e))i===null?t.removeAttribute(s):t.setAttribute(s,i)}draw(t,e=!1,s=!1){const i=At.#s++,n=this.#n(),r=At._svgFactory.createElement("defs");n.append(r);const a=At._svgFactory.createElement("path");r.append(a);const o=`path_p${this.pageIndex}_${i}`;a.setAttribute("id",o),a.setAttribute("vector-effect","non-scaling-stroke"),e&&this.#i.set(i,a);const l=s?this.#r(r,o):null,h=At._svgFactory.createElement("use");return n.append(h),h.setAttribute("href",`#${o}`),this.updateProperties(n,t),this.#e.set(i,n),{id:i,clipPathId:`url(#${l})`}}drawOutline(t,e){const s=At.#s++,i=this.#n(),n=At._svgFactory.createElement("defs");i.append(n);const r=At._svgFactory.createElement("path");n.append(r);const a=`path_p${this.pageIndex}_${s}`;r.setAttribute("id",a),r.setAttribute("vector-effect","non-scaling-stroke");let o;if(e){const c=At._svgFactory.createElement("mask");n.append(c),o=`mask_p${this.pageIndex}_${s}`,c.setAttribute("id",o),c.setAttribute("maskUnits","objectBoundingBox");const u=At._svgFactory.createElement("rect");c.append(u),u.setAttribute("width","1"),u.setAttribute("height","1"),u.setAttribute("fill","white");const f=At._svgFactory.createElement("use");c.append(f),f.setAttribute("href",`#${a}`),f.setAttribute("stroke","none"),f.setAttribute("fill","black"),f.setAttribute("fill-rule","nonzero"),f.classList.add("mask")}const l=At._svgFactory.createElement("use");i.append(l),l.setAttribute("href",`#${a}`),o&&l.setAttribute("mask",`url(#${o})`);const h=l.cloneNode();return i.append(h),l.classList.add("mainOutline"),h.classList.add("secondaryOutline"),this.updateProperties(i,t),this.#e.set(s,i),s}finalizeDraw(t,e){this.#i.delete(t),this.updateProperties(t,e)}updateProperties(t,e){if(!e)return;const{root:s,bbox:i,rootClass:n,path:r}=e,a=typeof t=="number"?this.#e.get(t):t;if(a){if(s&&this.#o(a,s),i&&At.#a(a,i),n){const{classList:o}=a;for(const[l,h]of Object.entries(n))o.toggle(l,h)}if(r){const l=a.firstChild.firstChild;this.#o(l,r)}}}updateParent(t,e){if(e===this)return;const s=this.#e.get(t);s&&(e.#t.append(s),this.#e.delete(t),e.#e.set(t,s))}remove(t){this.#i.delete(t),this.#t!==null&&(this.#e.get(t).remove(),this.#e.delete(t))}destroy(){this.#t=null;for(const t of this.#e.values())t.remove();this.#e.clear(),this.#i.clear()}}globalThis._pdfjsTestingUtils={HighlightOutliner:Fs};globalThis.pdfjsLib={AbortException:ee,AnnotationEditorLayer:Kt,AnnotationEditorParamsType:K,AnnotationEditorType:V,AnnotationEditorUIManager:se,AnnotationLayer:Qs,AnnotationMode:Zt,AnnotationType:gt,applyOpacity:zn,build:Yr,ColorPicker:Bt,createValidAbsoluteUrl:Ni,CSSConstants:Un,DOMSVGFactory:as,DrawLayer:At,FeatureTest:_t,fetchData:je,findContrastColor:$n,getDocument:nn,getFilenameFromUrl:Nn,getPdfFilenameFromUrl:Fn,getRGB:Ue,getUuid:Bi,getXfaPageViewport:Bn,GlobalWorkerOptions:xe,ImageKind:es,InvalidPDFException:Ts,isDataScheme:ds,isPdfFile:Us,isValidExplicitDest:Zn,MathClamp:Pt,noContextMenu:jt,normalizeUnicode:Ln,OPS:Ie,OutputScale:qt,PasswordResponses:_n,PDFDataRangeTransport:rn,PDFDateString:ks,PDFWorker:Fe,PermissionFlag:xn,PixelsPerInch:Se,RenderingCancelledException:Hs,renderRichText:Ui,ResponseException:ns,setLayerDimensions:le,shadow:W,SignatureExtractor:me,stopEvent:ht,SupportedImageMimeTypes:Ps,TextLayer:Tt,TouchManager:us,updateUrlHash:Fi,Util:B,VerbosityLevel:ls,version:Xr,XfaLayer:Hi};const va="/static/dist/assets/pdf.worker-9aISQa3R.mjs";xe.workerSrc=va;const Aa=1080,xa=.68;function Es(...d){return d.filter(Boolean).join(" ")}function _a(d){if(d instanceof Error)return d;if(typeof d=="string")return new Error(d);try{return new Error(JSON.stringify(d))}catch{return new Error("An unknown error occurred while loading the flipbook.")}}function Ii(d){d&&(d.onmouseenter=null,d.onmouseleave=null,d.onmousemove=null,d.onclick=null,d.onmousedown=null,d.onmouseup=null)}function Sa({pdfUrl:d,className:t,maxWidth:e=Aa,aspectRatio:s=xa,onLoading:i,onReady:n,onError:r}){const a=et.useRef(null),o=et.useRef(null),l=et.useRef(null),h=et.useRef(null),c=et.useRef(null),u=et.useRef({onLoading:i,onReady:n,onError:r}),[f,m]=et.useState("idle"),[p,b]=et.useState(e),[g,v]=et.useState(0),[y,S]=et.useState(0);et.useEffect(()=>{u.current={onLoading:i,onReady:n,onError:r}},[i,n,r]),et.useEffect(()=>{const N=a.current;if(!N)return;const H=ct=>{const Y=Math.round(ct);b(z=>!z||Math.abs(z-Y)>1?Y:z)};H(N.clientWidth||e);const q=new ResizeObserver(ct=>{for(const Y of ct)H(Y.contentRect.width)});return q.observe(N),()=>q.disconnect()},[e]),et.useEffect(()=>{const N=o.current;if(!N||p<=0)return;let H=!1,q=null;const ct=new Map,Y=Math.min(p,e),z=Math.round(Y*s);Ii(N),N.innerHTML="",N.style.maxWidth=`${Math.round(e)}px`,N.style.minHeight=`${z}px`,h.current?.destroy().catch(()=>{}),h.current=null,m("loading"),u.current.onLoading?.();const J=nn(d);h.current=J;const Et=ft=>{if(H)return;const Z=_a(ft);m("error"),u.current.onError?.(Z),console.error("[FlipbookViewer] Initialization failed:",Z)};return J.promise.then(ft=>{if(H)return;q=ft;const Z=(L,$)=>{if(!q){$(new Error("PDF document has not finished loading."));return}if(!L||L>q.numPages){$(null);return}const it=ct.get(L);if(it){$(null,it);return}q.getPage(L).then(X=>{if(H){$();return}const mt=X.getViewport({scale:1.25}),dt=window.devicePixelRatio||1,tt=document.createElement("canvas"),Ct=tt.getContext("2d");if(!Ct){$(new Error("Unable to acquire a 2D canvas context for the PDF page render."));return}tt.width=Math.floor(mt.width*dt),tt.height=Math.floor(mt.height*dt),tt.style.width=`${Math.floor(mt.width)}px`,tt.style.height=`${Math.floor(mt.height)}px`;const St=dt!==1?[dt,0,0,dt,0,0]:void 0;X.render({canvasContext:Ct,viewport:mt,transform:St,canvas:tt}).promise.then(()=>{if(H){$();return}const bt=new Image;bt.src=tt.toDataURL("image/png");const si=()=>{if(H){$();return}const ii={img:bt,num:L,width:bt.width,height:bt.height};ct.set(L,ii),$(null,ii)};bt.complete?si():(bt.addEventListener("load",si,{once:!0}),bt.addEventListener("error",()=>$(new Error(`Failed to load rendered image for page ${L}.`)),{once:!0}))}).catch(bt=>{console.error(`[FlipbookViewer] Rendering error on page ${L}:`,bt),$(bt)})}).catch(X=>{console.error(`[FlipbookViewer] Failed to retrieve page ${L}:`,X),$(X)})},wt={numPages:()=>q?.numPages??0,getPage:(L,$)=>Z(L,$)},Xt={backgroundColor:"rgba(248, 248, 248, 0.92)",boxBorder:0,width:Y,height:z,marginTop:6,marginLeft:6};An.init(wt,N,Xt,(L,$)=>{if(H)return;if(L){Et(L);return}if(l.current=$??null,S($?.page_count??0),v(0),$&&typeof $.on=="function"){const X=dt=>{H||typeof dt=="number"&&v(dt)};$.on("seen",X);const mt=()=>{$&&(typeof $.off=="function"?$.off("seen",X):typeof $.removeListener=="function"&&$.removeListener("seen",X))};c.current?.(),c.current=mt}m("ready"),u.current.onReady?.();const it=Math.min(wt.numPages(),6);for(let X=1;X<=it;X+=1)Z(X,()=>{})})}).catch(ft=>Et(ft)),()=>{H=!0,Ii(N),N.innerHTML="",h.current?.destroy().catch(()=>{}),h.current=null,l.current=null,c.current?.(),c.current=null,S(0),v(0),ct.clear(),q=null}},[d,p,e,s]);const A=Math.min(p||e,e),w=Math.round(A*s),_=et.useMemo(()=>y<=1?1:1+Math.ceil((y-1)/2),[y]),x=et.useMemo(()=>Math.min(_,Math.max(1,Math.floor(g/2)+1)),[g,_]),E=et.useMemo(()=>{if(x===1)return 1;const N=(x-1)*2;return Math.max(1,Math.min(y,N))},[x,y]),k=et.useMemo(()=>x===1?1:Math.max(1,Math.min(y,E+1)),[x,E,y]),T=f==="ready"&&x===1,P=et.useMemo(()=>T?{background:"linear-gradient(90deg, rgba(248,248,248,0) 0%, rgba(248,248,248,0.72) 45%, rgba(248,248,248,0.92) 100%)"}:{background:"rgba(248,248,248,0.92)"},[T]),M=et.useMemo(()=>({background:"linear-gradient(90deg, rgba(248,248,248,0.88) 0%, rgba(248,248,248,0.45) 100%)",mixBlendMode:"multiply"}),[]),I=x<_,R=x>1,D=()=>{const N=l.current;!N||!I||N.flip_forward()},O=()=>{const N=l.current;!N||!R||N.flip_back()};return C.jsx("div",{ref:a,className:Es("w-full",t),style:{minHeight:`${w}px`},"data-status":f,children:C.jsxs("div",{className:"relative mx-auto",style:{width:"100%",maxWidth:`${Math.round(e)}px`,minHeight:`${w}px`},children:[C.jsx("div",{className:"pointer-events-none absolute inset-0 z-0 rounded-[36px] border border-border-grey/40 shadow-xl shadow-primary-blue/10 transition-all duration-700 ease-out",style:{...P,minHeight:`${w}px`},"aria-hidden":"true"}),T&&C.jsx("div",{className:"pointer-events-none absolute inset-y-8 left-0 z-10 w-[52%] rounded-l-[30px]",style:M,"aria-hidden":"true"}),C.jsx("div",{ref:o,className:"relative z-20 transition-opacity duration-500 ease-out",style:{width:"100%",minHeight:`${w}px`,opacity:f==="ready"?1:0,pointerEvents:f==="ready"?"auto":"none"},"aria-live":"polite","aria-busy":f!=="ready"}),f==="ready"&&C.jsxs("div",{className:"pointer-events-none absolute inset-0 z-30 flex items-center justify-between px-4",children:[C.jsx("button",{type:"button",onClick:O,"aria-label":"Previous spread",disabled:!R,className:Es("pointer-events-auto inline-flex h-12 w-12 items-center justify-center rounded-full border border-border-grey/60 bg-white/85 text-primary-blue shadow-lg shadow-primary-blue/25 transition-all hover:scale-105 hover:bg-primary-blue hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-primary-blue/50",!R&&"opacity-40 hover:scale-100 hover:bg-white"),children:C.jsx("span",{"aria-hidden":"true",className:"text-xl font-semibold",children:"‹"})}),C.jsx("div",{className:"pointer-events-none absolute bottom-6 left-1/2 -translate-x-1/2 rounded-full border border-border-grey/60 bg-white/85 px-5 py-1.5 text-xs font-semibold uppercase tracking-[0.2em] text-light-text shadow-md shadow-primary-blue/15",children:x===1?`Page 1 / ${y}`:`Page ${E}–${k} / ${y}`}),C.jsx("button",{type:"button",onClick:D,"aria-label":"Next spread",disabled:!I,className:Es("pointer-events-auto inline-flex h-12 w-12 items-center justify-center rounded-full border border-border-grey/60 bg-white/85 text-primary-blue shadow-lg shadow-primary-blue/25 transition-all hover:scale-105 hover:bg-primary-blue hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-primary-blue/50",!I&&"opacity-40 hover:scale-100 hover:bg-white"),children:C.jsx("span",{"aria-hidden":"true",className:"text-xl font-semibold",children:"›"})})]})]})})}function Ea(){return typeof window>"u"||typeof window.matchMedia!="function"?!1:window.matchMedia("(prefers-reduced-motion: reduce)").matches}function ei(){const[d,t]=et.useState(Ea);return et.useEffect(()=>{if(typeof window>"u"||typeof window.matchMedia!="function")return;const e=window.matchMedia("(prefers-reduced-motion: reduce)"),s=i=>{t(i.matches)};return typeof e.addEventListener=="function"?e.addEventListener("change",s):typeof e.addListener=="function"&&e.addListener(s),()=>{typeof e.removeEventListener=="function"?e.removeEventListener("change",s):typeof e.removeListener=="function"&&e.removeListener(s)}},[]),d}function ue({threshold:d=.2,rootMargin:t="0px",once:e=!0,onReveal:s}={}){const i=et.useRef(null),n=ei();return et.useEffect(()=>{const r=i.current;if(!r)return;if(n){r.classList.add("is-visible"),s?.();return}const a=new IntersectionObserver(o=>{o.forEach(l=>{l.isIntersecting&&(l.target.classList.add("is-visible"),s?.(),e&&a.unobserve(l.target))})},{threshold:d,rootMargin:t});return a.observe(r),()=>{a.disconnect()}},[n,d,t,e,s]),i}const gn="/static/dist/assets/relax_picture-DuVMS5Km.png",Ca="/static/dist/assets/worry_picture-DmzCWqeS.png",Ta="/static/dist/assets/solution_address_picture-DTYEpwJe.png",ka="/static/documents/quell_ai_interactive.pdf",Pa=[{heading:"Pages",links:[{label:"About",href:"/"}]},{heading:"Resources",links:[{label:"ChatLab",href:"/labs/conversation-lab"},{label:"VoiceLab",href:"/labs/conversation-lab"}]}],Ma=[{before:["Developers often spend two or three hours a day responding to status messages and attending check-ins that break focus.","Important updates get buried in endless notifications, and meaningful creative flow is lost in the noise."],after:["Quell AI joins calls or threads on your behalf, listens, and creates clear, concise summaries.","It distills only what matters: key decisions, blockers, and next actions, allowing teams to stay informed without sacrificing productivity."]},{before:["Knowledge tends to scatter across documents, chats, and dashboards, making it difficult to retrieve when it is most needed.","Teams waste time searching for context or recreating already existing information."],after:["Quell AI keeps a continuous record of relevant knowledge within your authorized ecosystem.","When context is requested, whether in a chat, meeting, or email, it provides instant, precise answers derived from approved sources."]},{before:["Team leads often feel overwhelmed managing multiple priorities, schedules, and communications.","The mental overhead of coordination becomes a bottleneck to effective leadership."],after:["Quell AI automates repetitive coordination by sending follow-ups, documenting outcomes, and highlighting actionable insights.","This allows leaders to focus on strategy and human connection rather than constant information triage."]}],Ra=[{title:"Reduced Collaboration Fatigue",description:"When communication tools demand constant attention, focus suffers. Quell AI minimizes unnecessary noise by handling routine participation autonomously and aims to simplify collaboration rather than amplify complexity."},{title:"Accelerated Understanding",description:"Instead of chasing updates across platforms, Quell AI ensures knowledge is surfaced instantly, allowing teams to move from alignment to action faster."},{title:"Privacy by Design",description:"Every decision in Quell AI's architecture begins with user control and data minimization so your information remains yours."},{title:"Built for the Modern Workforce",description:"Designed for hybrid, distributed teams, Quell AI brings context continuity regardless of time zone or presence."}],La=["Phase 1: Meeting agent","Phase 2: Knowledge concierge","Phase 3: Team memory graph"],Da=[{title:"Bounded access",paragraphs:["Quell AI operates strictly within the permissions you grant. Using directory or group-based scoping, it can only access content you explicitly allow.","This balance between automation and trust ensures that your digital twin never sees more than you intend it to."]},{title:"Contextual answers",paragraphs:["At its core, Quell AI leverages retrieval-augmented generation (RAG) to draw precise responses from your approved data.","The agent stays relevant and context aware, so answers are not just accurate but situationally meaningful."]},{title:"Live presence",paragraphs:["Quell AI can attend meetings, transcribe discussions, and summarize action items in real time.","It bridges asynchronous and live collaboration by ensuring continuity so every conversation becomes searchable, referenceable knowledge."]},{title:"User control",paragraphs:["You remain the ultimate authority. Every action can be reviewed or overridden, and meeting organizers can always choose human presence over automation.","The AI assists; it never replaces human intent or accountability."]}];function Jt(...d){return d.filter(Boolean).join(" ")}function Ga(){const d=mn(),[t,e]=et.useState(!1),[s,i]=et.useState(null),[n,r]=et.useState(null),a=ei(),o=et.useRef(null);et.useEffect(()=>{yn()},[]);const l=u=>{const f=o.current;f&&(r(u),f.scrollIntoView({behavior:a?"auto":"smooth",block:"start"}))},h=()=>{d("/signup")},c=()=>s?C.jsx("div",{className:"pointer-events-none absolute inset-0 z-20 flex items-center justify-center px-4",children:C.jsxs("div",{className:"mx-auto flex w-full max-w-3xl flex-col items-center justify-center rounded-2xl border border-red-200/80 bg-red-50/85 p-12 text-center shadow-xl shadow-red-200/30 backdrop-blur",children:[C.jsx("span",{className:"text-lg font-semibold text-red-700",children:"Unable to load the interactive codex."}),C.jsx("span",{className:"mt-3 text-sm text-red-600",children:s.message})]})}):t?null:C.jsx("div",{className:"pointer-events-none absolute inset-0 z-20 flex items-center justify-center px-4",children:C.jsxs("div",{className:"mx-auto flex w-full max-w-3xl flex-col items-center justify-center rounded-2xl border border-border-grey/70 bg-white/80 p-12 text-center shadow-xl shadow-primary-blue/20 backdrop-blur",children:[C.jsx("span",{className:"text-lg font-semibold text-dark-text",children:"Preparing the interactive codex."}),C.jsx("span",{className:"mt-2 text-sm text-light-text",children:"Rendering pages from the PDF document."}),C.jsx("span",{className:"mt-6 h-1.5 w-40 animate-pulse rounded-full bg-primary-blue/60"})]})});return C.jsx("div",{className:"bg-light-background font-sans text-dark-text antialiased",children:C.jsxs("div",{className:"relative min-h-screen w-full overflow-x-hidden",children:[C.jsx(wn,{}),C.jsxs("div",{className:"relative z-10 mx-auto max-w-7xl px-4 sm:px-6 lg:px-8",children:[C.jsx(bn,{}),C.jsxs("main",{className:"snap-container flex flex-col",children:[C.jsx("section",{id:"about",className:"snap-section relative flex min-h-[calc(100vh-120px)] flex-col items-center justify-center pt-6 pb-16 text-center",children:C.jsx("div",{className:"hero-shell relative z-10 w-full max-w-6xl overflow-hidden rounded-[40px] border border-primary-blue/20 bg-white/85 p-10 text-left shadow-xl shadow-primary-blue/20 backdrop-blur-lg sm:px-14 md:px-16 md:py-14",children:C.jsxs("div",{className:"grid gap-10 md:grid-cols-[minmax(0,0.95fr)_minmax(0,0.75fr)] md:items-center",children:[C.jsxs("div",{className:"flex flex-col gap-6",children:[C.jsx("span",{className:"text-xs font-semibold uppercase tracking-[0.4em] text-primary-blue/70",children:"Proposal Preview"}),C.jsx("h1",{className:"font-serif text-4xl font-bold leading-tight text-dark-text md:text-5xl lg:text-6xl",children:"Quell AI: Rethinking Collaboration Through Intelligent Presence"}),C.jsxs("div",{className:"space-y-4 text-base text-light-text md:text-lg",children:[C.jsx("p",{children:"In an age of constant pings, overlapping meetings, and fragmented communication, Quell AI proposes a new way forward. It is not a product yet; it is a vision."}),C.jsx("p",{children:"The concept imagines a collaboration agent that represents you intelligently when you cannot be there, maintaining context, capturing intent, and helping teams stay in sync without adding more noise."})]}),C.jsx("div",{className:Jt("hero-keywords mt-4 flex flex-wrap items-center gap-3 text-sm font-semibold uppercase tracking-[0.35em] text-primary-blue",a&&"hero-keywords--static"),children:["Collaboration","Context","Continuity"].map((u,f)=>C.jsx("span",{className:"hero-keyword",style:{animationDelay:`${f*1.6}s`},children:u},u))}),C.jsx("button",{className:Jt("proposal-button mt-6 inline-flex h-12 min-w-[160px] items-center justify-center overflow-hidden rounded-full border border-primary-blue/30 bg-primary-blue px-7 text-sm font-bold text-white shadow-lg shadow-primary-blue/25 transition-all hover:scale-105 hover:bg-hover-blue focus:outline-none focus-visible:ring-2 focus-visible:ring-primary-blue/60",n==="hero"&&"button-active"),onClick:()=>l("hero"),children:"View Proposal"})]}),C.jsxs("figure",{className:"hero-figure relative flex justify-center",children:[C.jsx("img",{src:gn,alt:"Concept illustration depicting an AI assistant supporting a focused professional",loading:"lazy",decoding:"async",className:Jt("hero-illustration w-full max-w-md rounded-[32px] border border-primary-blue/15 shadow-xl",a&&"hero-illustration--static")}),C.jsx("figcaption",{className:"sr-only",children:"Concept illustration showing Quell AI as an intelligent presence that protects focus."})]})]})})}),C.jsxs("div",{className:"flex flex-col gap-24 pb-24 md:gap-28",children:[C.jsx(Ia,{}),C.jsx(Na,{}),C.jsx(Fa,{}),C.jsx(Oa,{}),C.jsx(Ba,{}),C.jsx(ja,{}),C.jsx(Ha,{activeProposalButton:n,onExploreCodex:l,onJoinBeta:h}),C.jsx("section",{id:"codex",ref:o,className:"relative w-full",children:C.jsxs("div",{className:"relative mx-auto w-full max-w-6xl",children:[c(),C.jsx(Sa,{pdfUrl:ka,className:"relative z-10",onLoading:()=>{e(!1),i(null)},onReady:()=>e(!0),onError:u=>{e(!1),i(u)}})]})})]})]}),C.jsxs("footer",{className:"relative z-10 mx-auto mt-20 max-w-7xl border-t border-border-grey bg-light-background/90 px-4 py-10 text-center backdrop-blur-sm sm:px-6 lg:px-8",children:[C.jsxs("div",{className:"grid grid-cols-1 gap-8 text-left md:grid-cols-3",children:[Pa.map(u=>C.jsxs("div",{children:[C.jsx("h4",{className:"font-bold text-dark-text",children:u.heading}),C.jsx("ul",{className:"mt-4 space-y-2",children:u.links.map(f=>C.jsx("li",{children:C.jsx("button",{type:"button",className:"text-left text-sm text-light-text hover:text-dark-text",onClick:()=>d(f.href),children:f.label})},f.label))})]},u.heading)),C.jsxs("div",{children:[C.jsx("h4",{className:"font-bold text-dark-text",children:"Connect"}),C.jsx("div",{className:"mt-4 flex gap-4",children:C.jsx("a",{className:"footer-linkedin",href:"https://www.linkedin.com/in/john-vimrish/",target:"_blank",rel:"noopener noreferrer","aria-label":"LinkedIn",children:C.jsx("svg",{"aria-hidden":"true",className:"h-6 w-6",fill:"currentColor",viewBox:"0 0 24 24",children:C.jsx("path",{clipRule:"evenodd",d:"M16.338 16.338H13.67V12.16c0-.995-.017-2.277-1.387-2.277-1.39 0-1.601 1.086-1.601 2.206v4.248H8.014v-8.59h2.559v1.174h.037c.356-.675 1.225-1.387 2.526-1.387 2.703 0 3.203 1.778 3.203 4.092v4.711zM5.005 6.575a1.548 1.548 0 11-.003-3.096 1.548 1.548 0 01.003 3.096zm-1.47 1.344h2.94v8.59H3.535v-8.59z",fillRule:"evenodd"})})})})]})]}),C.jsx("div",{className:"mt-10 border-t border-border-grey pt-6",children:C.jsx("p",{className:"text-sm text-light-text",children:"© 2024 CogniLex Codex. All Rights Reserved."})})]})]})]})})}function Ia(){const d=ue();return C.jsxs("section",{id:"about-why",ref:d,className:"reveal snap-section relative overflow-hidden rounded-[32px] border border-border-grey/60 bg-gradient-to-br from-white/95 via-white/85 to-primary-blue/10 px-6 py-16 shadow-xl shadow-primary-blue/15 backdrop-blur lg:px-16 lg:py-20","aria-labelledby":"about-why-heading",children:[C.jsxs("div",{className:"pointer-events-none absolute inset-0",children:[C.jsx("span",{className:"about-float",style:{width:"320px",height:"320px",top:"-120px",left:"-140px",background:"rgba(42, 58, 91, 0.4)"},"aria-hidden":"true"}),C.jsx("span",{className:"about-float about-float--secondary",style:{width:"260px",height:"260px",bottom:"-110px",right:"-120px",background:"rgba(158, 191, 214, 0.45)"},"aria-hidden":"true"}),C.jsx("span",{className:"about-float about-float--tertiary",style:{width:"220px",height:"220px",top:"40%",left:"25%",background:"rgba(90, 121, 181, 0.35)"},"aria-hidden":"true"})]}),C.jsxs("div",{className:"relative z-10 mx-auto flex max-w-3xl flex-col items-center gap-6 text-center",children:[C.jsx("p",{className:"typewriter text-xs font-semibold uppercase tracking-[0.4em] text-primary-blue/70",children:"Work is noisy. Focus is rare."}),C.jsx("h2",{id:"about-why-heading",className:"max-w-2xl font-serif text-3xl font-bold text-dark-text md:text-4xl",children:"Collaboration should feel calm, not chaotic."}),C.jsxs("div",{className:"space-y-4 text-lg text-light-text md:text-xl",children:[C.jsx("p",{children:"Todayâ€™s workspaces are louder than ever, not with sound but with signals. Every notification demands attention, every platform promises connection, and every meeting adds another layer of complexity."}),C.jsx("p",{children:"Quell AI proposes a quieter, smarter form of collaboration where communication flows naturally and your focus remains untouched."}),C.jsx("p",{children:"By learning context, preserving intent, and acting only when needed, Quell AI turns digital chaos into cognitive calm. It empowers teams to collaborate intentionally instead of reactively."})]}),C.jsxs("div",{className:"mt-4 flex flex-wrap justify-center gap-3 text-xs font-semibold uppercase tracking-[0.32em] text-primary-blue/70",children:[C.jsx("span",{children:"Intentional Collaboration"}),C.jsx("span",{children:"Focus First"}),C.jsx("span",{children:"Signals, not Noise"})]})]})]})}function Na(){const d=ue(),t=ei(),e=et.useMemo(()=>["In today’s connected world, collaboration is the heartbeat of productivity. Teams depend on constant communication through platforms such as Teams, Google Meet, and Zoom to align, share knowledge, and deliver results. Yet the same tools that enable connection can easily become a source of fatigue.","Imagine a developer juggling several projects or a team lead managing multiple groups. Continuous meeting requests, follow-up emails, and overlapping conversations often disrupt focus and delay outcomes. When someone takes unplanned leave or faces an emergency, the flow of information breaks and others must document decisions, resend context, or request minutes after the fact.","Many AI tools already translate languages, summarize meetings, or schedule sessions, but they solve isolated problems. What is missing is continuity: an AI that does not simply assist but can truly stand in for you.","Quell AI addresses that gap. It is a proposal, not a finished product, outlining what intelligent collaboration could become. The concept envisions an agent or bot that can activate during your absence or whenever you choose, operating under strict, user-defined permissions.","The agent would access only the data you authorize, scoped through your organization’s Active Directory groups. It could answer questions or provide information on your behalf using retrieval-augmented generation to deliver data-backed responses. It could join meetings in your place, recording, transcribing, and summarizing in real time, and even speak naturally in your voice when the required information is within reach.","The goal is not to replace people but to help them stay connected, focused, and efficient even when real-time participation is impossible. From emergencies to time zone gaps between onshore and offshore teams, Quell AI’s vision bridges these divides and orchestrates collaboration responsibly."],[]),s=[{src:Ca,alt:"Illustration showing overwhelming notifications and communication overload",caption:"Every ping steals a moment of focus."},{src:Ta,alt:"Illustration showing an AI aura forming around a workspace",caption:"Then came an idea: what if collaboration could think with you?"},{src:gn,alt:"Illustration depicting an AI presence supporting calm, balanced work",caption:"When you cannot be there, your work still moves forward."}];return C.jsxs("section",{id:"about-origin",ref:d,className:"reveal snap-section grid gap-12 rounded-[32px] border border-border-grey/60 bg-white/80 p-8 shadow-lg shadow-primary-blue/10 backdrop-blur md:grid-cols-[minmax(0,1.05fr)_minmax(0,0.95fr)] lg:p-14","aria-labelledby":"about-origin-heading",children:[C.jsxs("div",{className:"flex flex-col gap-5",children:[C.jsx("p",{className:"text-xs font-semibold uppercase tracking-[0.4em] text-primary-blue/70",children:"Origin Story"}),C.jsx("h2",{id:"about-origin-heading",className:"font-serif text-3xl font-bold text-dark-text md:text-4xl",children:"It began with a simple question: what if meetings could run themselves?"}),C.jsx("div",{className:"space-y-4 text-base leading-relaxed text-light-text md:text-lg",children:e.map(i=>C.jsx("p",{children:i},i))})]}),C.jsx("div",{className:"flex flex-col gap-6",children:s.map((i,n)=>C.jsxs("figure",{className:Jt("about-card relative overflow-hidden rounded-[28px] border border-primary-blue/20 bg-white/90 p-4 shadow-md shadow-primary-blue/15","storyboard-frame"),style:{transitionDelay:`${n*90}ms`},children:[C.jsx("img",{src:i.src,alt:i.alt,loading:"lazy",decoding:"async",className:Jt("storyboard-image w-full rounded-[22px] border border-primary-blue/15 object-cover",t&&"storyboard-image--static")}),C.jsx("figcaption",{className:"mt-3 text-sm font-medium text-primary-blue/80",children:i.caption})]},i.caption))})]})}function Fa(){const d=ue();return C.jsxs("section",{id:"about-scenarios",ref:d,className:"reveal rounded-[32px] border border-border-grey/50 bg-white/85 p-8 shadow-lg shadow-primary-blue/10 backdrop-blur lg:p-14","aria-labelledby":"about-scenarios-heading",children:[C.jsxs("div",{className:"mb-10 flex flex-col gap-3 text-center",children:[C.jsx("p",{className:"text-xs font-semibold uppercase tracking-[0.4em] text-primary-blue/70",children:"Before vs After"}),C.jsx("h2",{id:"about-scenarios-heading",className:"font-serif text-3xl font-bold text-dark-text md:text-4xl",children:"From interruption fatigue to intentional collaboration."})]}),C.jsx("div",{className:"grid gap-6",children:Ma.map((t,e)=>C.jsxs("div",{className:Jt("about-card grid gap-6 rounded-3xl border border-border-grey/60 bg-white/90 p-6 shadow-md shadow-primary-blue/10 transition-all lg:p-8","sm:grid-cols-2"),style:{transitionDelay:`${e*60}ms`},children:[C.jsxs("div",{children:[C.jsx("span",{className:"text-xs font-semibold uppercase tracking-[0.34em] text-red-500/70",children:"Before"}),t.before.map((s,i)=>C.jsx("p",{className:Jt("mt-3 text-base text-dark-text md:text-lg",i===0&&"font-semibold"),children:s},s))]}),C.jsxs("div",{children:[C.jsx("span",{className:"text-xs font-semibold uppercase tracking-[0.34em] text-accent-green/80",children:"After"}),t.after.map((s,i)=>C.jsx("p",{className:Jt("mt-3 text-base text-dark-text md:text-lg",i===0&&"font-semibold"),children:s},s))]})]},e))})]})}function Oa(){const d=ue();return C.jsxs("section",{id:"about-stats",ref:d,className:"reveal snap-section rounded-[32px] border border-border-grey/50 bg-gradient-to-br from-white/95 via-white/80 to-primary-blue/10 p-8 shadow-lg shadow-primary-blue/15 backdrop-blur lg:p-14","aria-labelledby":"about-stats-heading",children:[C.jsxs("div",{className:"mb-10 flex flex-col gap-3 text-center",children:[C.jsx("p",{className:"text-xs font-semibold uppercase tracking-[0.4em] text-primary-blue/70",children:"Why Teams Need Quell AI"}),C.jsx("h2",{id:"about-stats-heading",className:"font-serif text-3xl font-bold text-dark-text md:text-4xl",children:"Why teams need Quell AI."})]}),C.jsxs("div",{className:"mx-auto max-w-3xl space-y-6 text-left text-base text-light-text md:text-lg",children:[C.jsx("p",{className:"text-dark-text",children:"Insights from today's fast-paced work environments show that modern collaboration tools often add friction instead of removing it. Quell AI is designed to simplify collaboration rather than amplify complexity, turning scattered interactions into meaningful outcomes."}),C.jsx("ul",{className:"space-y-4",children:Ra.map(t=>C.jsxs("li",{className:"about-card rounded-3xl border border-border-grey/60 bg-white/92 p-5 shadow-sm",children:[C.jsx("p",{className:"text-sm font-semibold uppercase tracking-[0.3em] text-primary-blue/70",children:t.title}),C.jsx("p",{className:"mt-2 text-base text-dark-text",children:t.description})]},t.title))})]})]})}function Ba(){const d=ue();return C.jsxs("section",{id:"about-agent",ref:d,className:"reveal grid gap-12 rounded-[32px] border border-border-grey/60 bg-white/90 p-8 shadow-lg shadow-primary-blue/15 backdrop-blur md:grid-cols-[minmax(0,1.1fr)_minmax(0,0.9fr)] lg:p-14","aria-labelledby":"about-agent-heading",children:[C.jsxs("div",{className:"flex flex-col gap-6",children:[C.jsx("p",{className:"text-xs font-semibold uppercase tracking-[0.4em] text-primary-blue/70",children:"How it works"}),C.jsx("h2",{id:"about-agent-heading",className:"font-serif text-3xl font-bold text-dark-text md:text-4xl",children:"Your time, protected. Your context, amplified."}),C.jsx("ul",{className:"mt-2 grid gap-4",children:Da.map(t=>C.jsxs("li",{className:"about-card flex gap-4 rounded-2xl border border-border-grey/60 bg-white/95 p-5 shadow-sm",children:[C.jsx("span",{className:"mt-1 inline-flex h-10 w-10 flex-shrink-0 items-center justify-center rounded-full bg-primary-blue/10 text-primary-blue",children:C.jsx("svg",{className:"h-5 w-5",viewBox:"0 0 24 24","aria-hidden":"true",fill:"none",stroke:"currentColor",strokeWidth:"1.75",children:C.jsx("path",{d:"M20 6L9 17l-5-5",strokeLinecap:"round",strokeLinejoin:"round"})})}),C.jsxs("div",{children:[C.jsx("h3",{className:"text-base font-semibold text-dark-text",children:t.title}),t.paragraphs.map(e=>C.jsx("p",{className:"mt-2 text-sm text-light-text",children:e},e))]})]},t.title))})]}),C.jsxs("div",{className:"about-card about-connector flex flex-col justify-center gap-6 rounded-3xl border border-primary-blue/20 bg-white/85 p-8 text-center shadow-md shadow-primary-blue/15",children:[C.jsx("h3",{className:"text-sm font-semibold uppercase tracking-[0.3em] text-primary-blue/70",children:"Context Pipeline"}),C.jsxs("svg",{viewBox:"0 0 520 160",role:"img","aria-label":"Sources feed into RAG agent producing outputs like minutes, tasks, answers",className:"mx-auto h-auto w-full max-w-[460px] text-primary-blue",children:[C.jsx("title",{children:"Quell AI context diagram"}),C.jsxs("g",{fill:"none",stroke:"currentColor",strokeLinecap:"round",strokeLinejoin:"round",children:[C.jsx("rect",{x:"12",y:"44",width:"120",height:"72",rx:"24",fill:"rgba(42,58,91,0.08)"}),C.jsx("rect",{x:"200",y:"24",width:"120",height:"112",rx:"26",fill:"rgba(42,58,91,0.16)"}),C.jsx("rect",{x:"388",y:"12",width:"120",height:"136",rx:"28",fill:"rgba(42,58,91,0.08)"}),C.jsx("path",{d:"M132 80h56",strokeWidth:"6"}),C.jsx("path",{d:"M320 80h56",strokeWidth:"6"})]}),C.jsx("text",{x:"72",y:"78",textAnchor:"middle",className:"fill-current text-[18px] font-semibold",children:"Sources"}),C.jsx("text",{x:"260",y:"70",textAnchor:"middle",className:"fill-current text-[16px] font-semibold",children:"RAG / Agent"}),C.jsx("text",{x:"260",y:"96",textAnchor:"middle",className:"fill-current text-[13px]",children:"Policies Â· Context Â· Voice"}),C.jsx("text",{x:"448",y:"60",textAnchor:"middle",className:"fill-current text-[16px] font-semibold",children:"Outputs"}),C.jsx("text",{x:"448",y:"86",textAnchor:"middle",className:"fill-current text-[13px]",children:"Minutes Â· Tasks"}),C.jsx("text",{x:"448",y:"110",textAnchor:"middle",className:"fill-current text-[13px]",children:"Answers Â· Follow-ups"})]})]})]})}function ja(){const d=ue();return C.jsxs("section",{ref:d,className:"reveal snap-section rounded-[32px] border border-border-grey/60 bg-white/92 p-8 text-center shadow-lg shadow-primary-blue/15 backdrop-blur lg:p-14","aria-labelledby":"about-why-matters-heading",children:[C.jsx("p",{className:"text-xs font-semibold uppercase tracking-[0.4em] text-primary-blue/70",children:"Why it matters"}),C.jsx("h2",{id:"about-why-matters-heading",className:"mt-4 font-serif text-3xl font-bold text-dark-text md:text-4xl",children:"Collaboration should amplify creativity, not compete with it."}),C.jsx("p",{className:"mx-auto mt-6 max-w-3xl text-base text-light-text md:text-lg",children:"Modern collaboration tools were built to connect people, yet they often drain focus. Quell AI reimagines collaboration as a network of understanding that adapts to your pace. Its goal is not to replace conversation; it is to restore balance between creation and communication."})]})}function Ha({activeProposalButton:d,onExploreCodex:t,onJoinBeta:e}){const s=ue();return C.jsx("section",{id:"about-vision",ref:s,className:"reveal rounded-[32px] border border-border-grey/60 bg-white/95 p-8 shadow-lg shadow-primary-blue/15 backdrop-blur lg:p-14","aria-labelledby":"about-vision-heading",children:C.jsxs("div",{className:"flex flex-col items-center gap-6 text-center",children:[C.jsx("p",{className:"text-xs font-semibold uppercase tracking-[0.4em] text-primary-blue/70",children:"Vision"}),C.jsx("h2",{id:"about-vision-heading",className:"font-serif text-3xl font-bold text-dark-text md:text-4xl",children:"Beyond meetings: collaboration that understands."}),C.jsx("p",{className:"max-w-3xl text-base text-light-text md:text-lg",children:"Quell AI keeps teams aligned today while building the memory graph that tomorrow's collaboration needs."}),C.jsx("div",{className:"flex flex-wrap justify-center gap-3",children:La.map(i=>C.jsx("span",{className:"rounded-full border border-primary-blue/30 bg-primary-blue/10 px-5 py-2 text-sm font-semibold text-primary-blue",children:i},i))}),C.jsxs("div",{className:"flex flex-col gap-4 sm:flex-row",children:[C.jsx("button",{type:"button",onClick:()=>t("vision"),className:Jt("proposal-button inline-flex items-center justify-center rounded-full border border-primary-blue/40 bg-primary-blue px-6 py-3 text-sm font-semibold text-white shadow-lg shadow-primary-blue/25 transition hover:scale-105 hover:bg-hover-blue focus:outline-none focus-visible:ring-2 focus-visible:ring-primary-blue/50",d==="vision"&&"button-active"),children:"View Proposal"}),C.jsx("button",{type:"button",onClick:e,className:"inline-flex items-center justify-center rounded-full border border-primary-blue/30 bg-white px-6 py-3 text-sm font-semibold text-primary-blue shadow-lg shadow-primary-blue/15 transition hover:scale-105 hover:bg-primary-blue/10 focus:outline-none focus-visible:ring-2 focus-visible:ring-primary-blue/50",children:"Join the Beta"})]})]})})}export{Ga as default};
