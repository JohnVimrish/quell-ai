import{r as o,j as t}from"./main-twaqvZcK.js";const x=[".txt",".csv",".json",".xlsx"],g="Quell-Ai",P="qlx_lab_display_name",v="qlx_lab_chat_history",f=()=>`msg-${Date.now()}-${Math.random().toString(16).slice(2)}`,y=()=>new Date().toLocaleTimeString([],{hour:"numeric",minute:"2-digit"}),ee=()=>{if(typeof window>"u")return null;try{const i=window.localStorage.getItem(v);return i?JSON.parse(i):null}catch{return null}},se=(i,m)=>{if(!(typeof window>"u"))try{const d={sessionId:i,history:m.slice(-15)};window.localStorage.setItem(v,JSON.stringify(d))}catch{}},M=()=>{if(!(typeof window>"u"))try{window.localStorage.removeItem(v)}catch{}};function ae(){const[i,m]=o.useState(null),[d,c]=o.useState([]),[E,_]=o.useState(""),[j,I]=o.useState(!1),[b,T]=o.useState(!1),[k,C]=o.useState(!0),[$,u]=o.useState(null),[U,A]=o.useState(!1),w=o.useRef(null),O=o.useRef(null);o.useEffect(()=>{H()},[]),o.useEffect(()=>{O.current?.scrollIntoView({behavior:"smooth"})},[d]),o.useEffect(()=>{!i?.sessionId||d.length===0||se(i.sessionId,d)},[d,i?.sessionId]);const B=()=>{if(typeof window>"u")return"";try{return window.localStorage.getItem(P)||""}catch{return""}},R=e=>{if(!(typeof window>"u"))try{window.localStorage.setItem(P,e)}catch{}},z=async e=>{try{await L(e,{silent:!0}),m(s=>s&&{...s,hasName:!0,displayName:e})}catch(s){console.warn("Failed to restore stored Conversation Lab name",s)}};async function H(){C(!0),u(null);try{const e=await fetch("/api/labs/conversation/session",{method:"POST",credentials:"include"}),s=await e.json();if(!e.ok)throw new Error(s?.error||"Failed to initialize Conversation Lab session.");m(s);const a=ee();a&&a.sessionId===s.sessionId&&a.history?.length?c(a.history):(M(),c([{id:f(),role:"assistant",text:s.greeting,timestamp:y(),senderName:s.assistantName??g}]))}catch(e){const s=e instanceof Error?e.message:"Unable to start the session.";u(s),M(),c([{id:f(),role:"assistant",text:`${g} here. ${s}`,timestamp:y()}])}finally{C(!1)}}const N=!!(i&&!i.hasName),p=(e,s)=>({...{id:s?.id??f(),role:"assistant",text:e,timestamp:s?.timestamp??y(),senderName:i?.assistantName??g},...s}),K=()=>{const e=p("Thinking with the Ollama modelâ€¦",{pending:!0}),s=e.id;return c(a=>[...a,e]),s},D=(e,s)=>{const a=p(e,{id:s?.placeholderId,pending:!1,attachment:s?.attachment});if(!s?.placeholderId){c(n=>[...n,a]);return}c(n=>{let l=!1;const r=n.map(h=>h.id===a.id?(l=!0,a):h);return l?r:[...r,a]})};o.useEffect(()=>{if(i){if(i.displayName){R(i.displayName);return}if(!i.hasName){const e=B();e&&z(e)}}},[i]);const F=async()=>{if(!i)return;const e=E.trim();if(!e||j||b)return;_(""),I(!0),u(null);const s={id:f(),role:"user",text:e,timestamp:y()};c(n=>[...n,s]);let a;try{if(N){const n=await L(e);m(l=>l&&{...l,hasName:!0,displayName:n.displayName}),c(l=>[...l,p(n.assistantReply)])}else{a=K();const n=await J(e);D(n.reply,{placeholderId:a})}}catch(n){const l=n instanceof Error?n.message:"Unable to send message.";u(l),D("I hit a snag while reaching the model. Please try again in a moment.",{placeholderId:a})}finally{I(!1)}},Y=e=>{e.key==="Enter"&&(e.preventDefault(),F())},q=()=>{k||(A(!0),window.setTimeout(()=>A(!1),900),w.current?.click())},G=async e=>{const s=e.target.files;if(!(!s||s.length===0)){u(null),T(!0);for(const a of Array.from(s)){const n=`.${a.name.split(".").pop()?.toLowerCase()||""}`;if(!x.includes(n)){u(`Unsupported file type: ${n}. Please upload ${x.join(", ")}`);continue}const l={id:f(),role:"user",text:`Uploading ${a.name} for review...`,timestamp:y()};c(r=>[...r,l]);try{const r=await Q(a),h={filename:r.filename,fileType:r.fileType,summary:r.summary,analytics:r.analytics,concepts:r.concepts,translated:!!r.translated},S={...p(`Here is a quick breakdown of ${r.filename}.`),attachment:h};c(Z=>[...Z,S])}catch(r){const h=r instanceof Error?r.message:"Upload failed.";u(h),c(S=>[...S,p(`I could not process ${a.name}: ${h}`)])}}w.current&&(w.current.value=""),T(!1)}},L=async(e,s)=>{const a=await fetch("/api/labs/conversation/name",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:e,message:e})}),n=await a.json();if(!a.ok||n?.ok===!1)throw new Error(n?.error||"Failed to store name.");return R(n.displayName),{...n,silent:s?.silent}},J=async e=>{const s=await fetch("/api/labs/conversation/chat",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:e})}),a=await s.json();if(!s.ok||a?.error)throw new Error(a?.error||"Failed to reach Quell-Ai.");return a},Q=async e=>{const s=new FormData;s.append("file",e),s.append("description","Conversation Lab upload");const a=await fetch("/api/labs/conversation/ingest",{method:"POST",credentials:"include",body:s}),n=await a.json();if(!a.ok||n?.ok===!1)throw new Error(n?.error||"Failed to process file");return n},V=e=>{const s=e.analytics||{};return"row_count"in s?`${s.row_count} rows â€¢ ${s.column_count??0} columns`:"word_count"in s?`${s.word_count} words â€¢ ${s.line_count??0} lines`:e.summary},W=e=>{const s=[];e.analytics?.row_count&&s.push(`${e.analytics.row_count} rows`),e.analytics?.column_count&&s.push(`${e.analytics.column_count} columns`),e.analytics?.word_count&&s.push(`${e.analytics.word_count} words`);const a=e.concepts?.key_phrases?.[0];return a&&s.push(`Key phrase: ${a}`),e.translated&&s.push("Translated to English"),s.slice(0,3)},X=x.join(", ");return k?t.jsxs("div",{className:"conversation-lab",children:[t.jsx("div",{className:"clab-background","aria-hidden":!0}),t.jsx("section",{className:"clab-chat-shell",children:t.jsx("div",{className:"clab-loading",children:"Preparing Conversation Lab..."})})]}):t.jsxs("div",{className:"conversation-lab",children:[t.jsx("div",{className:"clab-background","aria-hidden":!0}),t.jsx("section",{className:"clab-chat-shell",children:t.jsxs("div",{className:"clab-chat-panel",children:[t.jsxs("header",{className:"clab-chat-header",children:[t.jsxs("div",{children:[t.jsx("p",{className:"clab-chat-title",children:"Conversation stream"}),t.jsxs("p",{className:"clab-chat-subtitle",children:["Attach ",X," or type a natural question. Responses stay inside this lab."]})]}),t.jsxs("div",{className:"clab-chat-actions",children:[t.jsxs("button",{type:"button",className:`clab-attach-btn ${U?"active":""}`,onClick:q,disabled:b,children:[t.jsx("span",{className:"clab-attach-icon","aria-hidden":!0,children:"ðŸ“Ž"}),t.jsx("span",{children:"Attach file"})]}),t.jsx("input",{ref:w,type:"file",accept:x.join(","),multiple:!0,hidden:!0,onChange:G})]})]}),$&&t.jsx("div",{className:"clab-alert",role:"status",children:$}),t.jsxs("div",{className:"clab-chat-messages",children:[d.map(e=>t.jsxs("div",{className:`clab-message ${e.role} ${e.pending?"pending":""}`,children:[t.jsx("div",{className:"clab-avatar","aria-hidden":!0,children:e.role==="assistant"?"QA":"You".slice(0,2)}),t.jsxs("div",{className:"clab-bubble",children:[t.jsxs("div",{className:"clab-bubble-meta",children:[t.jsx("span",{children:e.role==="assistant"?g:i?.displayName||"You"}),t.jsx("span",{children:e.timestamp})]}),e.pending?t.jsxs("div",{className:"clab-thinking",role:"status","aria-live":"polite",children:[t.jsxs("span",{className:"clab-thinking-dots","aria-hidden":!0,children:[t.jsx("span",{}),t.jsx("span",{}),t.jsx("span",{})]}),t.jsx("span",{children:e.text||"Thinking..."})]}):t.jsx("p",{className:"clab-message-text",children:e.text}),e.attachment&&t.jsxs("div",{className:"clab-attachment-card",children:[t.jsxs("div",{className:"clab-attachment-header",children:[t.jsxs("div",{children:[t.jsx("span",{className:"clab-attachment-name",children:e.attachment.filename}),t.jsx("span",{className:"clab-attachment-type",children:e.attachment.fileType.toUpperCase()})]}),t.jsx("span",{children:V(e.attachment)})]}),t.jsx("p",{className:"clab-attachment-summary",children:e.attachment.summary}),t.jsx("div",{className:"clab-attachment-chips",children:W(e.attachment).map(s=>t.jsx("span",{children:s},s))})]})]})]},e.id)),t.jsx("div",{ref:O})]}),t.jsxs("div",{className:"clab-chat-input",children:[t.jsx("input",{value:E,placeholder:N?"First, let me know your name so I can personalize things.":"Type a message...",onChange:e=>_(e.target.value),onKeyDown:Y,disabled:j||b}),t.jsx("button",{type:"button",onClick:F,disabled:j||b,children:N?"Share name":"Send"})]})]})})]})}export{ae as default};
