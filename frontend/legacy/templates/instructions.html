{% extends "base.html" %}

{% block title %}AI Instructions - Communicator-Copilot{% endblock %}

{% block content %}
<section class="section-padding">
    <div class="glass-panel" style="padding: clamp(32px,4vw,48px); display:grid; gap:32px;">
        <header class="hero" style="margin-bottom:0;">
            <div>
                <h1 class="headline" style="font-size: clamp(2.2rem,3vw,2.8rem);">AI Instruction Feed</h1>
                <p class="subheadline">Brief the copilot with precise guidance that auto-expires to protect your privacy.</p>
            </div>
        </header>
    </div>
</section>
<section class="section-padding" style="padding-top:0; display:grid; gap:32px;">
    <div class="glass-panel" style="padding: clamp(24px,4vw,40px);">
        <h2 style="margin-top:0;">Add New Instruction</h2>
        <script>
            function toggleVerificationDetails() {
                const verificationCheckbox = document.getElementById('verification_required');
                const verificationDetails = document.getElementById('verification_details');
                verificationDetails.style.display = verificationCheckbox.checked ? 'block' : 'none';
            }

            function toggleVerificationDataFields() {
                const verificationMethod = document.getElementById('verification_method').value;
                const passcodeField = document.getElementById('passcode_field');
                const questionField = document.getElementById('question_field');
                
                passcodeField.style.display = 'none';
                questionField.style.display = 'none';

                if (verificationMethod === 'passcode') {
                    passcodeField.style.display = 'block';
                } else if (verificationMethod === 'question') {
                    questionField.style.display = 'block';
                }
            }

            // Run on page load to set initial state
            document.addEventListener('DOMContentLoaded', () => {
                toggleVerificationDetails();
                toggleVerificationDataFields();
            });
        </script>
        <form action="/instructions" method="post" class="form-glass">
            <div class="form-row two">
                <div>
                    <label class="label" for="title">Title</label>
                    <input type="text" id="title" name="title" class="input-control" placeholder="e.g., Regarding the upcoming project deadline" required>
                </div>
                <div>
                    <label class="label" for="target_contact">Target Contact (Optional)</label>
                    <input type="text" id="target_contact" name="target_contact" class="input-control" placeholder="e.g., +11234567890 or 'John Doe'">
                </div>
            </div>
            <div>
                <label class="label" for="instruction_text">Instruction Text</label>
                <textarea id="instruction_text" name="instruction_text" class="textarea-control" rows="4" placeholder="e.g., If they ask about the project, tell them I'm reviewing the documents and will call back tomorrow." required></textarea>
            </div>
            <div class="form-row two">
                <div>
                    <label class="label" for="instruction_type">Instruction Type</label>
                    <select id="instruction_type" name="instruction_type" class="select-control">
                        <option value="general" selected>General</option>
                        <option value="call">Call-Specific</option>
                        <option value="text">Text-Specific</option>
                        <option value="verification">Verification Only</option>
                    </select>
                </div>
                <div>
                    <label class="label" for="priority">Priority</label>
                    <select id="priority" name="priority" class="select-control">
                        <option value="low">Low</option>
                        <option value="normal" selected>Normal</option>
                        <option value="high">High</option>
                    </select>
                </div>
            </div>
            <div class="form-row two">
                <div>
                    <label class="label" for="expires_at">Expires At (Optional)</label>
                    <input type="datetime-local" id="expires_at" name="expires_at" class="input-control">
                </div>
                <div>
                    <label class="label" for="max_usage">Max Usage Count (Optional)</label>
                    <input type="number" id="max_usage" name="max_usage" class="input-control" min="1" placeholder="e.g., 3">
                </div>
            </div>
            <div>
                <label class="label">
                    <input type="checkbox" id="verification_required" name="verification_required" value="true" onchange="toggleVerificationDetails()">
                    Require Verification to Disclose
                </label>
            </div>
            <div id="verification_details" class="glass-panel" style="display:none; padding:20px; box-shadow:none;">
                <div>
                    <label class="label" for="verification_method">Verification Method</label>
                    <select id="verification_method" name="verification_method" class="select-control" onchange="toggleVerificationDataFields()">
                        <option value="">Select Method</option>
                        <option value="passcode">Passcode</option>
                        <option value="question">Security Question</option>
                        <option value="callback">Request a Callback</option>
                    </select>
                </div>
                <div id="passcode_field" style="display:none; margin-top:16px;">
                    <label class="label" for="passcode">Passcode</label>
                    <input type="text" id="passcode" name="passcode" class="input-control" placeholder="Enter the passcode">
                </div>
                <div id="question_field" style="display:none; margin-top:16px; display:grid; gap:16px;">
                    <div>
                        <label class="label" for="security_question">Security Question</label>
                        <input type="text" id="security_question" name="security_question" class="input-control" placeholder="e.g., What is my mother's maiden name?">
                    </div>
                    <div>
                        <label class="label" for="security_answer">Expected Answer</label>
                        <input type="text" id="security_answer" name="security_answer" class="input-control" placeholder="Enter the exact answer">
                    </div>
                </div>
            </div>
            <button type="submit" class="button-primary" style="justify-self:flex-start;">Add Instruction</button>
        </form>
    </div>

    <div class="glass-panel" style="padding: clamp(24px,4vw,40px);">
        <div class="instructions-list">
            <h2>Active & Recent Instructions</h2>
            {% for instruction in instructions %}
            <article class="glass-tile">
                <div class="activity-card-header">
                    <div class="activity-icon"><i class="fas fa-robot"></i></div>
                    <div class="activity-meta">
                        <h3>{{ instruction.title }}</h3>
                        <span class="activity-time">Created {{ instruction.created_at.strftime('%Y-%m-%d %H:%M') }}</span>
                        {% if instruction.expires_at %}
                        <span class="activity-time">Expires {{ instruction.expires_at.strftime('%Y-%m-%d %H:%M') }}</span>
                        {% endif %}
                    </div>
                    <div class="chip" style="align-self:flex-start;">{{ instruction.status | title }}</div>
                </div>
                <div class="activity-body">
                    <p>{{ instruction.instruction_text }}</p>
                    <div style="display:flex; flex-wrap:wrap; gap:12px;">
                        <span class="chip">Priority: {{ instruction.priority | title }}</span>
                        <span class="chip">Type: {{ instruction.instruction_type | title }}</span>
                        {% if instruction.target_contact %}
                        <span class="chip">For: {{ instruction.target_contact }}</span>
                        {% endif %}
                        {% if instruction.verification_required %}
                        <span class="chip warning">Verification: {{ instruction.verification_method | title }}</span>
                        {% endif %}
                        <span class="chip">Usage: {{ instruction.usage_count }} / {{ instruction.max_usage or '&#8734;' }}</span>
                    </div>
                </div>
            </article>
            {% else %}
            <article class="glass-tile">
                <div class="activity-body">No instructions found.</div>
            </article>
            {% endfor %}
        </div>
    </div>
</section>
{% endblock %}
